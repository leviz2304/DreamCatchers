This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2024-11-30T11:09:28.525Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repomix, visit: https://github.com/yamadashy/repomix

================================================================
Repository Structure
================================================================
.gitignore
.mvn/wrapper/maven-wrapper.properties
mvnw
mvnw.cmd
pom.xml
src/main/java/com/example/demo/auth/AuthenticationRequest.java
src/main/java/com/example/demo/auth/AuthService.java
src/main/java/com/example/demo/auth/OtpVerifyRequest.java
src/main/java/com/example/demo/auth/RegisterRequest.java
src/main/java/com/example/demo/auth/ResetPasswordRequest.java
src/main/java/com/example/demo/cloudinary/CloudService.java
src/main/java/com/example/demo/config/AppConfig.java
src/main/java/com/example/demo/config/ConfigVNPAY.java
src/main/java/com/example/demo/config/CorsConfig.java
src/main/java/com/example/demo/config/CorsFilter.java
src/main/java/com/example/demo/config/MethodSecurityConfig.java
src/main/java/com/example/demo/config/ModelMapperConfig.java
src/main/java/com/example/demo/config/RestAuthenticationEntryPoint.java
src/main/java/com/example/demo/config/SecurityConfig.java
src/main/java/com/example/demo/config/StompPrincipal.java
src/main/java/com/example/demo/config/UserInterceptor.java
src/main/java/com/example/demo/config/WebSocketConfig.java
src/main/java/com/example/demo/config/WebSocketSecurityConfig.java
src/main/java/com/example/demo/controller/PrivateController/CategoryController.java
src/main/java/com/example/demo/controller/PrivateController/CourseController.java
src/main/java/com/example/demo/controller/PrivateController/DashboardController.java
src/main/java/com/example/demo/controller/PrivateController/FlashcardController.java
src/main/java/com/example/demo/controller/PrivateController/InstructorController.java
src/main/java/com/example/demo/controller/PrivateController/InvoiceController.java
src/main/java/com/example/demo/controller/PrivateController/LessonController.java
src/main/java/com/example/demo/controller/PrivateController/MeController.java
src/main/java/com/example/demo/controller/PrivateController/PrivateTestController.java
src/main/java/com/example/demo/controller/PrivateController/PrivateWritingController.java
src/main/java/com/example/demo/controller/PrivateController/StatisticController.java
src/main/java/com/example/demo/controller/PrivateController/UploadController.java
src/main/java/com/example/demo/controller/PrivateController/UserController.java
src/main/java/com/example/demo/controller/PrivateController/VocabularyController.java
src/main/java/com/example/demo/controller/PublicController/ChatController.java
src/main/java/com/example/demo/controller/PublicController/CommentController.java
src/main/java/com/example/demo/controller/PublicController/DemoController.java
src/main/java/com/example/demo/controller/PublicController/PCategoryController.java
src/main/java/com/example/demo/controller/PublicController/PCourseController.java
src/main/java/com/example/demo/controller/PublicController/PLessonController.java
src/main/java/com/example/demo/controller/PublicController/PPostController.java
src/main/java/com/example/demo/controller/PublicController/PublicTestController.java
src/main/java/com/example/demo/controller/PublicController/PublicWritingController.java
src/main/java/com/example/demo/controller/PublicController/PUserController.java
src/main/java/com/example/demo/DemoApplication.java
src/main/java/com/example/demo/dto/ChatMessageDTO.java
src/main/java/com/example/demo/dto/Choice.java
src/main/java/com/example/demo/dto/CommentDTO.java
src/main/java/com/example/demo/dto/CourseDTO.java
src/main/java/com/example/demo/dto/CourseStatisticDTO.java
src/main/java/com/example/demo/dto/CriterionFeedback.java
src/main/java/com/example/demo/dto/EnrollDTO.java
src/main/java/com/example/demo/dto/EssayFeedback.java
src/main/java/com/example/demo/dto/EssaySubmissionRequest.java
src/main/java/com/example/demo/dto/ExercideDTO.java
src/main/java/com/example/demo/dto/GrammarError.java
src/main/java/com/example/demo/dto/InstructorDTO.java
src/main/java/com/example/demo/dto/InvoiceDTO.java
src/main/java/com/example/demo/dto/InvoiceStatisticDTO.java
src/main/java/com/example/demo/dto/LessonDTO.java
src/main/java/com/example/demo/dto/LessonProgressDTO.java
src/main/java/com/example/demo/dto/ListeningSectionDTO.java
src/main/java/com/example/demo/dto/Message.java
src/main/java/com/example/demo/dto/OpenAIRequest.java
src/main/java/com/example/demo/dto/OpenAIResponse.java
src/main/java/com/example/demo/dto/PassageDTO.java
src/main/java/com/example/demo/dto/PasswordDTO.java
src/main/java/com/example/demo/dto/PostDTO.java
src/main/java/com/example/demo/dto/ProgressDTO.java
src/main/java/com/example/demo/dto/QuestionDTO.java
src/main/java/com/example/demo/dto/QuestionOptionDTO.java
src/main/java/com/example/demo/dto/ResponseObject.java
src/main/java/com/example/demo/dto/SectionDTO.java
src/main/java/com/example/demo/dto/StatisticsDTO.java
src/main/java/com/example/demo/dto/TestDTO.java
src/main/java/com/example/demo/dto/UserDTO.java
src/main/java/com/example/demo/dto/UserEssayDTO.java
src/main/java/com/example/demo/dto/UserResponseDTO.java
src/main/java/com/example/demo/dto/UsersAndRoles.java
src/main/java/com/example/demo/dto/UserStatisticDTO.java
src/main/java/com/example/demo/dto/VocabularyError.java
src/main/java/com/example/demo/entity/data/Category.java
src/main/java/com/example/demo/entity/data/Comment.java
src/main/java/com/example/demo/entity/data/Course.java
src/main/java/com/example/demo/entity/data/Flashcard.java
src/main/java/com/example/demo/entity/data/FlashcardSet.java
src/main/java/com/example/demo/entity/data/Invoice.java
src/main/java/com/example/demo/entity/data/Lesson.java
src/main/java/com/example/demo/entity/data/LessonProgress.java
src/main/java/com/example/demo/entity/data/LessonProgressKey.java
src/main/java/com/example/demo/entity/data/ListeningSection.java
src/main/java/com/example/demo/entity/data/Message.java
src/main/java/com/example/demo/entity/data/MethodPayment.java
src/main/java/com/example/demo/entity/data/Notification.java
src/main/java/com/example/demo/entity/data/Passage.java
src/main/java/com/example/demo/entity/data/Post.java
src/main/java/com/example/demo/entity/data/Progress.java
src/main/java/com/example/demo/entity/data/Question.java
src/main/java/com/example/demo/entity/data/QuestionOption.java
src/main/java/com/example/demo/entity/data/Section.java
src/main/java/com/example/demo/entity/data/Test.java
src/main/java/com/example/demo/entity/data/TestProgress.java
src/main/java/com/example/demo/entity/data/UserEssay.java
src/main/java/com/example/demo/entity/data/UserResponse.java
src/main/java/com/example/demo/entity/data/Vocabulary.java
src/main/java/com/example/demo/entity/data/WritingTask.java
src/main/java/com/example/demo/entity/user/OtpStatus.java
src/main/java/com/example/demo/entity/user/Permission.java
src/main/java/com/example/demo/entity/user/Role.java
src/main/java/com/example/demo/entity/user/User.java
src/main/java/com/example/demo/exception/CourseNotFoundException.java
src/main/java/com/example/demo/exception/ResourceNotFoundException.java
src/main/java/com/example/demo/exception/UserNotFoundException.java
src/main/java/com/example/demo/handler/LogoutHandler.java
src/main/java/com/example/demo/handler/Oauth2SuccessHandler.java
src/main/java/com/example/demo/jwt/JwtFilter.java
src/main/java/com/example/demo/jwt/JwtService.java
src/main/java/com/example/demo/jwt/Token.java
src/main/java/com/example/demo/mail/MailRequest.java
src/main/java/com/example/demo/mail/MailService.java
src/main/java/com/example/demo/MUX/MuxService.java
src/main/java/com/example/demo/repository/data/CategoryRepository.java
src/main/java/com/example/demo/repository/data/CommentRepository.java
src/main/java/com/example/demo/repository/data/CourseRepository.java
src/main/java/com/example/demo/repository/data/FlashcardRepository.java
src/main/java/com/example/demo/repository/data/FlashcardSetRepository.java
src/main/java/com/example/demo/repository/data/InvoiceRepository.java
src/main/java/com/example/demo/repository/data/LessonProgressRepository.java
src/main/java/com/example/demo/repository/data/LessonRepository.java
src/main/java/com/example/demo/repository/data/ListeningSectionRepository.java
src/main/java/com/example/demo/repository/data/MessageRepository.java
src/main/java/com/example/demo/repository/data/NotificationRepository.java
src/main/java/com/example/demo/repository/data/PassageRepository.java
src/main/java/com/example/demo/repository/data/PostRepository.java
src/main/java/com/example/demo/repository/data/ProgressRepository.java
src/main/java/com/example/demo/repository/data/QuestionOptionRepository.java
src/main/java/com/example/demo/repository/data/QuestionRepository.java
src/main/java/com/example/demo/repository/data/SectionRepository.java
src/main/java/com/example/demo/repository/data/TestProgressRepository.java
src/main/java/com/example/demo/repository/data/TestRepository.java
src/main/java/com/example/demo/repository/data/UserEssayRepository.java
src/main/java/com/example/demo/repository/data/UserResponseRepository.java
src/main/java/com/example/demo/repository/data/VocabularyRepository.java
src/main/java/com/example/demo/repository/data/WritingTaskRepository.java
src/main/java/com/example/demo/repository/TokenRepository.java
src/main/java/com/example/demo/repository/UserRepository.java
src/main/java/com/example/demo/service/CategoryService.java
src/main/java/com/example/demo/service/ChatService.java
src/main/java/com/example/demo/service/CommentService.java
src/main/java/com/example/demo/service/CourseService.java
src/main/java/com/example/demo/service/DashboardService.java
src/main/java/com/example/demo/service/ExternalEssayEvaluationService.java
src/main/java/com/example/demo/service/FlashcardService.java
src/main/java/com/example/demo/service/InvoiceService.java
src/main/java/com/example/demo/service/LessonProgressService.java
src/main/java/com/example/demo/service/LessonService.java
src/main/java/com/example/demo/service/MessageService.java
src/main/java/com/example/demo/service/NotificationService.java
src/main/java/com/example/demo/service/PostService.java
src/main/java/com/example/demo/service/SectionService.java
src/main/java/com/example/demo/service/StatisticsService.java
src/main/java/com/example/demo/service/TestService.java
src/main/java/com/example/demo/service/UploadService.java
src/main/java/com/example/demo/service/UserService.java
src/main/java/com/example/demo/service/VocabularyService.java
src/main/java/com/example/demo/service/WritingService.java
src/main/resources/application.properties
src/test/java/com/example/demo/DemoApplicationTests.java

================================================================
Repository Files
================================================================

================
File: .gitignore
================
HELP.md
target/
!.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/
BE/src/main/resources/application.properties
### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache


### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr

================
File: .mvn/wrapper/maven-wrapper.properties
================
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.5/apache-maven-3.9.5-bin.zip
wrapperUrl=https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.2.0/maven-wrapper-3.2.0.jar

================
File: mvnw
================
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.2.0
#
# Required ENV vars:
# ------------------
#   JAVA_HOME - location of a JDK home dir
#
# Optional ENV vars
# -----------------
#   MAVEN_OPTS - parameters passed to the Java VM when running Maven
#     e.g. to debug Maven itself, use
#       set MAVEN_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000
#   MAVEN_SKIP_RC - flag to disable loading of mavenrc files
# ----------------------------------------------------------------------------

if [ -z "$MAVEN_SKIP_RC" ] ; then

  if [ -f /usr/local/etc/mavenrc ] ; then
    . /usr/local/etc/mavenrc
  fi

  if [ -f /etc/mavenrc ] ; then
    . /etc/mavenrc
  fi

  if [ -f "$HOME/.mavenrc" ] ; then
    . "$HOME/.mavenrc"
  fi

fi

# OS specific support.  $var _must_ be set to either true or false.
cygwin=false;
darwin=false;
mingw=false
case "$(uname)" in
  CYGWIN*) cygwin=true ;;
  MINGW*) mingw=true;;
  Darwin*) darwin=true
    # Use /usr/libexec/java_home if available, otherwise fall back to /Library/Java/Home
    # See https://developer.apple.com/library/mac/qa/qa1170/_index.html
    if [ -z "$JAVA_HOME" ]; then
      if [ -x "/usr/libexec/java_home" ]; then
        JAVA_HOME="$(/usr/libexec/java_home)"; export JAVA_HOME
      else
        JAVA_HOME="/Library/Java/Home"; export JAVA_HOME
      fi
    fi
    ;;
esac

if [ -z "$JAVA_HOME" ] ; then
  if [ -r /etc/gentoo-release ] ; then
    JAVA_HOME=$(java-config --jre-home)
  fi
fi

# For Cygwin, ensure paths are in UNIX format before anything is touched
if $cygwin ; then
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=$(cygpath --unix "$JAVA_HOME")
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=$(cygpath --path --unix "$CLASSPATH")
fi

# For Mingw, ensure paths are in UNIX format before anything is touched
if $mingw ; then
  [ -n "$JAVA_HOME" ] && [ -d "$JAVA_HOME" ] &&
    JAVA_HOME="$(cd "$JAVA_HOME" || (echo "cannot cd into $JAVA_HOME."; exit 1); pwd)"
fi

if [ -z "$JAVA_HOME" ]; then
  javaExecutable="$(which javac)"
  if [ -n "$javaExecutable" ] && ! [ "$(expr "\"$javaExecutable\"" : '\([^ ]*\)')" = "no" ]; then
    # readlink(1) is not available as standard on Solaris 10.
    readLink=$(which readlink)
    if [ ! "$(expr "$readLink" : '\([^ ]*\)')" = "no" ]; then
      if $darwin ; then
        javaHome="$(dirname "\"$javaExecutable\"")"
        javaExecutable="$(cd "\"$javaHome\"" && pwd -P)/javac"
      else
        javaExecutable="$(readlink -f "\"$javaExecutable\"")"
      fi
      javaHome="$(dirname "\"$javaExecutable\"")"
      javaHome=$(expr "$javaHome" : '\(.*\)/bin')
      JAVA_HOME="$javaHome"
      export JAVA_HOME
    fi
  fi
fi

if [ -z "$JAVACMD" ] ; then
  if [ -n "$JAVA_HOME"  ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
    else
      JAVACMD="$JAVA_HOME/bin/java"
    fi
  else
    JAVACMD="$(\unset -f command 2>/dev/null; \command -v java)"
  fi
fi

if [ ! -x "$JAVACMD" ] ; then
  echo "Error: JAVA_HOME is not defined correctly." >&2
  echo "  We cannot execute $JAVACMD" >&2
  exit 1
fi

if [ -z "$JAVA_HOME" ] ; then
  echo "Warning: JAVA_HOME environment variable is not set."
fi

# traverses directory structure from process work directory to filesystem root
# first directory with .mvn subdirectory is considered project base directory
find_maven_basedir() {
  if [ -z "$1" ]
  then
    echo "Path not specified to find_maven_basedir"
    return 1
  fi

  basedir="$1"
  wdir="$1"
  while [ "$wdir" != '/' ] ; do
    if [ -d "$wdir"/.mvn ] ; then
      basedir=$wdir
      break
    fi
    # workaround for JBEAP-8937 (on Solaris 10/Sparc)
    if [ -d "${wdir}" ]; then
      wdir=$(cd "$wdir/.." || exit 1; pwd)
    fi
    # end of workaround
  done
  printf '%s' "$(cd "$basedir" || exit 1; pwd)"
}

# concatenates all lines of a file
concat_lines() {
  if [ -f "$1" ]; then
    # Remove \r in case we run on Windows within Git Bash
    # and check out the repository with auto CRLF management
    # enabled. Otherwise, we may read lines that are delimited with
    # \r\n and produce $'-Xarg\r' rather than -Xarg due to word
    # splitting rules.
    tr -s '\r\n' ' ' < "$1"
  fi
}

log() {
  if [ "$MVNW_VERBOSE" = true ]; then
    printf '%s\n' "$1"
  fi
}

BASE_DIR=$(find_maven_basedir "$(dirname "$0")")
if [ -z "$BASE_DIR" ]; then
  exit 1;
fi

MAVEN_PROJECTBASEDIR=${MAVEN_BASEDIR:-"$BASE_DIR"}; export MAVEN_PROJECTBASEDIR
log "$MAVEN_PROJECTBASEDIR"

##########################################################################################
# Extension to allow automatically downloading the maven-wrapper.jar from Maven-central
# This allows using the maven wrapper in projects that prohibit checking in binary data.
##########################################################################################
wrapperJarPath="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.jar"
if [ -r "$wrapperJarPath" ]; then
    log "Found $wrapperJarPath"
else
    log "Couldn't find $wrapperJarPath, downloading it ..."

    if [ -n "$MVNW_REPOURL" ]; then
      wrapperUrl="$MVNW_REPOURL/org/apache/maven/wrapper/maven-wrapper/3.2.0/maven-wrapper-3.2.0.jar"
    else
      wrapperUrl="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.2.0/maven-wrapper-3.2.0.jar"
    fi
    while IFS="=" read -r key value; do
      # Remove '\r' from value to allow usage on windows as IFS does not consider '\r' as a separator ( considers space, tab, new line ('\n'), and custom '=' )
      safeValue=$(echo "$value" | tr -d '\r')
      case "$key" in (wrapperUrl) wrapperUrl="$safeValue"; break ;;
      esac
    done < "$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.properties"
    log "Downloading from: $wrapperUrl"

    if $cygwin; then
      wrapperJarPath=$(cygpath --path --windows "$wrapperJarPath")
    fi

    if command -v wget > /dev/null; then
        log "Found wget ... using wget"
        [ "$MVNW_VERBOSE" = true ] && QUIET="" || QUIET="--quiet"
        if [ -z "$MVNW_USERNAME" ] || [ -z "$MVNW_PASSWORD" ]; then
            wget $QUIET "$wrapperUrl" -O "$wrapperJarPath" || rm -f "$wrapperJarPath"
        else
            wget $QUIET --http-user="$MVNW_USERNAME" --http-password="$MVNW_PASSWORD" "$wrapperUrl" -O "$wrapperJarPath" || rm -f "$wrapperJarPath"
        fi
    elif command -v curl > /dev/null; then
        log "Found curl ... using curl"
        [ "$MVNW_VERBOSE" = true ] && QUIET="" || QUIET="--silent"
        if [ -z "$MVNW_USERNAME" ] || [ -z "$MVNW_PASSWORD" ]; then
            curl $QUIET -o "$wrapperJarPath" "$wrapperUrl" -f -L || rm -f "$wrapperJarPath"
        else
            curl $QUIET --user "$MVNW_USERNAME:$MVNW_PASSWORD" -o "$wrapperJarPath" "$wrapperUrl" -f -L || rm -f "$wrapperJarPath"
        fi
    else
        log "Falling back to using Java to download"
        javaSource="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/MavenWrapperDownloader.java"
        javaClass="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/MavenWrapperDownloader.class"
        # For Cygwin, switch paths to Windows format before running javac
        if $cygwin; then
          javaSource=$(cygpath --path --windows "$javaSource")
          javaClass=$(cygpath --path --windows "$javaClass")
        fi
        if [ -e "$javaSource" ]; then
            if [ ! -e "$javaClass" ]; then
                log " - Compiling MavenWrapperDownloader.java ..."
                ("$JAVA_HOME/bin/javac" "$javaSource")
            fi
            if [ -e "$javaClass" ]; then
                log " - Running MavenWrapperDownloader.java ..."
                ("$JAVA_HOME/bin/java" -cp .mvn/wrapper MavenWrapperDownloader "$wrapperUrl" "$wrapperJarPath") || rm -f "$wrapperJarPath"
            fi
        fi
    fi
fi
##########################################################################################
# End of extension
##########################################################################################

# If specified, validate the SHA-256 sum of the Maven wrapper jar file
wrapperSha256Sum=""
while IFS="=" read -r key value; do
  case "$key" in (wrapperSha256Sum) wrapperSha256Sum=$value; break ;;
  esac
done < "$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.properties"
if [ -n "$wrapperSha256Sum" ]; then
  wrapperSha256Result=false
  if command -v sha256sum > /dev/null; then
    if echo "$wrapperSha256Sum  $wrapperJarPath" | sha256sum -c > /dev/null 2>&1; then
      wrapperSha256Result=true
    fi
  elif command -v shasum > /dev/null; then
    if echo "$wrapperSha256Sum  $wrapperJarPath" | shasum -a 256 -c > /dev/null 2>&1; then
      wrapperSha256Result=true
    fi
  else
    echo "Checksum validation was requested but neither 'sha256sum' or 'shasum' are available."
    echo "Please install either command, or disable validation by removing 'wrapperSha256Sum' from your maven-wrapper.properties."
    exit 1
  fi
  if [ $wrapperSha256Result = false ]; then
    echo "Error: Failed to validate Maven wrapper SHA-256, your Maven wrapper might be compromised." >&2
    echo "Investigate or delete $wrapperJarPath to attempt a clean download." >&2
    echo "If you updated your Maven version, you need to update the specified wrapperSha256Sum property." >&2
    exit 1
  fi
fi

MAVEN_OPTS="$(concat_lines "$MAVEN_PROJECTBASEDIR/.mvn/jvm.config") $MAVEN_OPTS"

# For Cygwin, switch paths to Windows format before running java
if $cygwin; then
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=$(cygpath --path --windows "$JAVA_HOME")
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=$(cygpath --path --windows "$CLASSPATH")
  [ -n "$MAVEN_PROJECTBASEDIR" ] &&
    MAVEN_PROJECTBASEDIR=$(cygpath --path --windows "$MAVEN_PROJECTBASEDIR")
fi

# Provide a "standardized" way to retrieve the CLI args that will
# work with both Windows and non-Windows executions.
MAVEN_CMD_LINE_ARGS="$MAVEN_CONFIG $*"
export MAVEN_CMD_LINE_ARGS

WRAPPER_LAUNCHER=org.apache.maven.wrapper.MavenWrapperMain

# shellcheck disable=SC2086 # safe args
exec "$JAVACMD" \
  $MAVEN_OPTS \
  $MAVEN_DEBUG_OPTS \
  -classpath "$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.jar" \
  "-Dmaven.multiModuleProjectDirectory=${MAVEN_PROJECTBASEDIR}" \
  ${WRAPPER_LAUNCHER} $MAVEN_CONFIG "$@"

================
File: mvnw.cmd
================
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    https://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Apache Maven Wrapper startup batch script, version 3.2.0
@REM
@REM Required ENV vars:
@REM JAVA_HOME - location of a JDK home dir
@REM
@REM Optional ENV vars
@REM MAVEN_BATCH_ECHO - set to 'on' to enable the echoing of the batch commands
@REM MAVEN_BATCH_PAUSE - set to 'on' to wait for a keystroke before ending
@REM MAVEN_OPTS - parameters passed to the Java VM when running Maven
@REM     e.g. to debug Maven itself, use
@REM set MAVEN_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000
@REM MAVEN_SKIP_RC - flag to disable loading of mavenrc files
@REM ----------------------------------------------------------------------------

@REM Begin all REM lines with '@' in case MAVEN_BATCH_ECHO is 'on'
@echo off
@REM set title of command window
title %0
@REM enable echoing by setting MAVEN_BATCH_ECHO to 'on'
@if "%MAVEN_BATCH_ECHO%" == "on"  echo %MAVEN_BATCH_ECHO%

@REM set %HOME% to equivalent of $HOME
if "%HOME%" == "" (set "HOME=%HOMEDRIVE%%HOMEPATH%")

@REM Execute a user defined script before this one
if not "%MAVEN_SKIP_RC%" == "" goto skipRcPre
@REM check for pre script, once with legacy .bat ending and once with .cmd ending
if exist "%USERPROFILE%\mavenrc_pre.bat" call "%USERPROFILE%\mavenrc_pre.bat" %*
if exist "%USERPROFILE%\mavenrc_pre.cmd" call "%USERPROFILE%\mavenrc_pre.cmd" %*
:skipRcPre

@setlocal

set ERROR_CODE=0

@REM To isolate internal variables from possible post scripts, we use another setlocal
@setlocal

@REM ==== START VALIDATION ====
if not "%JAVA_HOME%" == "" goto OkJHome

echo.
echo Error: JAVA_HOME not found in your environment. >&2
echo Please set the JAVA_HOME variable in your environment to match the >&2
echo location of your Java installation. >&2
echo.
goto error

:OkJHome
if exist "%JAVA_HOME%\bin\java.exe" goto init

echo.
echo Error: JAVA_HOME is set to an invalid directory. >&2
echo JAVA_HOME = "%JAVA_HOME%" >&2
echo Please set the JAVA_HOME variable in your environment to match the >&2
echo location of your Java installation. >&2
echo.
goto error

@REM ==== END VALIDATION ====

:init

@REM Find the project base dir, i.e. the directory that contains the folder ".mvn".
@REM Fallback to current working directory if not found.

set MAVEN_PROJECTBASEDIR=%MAVEN_BASEDIR%
IF NOT "%MAVEN_PROJECTBASEDIR%"=="" goto endDetectBaseDir

set EXEC_DIR=%CD%
set WDIR=%EXEC_DIR%
:findBaseDir
IF EXIST "%WDIR%"\.mvn goto baseDirFound
cd ..
IF "%WDIR%"=="%CD%" goto baseDirNotFound
set WDIR=%CD%
goto findBaseDir

:baseDirFound
set MAVEN_PROJECTBASEDIR=%WDIR%
cd "%EXEC_DIR%"
goto endDetectBaseDir

:baseDirNotFound
set MAVEN_PROJECTBASEDIR=%EXEC_DIR%
cd "%EXEC_DIR%"

:endDetectBaseDir

IF NOT EXIST "%MAVEN_PROJECTBASEDIR%\.mvn\jvm.config" goto endReadAdditionalConfig

@setlocal EnableExtensions EnableDelayedExpansion
for /F "usebackq delims=" %%a in ("%MAVEN_PROJECTBASEDIR%\.mvn\jvm.config") do set JVM_CONFIG_MAVEN_PROPS=!JVM_CONFIG_MAVEN_PROPS! %%a
@endlocal & set JVM_CONFIG_MAVEN_PROPS=%JVM_CONFIG_MAVEN_PROPS%

:endReadAdditionalConfig

SET MAVEN_JAVA_EXE="%JAVA_HOME%\bin\java.exe"
set WRAPPER_JAR="%MAVEN_PROJECTBASEDIR%\.mvn\wrapper\maven-wrapper.jar"
set WRAPPER_LAUNCHER=org.apache.maven.wrapper.MavenWrapperMain

set WRAPPER_URL="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.2.0/maven-wrapper-3.2.0.jar"

FOR /F "usebackq tokens=1,2 delims==" %%A IN ("%MAVEN_PROJECTBASEDIR%\.mvn\wrapper\maven-wrapper.properties") DO (
    IF "%%A"=="wrapperUrl" SET WRAPPER_URL=%%B
)

@REM Extension to allow automatically downloading the maven-wrapper.jar from Maven-central
@REM This allows using the maven wrapper in projects that prohibit checking in binary data.
if exist %WRAPPER_JAR% (
    if "%MVNW_VERBOSE%" == "true" (
        echo Found %WRAPPER_JAR%
    )
) else (
    if not "%MVNW_REPOURL%" == "" (
        SET WRAPPER_URL="%MVNW_REPOURL%/org/apache/maven/wrapper/maven-wrapper/3.2.0/maven-wrapper-3.2.0.jar"
    )
    if "%MVNW_VERBOSE%" == "true" (
        echo Couldn't find %WRAPPER_JAR%, downloading it ...
        echo Downloading from: %WRAPPER_URL%
    )

    powershell -Command "&{"^
		"$webclient = new-object System.Net.WebClient;"^
		"if (-not ([string]::IsNullOrEmpty('%MVNW_USERNAME%') -and [string]::IsNullOrEmpty('%MVNW_PASSWORD%'))) {"^
		"$webclient.Credentials = new-object System.Net.NetworkCredential('%MVNW_USERNAME%', '%MVNW_PASSWORD%');"^
		"}"^
		"[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; $webclient.DownloadFile('%WRAPPER_URL%', '%WRAPPER_JAR%')"^
		"}"
    if "%MVNW_VERBOSE%" == "true" (
        echo Finished downloading %WRAPPER_JAR%
    )
)
@REM End of extension

@REM If specified, validate the SHA-256 sum of the Maven wrapper jar file
SET WRAPPER_SHA_256_SUM=""
FOR /F "usebackq tokens=1,2 delims==" %%A IN ("%MAVEN_PROJECTBASEDIR%\.mvn\wrapper\maven-wrapper.properties") DO (
    IF "%%A"=="wrapperSha256Sum" SET WRAPPER_SHA_256_SUM=%%B
)
IF NOT %WRAPPER_SHA_256_SUM%=="" (
    powershell -Command "&{"^
       "$hash = (Get-FileHash \"%WRAPPER_JAR%\" -Algorithm SHA256).Hash.ToLower();"^
       "If('%WRAPPER_SHA_256_SUM%' -ne $hash){"^
       "  Write-Output 'Error: Failed to validate Maven wrapper SHA-256, your Maven wrapper might be compromised.';"^
       "  Write-Output 'Investigate or delete %WRAPPER_JAR% to attempt a clean download.';"^
       "  Write-Output 'If you updated your Maven version, you need to update the specified wrapperSha256Sum property.';"^
       "  exit 1;"^
       "}"^
       "}"
    if ERRORLEVEL 1 goto error
)

@REM Provide a "standardized" way to retrieve the CLI args that will
@REM work with both Windows and non-Windows executions.
set MAVEN_CMD_LINE_ARGS=%*

%MAVEN_JAVA_EXE% ^
  %JVM_CONFIG_MAVEN_PROPS% ^
  %MAVEN_OPTS% ^
  %MAVEN_DEBUG_OPTS% ^
  -classpath %WRAPPER_JAR% ^
  "-Dmaven.multiModuleProjectDirectory=%MAVEN_PROJECTBASEDIR%" ^
  %WRAPPER_LAUNCHER% %MAVEN_CONFIG% %*
if ERRORLEVEL 1 goto error
goto end

:error
set ERROR_CODE=1

:end
@endlocal & set ERROR_CODE=%ERROR_CODE%

if not "%MAVEN_SKIP_RC%"=="" goto skipRcPost
@REM check for post script, once with legacy .bat ending and once with .cmd ending
if exist "%USERPROFILE%\mavenrc_post.bat" call "%USERPROFILE%\mavenrc_post.bat"
if exist "%USERPROFILE%\mavenrc_post.cmd" call "%USERPROFILE%\mavenrc_post.cmd"
:skipRcPost

@REM pause the script if MAVEN_BATCH_PAUSE is set to 'on'
if "%MAVEN_BATCH_PAUSE%"=="on" pause

if "%MAVEN_TERMINATE_CMD%"=="on" exit %ERROR_CODE%

cmd /C exit /B %ERROR_CODE%

================
File: pom.xml
================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.2.3</version>
		<relativePath/>
	</parent>
	<groupId>com.example</groupId>
	<artifactId>demo</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>demo</name>
	<description>Demo project for Spring Boot</description>
	<properties>
		<java.version>23</java.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-oauth2-client</artifactId>
			<version>3.2.5</version>
		</dependency>

		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>3.0.0</version>
		</dependency>
		<!-- https://mvnrepository.com/artifact/com.mux/mux-sdk-java -->
		<dependency>
			<groupId>com.mux</groupId>
			<artifactId>mux-sdk-java</artifactId>
			<version>0.15.0</version>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
		</dependency>
		<!-- https://mvnrepository.com/artifact/net.bramp.ffmpeg/ffmpeg -->

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-websocket</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework</groupId>
			<artifactId>spring-websocket</artifactId>
			<version>6.1.6</version>
		</dependency>

		<dependency>
			<groupId>com.mysql</groupId>
			<artifactId>mysql-connector-j</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.12.5</version>
		</dependency><dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.12.5</version>
		</dependency><dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.12.5</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-mail</artifactId>
			<version>3.1.3</version>
		</dependency>

		<dependency>
			<groupId>com.twilio.sdk</groupId>
			<artifactId>twilio</artifactId>
			<version>10.1.2</version>
		</dependency>
		<dependency>
			<groupId>com.cloudinary</groupId>
			<artifactId>cloudinary-http44</artifactId>
			<version>1.38.0</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
			<version>3.2.3</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<scope>test</scope>
		</dependency>

	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>

</project>

================
File: src/main/java/com/example/demo/auth/AuthenticationRequest.java
================
package com.example.demo.auth;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class AuthenticationRequest {
    private String email;
    private String password;
}

================
File: src/main/java/com/example/demo/auth/AuthService.java
================
package com.example.demo.auth;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.config.ConfigVNPAY;
import com.example.demo.dto.*;
import com.example.demo.entity.data.Comment;
import com.example.demo.entity.data.MethodPayment;
import com.example.demo.entity.data.Notification;
import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.jwt.JwtService;
import com.example.demo.jwt.Token;
import com.example.demo.mail.MailRequest;
import com.example.demo.repository.TokenRepository;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.repository.data.LessonRepository;
import com.example.demo.repository.data.NotificationRepository;
import com.example.demo.repository.data.ProgressRepository;
import com.example.demo.service.CommentService;
import com.example.demo.service.InvoiceService;
import com.example.demo.service.NotificationService;
import com.example.demo.service.PostService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.*;

@Service
@RequiredArgsConstructor
@Slf4j
public class AuthService {
    private final UserRepository userRepository;
    private final AuthenticationManager authenticationManager;
    private final CourseRepository courseRepository;
    private final ProgressRepository progressRepository;

    private final JwtService jwtService;
    private final CloudService cloudService;
    private final PasswordEncoder passwordEncoder;
    private  final NotificationService notificationService;
    private final InvoiceService invoiceService;
    private  final CommentService commentService;
    @Autowired
    private PostService postService;
    public User assignRoleToUser(String email, Role role) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new ResourceNotFoundException("User not found with email: " + email));
        user.setRole(role);
        return userRepository.save(user);
    }

   public ResponseObject savePost(PostDTO postDTO) {
       var user = userRepository.findByEmail(postDTO.getEmail()).orElse(null);
       if (user == null) {
           return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
       }

       postService.savePost(user, postDTO);
       userRepository.save(user);
       return ResponseObject.builder().status(HttpStatus.OK).mess("Create post successfully").build();
   }

    public ResponseObject deleteCommentById(String email, int id) {
        var comment = commentService.getById(id);
        if(comment == null) {
            return ResponseObject.builder().status(HttpStatus.OK).mess("Delete successfully").build();
        }
        var user = userRepository.findByEmail(email).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        user.getComments().remove(comment);
        commentService.deleteById(id);
        userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Delete successfully").build();
    }

    public ResponseObject removeAllNotificationsByEmail(String email) {
        if(!email.contains("@")) {
            email += "@gmail.com";
        }
        var user = userRepository.findByEmail(email).orElse(null);

        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content("User not found ").build();
        }
        var result = notificationService.removeAllNotificationsByEmail(user.getId());
        if (result != null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Error while remove all notification").build();
        }
        user.setNotifications(new ArrayList<>());
        userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Remove all notification successfully").build();
    }
    public ResponseObject readAllNotification(String email) {
        if(!email.contains("@")) {
            email += "@gmail.com";
        }
        var user = userRepository.findByEmail(email).orElse(null);

        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content("User not found ").build();
        }
        var result = notificationService.readAllNotification(user.getId());
        if (result == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content("Error while read notification").build();
        }
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }
    public ResponseObject readNotification(String email, int id) {
        if(!email.contains("@")) {
            email += "@gmail.com";
        }
        var user = userRepository.findByEmail(email).orElse(null);

        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content("User not found ").build();
        }
        var result = notificationService.readNotification(id);
        if (result == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content("Error while read notification").build();
        }
        return ResponseObject.builder().status(HttpStatus.OK).mess("Read notification successfully").content(result).build();
    }
    public ResponseObject getAllNotificationsByEmail(String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content("User not found").build();
        }
        return ResponseObject.builder().status(HttpStatus.OK).content(notificationService.getAllNotificationsByEmail(user.getId())).build();
    }


    public ResponseObject updateLessonsIds(String alias, int courseId, List<Integer> lessonIds) {
        var email = alias + "@gmail.com";
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        var progress = progressRepository.findByCourseIdAndUser(courseId, user).orElse(null);
        if (progress == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User has not registered for the course ").build();
        }
        progress.setLessonIds(lessonIds);
        progressRepository.save(progress);
        return ResponseObject.builder().status(HttpStatus.OK).build();
    }

    public ResponseObject getProgressByCourseId(String alias, int courseId) {
        var email = alias + "@gmail.com";
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        var progress = progressRepository.findByCourseIdAndUser(courseId, user).orElse(null);
        if (progress == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User has not registered for the course ").build();
        }
        var progressDTO = ProgressDTO.builder().course(progress.getCourse()).lessonIds(progress.getLessonIds()).build();

        return ResponseObject.builder().status(HttpStatus.OK).content(progressDTO).build();

    }

    public boolean register(RegisterRequest request) {
        if(isUsedEmail(request.getEmail())) return  false;
        saveUser(request);
        return true;
    }

    public ResponseObject authenticate(AuthenticationRequest auth) {
        try {
            authenticationManager.authenticate(
                    new UsernamePasswordAuthenticationToken(auth.getEmail(), auth.getPassword())
            );
            var user = userRepository.findByEmail(auth.getEmail()).orElse(null);
            if (user == null) {
                return ResponseObject.builder()
                        .status(HttpStatus.BAD_REQUEST)
                        .content("User does not exist.")
                        .build();
            }
            Token token = new Token(jwtService.generateToken(user));
            user.setToken(token);
            var userDTO = getUserDTOFromUser(user);
            userDTO.setToken(token.getToken());
            return ResponseObject.builder()
                    .status(HttpStatus.OK)
                    .content(userDTO)
                    .build();
        } catch (AuthenticationException ex) {
            System.out.println(ex.getMessage() + " Authentication failed!");
            return ResponseObject.builder()
                    .status(HttpStatus.BAD_REQUEST)
                    .mess("Error while authenticating user: " + ex.getMessage())
                    .build();
        }
    }


    public UserDTO getUserDTOFromUser(User user) {
        return UserDTO.builder()
                .id(user.getId()) // Add this line
                .avatar(user.getAvatar())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .phoneNumber(user.getPhoneNumber())
                .role(user.getRole())
                // .progresses(user.getProgresses())
                .build();
    }


    public ResponseObject getAllByPage(int page, int size) {
        var result = userRepository.findAll(PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }

    public ResponseObject getAllUser() {
        var users = userRepository.findAll();
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get data successfully").status(HttpStatus.OK).content(users).build();
    }

    public ResponseObject getAllRole() {
        return ResponseObject.builder().status(HttpStatus.OK).content(Role.values()).build();
    }

    public ResponseObject getUserByRole(String role, int page, int size) {
        if(Objects.equals(role, "All"))
            return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findAll(PageRequest.of(page, size))).build();
        return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findByRole(role, PageRequest.of(page, size))).build();
    }

    public ResponseObject getUserByEmail(String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Username not found").build();
        }
        var userDTO = getUserDTOFromUser(user);
        return ResponseObject.builder().status(HttpStatus.OK).content(userDTO).mess("Successfully").build();
    }

    private void saveUser(RegisterRequest request) {
        User user = User.builder()
                .email(request.getEmail())
                .password(passwordEncoder.encode(request.getPassword()))
                .firstName(request.getFirstName())
                .lastName(request.getLastName())
                .role(Role.USER)
                .build();
        userRepository.save(user);
    }


    public boolean isUsedEmail(String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        return user != null;
    }

    public boolean isValidPhoneNumber(String phoneNumber) {
        var user = userRepository.findByPhoneNumber(phoneNumber).orElse(null);
        if(user == null) return false;
        return true;
    }
    public String getVerifyCode() {
        SecureRandom random = new SecureRandom();
        StringBuilder code = new StringBuilder();
        String characters = "1234567890";
        for(int i = 0; i < 6; i++) {
            code.append(characters.charAt(random.nextInt(characters.length())));
        }
        return code.toString();
    }

    public boolean isValidCode(MailRequest request) {
        User user = findUserByEmail(request.getEmail());
        if(user == null || user.getCode().isEmpty()) return false;
            return user.getCode().get(request.getCode()).isAfter(LocalDateTime.now());
    }

    public ResponseObject resetPassword(ResetPasswordRequest request) {
        var user = findUserByEmail(request.getEmail());
        if(user == null) return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Reset password failed").build();
        ;
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user = userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Reset password successfully").content(user).build();
    }

    public ResponseObject adminUpdatePasswordForUser(PasswordDTO passwordDTO, String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().mess("User not found").status(HttpStatus.BAD_REQUEST).build();
        }
        user.setPassword(passwordEncoder.encode(passwordDTO.getNewPassword()));
        user = userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update password for user successfully").content(user).build();
    }

    public User findUserByEmail(String email) {
        return userRepository.findByEmail(email).orElse(null);
    }

    public boolean saveCode(MailRequest request, String code) {
        User user = userRepository.findByEmail(request.getEmail()).orElse(null);
        if(user == null) return false;
        Map<String, LocalDateTime> token = new HashMap<String, LocalDateTime>();
        token.put(code, LocalDateTime.now().plus(48, ChronoUnit.HOURS));
        user.setCode(token);
        userRepository.save(user);
        return true;
    }
    public boolean saveCode(OtpVerifyRequest request, String code) {
        User user = userRepository.findByPhoneNumber(request.getPhoneNumber()).orElse(null);
        if(user == null) return false;
        Map<String, LocalDateTime> token = new HashMap<String, LocalDateTime>();
        token.put(code, LocalDateTime.now().plus(48, ChronoUnit.HOURS));
        user.setCode(token);
        userRepository.save(user);
        return true;
    }

    public ResponseObject getUserByToken(String token) {
        String userName;
        try {
            userName = jwtService.extractUserName(token);
        }
        catch (Exception e) {
            System.out.println("getUserByToken: " + e.getMessage());
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Username not found").build();
        }
        var user = userRepository.findByEmail(userName).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Username not found").build();
        }
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get user data successfully").build();
    }

    public ResponseObject updateProfile(UserDTO userDTO, MultipartFile avatar) {
        var user = userRepository.findByEmail(userDTO.getEmail()).orElse(null);
        if (user == null) {
            return ResponseObject.builder()
                    .status(HttpStatus.BAD_REQUEST)
                    .mess("User not found")
                    .build();
        }

        // Update user fields
        user.setFirstName(userDTO.getFirstName());
        user.setLastName(userDTO.getLastName());

        if (avatar != null && !avatar.isEmpty()) {
            try {
                // Upload avatar to Cloudinary
                String avatarUrl = cloudService.uploadImage(avatar.getBytes());
                if (avatarUrl != null) {
                    user.setAvatar(avatarUrl);
                } else {
                    return ResponseObject.builder()
                            .status(HttpStatus.INTERNAL_SERVER_ERROR)
                            .mess("Failed to upload avatar")
                            .build();
                }
            } catch (IOException e) {
                System.out.println("Error uploading avatar: " + e.getMessage());
                return ResponseObject.builder()
                        .status(HttpStatus.INTERNAL_SERVER_ERROR)
                        .mess("Error occurred when updating profile")
                        .build();
            }
        }

        userRepository.save(user);
        return ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Update successfully")
                .content(user)
                .build();
    }


    public ResponseObject updatePassword(PasswordDTO passwordDTO) {
        var user = userRepository.findByEmail(passwordDTO.getEmail()).orElse(null);
        if(user == null) {
            return ResponseObject.builder().mess("User not found").status(HttpStatus.BAD_REQUEST).build();
        }
        if(!passwordEncoder.matches( passwordDTO.getOldPassword(), user.getPassword())) {
            return ResponseObject.builder().mess("Old password not correct").status(HttpStatus.BAD_REQUEST).build();
        }
        user.setPassword(passwordEncoder.encode(passwordDTO.getNewPassword()));
        userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update password successfully").build();
    }

    public ResponseObject enrollCourse(EnrollDTO enrollDTO) {

        var user = userRepository.findByEmail(enrollDTO.getEmail()).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }

        Optional<Progress> existingProgress = progressRepository.findByCourse_IdAndUser(enrollDTO.getCourseId(), user);
        if (existingProgress.isPresent()) {
            return ResponseObject.builder()
                    .status(HttpStatus.OK)
                    .mess("Continue studying")
                    .content(existingProgress.get())
                    .build();
        }


        var course = courseRepository.findById(enrollDTO.getCourseId()).orElse(null);
        if (course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course not found").build();
        }

        Progress progress = Progress.builder()
                .course(course)
                .user(user)
                .lessonIds(enrollDTO.getLessonIds())
                .build();
        progressRepository.save(progress);

        return ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Enroll course successfully")
                .content(progress)
                .build();
    }


    public ResponseObject getPayment(String method, int courseId, String email) {
        var course = courseRepository.findById(courseId).orElse(null);
        if(course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course not found").build();
        }
        if(!Objects.equals(method,"vnpay")) return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Just VNPAY method").build();
        long amount = course.getPrice() * 100L;

        String vnp_Version = "2.1.0";
        String vnp_Command = "pay";
        String orderType = "other";
        String bankCode = "NCB";

        String vnp_TxnRef = ConfigVNPAY.getRandomNumber(8);
        String vnp_IpAddr = "127.0.0.1";

        String vnp_TmnCode = ConfigVNPAY.vnp_TmnCode;

        Map<String, String> vnp_Params = new HashMap<>();
        vnp_Params.put("vnp_Version", vnp_Version);
        vnp_Params.put("vnp_Command", vnp_Command);
        vnp_Params.put("vnp_TmnCode", vnp_TmnCode);
        vnp_Params.put("vnp_Amount", String.valueOf(amount));
        vnp_Params.put("vnp_CurrCode", "VND");

        vnp_Params.put("vnp_BankCode", bankCode);
        vnp_Params.put("vnp_TxnRef", vnp_TxnRef);
        vnp_Params.put("vnp_OrderInfo", "Pay for the course:" + vnp_TxnRef);
        vnp_Params.put("vnp_OrderType", orderType);

        vnp_Params.put("vnp_Locale", "vn");
        vnp_Params.put("vnp_ReturnUrl", ConfigVNPAY.vnp_ReturnUrl + "/" + email + "/" + courseId);
        vnp_Params.put("vnp_IpAddr", vnp_IpAddr);

        Calendar cld = Calendar.getInstance(TimeZone.getTimeZone("Etc/GMT+7"));
        SimpleDateFormat formatter = new SimpleDateFormat("yyyyMMddHHmmss");
        String vnp_CreateDate = formatter.format(cld.getTime());
        vnp_Params.put("vnp_CreateDate", vnp_CreateDate);

        cld.add(Calendar.MINUTE, 15);
        String vnp_ExpireDate = formatter.format(cld.getTime());
        vnp_Params.put("vnp_ExpireDate", vnp_ExpireDate);

        List fieldNames = new ArrayList(vnp_Params.keySet());
        Collections.sort(fieldNames);
        StringBuilder hashData = new StringBuilder();
        StringBuilder query = new StringBuilder();
        Iterator itr = fieldNames.iterator();
        while (itr.hasNext()) {
            String fieldName = (String) itr.next();
            String fieldValue = (String) vnp_Params.get(fieldName);
            if ((fieldValue != null) && (fieldValue.length() > 0)) {
                //Build hash data
             try {
                 hashData.append(fieldName);
                 hashData.append('=');
                 hashData.append(URLEncoder.encode(fieldValue, StandardCharsets.US_ASCII.toString()));
                 //Build query
                 query.append(URLEncoder.encode(fieldName, StandardCharsets.US_ASCII.toString()));
                 query.append('=');
                 query.append(URLEncoder.encode(fieldValue, StandardCharsets.US_ASCII.toString()));
             }
             catch (Exception ex) {
                 System.out.println("getPayment: " + ex.getMessage());
                 log.info("Error while get payment" + ex.getMessage());
                 return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Error while get payment").build();
             }
                if (itr.hasNext()) {
                    query.append('&');
                    hashData.append('&');
                }
            }
        }
        String queryUrl = query.toString();
        String vnp_SecureHash = ConfigVNPAY.hmacSHA512(ConfigVNPAY.secretKey, hashData.toString());
        queryUrl += "&vnp_SecureHash=" + vnp_SecureHash;
        String paymentUrl = ConfigVNPAY.vnp_PayUrl + "?" + queryUrl;
        return ResponseObject.builder().status(HttpStatus.OK).content(paymentUrl).build();
    }


    public ResponseObject unLockCourse(String email, int courseId, MethodPayment method) {
        var user = userRepository.findByEmail(email).orElse(null);
        var course = courseRepository.findById(courseId).orElse(null);
        if(user == null || course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User or Course not found").build();
        }
        Progress progress = Progress.builder()
                .user(user)
                .course(course)
                .build();
        user.getProgresses().add(progress);
        progressRepository.save(progress);
        return ResponseObject.builder().status(HttpStatus.OK).content("Enroll course successfully").build();
    }

    public ResponseObject getAllCourseByEmail(String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        List<ProgressDTO> progresses = progressRepository.findAllDTOByUserEmail(email);

        return ResponseObject.builder().status(HttpStatus.OK).content(progresses).build();
    }
}

================
File: src/main/java/com/example/demo/auth/OtpVerifyRequest.java
================
package com.example.demo.auth;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class OtpVerifyRequest {
    private String phoneNumber;
    private String otp;
}

================
File: src/main/java/com/example/demo/auth/RegisterRequest.java
================
package com.example.demo.auth;

import com.example.demo.entity.user.Role;
import lombok.*;
import org.springframework.stereotype.Component;

@Component
@NoArgsConstructor
@AllArgsConstructor
@Data
@Builder
public class RegisterRequest {
    private String email;
    private String password;
    private String firstName;
    private String lastName;
    private Role role;
}

================
File: src/main/java/com/example/demo/auth/ResetPasswordRequest.java
================
package com.example.demo.auth;

import lombok.Data;
import lombok.NoArgsConstructor;

@NoArgsConstructor
@Data
public class ResetPasswordRequest {
    private String email;
    private String password;
}

================
File: src/main/java/com/example/demo/cloudinary/CloudService.java
================
package com.example.demo.cloudinary;

import com.cloudinary.Cloudinary;
import com.cloudinary.EagerTransformation;
import com.cloudinary.utils.ObjectUtils;
import com.example.demo.entity.data.Course;
import lombok.RequiredArgsConstructor;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class CloudService {
    private final Cloudinary cloud;

    public String uploadImage(byte[] file)  {
        try {
            Map map = cloud.uploader().upload(file, ObjectUtils.asMap("resource_type", "auto", "folder", "dacs"));
            if(map != null) {
                return (map.get("secure_url").toString());
            }
        }
        catch (Exception e) {
            System.out.println("getLinkCloud: " + e.getMessage());
            return null;
        }
        return null;
    }

    public List<String> uploadVideos(List<MultipartFile> filesData){
        List<String> secureUrls = new ArrayList<>();
        for (var fileData : filesData) {
           try {
               Map map = cloud.uploader().upload(fileData.getBytes(),
                       ObjectUtils.asMap("resource_type", "video",
                               "folder", "dacs",
                               "eager", Arrays.asList(
                                       new EagerTransformation().width(300).height(300).crop("pad").audioCodec("none"),
                                       new EagerTransformation().width(160).height(100).crop("crop").gravity("south").audioCodec("none")),
                               "eager_async", true));
//                            "eager_notification_url", "https://mysite.example.com/notify_endpoint"));
               secureUrls.add(map.get("secure_url").toString());
           } catch (Exception e) {
               System.out.println("Upload videos: " + e.getMessage());
           }
        }
        return secureUrls;
    }

    public String uploadVideo(byte[] video) {
        try {
            Map map = cloud.uploader().upload(video,
                    ObjectUtils.asMap("resource_type", "video",
                            "folder", "dacs",
                            "eager", Arrays.asList(
                                    new EagerTransformation().width(300).height(300).crop("pad").audioCodec("none"),
                                    new EagerTransformation().width(160).height(100).crop("crop").gravity("south").audioCodec("none")),
                            "eager_async", true));
//                            "eager_notification_url", "https://mysite.example.com/notify_endpoint"));

        }
        catch (Exception e) {
            System.out.println("Cloud upload video: " + e.getMessage());
        }
        return null;
    }

    @Async("asyncExecutor")
    public void saveImageToCourse(byte[] file, Course course) throws IOException {
        try {
            Map map = cloud.uploader().upload(file, ObjectUtils.asMap("resource_type", "auto", "folder", "dacs"));
            if(map != null) {
                course.setThumbnail(map.get("secure_url").toString());
            }
        }
        catch (Exception e) {
            System.out.println("saveImageToCourse: " + e.getMessage());
        }
    }
}

================
File: src/main/java/com/example/demo/config/AppConfig.java
================
package com.example.demo.config;

import com.cloudinary.Cloudinary;
import com.cloudinary.utils.ObjectUtils;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.util.concurrent.Executor;

@Configuration
@RequiredArgsConstructor
@EnableAsync
public class AppConfig {
    private final UserRepository userRepository;
    @Value("${cloudinary.cloud-name}")
    private String cloudName;
    @Value("${cloudinary.api-key}")
    private String apiKey;
    @Value("${cloudinary.api-secret}")
    private String apiSecret;



    @Bean(name = "asyncExecutor")
    public Executor asyncExecutor() {
            ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setThreadNamePrefix("Async-");
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.initialize();
        return executor;
    }

    @Bean
    public Executor getAsyncTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("Async-");
        executor.initialize();
        return executor;
    }
    @Bean
    public DaoAuthenticationProvider daoAuthenticationProvider() {
        DaoAuthenticationProvider daoAuthenticationProvider = new DaoAuthenticationProvider();
        daoAuthenticationProvider.setUserDetailsService(userDetailsService());
        daoAuthenticationProvider.setPasswordEncoder(passwordEncoder());
        return daoAuthenticationProvider;
    }

    @Bean
    public Cloudinary cloudinary() {
        return new Cloudinary(ObjectUtils.asMap(
                "cloud_name", cloudName,
                "api_key", apiKey,
            "api_secret", apiSecret,
            "secure", true
        ));
    }

    @Bean
    public UserDetailsService userDetailsService() {
        return username -> {
            return userRepository.findByEmail(username).orElseThrow(() -> new UsernameNotFoundException("Username not found"));
        };
    }
    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration configuration) throws Exception {
        return configuration.getAuthenticationManager();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}

================
File: src/main/java/com/example/demo/config/ConfigVNPAY.java
================
package com.example.demo.config;

import jakarta.servlet.http.HttpServletRequest;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.io.UnsupportedEncodingException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.*;

public class ConfigVNPAY {
    public static String vnp_PayUrl = "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html";
    public static String vnp_ApiUrl = "https://sandbox.vnpayment.vn/merchant_webapi/api/transaction";
    public static String vnp_ReturnUrl = "http://localhost:8080/api/v1/me/payment/process";
    public static String vnp_TmnCode = "0DTWWU8C";
    public static String secretKey = "P27TDIC7WKMEP85LJN1ZLIMW146I3TEG";


    public static String md5(String message) {
        String digest = null;
        try {
            MessageDigest md = MessageDigest.getInstance("MD5");
            byte[] hash = md.digest(message.getBytes("UTF-8"));
            StringBuilder sb = new StringBuilder(2 * hash.length);
            for (byte b : hash) {
                sb.append(String.format("%02x", b & 0xff));
            }
            digest = sb.toString();
        } catch (UnsupportedEncodingException ex) {
            digest = "";
        } catch (NoSuchAlgorithmException ex) {
            digest = "";
        }
        return digest;
    }

    public static String Sha256(String message) {
        String digest = null;
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            byte[] hash = md.digest(message.getBytes("UTF-8"));
            StringBuilder sb = new StringBuilder(2 * hash.length);
            for (byte b : hash) {
                sb.append(String.format("%02x", b & 0xff));
            }
            digest = sb.toString();
        } catch (UnsupportedEncodingException ex) {
            digest = "";
        } catch (NoSuchAlgorithmException ex) {
            digest = "";
        }
        return digest;
    }

    //Util for VNPAY
    public static String hashAllFields(Map fields) {
        List fieldNames = new ArrayList(fields.keySet());
        Collections.sort(fieldNames);
        StringBuilder sb = new StringBuilder();
        Iterator itr = fieldNames.iterator();
        while (itr.hasNext()) {
            String fieldName = (String) itr.next();
            String fieldValue = (String) fields.get(fieldName);
            if ((fieldValue != null) && (fieldValue.length() > 0)) {
                sb.append(fieldName);
                sb.append("=");
                sb.append(fieldValue);
            }
            if (itr.hasNext()) {
                sb.append("&");
            }
        }
        return hmacSHA512(secretKey,sb.toString());
    }

    public static String hmacSHA512(final String key, final String data) {
        try {

            if (key == null || data == null) {
                throw new NullPointerException();
            }
            final Mac hmac512 = Mac.getInstance("HmacSHA512");
            byte[] hmacKeyBytes = key.getBytes();
            final SecretKeySpec secretKey = new SecretKeySpec(hmacKeyBytes, "HmacSHA512");
            hmac512.init(secretKey);
            byte[] dataBytes = data.getBytes(StandardCharsets.UTF_8);
            byte[] result = hmac512.doFinal(dataBytes);
            StringBuilder sb = new StringBuilder(2 * result.length);
            for (byte b : result) {
                sb.append(String.format("%02x", b & 0xff));
            }
            return sb.toString();

        } catch (Exception ex) {
            return "";
        }
    }

    public static String getIpAddress(HttpServletRequest request) {
        String ipAdress;
        try {
            ipAdress = request.getHeader("X-FORWARDED-FOR");
            if (ipAdress == null) {
                ipAdress = request.getRemoteAddr();
            }
        } catch (Exception e) {
            ipAdress = "Invalid IP:" + e.getMessage();
        }
        return ipAdress;
    }

    public static String getRandomNumber(int len) {
        Random rnd = new Random();
        String chars = "0123456789";
        StringBuilder sb = new StringBuilder(len);
        for (int i = 0; i < len; i++) {
            sb.append(chars.charAt(rnd.nextInt(chars.length())));
        }
        return sb.toString();
    }
}

================
File: src/main/java/com/example/demo/config/CorsConfig.java
================
package com.example.demo.config;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("http://localhost:3000")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}

================
File: src/main/java/com/example/demo/config/CorsFilter.java
================
//package com.example.demo.config;
//
//import jakarta.servlet.FilterChain;
//import jakarta.servlet.ServletException;
//import jakarta.servlet.http.HttpServletRequest;
//import jakarta.servlet.http.HttpServletResponse;
//import org.springframework.stereotype.Component;
//import org.springframework.web.filter.OncePerRequestFilter;
//
//import java.io.IOException;
//@Component
//public class CorsFilter extends OncePerRequestFilter {
//    @Override
//    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
//        response.setHeader("Access-Control-Allow-Origin", "http://localhost:3000");
//        response.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
//        response.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
//        filterChain.doFilter(request, response);
//    }
//}

================
File: src/main/java/com/example/demo/config/MethodSecurityConfig.java
================
package com.example.demo.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.method.configuration.GlobalMethodSecurityConfiguration;

@EnableGlobalMethodSecurity(prePostEnabled = true)
@Configuration
public class MethodSecurityConfig extends GlobalMethodSecurityConfiguration {
}

================
File: src/main/java/com/example/demo/config/ModelMapperConfig.java
================
package com.example.demo.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
@Configuration
public class ModelMapperConfig {

    @Bean
    public ModelMapper modelMapper() {
        return new ModelMapper();
    }
}

================
File: src/main/java/com/example/demo/config/RestAuthenticationEntryPoint.java
================
package com.example.demo.config;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class RestAuthenticationEntryPoint implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
    }
}

================
File: src/main/java/com/example/demo/config/SecurityConfig.java
================
package com.example.demo.config;

import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.user.Role;
import static com.example.demo.entity.user.Permission.*;
import com.example.demo.handler.LogoutHandler;
import com.example.demo.handler.Oauth2SuccessHandler;
import com.example.demo.jwt.JwtFilter;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;


@Configuration
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtFilter jwtFilter;
    private final LogoutHandler logoutHandler;
    private final RestAuthenticationEntryPoint restAuthenticationEntryPoint;

    @Bean
    public AccessDeniedHandler accessDeniedHandler () {
        return (request, response, accessDeniedException) -> {
            response.setStatus(HttpServletResponse.SC_FORBIDDEN);
            ResponseObject res = ResponseObject.builder().status(HttpStatus.FORBIDDEN).mess("You don't have permission!").build();
            ObjectMapper mapper = new ObjectMapper();
            response.getWriter().write(mapper.writeValueAsString(res));
            response.getWriter().flush();
        };
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity
//                .cors(AbstractHttpConfigurer::disable) vô hiệu hóa cấu hình mặc định và cấu hình CORS riêng
                 .csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers(
                                "/api/v1/public/**", "/ws/**").permitAll()
                        .requestMatchers("/api/v1/user/**").hasAnyRole(Role.USER.name(), Role.ADMIN.name(), Role.MANAGER.name())

                        .requestMatchers(HttpMethod.GET, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers(HttpMethod.POST, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers(HttpMethod.PUT, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers(HttpMethod.DELETE, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers("/api/v1/instructor/**").hasRole(Role.INSTRUCTOR.name())
                        .anyRequest()
                        .permitAll()
                )
                .logout(logout -> logout.logoutUrl("/api/v1/me/logout")
                        .addLogoutHandler(logoutHandler)
                        .logoutSuccessHandler(((request, response, authentication) -> {
                            SecurityContextHolder.clearContext();
                            response.setStatus(HttpServletResponse.SC_OK);
                        }))
                )
//                .authenticationProvider(authenticationProvider)
                .exceptionHandling(exception -> exception.authenticationEntryPoint(restAuthenticationEntryPoint))
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)
//                .exceptionHandling(exception -> exception.accessDeniedHandler(accessDeniedHandler()))
                .build();
    }
}

================
File: src/main/java/com/example/demo/config/StompPrincipal.java
================
package com.example.demo.config;

import java.security.Principal;

public class StompPrincipal implements Principal {
    private String name;

    public StompPrincipal(String name) {
        this.name = name;
    }

    @Override
    public String getName() {
        return name;
    }
}

================
File: src/main/java/com/example/demo/config/UserInterceptor.java
================
package com.example.demo.config;

import org.springframework.messaging.Message;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.simp.stomp.StompHeaderAccessor;
import org.springframework.messaging.support.ChannelInterceptor;
import org.springframework.messaging.simp.stomp.StompCommand; // Import StompCommand

public class UserInterceptor implements ChannelInterceptor {
    @Override
    public Message<?> preSend(Message<?> message, MessageChannel channel) {

        StompHeaderAccessor accessor = StompHeaderAccessor.wrap(message);

        if (StompCommand.CONNECT.equals(accessor.getCommand())) {
            // Get the user ID from the headers
            String userId = accessor.getFirstNativeHeader("userId");
            if (userId != null) {
                // Set the principal with the user ID
                accessor.setUser(new StompPrincipal(userId));
            }
        }

        return message;
    }
}

================
File: src/main/java/com/example/demo/config/WebSocketConfig.java
================
package com.example.demo.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.Message;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.simp.config.*;
import org.springframework.messaging.simp.stomp.StompCommand;
import org.springframework.messaging.simp.stomp.StompHeaderAccessor;
import org.springframework.messaging.support.*;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.web.socket.config.annotation.*;

import java.util.Collections;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureClientInboundChannel(ChannelRegistration registration) {
        registration.interceptors(new UserInterceptor());

        registration.interceptors(new ChannelInterceptor() {
            @Override
            public Message<?> preSend(Message<?> message, MessageChannel channel) {

                StompHeaderAccessor accessor =
                        MessageHeaderAccessor.getAccessor(message, StompHeaderAccessor.class);

                if (accessor != null && StompCommand.CONNECT.equals(accessor.getCommand())) {
                    String userId = accessor.getFirstNativeHeader("userId");
                    if (userId != null) {
                        Authentication auth = new UsernamePasswordAuthenticationToken(
                                userId, null, Collections.emptyList());
                        accessor.setUser(auth);
                    }
                }
                return message;
            }
        });
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.setApplicationDestinationPrefixes("/app")
            .enableSimpleBroker("/comment", "/user", "/topic", "/queue");
        config.setUserDestinationPrefix("/user");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")
                .setAllowedOriginPatterns("*")
                .withSockJS();
    }
}

================
File: src/main/java/com/example/demo/config/WebSocketSecurityConfig.java
================
package com.example.demo.config;

import org.springframework.security.config.annotation.web.messaging.MessageSecurityMetadataSourceRegistry;
import org.springframework.security.config.annotation.web.socket.AbstractSecurityWebSocketMessageBrokerConfigurer;

public class WebSocketSecurityConfig extends AbstractSecurityWebSocketMessageBrokerConfigurer {
    @Override
    protected boolean sameOriginDisabled() {
        return true; // Adjust based on your CSRF policy
    }

    @Override
    protected void configureInbound(MessageSecurityMetadataSourceRegistry messages) {
        messages
                .simpDestMatchers("/app/**").authenticated()
                .simpSubscribeDestMatchers("/user/**").authenticated()
                .anyMessage().denyAll();
    }
}

================
File: src/main/java/com/example/demo/controller/PrivateController/CategoryController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Category;
import com.example.demo.service.CategoryService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/private/category")
@RequiredArgsConstructor
public class CategoryController {
    private final CategoryService categoryService;

    @GetMapping("/getAllDeleted")
    public ResponseEntity<ResponseObject> getAllDeleted(@RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = categoryService.getAllCategoryDeleted(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/{id}")
    public ResponseEntity<ResponseObject> update(@PathVariable int id, @RequestBody Category category) {
        var result = categoryService.updateCategoryById(id, category);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/create")
    public ResponseEntity<ResponseObject> create(@RequestBody String name) {
        var result = categoryService.createCategory(name);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/delete/soft/{id}")
    public ResponseEntity<ResponseObject> softDelete(@PathVariable int id) {
        var result = categoryService.softDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/restore/{id}")
    public ResponseEntity<ResponseObject> restore(@PathVariable int id) {
        var result = categoryService.restoreCategoryById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @DeleteMapping("/delete/hard/{id}")
    public ResponseEntity<ResponseObject> hardDelete(@PathVariable int id) {
        var result = categoryService.hardDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
}

================
File: src/main/java/com/example/demo/controller/PrivateController/CourseController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.auth.AuthService;
import com.example.demo.dto.CourseDTO;
import com.example.demo.dto.EnrollDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.exception.CourseNotFoundException;
import com.example.demo.exception.UserNotFoundException;
import com.example.demo.service.CourseService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
@RestController
@RequestMapping("/api/v1/private/course")
@RequiredArgsConstructor
public class CourseController {
    private final CourseService courseService;
    private final AuthService authService;
    @GetMapping("")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> getCourseByCourseTitle(@RequestParam("title") String title,
                                                                 @RequestParam(defaultValue = "0") int page,
                                                                 @RequestParam(defaultValue = "5") int size
            , @RequestParam(defaultValue = "false") boolean isDeleted) {
        var result = courseService.getAllCourseByCourseTitle(title, isDeleted, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/create")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> create(@RequestPart CourseDTO course
          ) {
        System.out.println(course);
        var result = courseService.addCourse(course);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @PostMapping("/enroll")
    public ResponseEntity<ResponseObject> enrollCourse(@RequestBody EnrollDTO enrollDTO) {
        ResponseObject response = authService.enrollCourse(enrollDTO);
        return new ResponseEntity<>(response, response.getStatus());
    }


    @GetMapping("/{courseId}/is-enrolled")
    public ResponseEntity<Boolean> checkEnrollment(
            @PathVariable int courseId,
            @RequestParam int userId) {

        boolean isEnrolled = courseService.isUserEnrolled(courseId, userId);
        return ResponseEntity.ok(isEnrolled);
    }


    @PutMapping("/edit/{id}")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> updateCourse(@PathVariable int id
            , @RequestPart CourseDTO course
          )  {

        var result = courseService.updateCourse(id, course);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/restore/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> restoreCourse(@PathVariable int id) {
        var result = courseService.restoreCourseById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @PutMapping("/delete/soft/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> softDelete(@PathVariable int id) {
        var result = courseService.softDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @DeleteMapping("/delete/hard/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> hardDelete(@PathVariable int id) {
        var result = courseService.hardDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/deleted/category")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> getCourseDeletedByCategoryId(@RequestParam("id") int id, @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourseDeletedByCategoryId(id, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/getAllDeleted")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> getAllDeleted(@RequestParam(defaultValue = "0") int page,
                                                        @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourseDeleted(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/getAll")
    public ResponseEntity<ResponseObject> getAll(@RequestParam(defaultValue = "0") int page,
                                                        @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourse(page, size);
        System.out.println("Result"+result);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

}

================
File: src/main/java/com/example/demo/controller/PrivateController/DashboardController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.UserEssayDTO;
import com.example.demo.entity.data.Comment;
import com.example.demo.entity.data.UserEssay;
import com.example.demo.service.CommentService;
import com.example.demo.service.DashboardService;
import com.example.demo.service.WritingService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/private/dashboard")
public class DashboardController {
    private final CommentService commentService;
    private final DashboardService dashboardService;
    private final WritingService writingService;

    public DashboardController(CommentService commentService, DashboardService dashboardService, WritingService writingService) {
        this.commentService = commentService;
        this.dashboardService = dashboardService;
        this.writingService = writingService;
    }

    @GetMapping("/essays/statistics")
    public ResponseEntity<Map<String, Object>> getEssayStatistics() {
        long totalEssayCount = writingService.getTotalEssayCount();
        Double averageScore = writingService.getAverageEssayScore();

        Map<String, Object> response = new HashMap<>();
        response.put("totalEssayCount", totalEssayCount);
        response.put("averageScore", averageScore);

        return ResponseEntity.ok(response);
    }

    @GetMapping("/essays")
    public ResponseEntity<List<UserEssayDTO>> getAllEssays() {
        List<UserEssayDTO> essays = writingService.getAllEssaysWithUserNames();
        return ResponseEntity.ok(essays);
    }

    @GetMapping("/comments")
    public ResponseEntity<?> getRecentComments(@RequestParam(defaultValue = "10") int limit) {
        List<Comment> recentComments = commentService.getRecentComments(limit);
        List<Map<String, Object>> response = recentComments.stream().map(comment -> {
            Map<String, Object> map = new HashMap<>();
            map.put("id", comment.getId());
            map.put("content", comment.getContent());
            map.put("userEmail", comment.getUserEmail());
            map.put("userName", comment.getUserName());
            map.put("avatar", comment.getAvatar());
            map.put("date", comment.getDate());
            map.put("lessonId", comment.getLesson() != null ? comment.getLesson().getId() : null);
            map.put("replyToUser", comment.getReplyToUser());
            map.put("replyToUserName", comment.getReplyToUserName());
            return map;
        }).collect(Collectors.toList());
        return ResponseEntity.ok(response);
    }
    @GetMapping("/stats")
    public ResponseEntity<?> getDashboardStats() {
        Map<String, Integer> stats = dashboardService.getDashboardStats();
        return ResponseEntity.ok(stats);
    }

}

================
File: src/main/java/com/example/demo/controller/PrivateController/FlashcardController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.entity.data.FlashcardSet;
import com.example.demo.service.FlashcardService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/private/flashcards")
public class FlashcardController {

    @Autowired
    private FlashcardService flashcardService;

    @GetMapping("/user/{userId}")
    public ResponseEntity<List<FlashcardSet>> getFlashcardSetsByUser(@PathVariable Integer userId){
        return ResponseEntity.ok(flashcardService.getFlashcardSetsByUserId(userId));
    }

    @PostMapping("/create")
    public ResponseEntity<FlashcardSet> createFlashcardSet(@RequestParam Integer userId,
                                                           @RequestParam String title,
                                                           @RequestParam String description,
                                                           @RequestBody List<Integer> vocabularyIds){
        return ResponseEntity.ok(flashcardService.createFlashcardSet(userId, title, description, vocabularyIds));
    }

    // Thêm các endpoint khác như update, delete nếu cần
}

================
File: src/main/java/com/example/demo/controller/PrivateController/InstructorController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.UserDTO;
import com.example.demo.entity.user.User;
import com.example.demo.service.ChatService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/private/instructor")
@RequiredArgsConstructor
public class InstructorController {
    private final ChatService chatService;

    @GetMapping("/{userId}")
    public ResponseEntity<List<UserDTO>> getInstructorsForUser(@PathVariable Integer userId) {
        // Directly return the list of UserDTOs from the service
        List<UserDTO> instructors = chatService.getInstructorsForUserCourses(userId);
        return ResponseEntity.ok(instructors);
    }
}

================
File: src/main/java/com/example/demo/controller/PrivateController/InvoiceController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.service.InvoiceService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/private/invoice")

public class InvoiceController {

    @Autowired
    private InvoiceService invoiceService;

    @GetMapping("/getAll")
    public ResponseEntity<ResponseObject> getAll(@RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size){
        var result = invoiceService.getAll(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @GetMapping("/getAllDeleted")
    public ResponseEntity<ResponseObject> getAllDeleted(@RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size){
        var result = invoiceService.getAllDelete(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/getByDate")
    public ResponseEntity<ResponseObject> searchByDate(@RequestParam String start, @RequestParam String end, @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size){
        var result = invoiceService.getByDateRange(start, end, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/search")
    public ResponseEntity<ResponseObject> search(@RequestParam String name, @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size){
        var result = invoiceService.searchByName(name, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("delete/soft/{id}")
    public ResponseEntity<ResponseObject> delete(@PathVariable int id){
        var result = invoiceService.softDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @PutMapping("restore/{id}")
    public ResponseEntity<ResponseObject> restore(@PathVariable int id){
        var result = invoiceService.restoreInvoice(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
}

================
File: src/main/java/com/example/demo/controller/PrivateController/LessonController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.LessonProgressDTO;
import com.example.demo.entity.data.LessonProgress;
import com.example.demo.service.LessonProgressService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/private/lesson")
@RequiredArgsConstructor
public class LessonController {
    @Autowired
    private LessonProgressService lessonProgressService;

    @PostMapping("/progress")
    public ResponseEntity<?> updateProgress(@RequestBody LessonProgressDTO lessonProgressDTO) {
        lessonProgressService.updateProgress(
                lessonProgressDTO.getUserId(),
                lessonProgressDTO.getLessonId(),
                lessonProgressDTO.getProgressPercentage()
        );
        return ResponseEntity.ok().build();
    }

    @GetMapping("/course/{courseId}/progress/{userId}")
    public ResponseEntity<List<LessonProgressDTO>> getUserProgress(
            @PathVariable int courseId,
            @PathVariable int userId
    ) {
        List<LessonProgress> progressList = lessonProgressService.getUserProgressForCourse(userId, courseId);
        List<LessonProgressDTO> dtoList = progressList.stream().map(lp -> {
            LessonProgressDTO dto = new LessonProgressDTO();
            dto.setUserId(lp.getUser().getId());
            dto.setLessonId(lp.getLesson().getId());
            dto.setProgressPercentage(lp.getProgressPercentage());
            dto.setCompleted(lp.isCompleted());
            dto.setUnlocked(lp.isUnlocked());
            return dto;
        }).collect(Collectors.toList());
        return ResponseEntity.ok(dtoList);
    }
}

================
File: src/main/java/com/example/demo/controller/PrivateController/MeController.java
================
package com.example.demo.controller.PrivateController;


import com.example.demo.auth.AuthService;
import com.example.demo.dto.*;
import com.example.demo.entity.data.MethodPayment;
import com.twilio.http.Response;
import jakarta.servlet.http.HttpServletResponse;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.util.List;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/me")
public class MeController {
    private final AuthService authService;

    @GetMapping("/")
    public String greeting() {
        return "Hello me";
    }

    @PostMapping("/post/create")
    public ResponseEntity<ResponseObject> createPost(@RequestBody PostDTO post) {
        var result = authService.savePost(post);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @DeleteMapping("/{email}/comment/delete/{id}")
    public ResponseEntity<ResponseObject> DeleteComment(@PathVariable String email, @PathVariable int id) {
        var result = authService.deleteCommentById(email, id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/course/getAll/{email}")
    public ResponseEntity<ResponseObject> getAllCourse(@PathVariable String email) {
        var result = authService.getAllCourseByEmail(email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{email}")
    public ResponseEntity<ResponseObject> getUsername(@PathVariable String email) {
        var result = authService.getUserByEmail(email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/update")
    public ResponseEntity<ResponseObject> updateProfile(
            @RequestPart("user") UserDTO userDTO,
            @RequestPart(value = "avatar", required = false) MultipartFile avatar
    ) {
        ResponseObject response = authService.updateProfile(userDTO, avatar);
        return new ResponseEntity<>(response, response.getStatus());
    }


    @PutMapping("/update/password")
    public ResponseEntity<ResponseObject> updatePassword(@RequestBody PasswordDTO passwordDTO) {
        var result = authService.updatePassword(passwordDTO);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/enroll/course")
    public ResponseEntity<ResponseObject> enrollCourse(@RequestBody EnrollDTO enrollDTO) {
        var result = authService.enrollCourse(enrollDTO);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{alias}/progress/{courseId}")
    public ResponseEntity<ResponseObject> getProgress(@PathVariable String alias, @PathVariable int courseId) {
        // Use the authService to check progress and enrollment status
        ResponseObject result = authService.getProgressByCourseId(alias, courseId);

        // Return the appropriate HTTP status and response body
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/{alias}/progress/{courseId}/updateLessonIds")
    public ResponseEntity<ResponseObject> updateLessonIds(@PathVariable String alias, @PathVariable int courseId
            , @RequestBody List<Integer> lessonIds) {
        var result = authService.updateLessonsIds(alias, courseId, lessonIds);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{email}/notification/getAll")
    public ResponseEntity<ResponseObject> getAllNotification(@PathVariable String email) {
        var result = authService.getAllNotificationsByEmail(email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @DeleteMapping("/{email}/notification/removeAll")
    public ResponseEntity<ResponseObject> removeAllNotification(@PathVariable String email) {
        var result = authService.removeAllNotificationsByEmail(email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/{email}/notification/read/{id}")
    public ResponseEntity<ResponseObject> readNotification(@PathVariable String email, @PathVariable int id) {
        var result = authService.readNotification(email, id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/{email}/notification/readAll")
    public ResponseEntity<ResponseObject> readAllNotification(@PathVariable String email) {
        var result = authService.readAllNotification(email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/create_payment/{method}/{email}/{courseId}")
    public ResponseEntity<ResponseObject> getPay(@PathVariable String method, @PathVariable int courseId, @PathVariable String email) throws UnsupportedEncodingException {
        var result = authService.getPayment(method, courseId, email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/payment/process/{email}/{courseId}")
    public void processPayment(@PathVariable String email
            , @PathVariable int courseId
            , @RequestParam("vnp_Amount") String amount
            , @RequestParam("vnp_ResponseCode") String responseCode
            , @RequestParam("vnp_TransactionStatus") String transactionStatus, HttpServletResponse response) throws IOException {

        switch (transactionStatus) {
            case "00" -> {
                var result = authService.unLockCourse(email, courseId, MethodPayment.VNPAY);
                if (result.getStatus() == HttpStatus.BAD_REQUEST) {
                    response.sendRedirect("http://localhost:3000/payment/failure?status=" + transactionStatus + "&email=" + email + "&courseId=" + courseId + "&content=" + result.getContent());
                }
                response.sendRedirect("http://localhost:3000/payment/success?status=" + transactionStatus + "&email=" + email + "&courseId=" + courseId);
            }

            case "01", "02", "04", "05", "06", "07", "09" ->
                    response.sendRedirect("http://localhost:3000/payment/failure?status=" + transactionStatus + "&email=" + email + "&courseId=" + courseId);
        }
    }

}

================
File: src/main/java/com/example/demo/controller/PrivateController/PrivateTestController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.UserResponseDTO;
import com.example.demo.entity.data.TestProgress;
import com.example.demo.service.TestService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/private/tests")
@RequiredArgsConstructor
public class PrivateTestController {

    private final TestService testService;

    @PostMapping("/{testId}/start")
    public ResponseEntity<ResponseObject> startTest(@PathVariable int testId, @RequestParam int userId) {
        TestProgress testProgress = testService.startTest(testId, userId);
        return ResponseEntity.status(HttpStatus.CREATED).body(
                ResponseObject.builder()
                        .status(HttpStatus.CREATED)
                        .mess("Test started")
                        .content(testProgress)
                        .build()
        );
    }

    @PostMapping("/{testProgressId}/submit-responses")
    public ResponseEntity<ResponseObject> submitResponses(
            @PathVariable int testProgressId,
            @RequestBody List<UserResponseDTO> userResponses) {

        testService.submitUserResponses(testProgressId, userResponses);

        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Responses submitted")
                        .build()
        );
    }


    @PostMapping("/{testProgressId}/complete")
    public ResponseEntity<ResponseObject> completeTest(@PathVariable int testProgressId) {
        testService.completeTest(testProgressId);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Test completed")
                        .build()
        );
    }
}

================
File: src/main/java/com/example/demo/controller/PrivateController/PrivateWritingController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.EssayFeedback;
import com.example.demo.dto.EssaySubmissionRequest;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.UserEssay;
import com.example.demo.entity.data.WritingTask;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.UserEssayRepository;
import com.example.demo.repository.data.WritingTaskRepository;
import com.example.demo.service.ExternalEssayEvaluationService;
import com.example.demo.service.WritingService;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/v1/private/writing")
@RequiredArgsConstructor
public class PrivateWritingController {

    private final WritingService writingService;
    private final UserEssayRepository userEssayRepository;
    private final UserRepository userRepository;
    private final WritingTaskRepository writingTaskRepository;
    private final ExternalEssayEvaluationService externalEssayEvaluationService;
    @PostMapping("/submit")
    public ResponseEntity<ResponseObject> submitEssay(@Validated @RequestBody EssaySubmissionRequest request) {
        // Gọi service để xử lý việc gửi bài luận
        UserEssay userEssay = writingService.submitEssay(
                request.getUserId(),
                request.getWritingTaskId(),
                request.getEssayContent()
        );

        // Trả về phản hồi với thông tin bài luận đã được lưu
        return ResponseEntity.status(HttpStatus.CREATED).body(
                ResponseObject.builder()
                        .status(HttpStatus.CREATED)
                        .mess("Essay submitted successfully")
                        .content(userEssay)
                        .build()
        );

    }
    private String convertFeedbackToJson(EssayFeedback feedback) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            return mapper.writeValueAsString(feedback);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Error converting feedback to JSON.");
        }
    }
    @GetMapping("/essays/{userId}")
    public ResponseEntity<List<UserEssay>> getUserEssays(@PathVariable int userId) {
        List<UserEssay> essays = userEssayRepository.findAllByUserId(userId);
        return ResponseEntity.ok(essays);
    }
    @PostMapping("/tasks")
    public ResponseEntity<ResponseObject> createWritingTask(@RequestBody WritingTask writingTask) {
        WritingTask createdTask = writingService.createWritingTask(writingTask);
        return ResponseEntity.status(HttpStatus.CREATED).body(
                ResponseObject.builder()
                        .status(HttpStatus.CREATED)
                        .mess("Writing task created successfully")
                        .content(createdTask)
                        .build()
        );
    }

    @GetMapping("/tasks")
    public ResponseEntity<List<WritingTask>> getAllWritingTasks() {
        List<WritingTask> tasks = writingService.getAllWritingTasks();
        return ResponseEntity.ok(tasks);
    }

    @GetMapping("/tasks/{id}")
    public ResponseEntity<ResponseObject> getWritingTaskById(@PathVariable int id) {
        WritingTask task = writingService.getWritingTaskById(id);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Writing task retrieved successfully")
                        .content(task)
                        .build()
        );
    }

    @PutMapping("/tasks/{id}")
    public ResponseEntity<ResponseObject> updateWritingTask(@PathVariable int id, @RequestBody WritingTask updatedTask) {
        WritingTask task = writingService.updateWritingTask(id, updatedTask);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Writing task updated successfully")
                        .content(task)
                        .build()
        );
    }

    @DeleteMapping("/tasks/{id}")
    public ResponseEntity<ResponseObject> deleteWritingTask(@PathVariable int id) {
        writingService.deleteWritingTask(id);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Writing task deleted successfully")
                        .build()
        );
    }
}

================
File: src/main/java/com/example/demo/controller/PrivateController/StatisticController.java
================
package com.example.demo.controller.PrivateController;


import com.example.demo.service.StatisticsService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.HttpStatusCode;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/private/statistic")
public class StatisticController {
    @Autowired
    private StatisticsService statisticsService;

    @GetMapping("")
    public ResponseEntity<Object> getStatistic(@RequestParam("month") int month, @RequestParam("year") int year, @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size){
        return ResponseEntity.status(HttpStatus.OK).body(statisticsService.getMonthlyStatistics(month, year, page, size));
    }

}

================
File: src/main/java/com/example/demo/controller/PrivateController/UploadController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.service.UploadService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

@RestController
@RequestMapping("/api/v1/public/upload")
public class UploadController {

    @Autowired
    private UploadService uploadService;

    @PostMapping("/img")
    public ResponseEntity<ResponseObject> uploadImg(@RequestPart(name = "file") MultipartFile img) throws IOException {
        var result = uploadService.uploadImg(img.getBytes());
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/video")
    public ResponseEntity<ResponseObject> uploadVideo(@RequestPart(name = "file") MultipartFile video) throws IOException {
        var result = uploadService.uploadVideo(video.getBytes());
        return ResponseEntity.status(result.getStatus()).body(result);
    }



}

================
File: src/main/java/com/example/demo/controller/PrivateController/UserController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.auth.*;
import com.example.demo.dto.PasswordDTO;
import com.example.demo.dto.PostDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.mail.MailRequest;
import com.example.demo.mail.MailService;
import com.example.demo.repository.UserRepository;
import com.example.demo.service.UserService;
import jakarta.mail.MessagingException;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Optional;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/private/user")
public class UserController {
    private final AuthService authService;
    private final MailService mailService;
    private final UserService userService;
    private final UserRepository userRepository; // Or your service layer if you prefer

    @PostMapping("/assign-role")
    public ResponseEntity<?> assignRole(@RequestParam String email, @RequestParam String role) {
        Role newRole = Role.valueOf(role.toUpperCase());
        User updatedUser = authService.assignRoleToUser(email, newRole);
        return ResponseEntity.ok(updatedUser);
    }


    @PutMapping("/resetPassword/{email}")
    public ResponseEntity<ResponseObject> resetPassword(@RequestBody PasswordDTO passwordDTO, @RequestParam String email) {
        var result = authService.adminUpdatePasswordForUser(passwordDTO, email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("")
    public ResponseEntity<ResponseObject> greeting() {
        var res = ResponseObject.builder().status(HttpStatus.OK).mess("Welcome to admin dashboard").build();
        return ResponseEntity.status(res.getStatus()).body(res);
    }

    @GetMapping("/getAll")
    public ResponseEntity<Page<User>> getAllActiveUsers(Pageable pageable) {
        Page<User> activeUsers = userService.getAllActiveUsers(pageable);
        return ResponseEntity.ok(activeUsers);
    }

    //    @GetMapping("/active")
//    public ResponseEntity<List<User>> getAllActiveUsers() {
//        List<User> activeUsers = userService.getAllActiveUsers();
//        return ResponseEntity.ok(activeUsers);
//    }
    @GetMapping("/getAllDeleted")
    public ResponseEntity<ResponseObject> getAllDeleted(@RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = userService.getAllDeletedByPage(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/getAllUserAndRole")
    public ResponseEntity<ResponseObject> getAllRole(@RequestParam(defaultValue = "false") boolean isDeleted) {
        var result = userService.getAllUserAndRole(isDeleted);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/filter")
    public ResponseEntity<ResponseObject> getUserByRole(@RequestParam(value = "role") String role,
                                                        @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = userService.getUserByRole(role, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/search")
    public ResponseEntity<ResponseObject> getUserByName(@RequestParam(value = "name") String name, @RequestParam(defaultValue = "false") boolean isDeleted,
                                                        @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = userService.getUserByName(name, isDeleted, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/login")
    public ResponseEntity<ResponseObject> authenticate(@RequestBody AuthenticationRequest request) {
        var res = authService.authenticate(request);
        return ResponseEntity.status(res.getStatus()).body(res);
    }

    @PostMapping("/register")
    public ResponseEntity<String> register(@RequestBody RegisterRequest request) {
        if (!authService.register(request))
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email existed");
        return ResponseEntity.ok("Register success!");
    }

    @PostMapping("/send-verify-email")
    public ResponseEntity<String> sendVerifyEmail(@RequestBody MailRequest email) {
        if (authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email existed");
        }
        String code = authService.getVerifyCode();
        if (mailService.sendCode(email.getEmail(), code)) {
            return ResponseEntity.ok(code);
        }
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Send mail failed!");
    }

    @PostMapping("/send-reset-password-email")
    public ResponseEntity<String> sendResetPasswordEmail(@RequestBody MailRequest email) throws MessagingException {
        if (!authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email does not exist!");
        }
        String code = authService.getVerifyCode();
        if (!mailService.sendMailResetPassword(email.getEmail(), code)) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Send mail failed!");
        }
        authService.saveCode(email, code);
        return ResponseEntity.ok(code);
    }

    @PostMapping("/verify-reset-password-code")
    public ResponseEntity<String> verifyResetPassCode(@RequestBody MailRequest request) {
        if (authService.isValidCode(request)) return ResponseEntity.ok("Valid code");
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Invalid code");
    }

    @PostMapping("/reset-password")
    public ResponseEntity<ResponseObject> resetPassword(@RequestBody ResetPasswordRequest request) {
            var result = authService.resetPassword(request);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/delete/soft/{id}")
    public ResponseEntity<ResponseObject> softDelete(@PathVariable int id) {
        var result = userService.softDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @DeleteMapping("/delete/hard/{id}")
    public ResponseEntity<ResponseObject> hardDelete(@PathVariable int id) {
        var result = userService.hardDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/restore/{id}")
    public ResponseEntity<ResponseObject> restoreUser(@PathVariable int id) {
        var result = userService.restoreUserById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/findIdByEmail")
    public ResponseEntity<?> getUserIdByEmail(@RequestParam String email) {
        Optional<User> userOptional = userRepository.findByEmail(email);
        if (userOptional.isPresent()) {
            return ResponseEntity.ok(userOptional.get().getId()); // Return just the user ID
        }
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body("User not found");
    }

}

================
File: src/main/java/com/example/demo/controller/PrivateController/VocabularyController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.entity.data.Vocabulary;
import com.example.demo.service.VocabularyService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/private/vocabulary")
public class VocabularyController {

    @Autowired
    private VocabularyService vocabularyService;

    @GetMapping
    public ResponseEntity<List<Vocabulary>> getAllVocabulary(){
        return ResponseEntity.ok(vocabularyService.getAllVocabulary());
    }

    @PostMapping
    public ResponseEntity<Vocabulary> addVocabulary(@RequestBody Vocabulary vocabulary){
        return ResponseEntity.ok(vocabularyService.addVocabulary(vocabulary));
    }

    @PutMapping("/{id}")
    public ResponseEntity<Vocabulary> updateVocabulary(@PathVariable Integer id, @RequestBody Vocabulary vocabulary){
        return ResponseEntity.ok(vocabularyService.updateVocabulary(id, vocabulary));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteVocabulary(@PathVariable Integer id){
        vocabularyService.deleteVocabulary(id);
        return ResponseEntity.noContent().build();
    }
}

================
File: src/main/java/com/example/demo/controller/PublicController/ChatController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.ChatMessageDTO;
import com.example.demo.dto.UserDTO;
import com.example.demo.entity.data.Message;
import com.example.demo.service.MessageService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.Payload;
// Remove unused imports
// import org.springframework.messaging.handler.annotation.SendTo;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;
import java.util.stream.Collectors;

@RestController
public class ChatController {

    private final MessageService messageService;
    private final SimpMessagingTemplate messagingTemplate;
    public ChatController(MessageService messageService, SimpMessagingTemplate messagingTemplate) {
        this.messageService = messageService;
        this.messagingTemplate = messagingTemplate;
    }

    @MessageMapping("/chat")
    public void processMessage(@Payload ChatMessageDTO chatMessage, Principal principal) {
        System.out.println("Principal Name (should be senderId): " + principal.getName());

        // Save the message
        messageService.sendMessage(chatMessage.getSenderId(), chatMessage.getReceiverId(), chatMessage.getContent());

        // Send the message to the receiver
        messagingTemplate.convertAndSendToUser(
                chatMessage.getReceiverId().toString(),
                "/queue/messages",
                chatMessage
        );

        // Also send the message back to the sender
        messagingTemplate.convertAndSendToUser(
                principal.getName(), // This should be the sender's userId
                "/queue/messages",
                chatMessage
        );
    }


    @GetMapping("/students/{instructorId}")
    public ResponseEntity<List<UserDTO>> getStudentsForInstructor(@PathVariable Integer instructorId) {
        List<UserDTO> students = messageService.getStudentsForInstructor(instructorId);
        System.out.println(students);
        return ResponseEntity.ok(students);
    }
    @GetMapping("/messages/{userId1}/{userId2}")
    public ResponseEntity<List<ChatMessageDTO>> getMessagesBetweenUsers(
            @PathVariable Integer userId1,
            @PathVariable Integer userId2) {
        List<Message> messages = messageService.getMessagesBetweenUsers(userId1, userId2);
        List<ChatMessageDTO> messageDTOs = messages.stream()
                .map(ChatMessageDTO::new)
                .collect(Collectors.toList());
        return ResponseEntity.ok(messageDTOs);
    }


    @PutMapping("/messages/read")
    public ResponseEntity<Void> markMessagesAsRead(
            @RequestParam Integer receiverId,
            @RequestParam Integer senderId
    ) {
        messageService.markMessagesAsRead(receiverId, senderId);
        return ResponseEntity.noContent().build();
    }
}

================
File: src/main/java/com/example/demo/controller/PublicController/CommentController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.CommentDTO;
import com.example.demo.entity.data.Comment;
import com.example.demo.entity.data.Notification;
import com.example.demo.service.CommentService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.Message;
import org.springframework.messaging.handler.annotation.*;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.messaging.simp.annotation.SendToUser;
import org.springframework.stereotype.Controller;

import java.util.Objects;

@Controller
@RequiredArgsConstructor
public class CommentController {
    private final CommentService commentService;

    @Autowired
    private SimpMessagingTemplate simpMessagingTemplate;

    @MessageMapping("/comment/lesson/{lessonId}")
    @SendTo("/comment/lesson/{lessonId}")
    public Comment handleComment(@Payload CommentDTO commentDTO, @DestinationVariable int lessonId) throws Exception {
        System.out.println("Received CommentDTO: " + commentDTO);

        if (commentDTO == null) {
            throw new IllegalArgumentException("CommentDTO cannot be null");
        }

        if (commentDTO.getReplyToUser() != null && !Objects.equals(commentDTO.getEmail(), commentDTO.getReplyToUser())) {
            Notification notification = commentService.saveNotification(commentDTO);
            var alias = notification.getUser().getEmail().split("@")[0];
            simpMessagingTemplate.convertAndSendToUser(alias, "/notification", notification);
        }

        Comment savedComment = commentService.saveComment(commentDTO);
        System.out.println("Saved Comment: " + savedComment);
        return savedComment;
    }
    @MessageExceptionHandler
    @SendToUser("/queue/errors")
    public String handleException(Throwable exception) {
        return exception.getMessage();
    }

}

================
File: src/main/java/com/example/demo/controller/PublicController/DemoController.java
================
package com.example.demo.controller.PublicController;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/public")
public class DemoController {
    @GetMapping
    public String demo() {
        return "hello public";
    }
}

================
File: src/main/java/com/example/demo/controller/PublicController/PCategoryController.java
================
package com.example.demo.controller.PublicController;


import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Category;
import com.example.demo.service.CategoryService;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/public/category")
@RequiredArgsConstructor
public class PCategoryController {

    private final CategoryService categoryService;

    @GetMapping("/getAll")
    public ResponseEntity<ResponseObject> getAll(@RequestParam(defaultValue = "0") int page,@RequestParam(defaultValue = "5") int size) {
        var result = categoryService.getAllCategory(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @GetMapping("")
    public ResponseEntity<ResponseObject> getCategoryByName(@RequestParam String name, @RequestParam(defaultValue = "0") int page,@RequestParam(defaultValue = "5") int size) {
        var result = categoryService.getByTitle(name, page, size);
        return ResponseEntity.ok(result);
    }
    @GetMapping("/{id}")
    public ResponseEntity<Category> getById(@PathVariable int id) {
        var category = categoryService.getById(id);
        if(category == null) {
            return ResponseEntity.badRequest().build();
        }
        return ResponseEntity.ok(category);
    }

}

================
File: src/main/java/com/example/demo/controller/PublicController/PCourseController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.CourseDTO;
import com.example.demo.service.CourseService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;


@RestController
@RequestMapping("/api/v1/public/course")
@RequiredArgsConstructor
public class PCourseController {
    private final CourseService courseService;

    @GetMapping("/getAll")
    public ResponseEntity<ResponseObject> getAllByPageable(@RequestParam(defaultValue = "0") int page,
                                                           @RequestParam(defaultValue = "99") int size) {
        var result = courseService.getAllByPageable(page, size);
        System.out.println("result"+result.getContent());
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getCourseById(@PathVariable int id, @RequestParam boolean isDeleted){
        var result = courseService.getCourseById(id, isDeleted);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/category")
    public ResponseEntity<ResponseObject> getCourseByCategoryId(@RequestParam("id") int id, @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourseByCategoryId(id, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

}

================
File: src/main/java/com/example/demo/controller/PublicController/PLessonController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.repository.data.LessonRepository;
import com.example.demo.service.CommentService;
import com.example.demo.service.LessonService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/public/lesson")
@RequiredArgsConstructor
public class PLessonController {
    private final LessonRepository lessonRepository;
    private final LessonService lessonService;
    private final CommentService commentService;

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getById(@PathVariable  int id) {
        var result = lessonService.getById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{id}/comments")
    public ResponseEntity<ResponseObject> getComments(@PathVariable  int id) {
        var result = commentService.getCommentByLessonId(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
}

================
File: src/main/java/com/example/demo/controller/PublicController/PPostController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.service.PostService;
import jakarta.mail.Multipart;
import lombok.NoArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@RestController
@RequestMapping("/api/v1/public/post")
@NoArgsConstructor
public class PPostController {

    @Autowired
    private PostService postService;

    @PostMapping("/uploadImg")
    public ResponseEntity<ResponseObject> getTempImg(@RequestPart MultipartFile file) {
        var result = postService.uploadImg(file);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("")
    public ResponseEntity<ResponseObject> getPost(@RequestParam int page, @RequestParam int size) {
        var result = postService.getPosts(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
}

================
File: src/main/java/com/example/demo/controller/PublicController/PublicTestController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.TestDTO;
import com.example.demo.entity.data.ListeningSection;
import com.example.demo.entity.data.Passage;
import com.example.demo.entity.data.Test;
import com.example.demo.service.TestService;
import com.example.demo.dto.ResponseObject;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/public/tests")
@RequiredArgsConstructor
public class PublicTestController {

    private final TestService testService;

    @GetMapping("")
    public ResponseEntity<ResponseObject> getAllTests() {
        List<Test> tests = testService.getAllTests();
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Tests fetched successfully")
                .content(tests)
                .build());
    }

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getTestById(@PathVariable int id) {
        TestDTO testDTO = testService.getTestDTOById(id);
        if (testDTO == null) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                    ResponseObject.builder()
                            .status(HttpStatus.NOT_FOUND)
                            .mess("Test not found")
                            .build()
            );
        }

        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Test fetched successfully")
                .content(testDTO)
                .build());
    }
}

================
File: src/main/java/com/example/demo/controller/PublicController/PublicWritingController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.entity.data.WritingTask;
import com.example.demo.service.WritingService;
import com.example.demo.dto.ResponseObject;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/public/writing")
@RequiredArgsConstructor
public class PublicWritingController {

    private final WritingService writingService;

    @GetMapping("")
    public ResponseEntity<ResponseObject> getAllWritingTasks() {
        List<WritingTask> tasks = writingService.getAllWritingTasks();
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Writing tasks fetched successfully")
                .content(tasks)
                .build());
    }

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getWritingTaskById(@PathVariable int id) {
        WritingTask task = writingService.getWritingTaskById(id);
        if (task == null) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                    ResponseObject.builder()
                            .status(HttpStatus.NOT_FOUND)
                            .mess("Writing task not found")
                            .build()
            );
        }
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Writing task fetched successfully")
                .content(task)
                .build());
    }
}

================
File: src/main/java/com/example/demo/controller/PublicController/PUserController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.auth.*;
import com.example.demo.dto.ResponseObject;
import com.example.demo.mail.MailRequest;
import com.example.demo.mail.MailService;
import com.example.demo.service.UserService;
import jakarta.mail.MessagingException;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/public/user")
public class PUserController {
    private final AuthService authService;
    private final MailService mailService;

    @PostMapping("/login")
    public ResponseEntity<ResponseObject> authenticate(@RequestBody AuthenticationRequest request) {
        var res = authService.authenticate(request);
        return ResponseEntity.status(res.getStatus()).body(res);
    }

    @PostMapping("/register")
    public ResponseEntity<String> register(@RequestBody RegisterRequest request) {
        if (!authService.register(request))
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email đã tồn tại!");
        return ResponseEntity.ok("Đăng ký thành công!");
    }

    @PostMapping("/send-verify-email")
    public ResponseEntity<String> sendVerifyEmail(@RequestBody MailRequest email) {
        if (authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email đã tồn tại!"); // 400
        }
        String code = authService.getVerifyCode();
        if (mailService.sendCode(email.getEmail(), code)) {
            return ResponseEntity.ok(code);
        }
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Gửi không thành công!");
    }

    @PostMapping("/send-reset-password-email")
    public ResponseEntity<String> sendResetPasswordEmail(@RequestBody MailRequest email) throws MessagingException {
        if (!authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email không tồn tài!");
        }
        String code = authService.getVerifyCode();
        if(!mailService.sendMailResetPassword(email.getEmail(), code)) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Gửi mail thất bại!");
        }
        authService.saveCode(email, code);
        return ResponseEntity.ok(code);
    }

    @PostMapping("/verify-reset-password-code")
    public ResponseEntity<String> verifyResetPassCode(@RequestBody MailRequest request) {
        if (authService.isValidCode(request)) return ResponseEntity.ok("Mã xác thực đúng");
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Mã xác thực sai!");
    }

    @PostMapping("/reset-password")
    public ResponseEntity<ResponseObject> resetPassword(@RequestBody ResetPasswordRequest request) {
            var result = authService.resetPassword(request);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

//    @PostMapping("/send-verify-otp")
//    public ResponseEntity<String> sendOtp(@RequestBody OtpVerifyRequest request) {
//        if(!authService.isValidPhoneNumber(request.getPhoneNumber())) return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Số điện thoại chưa được đăng kí!");
//        if(!authService.sendOtpVerification(request)) return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Gửi OTP thất bại!");
//        return ResponseEntity.ok("Gửi mã xác nhận thành công!");
//    }



}

================
File: src/main/java/com/example/demo/DemoApplication.java
================
package com.example.demo;

import com.example.demo.auth.AuthService;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.jwt.JwtService;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.util.List;

@SpringBootApplication
@RequiredArgsConstructor
public class DemoApplication {
    private final UserRepository userRepository;
    private final JwtService jwtService;
    private final PasswordEncoder passwordEncoder;

    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }

}

================
File: src/main/java/com/example/demo/dto/ChatMessageDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Message;
import lombok.Data;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDateTime;
@Getter
@Setter
@Data
@NoArgsConstructor

public class ChatMessageDTO {
    private Integer senderId;
    private Integer receiverId;
    private String content;
    private LocalDateTime timestamp; // Add timestamp if needed
    public ChatMessageDTO(Message message) {
        this.senderId = message.getSender().getId();
        this.receiverId = message.getReceiver().getId();
        this.content = message.getContent();
        this.timestamp = message.getTimestamp();
    }
}

================
File: src/main/java/com/example/demo/dto/Choice.java
================
package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@JsonIgnoreProperties(ignoreUnknown = true)
public class Choice {
    private int index;
    private Message message;
}

================
File: src/main/java/com/example/demo/dto/CommentDTO.java
================
package com.example.demo.dto;

import lombok.Builder;
import lombok.Data;
import org.springframework.context.annotation.Bean;

@Data
@Builder
public class CommentDTO {
    private String email;
    private String userName;
    private String content;
    private String path;
    private int lessonId;
    private boolean sub;
    private String avatar;
    private int parentId;
    private String replyToUser;
    private String replyToUserName;
}

================
File: src/main/java/com/example/demo/dto/CourseDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Progress;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

import java.time.LocalDateTime;
import java.util.List;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class CourseDTO {
    private String title;
    private int price;
    private int discount;
    private String description;
    private LocalDateTime date;
    private List<Integer> categories; // IDs of associated categories
    private List<SectionDTO> sections; // Associated sections
    private String thumbnail;
    private String video;
    private String instructor; // Instructor's email
    private boolean isEditedCategories;
    private boolean isEdited;
}

================
File: src/main/java/com/example/demo/dto/CourseStatisticDTO.java
================
package com.example.demo.dto;


import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;

@Builder
@AllArgsConstructor
@Data
public class CourseStatisticDTO {
    private int id;
//    private String title;
    private String thumbnail;
//    private int price;
    private String courseTitle;
    private int enrollments;
}

================
File: src/main/java/com/example/demo/dto/CriterionFeedback.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
class CriterionFeedback {
    private double score;
    private String comments;
}

================
File: src/main/java/com/example/demo/dto/EnrollDTO.java
================
package com.example.demo.dto;

import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
public class EnrollDTO {

    private String email;
    private int courseId;
    private List<Integer> lessonIds;
}

================
File: src/main/java/com/example/demo/dto/EssayFeedback.java
================
package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Getter;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@JsonIgnoreProperties(ignoreUnknown = true)

public class EssayFeedback {
    private List<GrammarError> grammarErrors;
    private List<VocabularyError> vocabularyErrors;
    private String overallFeedback;
    private double overallScore;

}

================
File: src/main/java/com/example/demo/dto/EssaySubmissionRequest.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class EssaySubmissionRequest {
    private int userId;
    private int writingTaskId;
    private String essayContent;
}

================
File: src/main/java/com/example/demo/dto/ExercideDTO.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.HashMap;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ExercideDTO {
    private String question;
    private HashMap<String, Boolean> answers;
}

================
File: src/main/java/com/example/demo/dto/GrammarError.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
class GrammarError {
    private String sentence;
    private String error;
    private String recommendation;
}

================
File: src/main/java/com/example/demo/dto/InstructorDTO.java
================
package com.example.demo.dto;

public class InstructorDTO {
}

================
File: src/main/java/com/example/demo/dto/InvoiceDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.MethodPayment;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.RequiredArgsConstructor;

import java.time.LocalDateTime;

@Data
@Builder
@RequiredArgsConstructor
@AllArgsConstructor
public class InvoiceDTO {
    private int id;
    private final LocalDateTime date;
    private final long total;
    private String content;
    private MethodPayment method;
    private final UserStatisticDTO user;
    private Course course;

}

================
File: src/main/java/com/example/demo/dto/InvoiceStatisticDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.MethodPayment;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;

import java.time.LocalDateTime;

@Builder
@AllArgsConstructor
@Data
public class InvoiceStatisticDTO {
    private int id;
    private LocalDateTime createdDate;
    private MethodPayment methodPayment;
    private long totalInvoice;
    private String content;
    private UserStatisticDTO user;
}

================
File: src/main/java/com/example/demo/dto/LessonDTO.java
================
package com.example.demo.dto;

import lombok.Data;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

// NONE, REMOVE, UPDATE, HAS
@Getter
@Data
@NoArgsConstructor
public class LessonDTO {
    private int id;
    private String linkVideo;
    private String title;
    private String description;
    private LocalDateTime date;
    private String video;
    private boolean isEdited;
    private String actionVideo = "NONE";
    public LessonDTO(String value){}
}

================
File: src/main/java/com/example/demo/dto/LessonProgressDTO.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class LessonProgressDTO {
    private int userId;
    private int lessonId;
    private double progressPercentage;
    private boolean completed;
    private boolean unlocked;

    // Getters and setters
}

================
File: src/main/java/com/example/demo/dto/ListeningSectionDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ListeningSectionDTO {

    private int id;
    private int sectionNumber;
    private String audioUrl;
    private String transcript;
    private List<QuestionDTO> questions;
}

================
File: src/main/java/com/example/demo/dto/Message.java
================
package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@JsonIgnoreProperties(ignoreUnknown = true)
public class Message {
    private String role;
    private String content;
}

================
File: src/main/java/com/example/demo/dto/OpenAIRequest.java
================
package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Getter;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
public class OpenAIRequest {
    private String model;
    private List<Message> messages;

    @Getter
    @Setter
    public static class Message {
        private String role;
        private String content;

        public Message(String role, String content) {
            this.role = role;
            this.content = content;
        }
    }
}

================
File: src/main/java/com/example/demo/dto/OpenAIResponse.java
================
package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Getter;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@JsonIgnoreProperties(ignoreUnknown = true) // Bỏ qua các trường không được định nghĩa
public class OpenAIResponse {
    private String id;
    private String object;
    private long created;
    private String model;
    private List<Choice> choices;
}

================
File: src/main/java/com/example/demo/dto/PassageDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PassageDTO {

    private int id;
    private int passageNumber;
    private String content;
    private List<QuestionDTO> questions;
}

================
File: src/main/java/com/example/demo/dto/PasswordDTO.java
================
package com.example.demo.dto;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class PasswordDTO {
    private String email;
    private String oldPassword;
    private String newPassword;
}

================
File: src/main/java/com/example/demo/dto/PostDTO.java
================
package com.example.demo.dto;


import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class PostDTO {
    private String content;
    private String title;
    private String email;
}

================
File: src/main/java/com/example/demo/dto/ProgressDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Course;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Data
@Builder
public class ProgressDTO {
    private  Course course;
    private List<Integer> lessonIds = new ArrayList<>();
    public ProgressDTO(Course course) {
        this.course = course;
    }

    public ProgressDTO(Course course, List<Integer> lessonIds) {
        this.course = course;
        this.lessonIds = lessonIds;
    }
}

================
File: src/main/java/com/example/demo/dto/QuestionDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class QuestionDTO {

    private int id;
    private String content;
    private String questionType;
    private int questionNumber;
    private List<QuestionOptionDTO> options;
}

================
File: src/main/java/com/example/demo/dto/QuestionOptionDTO.java
================
package com.example.demo.dto;

import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class QuestionOptionDTO {

    private int id;
    private String content;
}

================
File: src/main/java/com/example/demo/dto/ResponseObject.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import org.springframework.http.HttpStatus;

@Data
@Builder
@AllArgsConstructor
public class ResponseObject {
    private HttpStatus status;
    private String mess;
    private Object content;
}

================
File: src/main/java/com/example/demo/dto/SectionDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Lesson;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SectionDTO {
    private int id;
    private String title;
    private int isEdited;
    private List<LessonDTO> lessons; // Associated lessons
}

================
File: src/main/java/com/example/demo/dto/StatisticsDTO.java
================
package com.example.demo.dto;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.domain.Page;
@Data
@Builder
public class StatisticsDTO {
    private Page<CourseStatisticDTO> coursesCreated;
    private Page<UserStatisticDTO> usersRegistered;
    private Page<InvoiceStatisticDTO> invoicesCreated;
    private long invoiceTotal;
}

================
File: src/main/java/com/example/demo/dto/TestDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class TestDTO {

    private int id;
    private String title;
    private String type;
    private List<PassageDTO> passages; // For Reading Test
    private List<ListeningSectionDTO> listeningSections; // For Listening TestTest
}

================
File: src/main/java/com/example/demo/dto/UserDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import jakarta.persistence.Entity;
import lombok.*;

import java.util.List;

@Data
@AllArgsConstructor
@Builder
@NoArgsConstructor
@Getter
@Setter
public class UserDTO {
    private int id;

    private String email;
    private String password;
    private String firstName;
    private String lastName;
    private String avatar;
    private String phoneNumber;
    private String token;
    private List<Progress> progresses;
    private Role role;

    public UserDTO(User user) {
        this.id = user.getId();
        this.email = user.getEmail();
        this.firstName = user.getFirstName();
        this.lastName = user.getLastName();
        this.avatar = user.getAvatar();
        this.phoneNumber = user.getPhoneNumber();
        this.role = user.getRole();
    }

    public void setAvatar(String avatar) {
    }
}

================
File: src/main/java/com/example/demo/dto/UserEssayDTO.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class UserEssayDTO {
    private int id;
    private String content;
    private LocalDateTime submissionTime;
    private double score;
    private String email;
}

================
File: src/main/java/com/example/demo/dto/UserResponseDTO.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserResponseDTO {
    private int questionId;
    private String userAnswer;
}

================
File: src/main/java/com/example/demo/dto/UsersAndRoles.java
================
package com.example.demo.dto;

import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import lombok.Builder;
import lombok.Data;
import org.springframework.data.domain.Page;


@Builder
@Data
public class UsersAndRoles {
    private Page<User> users;
    private Role[] roles;
}

================
File: src/main/java/com/example/demo/dto/UserStatisticDTO.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.RequiredArgsConstructor;

@Builder
@AllArgsConstructor
@RequiredArgsConstructor
@Data
public class UserStatisticDTO {
    private int id;
    private final String email;
    private final String firstName;
    private final String lastName;
    private final String avatar;
}

================
File: src/main/java/com/example/demo/dto/VocabularyError.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
class VocabularyError {
    private String word;
    private String error;
    private String recommendation;
}

================
File: src/main/java/com/example/demo/entity/data/Category.java
================
package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.*;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Builder
@Getter
@Setter
@AllArgsConstructor
@NoArgsConstructor
@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "name")
public class Category {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String name;
    private LocalDateTime date;
    private boolean isDeleted = false;
    @ManyToMany(mappedBy = "categories")
//! không được sử dụng @JsonBackReference() với Collections
    @JsonIgnore
    private List<Course> courses = new ArrayList<>();
}

================
File: src/main/java/com/example/demo/entity/data/Comment.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.Date;

@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Comment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private LocalDateTime date;
    @Column(columnDefinition = "TEXT")
    private String content;
    private String userEmail;
    private String userName;
    private String avatar;
    private int parentId;
    private String replyToUser;
    private String replyToUserName;

    @ManyToOne
    @JsonIgnore
    private User user;

    @ManyToOne
    @JsonIgnore
    private Lesson lesson;
}

================
File: src/main/java/com/example/demo/entity/data/Course.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.*;
import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.ManyToAny;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "id")
public class Course {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title;

    private String video;

    private int price;

    private int discount;

    private LocalDateTime date;

    @Column(columnDefinition = "TEXT")
    private String description;

    private String thumbnail;

    private String alias;

    private boolean isDeleted = false;

    @ManyToMany
    @JoinTable(
            name = "course_category",
            joinColumns = @JoinColumn(name = "course_id", referencedColumnName = "id"),
            inverseJoinColumns = @JoinColumn(name = "category_id", referencedColumnName = "id")
    )
    @Builder.Default
    private List<Category> categories = new ArrayList<>();

    @OneToMany(mappedBy = "course", cascade = CascadeType.ALL)
    @Builder.Default
    private List<Section> sections = new ArrayList<>();



    // New mapping: reference to the instructor
    @ManyToOne
    @JoinColumn(name = "instructor_id", nullable = false)
    @JsonIgnore // Bỏ qua instructor khi serialize Course

    private User instructor;

    // Additional utility methods if needed
    public void addCategory(Category category) {
        this.categories.add(category);
    }

    public void addSection(Section section) {
        this.sections.add(section);
    }

}

================
File: src/main/java/com/example/demo/entity/data/Flashcard.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Entity
@Table(name = "flashcards")
public class Flashcard {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @ManyToOne
    @JoinColumn(name = "set_id")
    private FlashcardSet set;

    @ManyToOne
    @JoinColumn(name = "vocabulary_id")
    private Vocabulary vocabulary;

    // Getters and Setters
}

================
File: src/main/java/com/example/demo/entity/data/FlashcardSet.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

import java.time.LocalDateTime;
import java.util.List;

@Getter
@Setter
@Entity
@Table(name = "flashcard_sets")
public class FlashcardSet {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title;
    private String description;

    private LocalDateTime createdAt;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;

    @OneToMany(mappedBy = "set", cascade = CascadeType.ALL)
    private List<Flashcard> flashcards;

    // Getters and Setters
}

================
File: src/main/java/com/example/demo/entity/data/Invoice.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Invoice {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private LocalDateTime date;
    private MethodPayment method;
    private long total;
    private String content;
    private boolean isDelete = false;
    @ManyToOne
    private User user;
    @ManyToOne
    private Course course;
}

================
File: src/main/java/com/example/demo/entity/data/Lesson.java
================
package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.JsonBackReference;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
//@Data
@NoArgsConstructor
@Getter
@Setter
@AllArgsConstructor
@Builder
public class Lesson {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String description;
    private String linkVideo;
    private String title;
    private String video;
    private LocalDateTime date;
    private int duration;
    private boolean isDeleted = false;
    private boolean isEdited = false;
    private String actionVideo = "NONE";
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "section_id")
    @JsonBackReference // Ngăn chặn vòng lặp khi serialize
    private Section section;
}

================
File: src/main/java/com/example/demo/entity/data/LessonProgress.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@Entity
@NoArgsConstructor
@AllArgsConstructor
public class LessonProgress {
    @EmbeddedId
    private LessonProgressKey id;

    @ManyToOne
    @MapsId("userId")
    @JoinColumn(name = "user_id")
    private User user;

    @ManyToOne
    @MapsId("lessonId")
    @JoinColumn(name = "lesson_id")
    private Lesson lesson;

    private double progressPercentage;

    private boolean isCompleted; // True if progress >= 80%

    private boolean isUnlocked;
}

================
File: src/main/java/com/example/demo/entity/data/LessonProgressKey.java
================
package com.example.demo.entity.data;

import jakarta.persistence.Column;
import jakarta.persistence.Embeddable;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.io.Serializable;
@Getter
@Setter
@Embeddable
@NoArgsConstructor
@AllArgsConstructor
public class LessonProgressKey implements Serializable {
    @Column(name = "user_id")
    private int userId;

    @Column(name = "lesson_id")
    private int lessonId;
}

================
File: src/main/java/com/example/demo/entity/data/ListeningSection.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class ListeningSection {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private int sectionNumber; // 1, 2, 3, or 4

    private String audioUrl; // URL to the audio file

    @Column(columnDefinition = "TEXT")
    private String transcript; // Optional: transcript of the audio

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_id")
    private Test test;

    @OneToMany(mappedBy = "listeningSection", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Question> questions = new ArrayList<>();
}

================
File: src/main/java/com/example/demo/entity/data/Message.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Message {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @ManyToOne
    @JoinColumn(name = "sender_id", nullable = false)
    private User sender;

    @ManyToOne
    @JoinColumn(name = "receiver_id", nullable = false)
    private User receiver;

    @Column(nullable = false)
    private String content;

    @Column(nullable = false)
    private LocalDateTime timestamp;

    @Column(nullable = false)
    private boolean isRead;

    @Column(nullable = false)
    private String chatRoomId;
}

================
File: src/main/java/com/example/demo/entity/data/MethodPayment.java
================
package com.example.demo.entity.data;

public enum MethodPayment {
    VNPAY, MOMO, ZALOPAY, PAYPAL, CASH
}

================
File: src/main/java/com/example/demo/entity/data/Notification.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Notification {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    @Column(columnDefinition = "TEXT")
    private String content;
    private LocalDateTime date;
    private String fromUser;
    private String path;
    private String img;
    private boolean isRead = false;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    @ToString.Exclude
    private User user;
}

================
File: src/main/java/com/example/demo/entity/data/Passage.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Passage {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private int passageNumber; // 1, 2, or 3

    @Column(columnDefinition = "TEXT")
    private String content; // The text content of the passage

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_id")
    private Test test;

    @OneToMany(mappedBy = "passage", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Question> questions = new ArrayList<>();
}

================
File: src/main/java/com/example/demo/entity/data/Post.java
================
package com.example.demo.entity.data;


import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Post {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String content;
    @ManyToOne
    private User user;
    private LocalDateTime date ;
    private String title;
    private boolean isDeleted = false;

    @OneToMany(cascade = CascadeType.ALL)
    private List<Comment> comment;
}

================
File: src/main/java/com/example/demo/entity/data/Progress.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import jdk.jshell.spi.ExecutionControl;
import lombok.*;
import org.antlr.v4.runtime.misc.IntegerList;

import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Progress {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private  int id;

    @ElementCollection // 1
    @CollectionTable(name = "lesson_ids", joinColumns = @JoinColumn(name = "id")) // 2
    @Column(name = "list_lessonid") // 3
    private List<Integer> lessonIds;

    @ManyToOne(cascade = CascadeType.PERSIST)
    @JoinColumn(name = "course_id")

    private Course course;

    @ManyToOne(cascade = CascadeType.PERSIST)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;
}

================
File: src/main/java/com/example/demo/entity/data/Question.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Question {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @Column(columnDefinition = "TEXT")
    private String content; // The question text

    private String questionType; // e.g., "MULTIPLE_CHOICE", "TRUE_FALSE", "FILL_IN_THE_BLANK"

    private String correctAnswer; // For checking user responses

    private int questionNumber;

    private boolean isDeleted = false;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "passage_id")
    private Passage passage;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "listening_section_id")
    private ListeningSection listeningSection;

    @OneToMany(mappedBy = "question", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<QuestionOption> options = new ArrayList<>(); // For multiple-choice questions
}

================
File: src/main/java/com/example/demo/entity/data/QuestionOption.java
================
package com.example.demo.entity.data;


import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "question_option") // Specify a non-reserved table name

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class QuestionOption {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String content; // Option text

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "question_id")
    private Question question;
}

================
File: src/main/java/com/example/demo/entity/data/Section.java
================
package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.JsonBackReference;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonManagedReference;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.Where;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Section {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title;
    private boolean isDeleted = false;
    private boolean isEdited = false;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "course_id")
    private Course course;

    @OneToMany(mappedBy = "section", cascade = CascadeType.ALL, orphanRemoval = true)
    @JsonManagedReference // Serialize lessons theo chiều từ Section -> Lesson
    private List<Lesson> lessons = new ArrayList<>();
}

================
File: src/main/java/com/example/demo/entity/data/Test.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Test {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title; // e.g., "IELTS Cambridge Reading Test 1"

    private String type; // "READING" or "LISTENING"

    private LocalDateTime date;

    private boolean isDeleted = false;

    // For Reading Test
    @OneToMany(mappedBy = "test", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Passage> passages = new ArrayList<>();

    // For Listening Test
    @OneToMany(mappedBy = "test", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<ListeningSection> listeningSections = new ArrayList<>();

}

================
File: src/main/java/com/example/demo/entity/data/TestProgress.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;
import java.util.List;
import java.util.ArrayList;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class TestProgress {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private LocalDateTime startTime;

    private LocalDateTime endTime;

    private int totalQuestions;

    private int correctAnswers;

    private boolean isCompleted;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_id")
    private Test test;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;

    @OneToMany(mappedBy = "testProgress", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<UserResponse> userResponses = new ArrayList<>();
}

================
File: src/main/java/com/example/demo/entity/data/UserEssay.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserEssay {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @Column(columnDefinition = "TEXT")
    private String content; // User's essay content

    private LocalDateTime submissionTime;

    @Column(columnDefinition = "TEXT")
    private String feedbackJson; // JSON feedback from the AI

    private double score; // Optional score assigned

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "writing_task_id")
    @JsonIgnore
    private WritingTask writingTask;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;
}

================
File: src/main/java/com/example/demo/entity/data/UserResponse.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserResponse {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String userAnswer;

    private boolean isCorrect;

    private LocalDateTime responseTime;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "question_id")
    private Question question;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_progress_id")
    private TestProgress testProgress;
}

================
File: src/main/java/com/example/demo/entity/data/Vocabulary.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

import java.time.LocalDateTime;
@Getter
@Setter
@Entity
@Table(name = "vocabulary")
public class Vocabulary {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String word;
    private String definition;
    private String example;

    private LocalDateTime createdAt;

    // Getters and Setters
}

================
File: src/main/java/com/example/demo/entity/data/WritingTask.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class WritingTask {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String taskType; // "TASK1" or "TASK2"

    private String title;

    @Column(columnDefinition = "TEXT")
    private String prompt; // The essay prompt

    private LocalDateTime dateCreated;

    private boolean isDeleted = false;
}

================
File: src/main/java/com/example/demo/entity/user/OtpStatus.java
================
package com.example.demo.entity.user;

public enum OtpStatus {
    DELIVERED, FAILED
}

================
File: src/main/java/com/example/demo/entity/user/Permission.java
================
package com.example.demo.entity.user;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

public enum Permission {
    INSTRUCTOR_CREATE_COURSE("instructor:create_course"),
    INSTRUCTOR_UPDATE_COURSE("instructor:update_course"),
    INSTRUCTOR_DELETE_COURSE("instructor:delete_course"),
    INSTRUCTOR_READ_COURSE("instructor:read_course"),
    INSTRUCTOR_COMMUNICATE("instructor:communicate"),
    // Existing permissions
    ADMIN_CREATE("admin:create"),
    ADMIN_UPDATE("admin:update"),
    ADMIN_DELETE("admin:delete"),
    ADMIN_READ("admin:read"),
    MANAGER_CREATE("manager:create"),
    MANAGER_UPDATE("manager:update"),
    MANAGER_DELETE("manager:delete"),
    MANAGER_READ("manager:read");

    @Getter
    private final String permission;

    Permission(String permission) {
        this.permission = permission;
    }
}

================
File: src/main/java/com/example/demo/entity/user/Role.java
================
package com.example.demo.entity.user;

import lombok.Getter;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import java.util.*;
import java.util.stream.Collectors;
@Getter

public enum Role {

    USER(Collections.emptySet()),
    INSTRUCTOR(
            Set.of(
                    Permission.INSTRUCTOR_CREATE_COURSE,
                    Permission.INSTRUCTOR_UPDATE_COURSE,
                    Permission.INSTRUCTOR_DELETE_COURSE,
                    Permission.INSTRUCTOR_READ_COURSE,
                    Permission.INSTRUCTOR_COMMUNICATE // Allows messaging with users
            )
    ),
    ADMIN(
            Set.of(
                    Permission.ADMIN_CREATE,
                    Permission.ADMIN_UPDATE,
                    Permission.ADMIN_DELETE,
                    Permission.ADMIN_READ,
                    Permission.MANAGER_READ,
                    Permission.MANAGER_CREATE,
                    Permission.MANAGER_UPDATE,
                    Permission.MANAGER_DELETE
            )
    ),
    MANAGER(
            Set.of(
                    Permission.MANAGER_CREATE,
                    Permission.MANAGER_UPDATE,
                    Permission.MANAGER_READ,
                    Permission.MANAGER_DELETE
            )
    );

    @Getter
    private final Set<Permission> permissions;

    Role(Set<Permission> permissions) {
        this.permissions = permissions;
    }


    public List<SimpleGrantedAuthority> getAuthorities() {
        List<SimpleGrantedAuthority> authorities = getPermissions()
                .stream()
                .map(permission -> new SimpleGrantedAuthority(permission.getPermission()))
                .collect(Collectors.toList());
        authorities.add(new SimpleGrantedAuthority("ROLE_" + this.name()));
        return authorities;
    }
}

================
File: src/main/java/com/example/demo/entity/user/User.java
================
package com.example.demo.entity.user;

import com.example.demo.entity.data.*;
import com.example.demo.jwt.Token;
import com.fasterxml.jackson.annotation.JsonIdentityInfo;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.ObjectIdGenerators;
import jakarta.persistence.*;
import lombok.*;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.time.LocalDateTime;
import java.util.*;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "id")
public class User implements UserDetails {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String email;
    private String password;
    private String firstName;
    private String lastName;
    private String avatar;
    private String phoneNumber;
    private boolean isDeleted = false;
    private LocalDateTime createdAt = LocalDateTime.now();

    @OneToOne
    @JoinColumn(name = "token_id")
    private Token token;

    @ElementCollection
    @CollectionTable(name = "code_table", joinColumns = @JoinColumn(name = "user_id"))
    @MapKeyColumn(name = "code")
    @Column(name = "expiration")
    private Map<String, LocalDateTime> code = new HashMap<String, LocalDateTime>();

    @Enumerated(EnumType.STRING)
    private Role role;

    @OneToMany(mappedBy = "user",cascade = CascadeType.REMOVE)
    @JsonIgnore
    private List<Comment> comments;

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL)
    @JsonIgnore

    private List<Notification> notifications = new ArrayList<>();

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL)
    List<Progress> progresses = new ArrayList<>();
    @OneToMany(mappedBy = "instructor", cascade = CascadeType.ALL, orphanRemoval = true)
    @JsonIgnore // Bỏ qua courses khi serialize User

    private List<Course> courses = new ArrayList<>();


    @OneToMany(cascade = CascadeType.ALL)
    @JsonIgnore

    List<Post> posts = new ArrayList<>();

    @PrePersist
    protected  void onCreate() {
        createdAt = LocalDateTime.now();
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return role.getAuthorities();
    }

    @Override
    public String getPassword() {
        return password;
    }

    @Override
    public String getUsername() {
        return email;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}

================
File: src/main/java/com/example/demo/exception/CourseNotFoundException.java
================
package com.example.demo.exception;

public class CourseNotFoundException extends RuntimeException {
    public CourseNotFoundException(String message) {
        super(message);
    }}

================
File: src/main/java/com/example/demo/exception/ResourceNotFoundException.java
================
package com.example.demo.exception;

public class ResourceNotFoundException extends RuntimeException {
    public ResourceNotFoundException(String message) {
        super(message);
    }
}

================
File: src/main/java/com/example/demo/exception/UserNotFoundException.java
================
package com.example.demo.exception;

public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(String message) {
        super(message);
    }
}

================
File: src/main/java/com/example/demo/handler/LogoutHandler.java
================
package com.example.demo.handler;

import com.example.demo.jwt.JwtService;
import com.example.demo.jwt.Token;
import com.example.demo.repository.TokenRepository;
import com.example.demo.repository.UserRepository;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

@Data
@RequiredArgsConstructor
@Component
public class LogoutHandler implements org.springframework.security.web.authentication.logout.LogoutHandler {
    private final TokenRepository tokenRepository;
    private final UserRepository userRepository;
    private final JwtService jwtService;
    @Override
    public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) {
        String jwt= request.getHeader("Authorization");
        if(jwt != null && jwt.startsWith("Bearer ")) {
            jwt = jwt.substring(7);
            Token token = tokenRepository.findByToken(jwt).orElse(null);
            if(token != null) {
                String email = jwtService.extractUserName(token.getToken());
                var user = userRepository.findByEmail(email).orElse(null);
                if(user != null) {
                    user.setToken(null);
                    SecurityContextHolder.clearContext();
                    tokenRepository.delete(token);
                    return;
                }
            }
        }
        SecurityContextHolder.clearContext();
    }
}

================
File: src/main/java/com/example/demo/handler/Oauth2SuccessHandler.java
================
package com.example.demo.handler;

import com.example.demo.auth.AuthService;
import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.jwt.JwtService;
import com.example.demo.jwt.Token;
import com.example.demo.repository.UserRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.Data;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Objects;

@Data
@Component
public class Oauth2SuccessHandler implements AuthenticationSuccessHandler {
    private final UserRepository userRepository;
    private final CloudService cloudService;
    private final AuthService authService;
    private final JwtService jwtService;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        OAuth2User oauth2User = (OAuth2User) authentication.getPrincipal();
        String avatar = "";
        if (oauth2User.getAttribute("picture") != null) {
            avatar = Objects.requireNonNull(oauth2User.getAttribute("picture")).toString();
        }
        String email = "";
        if(oauth2User.getAttribute("email") != null) {
            email = oauth2User.getAttribute("email");
        }
        String family_name = "";
        if(oauth2User.getAttribute("name") != null) {
            family_name = oauth2User.getAttribute("name").toString();
        }
        if(oauth2User.getAttribute("login") != null && Objects.equals(email, "")) {
            email = oauth2User.getAttribute("login");
        }
        var user = authService.findUserByEmail(email);
        if(user == null) {
            user = User.builder()
                    .email(Objects.equals(email, "") ? null : email)
                    .lastName(family_name)
                    .role(Role.USER)
                    .avatar(Objects.equals(avatar, "") ? null : avatar)
                    .build();
        }
        String userAvatar = user.getAvatar();
        if(userAvatar == null && !Objects.equals(avatar, "")) {
            user.setAvatar(avatar);
        }

        if(userAvatar != null && Objects.equals(avatar, "")) {
            avatar = user.getAvatar();
        }

        userRepository.save(user);
        Token token = new Token(jwtService.generateToken(user));
        user.setToken(token);

        String redirectUrl = "http://localhost:3000/?token=" + URLEncoder.encode(token.getToken(), StandardCharsets.UTF_8)
                + "&email=" + URLEncoder.encode(email, StandardCharsets.UTF_8)
                + "&lastName=" + URLEncoder.encode(family_name, StandardCharsets.UTF_8)
                + "&avatar=" + URLEncoder.encode(avatar, StandardCharsets.UTF_8);
        response.sendRedirect(redirectUrl);
    }
}

================
File: src/main/java/com/example/demo/jwt/JwtFilter.java
================
package com.example.demo.jwt;

import com.example.demo.dto.ResponseObject;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.jsonwebtoken.ExpiredJwtException;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.MalformedJwtException;
import io.jsonwebtoken.security.SignatureException;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.EOFException;
import java.io.IOException;
import java.nio.file.AccessDeniedException;

@Component
@RequiredArgsConstructor
public class JwtFilter extends OncePerRequestFilter {

    private final JwtService jwtService;
    private final UserDetailsService userDetailsService;
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws IOException, ServletException {
        if(request.getServletPath().contains("/api/v1/public")) {
            filterChain.doFilter(request, response);
            return;
        }

       try {
           String authHeader = request.getHeader("Authorization");
           String jwt;
           String email;
           if(authHeader == null || !authHeader.startsWith("Bearer ")) {
               filterChain.doFilter(request, response);
               return;
           }

           jwt = authHeader.substring(7);
           email = jwtService.extractUserName(jwt);
           if(email != null && SecurityContextHolder.getContext().getAuthentication() == null) {
               UserDetails    userDetails = userDetailsService.loadUserByUsername(email);
               if(jwtService.isValidToken(jwt, userDetails)) {
                   UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                   usernamePasswordAuthenticationToken.setDetails(
                           new WebAuthenticationDetailsSource().buildDetails(request)
                   );
                   SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);
               }
           }
           filterChain.doFilter(request, response);
       }
       catch (MalformedJwtException | SignatureException e) {
           logger.error("Token is not valid: " + e.getMessage());
           response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
           ResponseObject res = ResponseObject.builder().status(HttpStatus.UNAUTHORIZED).mess("Token is not valid, Log in again").build();
           ObjectMapper mapper = new ObjectMapper();
           response.getWriter().write(mapper.writeValueAsString(res));
       }
       catch (ExpiredJwtException e) {
           logger.error("Token is expiration: " + e.getMessage());
           response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
           ResponseObject res = ResponseObject.builder().status(HttpStatus.UNAUTHORIZED).mess("Token is expiration, Log in again").build();
           ObjectMapper mapper = new ObjectMapper();
           response.getWriter().write(mapper.writeValueAsString(res));
       }
    }
}

================
File: src/main/java/com/example/demo/jwt/JwtService.java
================
package com.example.demo.jwt;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

import javax.crypto.SecretKey;
import java.security.Key;
import java.security.SecureRandom;
import java.util.Base64;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Component
@Data
@NoArgsConstructor
public class JwtService {
    private String SECRET_KEY = getSecretKey();

    @Value("${jwt-expiration}")
    private long expiration;
    private long refreshToken;

    public String buildToken(Map<String, Object> claims, UserDetails userDetails) {
        return Jwts.builder()
                .claims(claims)
                .expiration(new Date(System.currentTimeMillis() + expiration))
                .subject(userDetails.getUsername())
                .signWith(getKey())
                .issuedAt(new Date())
                .compact();
    }

    private <T> T extractClaims(String token, Function<Claims, T> claimsResolver) {
        Claims claims = extractClaimsFromToken(token);
//        if (claims != null) {
            return claimsResolver.apply(claims);
//        }
//        return null;
    }


    public String extractUserName(String token) {
//        return extractClaims(token, new Function<Claims, String> () {
//            @Override
//            public String apply(Claims claims) {
//                return claims.getSubject();
//            }
//        });
//        return extractClaims(token, claims -> claims.getSubject());
        return extractClaims(token, Claims::getSubject);

    }

    public Boolean isTokenExpired(String token) {
        return extractExpiration(token).before(new Date());
    }

    public Date extractExpiration(String token) {
        return extractClaims(token, Claims::getExpiration);
    }

    public Boolean isValidToken(String token, UserDetails userDetails) {
        String username = extractUserName(token);
        return !isTokenExpired(token) && username.equals(userDetails.getUsername());
    }


    private Claims extractClaimsFromToken(String token) {
//       try {
           return Jwts.parser()
                   .verifyWith((SecretKey) getKey())
                   .build().parseSignedClaims(token).getPayload();
//       }
//       catch (Exception e) {
//           System.out.println("extractClaimsFromToken: " + e.getMessage());
//           return null;
//       }
    }


    public String generateToken(UserDetails userDetails )  {
        return buildToken(new HashMap<>(), userDetails);
    }

    public Key getKey() {
        byte[] key = Base64.getDecoder().decode(SECRET_KEY);
        return Keys.hmacShaKeyFor(key);
    }


    private String getSecretKey() {
        SecureRandom random = new SecureRandom(); // hàm random có tính bảo mật cao
        byte[] key = new byte[32];
        random.nextBytes(key); // random ra chuỗi 32byte
        return Base64.getEncoder().encodeToString(key); // encode chuỗi 32 byte sang chuỗi sử dụng base64
    }
}

================
File: src/main/java/com/example/demo/jwt/Token.java
================
package com.example.demo.jwt;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import lombok.Data;
import lombok.RequiredArgsConstructor;

import java.time.LocalDateTime;

@Data
@Entity

@RequiredArgsConstructor
public class Token {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private  String token;
    private LocalDateTime createAt;
    private LocalDateTime inspirationAt;
    public Token(String token) {
        this.token = token;
    }
}

================
File: src/main/java/com/example/demo/mail/MailRequest.java
================
package com.example.demo.mail;

import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.stereotype.Component;
@Data
@NoArgsConstructor
public class MailRequest {
    private String email;
    private String code;
}

================
File: src/main/java/com/example/demo/mail/MailService.java
================
package com.example.demo.mail;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ClassPathResource;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class MailService {
    private final JavaMailSender javaMailSender;

    @Value("${spring.mail.username}")
    private String from;

    public Boolean sendCode(String to, String code)  {
        try {
        MimeMessage mimeMessage = javaMailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true);
        String htmlContent;
            htmlContent = "<!DOCTYPE html>\n" +
                    "<html lang=\"en\">\n" +
                    "<head>\n" +
                    "    <meta charset=\"UTF-8\">\n" +
                    "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n" +
                    "    <style>\n" +
                    "        /* CSS cho email */\n" +
                    "        body {\n" +
                    "            font-family: Arial, sans-serif;\n" +
                    "            background-color: #f4f4f4;\n" +
                    "            margin: 0;\n" +
                    "            padding: 0;\n" +
                    "        }\n" +
                    "        .container {\n" +
                    "            max-width: 600px;\n" +
                    "            margin: 0 auto;\n" +
                    "            background-color: #ffffff;\n" +
                    "            padding: 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            box-shadow: 0 0 10px rgba(0,0,0,0.1);\n" +
                    "        }\n" +
                    "        h1 {\n" +
                    "            color: #333;\n" +
                    "            text-align: center" +
                    "        }\n" +
                    "        p {\n" +
                    "            color: #555;\n" +
                    "        }\n" +
                    "         i {" +
                    "               font-size: 15px;\n" +
                    "         }" +
                    "        .btn {\n" +
                    "            background-color: #007bff;\n" +
                    "            color: #fff;\n" +
                    "            text-decoration: none;\n" +
                    "            padding: 10px 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            display: inline-block;\n" +
                    "        }\n" +
                    "        .btn:hover {\n" +
                    "            background-color: #0056b3;\n" +
                    "        }\n" +
                    "    </style>\n" +
                    "</head>\n" +
                    "<body>\n" +
                    "    <div class=\"container\">\n" +
                    "        <div style=\"display: float\">\n" +
                    "            <img\n" +
                    "                style=\"margin: auto; display: block; height: 60px;\"\n" +
                    "                src='cid:logo'\n" +
                    "                alt=\"Dream Chasers\"\n" +
                    "            />\n" +
                    "        </div>" +
                    "        <h1 >Mã xác nhận đăng kí tài khoản\n</h1>\n" +
                    "        <p>Xin chào,</p>\n" +
                    "        <p>Để xác minh tài khoản của bạn, hãy nhập mã này vào Dream chasers:</p>\n" +
                    " <div style=\"background-color:#ebebeb;color:#333;font-size:40px;letter-spacing:8px;padding:16px;text-align:center\">" + code + "</div>" +
                    "        <p>Mã xác minh sẽ hết hạn sau 48 giờ.</p>\n" +
                    "        <p><strong>Nếu bạn không yêu cầu mã này</strong>, vui lòng bỏ qua tin nhắn này.</p>\n" +
                    "        <p>Trân trọng,</p>\n" +
                    "        <p>Đội ngũ phát triển <strong>Dream Chasers</strong></p>\n" +
                    "<p style=\"Margin:0;Margin-bottom:10px;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:24px;margin:0;margin-bottom:10px;padding:0;text-align:left;color:#757575\">" +
                    "<i>Đây là email được tạo tự động. Vui lòng không trả lời thư này.</i>" +
                    "</p>" +
//                    "        <a style = \" color: #fff;\" href=\"http://localhost:3000/login\" class=\"btn\">Đăng nhập vào Dolar Restaurant</a>\n" +
                    "    </div>\n" +
                    "</body>\n" +
                    "</html>\n";
            helper.setFrom(from, "Dream Chasers");
            helper.setText(htmlContent, true);
            helper.setTo(to);
            helper.addInline("logo", new ClassPathResource("/static/images/logo.png"));
            helper.setSubject("Yêu cầu xác minh email");
            javaMailSender.send(mimeMessage);
            return true;
        }
        catch(Exception e){
            System.out.println(e.getMessage());
            return false;
        }
    }

    public boolean sendMailResetPassword(String email, String code) {
        try {
        MimeMessage mimeMessage = javaMailSender.createMimeMessage();
        MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage, true);
        String htmlContent;
            htmlContent = "<!DOCTYPE html>\n" +
                    "<html lang=\"en\">\n" +
                    "<head>\n" +
                    "    <meta charset=\"UTF-8\">\n" +
                    "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n" +
                    "    <title>Dream Chasers</title>\n" +
                    "    <style>\n" +
                    "        /* CSS cho email */\n" +
                    "        body {\n" +
                    "            font-family: Arial, sans-serif;\n" +
                    "            background-color: #f4f4f4;\n" +
                    "            margin: 0;\n" +
                    "            padding: 0;\n" +
                    "        }\n" +
                    "        .container {\n" +
                    "            max-width: 600px;\n" +
                    "            margin: 0 auto;\n" +
                    "            background-color: #ffffff;\n" +
                    "            padding: 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            box-shadow: 0 0 10px rgba(0,0,0,0.1);\n" +
                    "        }\n" +
                    "        h1 {\n" +
                    "            color: #333;\n" +
                    "           text-align: center\n"+
                    "        }\n" +
                    "        p {\n" +
                    "            color: #555;\n" +
                    "            font-size: 15px;\n" +
                    "        }\n" +
                    "        .btn {\n" +
                    "            background-color: #007bff;\n" +
                    "            color: #fff;\n" +
                    "            text-decoration: none;\n" +
                    "            padding: 10px 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            display: inline-block;\n" +
                    "        }\n" +
                    "        .btn:hover {\n" +
                    "            background-color: #0056b3;\n" +
                    "        }\n" +
                    "    </style>\n" +
                    "<link rel=\"icon\" type=\"image/png\" href=\"images/logo.png\">"+

                    "</head>\n" +
                    "<body>\n" +
                    "    <div class=\"container\">\n" +
//                    "<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAABuCAYAAAD/PJegAAALRElEQVR4Xu1b7Y0TyxJtiGBJAEwGSwaEQAZ3M4AMIAPIwJsBRABkAD+R+GEkAlgJEN/g5+O9tao9VdVTMx7bM/d1SUeeOV1d3V1nuns+dkvJ28kGZxssN3izwcUG64ZRgFwip8sN/imXuR7NFuUycBPssFiWy9wPNlwFT4sN3HBYQIPeM3KxwarYYA3Hwar0mI2npYk3RazKpTZVW5Qm3pSxKpWZiHUWDlypYVpYlWBPbDcs8wG0umaLYp0apo1FUbZ0HBqmjWX517CecmHD9IEXK9u98MwpbJgHzjZoy+eMsdxg+xKVCxrmAWjXXlLPGNDOkA3zgiEa5gVDNMwLhmiYFwzRMC8YomFeMETDvGCIhnnBEA3zgiEa5gVDNMwLhmiYFwwxe9y/f3/99OnT9Zs3b7bni8Vi/erVq/XDhw+3x+w/cxhidjg5ObkS7eLiYi22Wq225Xfv3r3iYBAWvqenpybWDGGIWQCinZ2drc/Pz6+Jpg0C3rhxwwioDT7L5XJ7AXAbM4EhJguIhmUQy2EkmjY9A//+/cvFxmYqpiEmBYj26NGjrWh9DYLcvHlzu+9BQEHGcIFgdj948GDbB+7XhGCIowMJf/LkySDRtMkMRLzfv3+nxfPs+fPn2yV7gjdBhjgKsGxBNCR9LEMs7IF37tzZCvjnz59eszAyXFgTEtMQB4N35zimaQF//fq18yz0DGJiiT+imIbYG+R2/9mzZ3sTTZsW8MePH1sRZRbuw470eGKI0YEk4u7uEKJpg4ByE/Pt27f1z58/r2bhvkQUQ9vYEjgXe4AhRsfjx495fAcxLeDXr1+3s3Afy2jNZDbiIua8jARDjAZ0GslDIo9hsoTevn17/eXLl/X379+3y+ghZqAY9kidD87RCDDEqMDSeSwTAXERaQGxDx7S5MXA5AWUDuJXEndMkyUUM/Dz58/XBDzUDIS9fv3a5GpEGGIniHg4xpuMYxoERD9wIX369Gl7I3MMAWF4buQ8ce4GwhCDoWcgNu99W9ddrQiIGQgBcSODO1FPwK5Yuxr6ol/J6Qt9RxhiEKRD0ik8E41tWIrwDIk9BcnomuGyB+I5EEuoPEp4eyBiYqbKF463b9+yy86Gx4qRRNMwxGBI55CEXQ0zQgt269YtM/iMgPIY0bWE8hcI2cPxMnssQTEmnoWcwwEwxGBIh5C4viaC4SqVGcbxpQ1pJysgZiAvoWxoUyeUk4tzfJbaVVB5uOf4O8AQgyCJ7TP7IsGyg8sKKHtg1xLK8bk/LDBWBQiKVeLDhw8cMrSR35saIg0eUPahHcLphEWCyUXhJRDICAg/PQOzS+gQ4OLNCIlPU/DX4+Kx9YAhekM6gNlUMy3cDh2+qp8RUC+hmT0wulj4XPMsQEZIWbKjuD1giBR0wziuPbTjbYwsGzpB3HmOycfMDREweozgGch986DHwOPBMYTEReuZfrjnuj1hiBS4wSiZEE/7cz0+Z3CCtH/UphgEhH+fGeiB2+Uy/csAj9iekHrWR/UTMERv1P7qK5uY6NeD1MsICH/vLrQmYNS2tOv1m/34HMDLDd1n6d+OMEQvoGPYlCOLBtPFMXS5HPcVMLOEeiJx+/qceS7nYwAXvPQdX/O1H/smYIgquGO4jY4My0bUoYjnMm9Qcp4REL59Z6AHTzDNcR8jXw3cF+ARRB6hJI7nW4EhquBO1WafvMDVneL63jEjKssICL/sDOQ+Ru1GffP8eezsw+cDYIhO6EZrL4H5zpMR8dnyjIB97kJZjK72ta+uU6sb8RyHyyowRAjuWO2LA141SR3+9ToY8QztkxEQ/kPehTJ0u9xP3fch49BLKPslYIgQ3AA24MiwtrO/F8cbvD736ggyAuoPul0z0GuL+8L9yPLRuNhH80kYIo1Xlb+cjq5or7NRxyNeyvoI2GcGZvrmQYvE51wWIeNDMEQakWFfRHnUmYjXZTJgHrg+zggIP+yBmIFdd6HcVg2RH/O1mF4ZnydgiE6gEQw4shcvXlz56Toch2NGPlFZHwH7zECG13YE9pVz5gXYn+VfCrhOEoYw4IA4xx4Xmff4oONwvKHICIi29J9U1ATU/eXfCNqPx6t9NC//Jsev1/TLBI5RgSEMvIDcuDY8G+IBH9/LuF5feG0LlxHQ2wMhnicgtxO178ETUkP+XKP2F+q4Kcy2p2AIAx0Ux7iCsoYbHfmzCB1rQEevAfWzAnqPEWzcv6GQ+rh4IRj+VwL9yBi2ngHtG+IavIDgur79RQZB5Ss8x/XgtS/ICChXf+ZBnuNn+iDARY1Vp49g2jArB/5TjCE6IQMaKqKY/B0M9oNM52X2wxfLTdffpeg9UO5Coz1Qln3EzqwS+j+tao9TGdtBPMAQvbCriNowEPlPWAxI/ioMbYDve2WzgLUZyIaLA23iQoFQIpj853C0j/U1xLl3757Jq6B2Ef0LQ4QBcCzQPmOKOKaxgLXnwGOYnnk86znHFRgiBW5oiiJ6e2C0hB7aRDzOIyPiFQzhBohmn8bURBQBM18jDmksnpdnzm0FhriGKKB35eB4SiLqJbTrQf5QxjcsXh65rAOGSMFrWI6nIiIERH+mMgOjGxZvkmiOywiGMIGY68JUZuKUBOSZNyIMYcBXA5/rX41jiwgBoy/yhzRPPC9fmTIHhkhBNxKJeOyZKDMw8/+B+zJ9w8J58n61H+c3gCFceIJF4PJjiRjdxHgvs/dh3nMeH+vzmk8FhrgGviL4atEcQ/PHEJEFPOQe6D0qROiTUweGcOEFzjSi6x1aRBFQ9sBDPUb0EU/nyfP3OIIh0vCCe5zmDykiz0At4L6Mb1j0BexNAvbr4hwYoopM0K6OYoB4MYwX1XhxDVEBfOzENzF8oQDwL1q7vDQWAeVV2tCbGPQDwAtu9A/9xKcs9BlfUjAGjEVeevOYOS/RebaMYIgU9BWlua4yPhffrjr4QAohkCQAScOXAiQRn3SQUHwlAJBoJBwCoi5m4MePH9fv3r1bv3//fv3y5cutP4RAXcRAPACx5UsIxOA+cb9qYD8eozd2rpOAIVLgztQ4ry5zHt91zsAzn/h5SdGc+OrYXnyvLoPb8WJ6Zd55rZ0AhkgjasjjuWNy7vlyuZcErqfFw7FXT3x0Ocfh8y6+y6fWZ+E8vgcMsROiDnm8x2XhJUbHk2MRS/tqRDE5LnOMiOcyL6acM5eEIQbB66Qc1zrNcaKyKIZweknkNnU5fvVs9WJpRH41XpdFcWp1e8IQo6DWQW9wXjmfewnwfr36zOPYE9I75nhROxkMqdMBQ4yCro7qpHKCOTl87MXm+lyGX75x4b3Sq+OhVhb5ZesMgCF2giTE63DES5n+ZZ6PPR/2jfoiHAvKfsxH5TUfPo+4HWCIURB1sovn8tq5V6ahb2DkV3ORgBzX84nA/RNEPiPAEKMgGgh33uMisC/Xk/PIT/ja0sl1PI5/deyuOnuAIQ4KTi6XaZ7LI1/x00Lx3SfH4vMsr8s5ruezBxjiIOCBRoPlc/bXPl1xmIsQxWY/r07kF/EjwBCjoTYoSWiUdE44+3TFZB/9HMh12NcrZ3C9Lr89whB7BYvSlQCvTNeLEMX16kbn3FftMyEY4ujgZNXOvWTLuex7kY/HaV9uR4PjHBHlwiFnj4kleV+AduWNU9AwD0C7cu4UNMwDyw3KmVPQMA/8s0E5Kf/RffD/ANBua+dOYcO0sSzKFo5Dw7SxKGTPinVqmCaglTGsp6tinRumhVVRex/bojQRp4xVcZZOttPSRJwiVuVSm5QtShNxSliVxMxjwzrbbmyOD2gQ7nkZW5T2nHho4MXKsgyYdTXDVXBWLsV8W9rbmzGBXCKny3KZ4/SM+x+ZTP2qney0rQAAAABJRU5ErkJggg==\" />"+
                    "        <div style=\"display: flex\">\n" +
                    "            <img\n" +
                    "                style=\"margin: auto; display: block; height: 60px;\"\n" +
                    "                src='cid:logo'\n" +
                    "                alt=\"Dream Chasers\"\n" +
                    "            />\n" +
                    "        </div>" +
                    "        <h1>Mã khôi phục mật khẩu\n</h1>\n" +
                    "        <p>Xin chào,</p>\n" +
                    "        <p>Bạn nhân được email này vì chúng tôi đã nhận được yêu cầu đặt lại mật khẩu cho tài khoản của bạn.</p>\n" +
                    " <div style=\"background-color:#ebebeb;color:#333;font-size:40px;letter-spacing:8px;padding:16px;text-align:center\">" + code + "</div>" +
                    "        <p>Mã xác minh sẽ hết hạn sau 48 giờ.</p>\n" +
                    "        <p><strong>Nếu bạn không yêu cầu mã này</strong>, vui lòng bỏ qua tin nhắn này.</p>\n" +
                    "        <p>Trân trọng,</p>\n" +
                    "        <p>Đội ngũ phát triển <strong>Dream Chasers</strong></p>\n" +
                    "<p style=\"Margin:0;Margin-bottom:10px;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:24px;margin:0;margin-bottom:10px;padding:0;text-align:left;color:#757575\">" +
                    "<i>Đây là email được tạo tự động. Vui lòng không trả lời thư này.</i>" +
                    "</p>" +
//                    "        <a style = \" color: #fff;\" href=\"http://localhost:3000/login\" class=\"btn\">Đăng nhập vào Dolar Restaurant</a>\n" +
                    "    </div>\n" +
                    "</body>\n" +
                    "</html>\n";;
                    mimeMessageHelper.setFrom(from, "Dream Chasers");
                    mimeMessageHelper.setSubject("Yêu cầu khôi phục mật khẩu Dream Chasers");
                    mimeMessageHelper.setTo(email);
                    mimeMessageHelper.setText(htmlContent, true);
                    mimeMessageHelper.addInline("logo", new ClassPathResource("/static/images/logo.png"));
                    javaMailSender.send(mimeMessage);
        }
        catch (Exception ex) {
            System.out.println(ex.getMessage());
            return false;
        }
        return true;
    }

}

================
File: src/main/java/com/example/demo/MUX/MuxService.java
================
//package com.example.demo.MUX;
////import com.mux.ApiClient;
////import com.mux.ApiException;
////import com.mux.Configuration;
////import com.mux.auth.*;
////import com.mux.models.*;
////import com.mux.sdk.AssetsApi;
//import  com.
//public class MuxService {
//}

================
File: src/main/java/com/example/demo/repository/data/CategoryRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Category;
import com.example.demo.entity.data.Course;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import javax.swing.text.html.Option;
import java.util.List;
import java.util.Optional;
@Repository
public interface CategoryRepository extends JpaRepository<Category, Integer> {
    @Query(value = "select * from category", nativeQuery = true)
    Optional<List<Category>> getAllCategories();

    Page<Category> findAllByIsDeleted(boolean isDeleted, Pageable pageable);

    Optional<Category> findByName(String name);

    Page<Category> findByNameContaining(String name, Pageable pageable);
    Optional<List<Category>> findByCourses(Course course);
}

================
File: src/main/java/com/example/demo/repository/data/CommentRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.CommentDTO;
import com.example.demo.entity.data.Comment;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;


@Repository
public interface CommentRepository extends JpaRepository<Comment, Integer> {

    @Query(value = "SELECT * FROM comment WHERE lesson_id = :lessonId ORDER BY date DESC", nativeQuery = true)
    Page<Comment> findAllByLessonId(int lessonId, Pageable pageable);
    @Query("SELECT c FROM Comment c ORDER BY c.date DESC")
    List<Comment> findRecentComments(Pageable pageable);
    List<Comment> findAllByParentId(int parentId);
}

================
File: src/main/java/com/example/demo/repository/data/CourseRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.CourseDTO;
import com.example.demo.dto.CourseStatisticDTO;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Section;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface CourseRepository extends JpaRepository<Course, Integer> {
    @Query("SELECT COUNT(c) FROM Course c WHERE c.isDeleted = false")
    int countActiveCourses(); // Trả về kiểu int


    Optional<Course> findByTitle(String title);

    @Query(value = "SELECT * FROM section s " +
            "left join course c on s.course_id = c.id " +
            "where s.is_deleted = :isDeleted and c.id = :id " , nativeQuery = true)
    Optional<List<Section>> findSectionsById(int id, boolean isDeleted);

    Page<Course> findAllByIsDeleted(boolean isDeleted, Pageable pageable);

    @Query(value = "select * from course left join course_category on course.id = course_category.course_id where category_id = :id and title like %:title%", nativeQuery = true)
    Optional<List<Course>> findByCategoryIdAndTitle(int id, String title);

    @Query(value = "select * from course left join course_category on course.id = course_category.course_id where category_id = :id and course.is_deleted = 0", nativeQuery = true)
    Page<Course> findByCategoryId(int id, Pageable pageable);

    @Query(value = "select * from course left join course_category on course.id = course_category.course_id where category_id = :id and course.is_deleted = 1", nativeQuery = true)
    Page<Course> findByCategoryIdAndIsDeleted(int id, Pageable pageable);

    Page<Course> findByTitleContainingAndIsDeleted(String title, boolean isDeleted, Pageable pageable);


    Page<Course> findAll(Pageable pageable);

    @Query("SELECT COUNT(c) FROM Course c WHERE MONTH(c.date) = :month AND YEAR(c.date) = :year")
int countCoursesCreatedInMonth(@Param("month") int month, @Param("year") int year);

    @Query("SELECT NEW com.example.demo.dto.CourseStatisticDTO(c.id, c.title, c.thumbnail, c.price) FROM Course c WHERE MONTH(c.date) = :month AND YEAR(c.date) = :year")
    Page<CourseStatisticDTO> findCoursesCreatedInMonth(@Param("month") int month, @Param("year") int year, Pageable pageable);
}

================
File: src/main/java/com/example/demo/repository/data/FlashcardRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Flashcard;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface FlashcardRepository extends JpaRepository<Flashcard, Integer> {
}

================
File: src/main/java/com/example/demo/repository/data/FlashcardSetRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.FlashcardSet;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface FlashcardSetRepository extends JpaRepository<FlashcardSet, Integer> {
    List<FlashcardSet> findByUserId(Integer userId);
}

================
File: src/main/java/com/example/demo/repository/data/InvoiceRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.InvoiceDTO;
import com.example.demo.dto.InvoiceStatisticDTO;
import com.example.demo.entity.data.Invoice;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.lang.NonNull;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;

@Repository
public interface InvoiceRepository extends JpaRepository<Invoice, Integer> {
    @Query("SELECT new com.example.demo.dto.InvoiceDTO(i.id, i.date, i.total, i.content, i.method, new com.example.demo.dto.UserStatisticDTO(u.email, u.firstName, u.lastName, u.avatar)) FROM Invoice i JOIN i.user u WHERE i.isDelete = false")
    Page<InvoiceDTO> findAllInvoicesWithSelectedUserFields(Pageable pageable);
    @Query("SELECT new com.example.demo.dto.InvoiceDTO(i.id, i.date, i.total, i.content, i.method, new com.example.demo.dto.UserStatisticDTO(u.email, u.firstName, u.lastName, u.avatar)) FROM Invoice i JOIN i.user u WHERE i.isDelete = true")
    Page<InvoiceDTO> findAllIDeleteInvoicesWithSelectedUserFields(Pageable pageable);

    @Query("select new com.example.demo.dto.InvoiceDTO(i.id, i.date, i.total, i.content, i.method, new com.example.demo.dto.UserStatisticDTO(u.email, u.firstName, u.lastName, u.avatar)) from Invoice i JOIN i.user u WHERE function('YEAR', i.date) = ?3 and function('MONTH', i.date) = ?2 and function('DAY', i.date) = ?1")
    Page<InvoiceDTO> findAllByDate(int day, int month, int year, Pageable pageable);

    @Query("select new com.example.demo.dto.InvoiceDTO(i.id, i.date, i.total, i.content, i.method, new com.example.demo.dto.UserStatisticDTO(u.email, u.firstName, u.lastName, u.avatar)) from Invoice i JOIN i.user u WHERE i.date between ?1 and ?2")
    Page<InvoiceDTO> findAllByDateBetween(LocalDateTime start, LocalDateTime end, Pageable pageable);

    @Override
    Page<Invoice> findAll(@NonNull Pageable pageable);

    @Query("select new com.example.demo.dto.InvoiceDTO(i.id, i.date, i.total, i.content, i.method, new com.example.demo.dto.UserStatisticDTO(u.email, u.firstName, u.lastName, u.avatar)) from Invoice i JOIN i.user u WHERE (u.firstName like %?1% or u.lastName like %?1%) and i.isDelete = false")
    Page<Invoice> findAllByUserFirstNameContainingOrLastNameContaining(String name, Pageable pageable);

    @Query("SELECT COUNT(i) FROM Invoice i WHERE MONTH(i.date) = :month AND YEAR(i.date) = :year")
    int countInvoicesCreatedInMonth(@Param("month") int month, @Param("year") int year);

    @Query("SELECT SUM(i.total) FROM Invoice i WHERE MONTH(i.date) = :month AND YEAR(i.date) = :year")
    Long sumInvoiceTotalInMonth(@Param("month") int month, @Param("year") int year);

    @Query("SELECT NEW com.example.demo.dto.InvoiceStatisticDTO(i.id, i.date, i.method, i.total, i.content, new com.example.demo.dto.UserStatisticDTO(u.id, u.email, u.firstName, u.lastName, u.avatar)) FROM Invoice i JOIN i.user u WHERE MONTH(i.date) = :month AND YEAR(i.date) = :year")
    Page<InvoiceStatisticDTO> findInvoicesCreatedInMonth(@Param("month") int month, @Param("year") int year, Pageable pageable);
}

================
File: src/main/java/com/example/demo/repository/data/LessonProgressRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.LessonProgress;
import com.example.demo.entity.data.LessonProgressKey;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
@Repository
public interface LessonProgressRepository extends JpaRepository<LessonProgress, LessonProgressKey> {
    List<LessonProgress> findByUserId(int userId);
    @Query("SELECT lp FROM LessonProgress lp JOIN FETCH lp.lesson l JOIN FETCH l.section s JOIN FETCH s.course c WHERE lp.user.id = :userId")
    List<LessonProgress> findByUserIdWithCourse(@Param("userId") int userId);
}

================
File: src/main/java/com/example/demo/repository/data/LessonRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Lesson;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.Set;

@Repository
public interface LessonRepository extends JpaRepository<Lesson, Integer> {
//    @Query(value = "select l.* from lesson l where l.is_deleted = :isDeleted and l.section_id = :sectionId", nativeQuery = true)
//    Optional<List<Lesson>> findLessonsBySection(int sectionId, boolean isDeleted);
    @Query(value = "select * from lesson l where l.section_id in :list ", nativeQuery = true)
    List<Lesson> findLessonsBySections(List<Integer> list);
}

================
File: src/main/java/com/example/demo/repository/data/ListeningSectionRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.ListeningSection;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ListeningSectionRepository extends JpaRepository<ListeningSection, Integer> {
    // Additional query methods if needed
    List<ListeningSection> findByTest_Id(int testId);


}

================
File: src/main/java/com/example/demo/repository/data/MessageRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Message;
import com.example.demo.entity.user.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface MessageRepository extends JpaRepository<Message, Long> {
    List<Message> findBySenderAndReceiverOrderByTimestampAsc(User sender, User receiver);

    List<Message> findByReceiverAndIsReadFalseOrderByTimestampAsc(User receiver);
    List<Message> findByChatRoomId(String chatRoomId);
    @Query("SELECT m FROM Message m WHERE (m.sender.id = :userId1 AND m.receiver.id = :userId2) OR (m.sender.id = :userId2 AND m.receiver.id = :userId1) ORDER BY m.timestamp ASC")
    List<Message> findMessagesBetweenUsers(@Param("userId1") Integer userId1, @Param("userId2") Integer userId2);
    @Query("SELECT DISTINCT m.chatRoomId FROM Message m WHERE m.sender = :email OR m.receiver = :email")
    List<String> findChatRoomsByUser(@Param("email") String email);
    boolean existsByChatRoomId(String chatRoomId);
    @Query("SELECT DISTINCT m.sender FROM Message m WHERE m.receiver.id = :instructorId")
    List<User> findDistinctStudentsByInstructorId(@Param("instructorId") Integer instructorId);
    @Query("SELECT DISTINCT p.user FROM Progress p WHERE p.course.instructor.id = :instructorId")
    List<User> findStudentsByInstructorId(@Param("instructorId") Integer instructorId);

}

================
File: src/main/java/com/example/demo/repository/data/NotificationRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Notification;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface NotificationRepository extends JpaRepository<Notification, Integer> {

    Optional<List<Notification>> findAllByUserIdOrderByDateDesc(int userId);



}

================
File: src/main/java/com/example/demo/repository/data/PassageRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Passage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface PassageRepository extends JpaRepository<Passage, Integer> {
    // Additional query methods if needed
    List<Passage> findByTest_Id(int testId);

}

================
File: src/main/java/com/example/demo/repository/data/PostRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Post;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.lang.NonNull;

public interface PostRepository extends JpaRepository<Post, Integer> {
    Page<Post> findAll(@NonNull Pageable pageable);
    @Query("SELECT COUNT(p) FROM Post p WHERE p.isDeleted = false")
    int countActivePosts(); // Trả về kiểu int

}

================
File: src/main/java/com/example/demo/repository/data/ProgressRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.ProgressDTO;
import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;
import java.util.Optional;

public interface ProgressRepository extends JpaRepository<Progress, Integer> {
    Optional<Progress> findByCourseIdAndUser(int courseId, User user);
    List<Progress> findByUser(User user);
    boolean existsByCourse_IdAndUser_Id(int courseId, int userId);
    Optional<Progress> findByCourse_IdAndUser(int courseId, User user);
    List<ProgressDTO> findAllByUserEmail(String email);
    @Query("SELECT new com.example.demo.dto.ProgressDTO(p.course) FROM Progress p WHERE p.user.email = :email")
    List<ProgressDTO> findAllDTOByUserEmail(@Param("email") String email);
}

================
File: src/main/java/com/example/demo/repository/data/QuestionOptionRepository.java
================
package com.example.demo.repository.data;
import com.example.demo.entity.data.QuestionOption;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
@Repository
public interface QuestionOptionRepository extends JpaRepository<QuestionOption,Integer> {

}

================
File: src/main/java/com/example/demo/repository/data/QuestionRepository.java
================
package com.example.demo.repository.data;
import com.example.demo.entity.data.Question;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface QuestionRepository extends JpaRepository<Question,Integer> {
    List<Question> findByPassage_Test_Id(int testId);
    List<Question> findByListeningSection_Test_Id(int testId);


}

================
File: src/main/java/com/example/demo/repository/data/SectionRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Section;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface SectionRepository extends JpaRepository<Section, Integer> {
    @Query(value = "select s.* from section s where s.course_id = :courseId and s.is_deleted = :isDeleted", nativeQuery = true)
    Optional<List<Section>> findSectionsByCourse(int courseId, boolean isDeleted);
}

================
File: src/main/java/com/example/demo/repository/data/TestProgressRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.TestProgress;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface TestProgressRepository  extends JpaRepository<TestProgress, Integer> {
}

================
File: src/main/java/com/example/demo/repository/data/TestRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Test;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface TestRepository extends JpaRepository<Test, Integer> {
    // Additional query methods if needed
    @EntityGraph(attributePaths = {"passages.questions"})
    Optional<Test> findById(int id);
    @EntityGraph(attributePaths = {"passages.questions"})
    @Query("SELECT t FROM Test t WHERE t.id = :id")
    Optional<Test> findByIdWithPassagesAndQuestions(@Param("id") int id);

    @EntityGraph(attributePaths = {"listeningSections.questions"})
    @Query("SELECT t FROM Test t WHERE t.id = :id")
    Optional<Test> findByIdWithSectionsAndQuestions(@Param("id") int id);


}

================
File: src/main/java/com/example/demo/repository/data/UserEssayRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.UserEssayDTO;
import com.example.demo.entity.data.UserEssay;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface UserEssayRepository extends JpaRepository<UserEssay,Integer> {
    List<UserEssay>findAllByUserId(int userId);
    @Query("SELECT COUNT(e) FROM UserEssay e WHERE e.user.id = :userId")
    long countUserEssaysByUserId(@Param("userId") int userId);

    @Query("SELECT AVG(e.score) FROM UserEssay e WHERE e.user.id = :userId")
    Double findAverageEssayScoreByUserId(@Param("userId") int userId);

    @Query("SELECT e FROM UserEssay e WHERE e.user.id = :userId ORDER BY e.submissionTime DESC")
    List<UserEssay> findUserEssaysByUserId(@Param("userId") int userId);
    @Query("SELECT COUNT(e) FROM UserEssay e")
    long countAllEssays();

    @Query("SELECT AVG(e.score) FROM UserEssay e")
    Double findAverageEssayScore();

    @Query("SELECT e FROM UserEssay e ORDER BY e.submissionTime DESC")
    List<UserEssay> findAllEssaysOrderedBySubmissionTime();
    @Query("SELECT new com.example.demo.dto.UserEssayDTO(e.id, e.content, e.submissionTime, e.score, u.email) " +
            "FROM UserEssay e JOIN e.user u ORDER BY e.submissionTime DESC")
    List<UserEssayDTO> findAllEssaysWithUserNames();

}

================
File: src/main/java/com/example/demo/repository/data/UserResponseRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.UserResponse;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserResponseRepository extends JpaRepository<UserResponse, Integer> {

}

================
File: src/main/java/com/example/demo/repository/data/VocabularyRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Vocabulary;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface VocabularyRepository extends JpaRepository<Vocabulary, Integer> {
    Vocabulary findByWord(String word);
}

================
File: src/main/java/com/example/demo/repository/data/WritingTaskRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.WritingTask;
import org.springframework.data.jpa.repository.JpaRepository;

public interface WritingTaskRepository extends JpaRepository<WritingTask,Integer> {
}

================
File: src/main/java/com/example/demo/repository/TokenRepository.java
================
package com.example.demo.repository;

import com.example.demo.jwt.Token;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface TokenRepository extends JpaRepository<Token, Integer> {
    public Optional<Token> findByToken(String token);
}

================
File: src/main/java/com/example/demo/repository/UserRepository.java
================
package com.example.demo.repository;

import com.example.demo.dto.UserStatisticDTO;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User, Integer> {
    Optional<User> findByEmail(String email);
    @Query("SELECT COUNT(u) FROM User u WHERE u.role = :role")
    int countByRole(@Param("role") Role role);

    Page<User> findByIsDeletedFalse(Pageable pageable);

    Optional<User> findByPhoneNumber(String phoneNumber);

    @Query(value = "select * from user where role = :role", nativeQuery = true)
    Page<User> findByRole(String role, Pageable pageable);

    @Query(value = "select u from User u where (u.firstName like %?1% or u.lastName like %?2%) and u.isDeleted = ?3")
    Page<User> findByFirstNameContainingOrLastNameContainingAndAndDeleted(String firstName, String lastName, boolean isDelete, Pageable pageable);

    Page<User> findAllByIsDeleted(boolean isDeleted, Pageable pageable);

    @Query("SELECT COUNT(u) FROM User u WHERE MONTH(u.createdAt) = :month AND YEAR(u.createdAt) = :year")
    int countUsersRegisteredInMonth(@Param("month") int month, @Param("year") int year);

    @Query("SELECT NEW com.example.demo.dto.UserStatisticDTO(u.id, u.email, u.firstName, u.lastName, u.avatar) FROM User u WHERE MONTH(u.createdAt) = :month AND YEAR(u.createdAt) = :year")
    Page<UserStatisticDTO> findUsersRegisteredInMonth(@Param("month") int month, @Param("year") int year, Pageable pageable);

}

================
File: src/main/java/com/example/demo/service/CategoryService.java
================
package com.example.demo.service;

import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Category;
import com.example.demo.entity.data.Course;
import com.example.demo.repository.data.CategoryRepository;
import com.example.demo.repository.data.CourseRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional
public class CategoryService {
    private final CategoryRepository categoryRepository;
    private final CourseRepository courseRepository;

    public ResponseObject getAllCategory(int page, int size) {
        var categories = categoryRepository.findAllByIsDeleted(false, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(categories).build();
    }
    public List<Category> getCategoriesByIds(List<Integer> ids) {
        // Validate and fetch categories
        return categoryRepository.findAllById(ids);
    }
    public ResponseObject getAllCategoryDeleted(int page, int size) {
        var categories = categoryRepository.findAllByIsDeleted(true, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(categories).build();
    }

    public Category getById(int id) {
        var cate = categoryRepository.findById(id).orElse(null);
        if(cate == null) {
            return null;
        }
        return cate;
    }

    public void updateCategoriesForCourse(Course course, List<Integer> categoryIds) {
        var categories = getCategoriesByIds(categoryIds);
        course.setCategories(categories);
    }
    public void addCategoriesForCourse(Course course, List<Integer> categoryIds) {
        var categories = getCategoriesByIds(categoryIds);
        course.getCategories().addAll(categories);
    }

    public ResponseObject getByTitle(String title, int page, int size) {
        var result = categoryRepository.findByNameContaining(title, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get data successfully").content(result).build();
    }

    public ResponseObject updateCategoryById(int id, Category category) {
        var tempCategory = categoryRepository.findById(id).orElse(null);
        var existName = categoryRepository.findByName(category.getName()).orElse(null);
        if (tempCategory == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Category does not exist!").build();
        }
        if(existName != null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("The category name existed!").build();
        }
        categoryRepository.save(category);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update successfully").build();
    }

    public ResponseObject createCategory(String name)
    {
        var result = categoryRepository.findByName(name).orElse(null);
        if(result == null) {
            result = Category.builder().name(name).build();
            categoryRepository.save(result);
            return ResponseObject.builder().status(HttpStatus.OK).mess("Create category successfully").build();
        }
        return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Category existed").build();
    }

    public ResponseObject softDelete(int id) {
        var category = categoryRepository.findById(id).orElse(null);
        if (category == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Category does not exist!").build();
        }
        category.setDeleted(true);
        for (Course course : category.getCourses()) {
            course.getCategories().remove(category);
            courseRepository.save(course);
        }
        category.setCourses(null);
        categoryRepository.save(category);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject hardDelete(int id) {
        var category = categoryRepository.findById(id).orElse(null);
        if (category == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        categoryRepository.delete(category);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject restoreCategoryById(int id) {
        var category = categoryRepository.findById(id).orElse(null);
        if(category == null) return ResponseObject.builder().mess("Category does not exist").status(HttpStatus.BAD_REQUEST).build();
        category.setDeleted(false);
        return ResponseObject.builder().mess("Restore successfully").status(HttpStatus.OK).build();
    }
}

================
File: src/main/java/com/example/demo/service/ChatService.java
================
package com.example.demo.service;

import com.example.demo.dto.UserDTO;
import com.example.demo.entity.data.Message;
import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.User;
import com.example.demo.entity.data.Course;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.repository.data.MessageRepository;
import com.example.demo.repository.data.ProgressRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ChatService {

    private final MessageRepository messageRepository;
    private final CourseRepository courseRepository;
    private final UserRepository userRepository;
    private final ProgressRepository progressRepository;
    /**
     * Retrieve a list of instructors for courses the user has joined.
     *
     * @param userEmail the email of the user
     * @return a list of distinct instructors
     */


    public List<UserDTO> getInstructorsForUserCourses(Integer userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("User not found"));

        // Fetch all progress records for the user
        List<Progress> progresses = progressRepository.findByUser(user);

        // Extract courses from progress records
        List<Course> courses = progresses.stream()
                .map(Progress::getCourse)
                .collect(Collectors.toList());

        // Extract instructors from courses
        List<User> instructors = courses.stream()
                .map(Course::getInstructor)
                .distinct()
                .collect(Collectors.toList());

        // Convert instructors to UserDTO
        List<UserDTO> instructorDTOs = instructors.stream()
                .map(this::getUserDTOFromUser)
                .collect(Collectors.toList());

        return instructorDTOs;
    }
    public UserDTO getUserDTOFromUser(User user) {
        return UserDTO.builder()
                .id(user.getId())
                .avatar(user.getAvatar())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .phoneNumber(user.getPhoneNumber())
                .role(user.getRole())
                .build();
    }
    public String createOrGetChatRoom(String userEmail, String instructorEmail) {
        // Retrieve User entities based on email
        User sender = userRepository.findByEmail(userEmail)
                .orElseThrow(() -> new ResourceNotFoundException("User not found with email: " + userEmail));
        User receiver = userRepository.findByEmail(instructorEmail)
                .orElseThrow(() -> new ResourceNotFoundException("User not found with email: " + instructorEmail));

        // Generate a unique chat room ID
        String chatRoomId = generateChatRoomId(userEmail, instructorEmail);

        // Check if the chat room already exists
        boolean chatExists = messageRepository.existsByChatRoomId(chatRoomId);
        if (!chatExists) {
            // Create an initial message to initialize the chat room
            Message initialMessage = Message.builder()
                    .sender(sender) // Use User entity
                    .receiver(receiver) // Use User entity
                    .content("Chat started.")
                    .timestamp(LocalDateTime.now())
                    .chatRoomId(chatRoomId)
                    .build();
            messageRepository.save(initialMessage);
        }

        return chatRoomId;
    }

    /**
     * Generate a consistent chat room ID based on user and instructor emails.
     *
     * @param userEmail       the email of the user
     * @param instructorEmail the email of the instructor
     * @return a unique chat room ID
     */
    private String generateChatRoomId(String userEmail, String instructorEmail) {
        return userEmail.compareTo(instructorEmail) < 0
                ? userEmail + "_" + instructorEmail
                : instructorEmail + "_" + userEmail;
    }

    /**
     * Initialize a chat room with a placeholder message.
     *
     * @param chatRoomId      the ID of the chat room
     * @param userEmail       the email of the user
     * @param instructorEmail the email of the instructor
     */
    private void initializeChatRoom(String chatRoomId, String userEmail, String instructorEmail) {
        Message initialMessage = Message.builder()
                .sender(userRepository.findByEmail(userEmail)
                        .orElseThrow(() -> new IllegalArgumentException("User not found: " + userEmail)))
                .receiver(userRepository.findByEmail(instructorEmail)
                        .orElseThrow(() -> new IllegalArgumentException("Instructor not found: " + instructorEmail)))
                .content("Chat started.")
                .timestamp(LocalDateTime.now())
                .chatRoomId(chatRoomId)
                .isRead(false)
                .build();

        messageRepository.save(initialMessage);
    }

    /**
     * Validate the email addresses of the user and instructor.
     *
     * @param userEmail       the email of the user
     * @param instructorEmail the email of the instructor
     */
    private void validateEmails(String userEmail, String instructorEmail) {
        if (userEmail == null || userEmail.trim().isEmpty()) {
            throw new IllegalArgumentException("User email cannot be null or empty.");
        }
        if (instructorEmail == null || instructorEmail.trim().isEmpty()) {
            throw new IllegalArgumentException("Instructor email cannot be null or empty.");
        }
    }
}

================
File: src/main/java/com/example/demo/service/CommentService.java
================
package com.example.demo.service;

import com.example.demo.dto.CommentDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Comment;
import com.example.demo.entity.data.Notification;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CommentRepository;
import com.example.demo.repository.data.LessonRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional
public class CommentService {
    private final UserRepository userRepository;
    private  final CommentRepository commentRepository;
    private  final LessonRepository lessonRepository;

    public Comment getById(int id) {
        return commentRepository.findById(id).orElse(null);
    }
    public List<Comment> getRecentComments(int limit) {
        Pageable pageable = PageRequest.of(0, limit);
        return commentRepository.findRecentComments(pageable);
    }
    public void deleteById(int id) {
        var comment = commentRepository.findById(id).orElse(null);
        if (comment == null) {
            return ;
        }
        List<Comment> subComments = commentRepository.findAllByParentId(id);

        if(!subComments.isEmpty()) {
            for (Comment subComment : subComments) {
                subComment.getUser().getComments().remove(subComment);
                commentRepository.delete(subComment);
            }
        }
        commentRepository.delete(comment);
    }
    public Notification saveNotification(CommentDTO commentDTO) {
        var sendToUser = userRepository.findByEmail(commentDTO.getReplyToUser()).orElse(null);
        if (sendToUser == null) {
            System.out.println("sendToUser not found");
            return null;
        }
        Notification notification = Notification.builder()
                .content(commentDTO.getContent())
                .date(LocalDateTime.now())
                .fromUser(commentDTO.getUserName())
                .user(sendToUser)
                .img(commentDTO.getAvatar())
                .path(commentDTO.getPath())
                .content("Mentioned you in a comment")
                .build();
        if(notification == null)
        {
            System.out.println("Notification is null");
        }
        sendToUser.getNotifications().add(notification);
        userRepository.save(sendToUser);
        return notification;
    }

    public Comment saveComment(CommentDTO commentDTO) {
        var user = userRepository.findByEmail(commentDTO.getEmail()).orElse(null);
        var lesson = lessonRepository.findById(commentDTO.getLessonId()).orElse(null);
        if (user == null || lesson == null) {
            System.out.println("user || lesson not found");
            return null;
        }
        Comment comment = Comment.builder()
                .userEmail(commentDTO.getEmail())
                .userName(commentDTO.getUserName())
                .avatar(commentDTO.getAvatar())
                .user(user)
                .content(commentDTO.getContent())
                .lesson(lesson)
                .parentId(commentDTO.getParentId())
                .date(LocalDateTime.now())
                .replyToUser(commentDTO.getReplyToUser())
                .replyToUserName(commentDTO.getReplyToUserName())
                .build();
        return commentRepository.save(comment);
    }

    public ResponseObject getCommentByLessonId(int lessonId) {
        var comments = commentRepository.findAllByLessonId(lessonId, PageRequest.of(0, Integer.MAX_VALUE));
        return ResponseObject.builder().status(HttpStatus.OK).content(comments).build();
    }
}

================
File: src/main/java/com/example/demo/service/CourseService.java
================
package com.example.demo.service;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.CourseStatisticDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.SectionDTO;
import com.example.demo.entity.data.*;
import com.example.demo.entity.user.User;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.dto.CourseDTO;
import com.example.demo.repository.data.LessonProgressRepository;
import com.example.demo.repository.data.ProgressRepository;
import com.example.demo.repository.data.SectionRepository;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.atomic.AtomicReference;
import java.util.stream.Collectors;

@Data
@RequiredArgsConstructor
@Service
@Transactional
public class CourseService {
    private final CourseRepository courseRepository;
    private final UserRepository userRepository;
    private final LessonProgressRepository lessonProgressRepository;
    private final CloudService cloudService;
    private final CategoryService categoryService;
    private final LessonService lessonService;
    private final SectionService sectionService;
    private final ProgressRepository progressRepository;
    private final UserService userService; // Fetch instructors and students
    public ResponseObject getCourseById(int id, boolean isDeleted) {
        Course course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().mess("Course is not exist!").status(HttpStatus.BAD_REQUEST).build();
        }
        var sections = sectionService.getSectionsByCourse(course, isDeleted);
        course.setSections(sections);
        return ResponseObject.builder().content(course).status(HttpStatus.OK).build();
    }

    public ResponseObject getAllCourse(int page, int size) {
        var courses = courseRepository.findAllByIsDeleted(false, PageRequest.of(page, size));
        System.out.println("Gello"+courses);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(courses).build();
    }

    public ResponseObject getAllCourseDeleted(int page, int size) {
        var courses = courseRepository.findAllByIsDeleted(true, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(courses).build();
    }
    public boolean isUserEnrolled(int courseId, int userId) {
        return progressRepository.existsByCourse_IdAndUser_Id(courseId, userId);
    }
    private void unlockFirstLessonForUser(int courseId, int userId) {
        Course course = courseRepository.findById(courseId).orElseThrow();
        User user = userRepository.findById(userId).orElseThrow();

        List<Section> sections = course.getSections();
        sections.sort(Comparator.comparingInt(Section::getId));
        if (!sections.isEmpty()) {
            Section firstSection = sections.get(0);
            List<Lesson> lessons = firstSection.getLessons();
            lessons.sort(Comparator.comparingInt(Lesson::getId));
            if (!lessons.isEmpty()) {
                Lesson firstLesson = lessons.get(0);
                LessonProgressKey key = new LessonProgressKey(userId, firstLesson.getId());
                LessonProgress lessonProgress = new LessonProgress();
                lessonProgress.setId(key);
                lessonProgress.setUser(user);
                lessonProgress.setLesson(firstLesson);
                lessonProgress.setUnlocked(true);
                lessonProgressRepository.save(lessonProgress);
            }

        }
    }

    public ResponseObject updateCourse(int id, CourseDTO courseDTO) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().mess("Course does not exist!").status(HttpStatus.BAD_REQUEST).build();
        }

        course.setThumbnail(courseDTO.getThumbnail());
        course.setVideo(courseDTO.getVideo());
        course.setDescription(courseDTO.getDescription());
        course.setDiscount(courseDTO.getDiscount());
        course.setTitle(courseDTO.getTitle());

        sectionService.updateSections(courseDTO, course);

        if (courseDTO.isEditedCategories()) {
            categoryService.updateCategoriesForCourse(course, courseDTO.getCategories());
        }

        courseRepository.save(course);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update successfully").build();
    }

    public ResponseObject addCourse(CourseDTO request) {
        if (courseRepository.findByTitle(request.getTitle()).isPresent()) {
            return ResponseObject.builder().mess("Course already exists").status(HttpStatus.BAD_REQUEST).build();
        }

        // Fetch instructor
        var instructor = userService.findByEmail(request.getInstructor());
        if (instructor == null) {
            return ResponseObject.builder().mess("Instructor not found").status(HttpStatus.BAD_REQUEST).build();
        }
        Course course = Course.builder()
                .title(request.getTitle())
                .price(request.getPrice())
                .discount(request.getDiscount())
                .description(request.getDescription())
                .date(LocalDateTime.now())
                .thumbnail(request.getThumbnail())
                .video(request.getVideo())
                .instructor(instructor)
                .categories(categoryService.getCategoriesByIds(request.getCategories()))
                .build();

        for (SectionDTO sectionDTO : request.getSections()) {
            Section section = Section.builder()
                    .title(sectionDTO.getTitle())
                    .course(course)
                    .build();

            if (sectionDTO.getLessons() != null) {
                lessonService.addLessonForSection(sectionDTO.getLessons(), section, null, 0);
            }

            course.getSections().add(section);
        }

        // Lưu Course
        courseRepository.save(course);

        return ResponseObject.builder().mess("Course created successfully").status(HttpStatus.OK).build();
    }

    public ResponseObject softDelete(int id) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content(courseRepository.findAllByIsDeleted(false, PageRequest.of(0, 5))).mess("Course is not exist!").build();
        }
        course.setDeleted(true);
        courseRepository.save(course);
        return ResponseObject.builder().mess("Delete course successfully!").content(courseRepository.findAllByIsDeleted(false, PageRequest.of(0, 5))).status(HttpStatus.OK).build();
    }

    public ResponseObject hardDelete(int id) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        courseRepository.delete(course);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject getAllCourseByCategoryIdAndTitle(int id, String title) {
        List<Course> result = courseRepository.findAll();
        if (!Objects.equals(title, ""))
            result = result.stream().filter(c -> c.getTitle().contains(title)).toList();
        if (id != -1) {
            result = result.stream().filter(c -> c.getCategories().stream().anyMatch(ca -> ca.getId() == id)).toList();
        }
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject getAllCourseByCategoryId(int id, int page, int size) {
        if (id == -1) {
            return ResponseObject.builder().status(HttpStatus.OK).content(courseRepository.findAll(PageRequest.of(page, size))).mess("Get data successfully").build();
        }
        var result = courseRepository.findByCategoryId(id, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject getAllCourseDeletedByCategoryId(int id, int page, int size) {
        if (id == -1) {
            return ResponseObject.builder().status(HttpStatus.OK).content(courseRepository.findAllByIsDeleted(true, PageRequest.of(page, size))).mess("Get data successfully").build();
        }
        var result = courseRepository.findByCategoryIdAndIsDeleted(id, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject getAllCourseByCourseTitle(String title, boolean isDeleted, int page, int size) {
        var result = courseRepository.findByTitleContainingAndIsDeleted(title, isDeleted, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject restoreCourseById(int id) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null)
            return ResponseObject.builder().mess("Course does not exist").status(HttpStatus.BAD_REQUEST).build();
        course.setDeleted(false);
        courseRepository.save(course);
        return ResponseObject.builder().content(courseRepository.findAllByIsDeleted(true, PageRequest.of(0, 5))).mess("Restore successfully").status(HttpStatus.OK).build();
    }

    @Transactional
    public boolean enrollUser(int courseId, int userId) {
        // Check if the user is already enrolled in the course
        if (progressRepository.existsByCourse_IdAndUser_Id(courseId, userId)) {
            return false; // User is already enrolled
        }

        // Find course and user
        Course course = courseRepository.findById(courseId)
                .orElseThrow(() -> new RuntimeException("Course not found"));
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("User not found"));

        // Create a new Progress entry to represent the enrollment
        Progress progress = Progress.builder()
                .course(course)
                .user(user)
                .lessonIds(new ArrayList<>()) // Initialize if needed
                .build();

        // Save the Progress entity
        progressRepository.save(progress);

        return true; // User enrolled successfully
    }




    public ResponseObject getAllByPageable(int page, int size) {
        Pageable pageable = PageRequest.of(page, size);
        var courses = courseRepository.findAllByIsDeleted(false, pageable);
        System.out.println("Fetched Courses: " + courses.getContent());
        return ResponseObject.builder().status(HttpStatus.OK).content(courses).build();
    }
    public ResponseObject getAllcoursesNotdeleted(int page, int size) {
        Pageable pageable = PageRequest.of(page, size);
        var courses = courseRepository.findAllByIsDeleted(false, pageable);
        System.out.println("Fetched Courses: " + courses.getContent());
        return ResponseObject.builder().status(HttpStatus.OK).content(courses).build();
    }

}

================
File: src/main/java/com/example/demo/service/DashboardService.java
================
package com.example.demo.service;

import com.example.demo.entity.user.Role;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.repository.data.PostRepository;
import org.springframework.stereotype.Service;

import java.util.Map;

@Service
public class DashboardService {

    private final CourseRepository courseRepository;
    private final UserRepository userRepository;
    private final PostRepository postRepository;

    public DashboardService(CourseRepository courseRepository, UserRepository userRepository, PostRepository postRepository) {
        this.courseRepository = courseRepository;
        this.userRepository = userRepository;
        this.postRepository = postRepository;
    }

    public Map<String, Integer> getDashboardStats() {
        int totalCourses = courseRepository.countActiveCourses(); // Trả về int
        int totalStudents = userRepository.countByRole(Role.USER);
        int totalInstructors = userRepository.countByRole(Role.INSTRUCTOR);
        int totalPosts = postRepository.countActivePosts(); // Trả về int

        return Map.of(
                "totalCourses", totalCourses,
                "totalStudents", totalStudents,
                "totalInstructors", totalInstructors,
                "totalPosts", totalPosts
        );
    }
}

================
File: src/main/java/com/example/demo/service/ExternalEssayEvaluationService.java
================
package com.example.demo.service;

import com.example.demo.dto.EssayFeedback;
import com.example.demo.dto.OpenAIRequest;
import com.example.demo.dto.OpenAIResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;

import java.util.Arrays;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
@RequiredArgsConstructor
public class ExternalEssayEvaluationService {

    @Value("${openai.api.key}")
    private String apiKey;

    @Value("${openai.api.url}")
    private String apiUrl;

    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper objectMapper = new ObjectMapper();

    private static final long COOLDOWN_PERIOD = 3000; // 3 seconds
    private long lastRequestTime = 0;

    public EssayFeedback evaluateEssay(String prompt, String essayContent) {
        // Kiểm tra cooldown nếu cần thiết
        long currentTime = System.currentTimeMillis();
        if (currentTime - lastRequestTime < COOLDOWN_PERIOD) {
            try {
                Thread.sleep(COOLDOWN_PERIOD - (currentTime - lastRequestTime));
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        lastRequestTime = System.currentTimeMillis();

        // Tạo đối tượng OpenAIRequest
        OpenAIRequest requestPayload = new OpenAIRequest();
        requestPayload.setModel("gpt-4o-mini");
        requestPayload.setMessages(Arrays.asList(
                new OpenAIRequest.Message("system", "You are an IELTS examiner."),
                new OpenAIRequest.Message("user", buildUserMessage(prompt, essayContent))
        ));

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(apiKey);

        HttpEntity<OpenAIRequest> entity = new HttpEntity<>(requestPayload, headers);

        try {
            ResponseEntity<String> response = restTemplate.postForEntity(apiUrl, entity, String.class);

            if (response.getStatusCode() == HttpStatus.OK) {
                // Ghi log phản hồi từ AI để kiểm tra
                System.out.println("AI Response Body: " + response.getBody());

                OpenAIResponse openAIResponse = objectMapper.readValue(response.getBody(), OpenAIResponse.class);
                if (openAIResponse.getChoices() != null && !openAIResponse.getChoices().isEmpty()) {
                    String content = openAIResponse.getChoices().get(0).getMessage().getContent();
                    // Ghi log nội dung phần content
                    System.out.println("AI Content for Deserialization: " + content);

                    // Deserialize chỉ phần content vào EssayFeedback
                    return objectMapper.readValue(content, EssayFeedback.class);
                } else {
                    throw new RuntimeException("No choices found in AI response.");
                }
            } else {
                throw new RuntimeException("Failed to get response from AI. Status code: " + response.getStatusCode());
            }
        } catch (HttpClientErrorException.BadRequest e) {
            // Ghi log lỗi chi tiết từ OpenAI
            System.err.println("Bad Request Error: " + e.getResponseBodyAsString());
            throw new RuntimeException("Bad Request: " + e.getResponseBodyAsString(), e);
        } catch (Exception e) {
            throw new RuntimeException("Error processing AI response: " + e.getMessage(), e);
        }
    }

    private String buildUserMessage(String prompt, String essayContent) {
        return "Please evaluate the following essay focusing on grammatical and vocabulary errors. Provide the feedback strictly in JSON format with the following structure:\n" +
                "{\n" +
                "  \"grammarErrors\": [\n" +
                "    {\n" +
                "      \"sentence\": \"Incorrect sentence here.\",\n" +
                "      \"error\": \"Subject-verb agreement.\",\n" +
                "      \"recommendation\": \"Corrected sentence here.\"\n" +
                "    }\n" +
                "  ],\n" +
                "  \"vocabularyErrors\": [\n" +
                "    {\n" +
                "      \"word\": \"incorrectWord\",\n" +
                "      \"error\": \"Wrong usage.\",\n" +
                "      \"recommendation\": \"Suggested word here.\"\n" +
                "    }\n" +
                "  ],\n" +
                "  \"overallFeedback\": \"Detailed overall feedback here.\",\n" +
                "  \"overallScore\": 6\n" +
                "}\n\n" +
                "**Prompt:**\n" + prompt + "\n\n" +
                "**Essay:**\n" + essayContent;
    }

    public double calculateScore(String feedback) {
        // Sử dụng regex để tìm điểm số từ 0 đến 9, có thể có dấu chấm thập phân
        Pattern pattern = Pattern.compile("(\\b[0-9](?:\\.[0-9])?\\b)");
        Matcher matcher = pattern.matcher(feedback);
        double score = 0.0;
        while (matcher.find()) {
            double potentialScore = Double.parseDouble(matcher.group());
            if (potentialScore >= 0.0 && potentialScore <= 9.0) {
                score = potentialScore;
                break;
            }
        }
        return score;
    }
}

================
File: src/main/java/com/example/demo/service/FlashcardService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.Flashcard;
import com.example.demo.entity.data.FlashcardSet;
import com.example.demo.entity.data.Vocabulary;
import com.example.demo.repository.data.FlashcardRepository;
import com.example.demo.repository.data.FlashcardSetRepository;
import com.example.demo.repository.data.VocabularyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class FlashcardService {

    @Autowired
    private FlashcardSetRepository flashcardSetRepository;

    @Autowired
    private VocabularyRepository vocabularyRepository;

    @Autowired
    private FlashcardRepository flashcardRepository;

    public List<FlashcardSet> getFlashcardSetsByUserId(Integer userId){
        return flashcardSetRepository.findByUserId(userId);
    }

    public FlashcardSet createFlashcardSet(Integer userId, String title, String description, List<Integer> vocabularyIds){
        FlashcardSet set = new FlashcardSet();
        set.setTitle(title);
        set.setDescription(description);
        // Assume you have a method to get user by id
        // set.setUser(userService.getUserById(userId));

        FlashcardSet savedSet = flashcardSetRepository.save(set);

        for(Integer vocabId : vocabularyIds){
            Vocabulary vocab = vocabularyRepository.findById(vocabId)
                    .orElseThrow(() -> new RuntimeException("Vocabulary not found with id " + vocabId));
            Flashcard flashcard = new Flashcard();
            flashcard.setSet(savedSet);
            flashcard.setVocabulary(vocab);
            flashcardRepository.save(flashcard);
        }

        return savedSet;
    }

    // Thêm các phương thức khác như update, delete nếu cần
}

================
File: src/main/java/com/example/demo/service/InvoiceService.java
================
package com.example.demo.service;

import com.example.demo.dto.InvoiceDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.UserDTO;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Invoice;
import com.example.demo.entity.data.MethodPayment;
import com.example.demo.entity.user.User;
import com.example.demo.repository.data.InvoiceRepository;
import com.fasterxml.jackson.dataformat.xml.ser.UnwrappingXmlBeanSerializer;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

import java.lang.reflect.Method;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Locale;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class InvoiceService {
    private final InvoiceRepository invoiceRepository;

    public ResponseObject searchByName(String name, int page, int size) {
        return ResponseObject.builder().status(HttpStatus.OK).content(invoiceRepository.findAllByUserFirstNameContainingOrLastNameContaining(name, PageRequest.of(page, size))).build();
    }

    public ResponseObject softDelete(int id) {
        var invoice = invoiceRepository.findById(id).orElse(null);
        if (invoice == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Invoice not found").build();
        }
        invoice.setDelete(true);
        invoiceRepository.save(invoice);
        return ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Deleted successfully")
                .content(invoiceRepository.findAllInvoicesWithSelectedUserFields(PageRequest.of(0,5)))
                        .build();
    }

    public ResponseObject restoreInvoice(int id) {
        var invoice = invoiceRepository.findById(id).orElse(null);
        if (invoice == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST)
                    .mess("Invoice not found")
                    .content(invoiceRepository.findAllIDeleteInvoicesWithSelectedUserFields(PageRequest.of(0, 5)))
                    .build();
        }
        invoice.setDelete(false);
        invoiceRepository.save(invoice);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Restore successfully").content(invoiceRepository.findAllIDeleteInvoicesWithSelectedUserFields(PageRequest.of(0, 5))).build();
    }
    public ResponseObject getAll(int page, int size) {
//            var invoices = invoiceRepository.findAll(PageRequest.of(page, size));
//            var invoiceDTOs = invoices.stream().map(invoice -> InvoiceDTO.builder()
//                            .id(invoice.getId())
//                            .date(invoice.getDate())
//                            .total(invoice.getTotal())
//                            .content(invoice.getContent())
//                            .user(UserDTO.builder()
//                                    .email(invoice.getUser().getEmail())
//                                    .firstName(invoice.getUser().getFirstName())
//                                    .lastName(invoice.getUser().getLastName())
//                                    .avatar(invoice.getUser().getAvatar())
//                                    .build())
//                            .course(invoice.getCourse())
//                            .build())
//                    .toList(); // return immutable list
//                    .collect(Collectors.toList()); return mutable list
        return ResponseObject.builder().status(HttpStatus.OK).content(invoiceRepository.findAllInvoicesWithSelectedUserFields(PageRequest.of(page, size))).build() ;
    }
    public ResponseObject getAllDelete(int page, int size) {
        return ResponseObject.builder().status(HttpStatus.OK).content(invoiceRepository.findAllIDeleteInvoicesWithSelectedUserFields(PageRequest.of(page, size))).build() ;
    }
    public void saveForUser(User user, Course course, MethodPayment methodPayment) {
        Invoice invoice = Invoice.builder()
                .user(user)
                .date(LocalDateTime.now())
                .method(methodPayment)
                .content("Enroll for course " + course.getTitle())
                .course(course)
                .total(course.getPrice())
                .build();
         invoiceRepository.save(invoice);
    }

    public ResponseObject getByDateRange(String start, String end, int page, int size) {
        LocalDateTime startDate = LocalDateTime.parse(start);
        Page<InvoiceDTO> invoices = null;
        if(Objects.equals(start, end)) {
            int day = startDate.getDayOfMonth();
            int month = startDate.getMonthValue();
            int year = startDate.getYear();
             invoices = invoiceRepository.findAllByDate(day, month, year, PageRequest.of(page, size));
        }
        else {
                LocalDateTime endDate = LocalDateTime.parse(end);
                invoices = invoiceRepository.findAllByDateBetween(startDate, endDate, PageRequest.of(page, size));
        }
        return ResponseObject.builder().status(HttpStatus.OK).content(invoices).build();
    }

}

================
File: src/main/java/com/example/demo/service/LessonProgressService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.*;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.LessonProgressRepository;
import com.example.demo.repository.data.LessonRepository;
import com.example.demo.repository.data.SectionRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Comparator;
import java.util.List;
import java.util.stream.Collectors;

@Service

public class LessonProgressService {
    @Autowired
    private LessonProgressRepository lessonProgressRepository;

    @Autowired
    private LessonRepository lessonRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private SectionRepository sectionRepository;

    public void updateProgress(int userId, int lessonId, double progress) {
        LessonProgressKey key = new LessonProgressKey(userId, lessonId);
        LessonProgress lessonProgress = lessonProgressRepository.findById(key).orElseGet(() -> {
            LessonProgress lp = new LessonProgress();
            lp.setId(key);
            lp.setUser(userRepository.findById(userId).orElseThrow());
            lp.setLesson(lessonRepository.findById(lessonId).orElseThrow());
            lp.setUnlocked(true);
            return lp;
        });

        lessonProgress.setProgressPercentage(progress);
        if (progress >= 80 && !lessonProgress.isCompleted()) {
            lessonProgress.setCompleted(true);
            unlockNextLesson(userId, lessonId);
        }

        lessonProgressRepository.save(lessonProgress);
    }

    private void unlockNextLesson(int userId, int currentLessonId) {
        // Find the next lesson in the course
        Lesson currentLesson = lessonRepository.findById(currentLessonId).orElseThrow();
        Section currentSection = currentLesson.getSection();
        Course course = currentSection.getCourse();

        List<Section> sections = course.getSections();
        // Sort sections and lessons if not already sorted
        sections.sort(Comparator.comparingInt(Section::getId));

        boolean nextLessonFound = false;

        for (int i = 0; i < sections.size(); i++) {
            Section section = sections.get(i);
            List<Lesson> lessons = section.getLessons();
            lessons.sort(Comparator.comparingInt(Lesson::getId));

            for (int j = 0; j < lessons.size(); j++) {
                Lesson lesson = lessons.get(j);
                if (nextLessonFound) {
                    // Unlock this lesson for the user
                    LessonProgressKey key = new LessonProgressKey(userId, lesson.getId());
                    LessonProgress lessonProgress = new LessonProgress();
                    lessonProgress.setId(key);
                    lessonProgress.setUser(userRepository.findById(userId).orElseThrow());
                    lessonProgress.setLesson(lesson);
                    lessonProgress.setUnlocked(true);
                    lessonProgressRepository.save(lessonProgress);
                    return; // Only unlock the immediate next lesson
                }
                if (lesson.getId() == currentLessonId) {
                    nextLessonFound = true;
                }
            }
        }
    }

    public List<LessonProgress> getUserProgressForCourse(int userId, int courseId) {
        // Fetch all LessonProgress for the user with related entities
        List<LessonProgress> allProgress = lessonProgressRepository.findByUserIdWithCourse(userId);

        // Filter by courseId (no lazy loading issues)
        return allProgress.stream()
                .filter(lp -> lp.getLesson().getSection().getCourse().getId() == courseId)
                .collect(Collectors.toList());
    }
}

================
File: src/main/java/com/example/demo/service/LessonService.java
================
package com.example.demo.service;

import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.SectionDTO;
import com.example.demo.dto.LessonDTO;
import com.example.demo.entity.data.Lesson;
import com.example.demo.entity.data.Section;
import com.example.demo.repository.data.LessonRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;

@Service
@RequiredArgsConstructor
@Transactional
public class LessonService {
    private final LessonRepository lessonRepository;

    public ResponseObject getById(int id) {
        var lesson = lessonRepository.findById(id).orElse(null);
        if(lesson == null) {
            return ResponseObject.builder().content("Lesson is not exist!").status(HttpStatus.BAD_REQUEST).build();
        }
        return  ResponseObject.builder().status(HttpStatus.OK).content(lesson).build();
    }

    public List<Lesson> getLessonsBySections(List<Integer> list) {
        return lessonRepository.findLessonsBySections(list);
    }

    public List<Lesson> updateLessonsOfSection(Section oldSection, SectionDTO newSection) {
        if (newSection.getLessons().isEmpty()) {
            // Handle deletion...
            return null;
        }

        var lessonsUpdate = new ArrayList<Lesson>();

        for (var newLesson : newSection.getLessons()) {
            var currentLesson = oldSection.getLessons().stream()
                    .filter(l -> newLesson.getId() == l.getId())
                    .findFirst()
                    .orElse(null);

            if (currentLesson != null) {
                // Update existing lesson
                currentLesson.setDescription(newLesson.getDescription());
                currentLesson.setTitle(newLesson.getTitle());
                currentLesson.setVideo(newLesson.getVideo());
                currentLesson.setLinkVideo(newLesson.getLinkVideo());
                // Ensure section is set
                currentLesson.setSection(oldSection);
                lessonsUpdate.add(currentLesson);
            } else {
                // Create new lesson
                currentLesson = Lesson.builder()
                        .description(newLesson.getDescription())
                        .video(newLesson.getVideo())
                        .title(newLesson.getTitle())
                        .linkVideo(newLesson.getLinkVideo())
                        .section(oldSection) // Set the section
                        .build();
                oldSection.getLessons().add(currentLesson);
                lessonsUpdate.add(currentLesson);
            }
        }

        // Handle deletion of removed lessons...
        return oldSection.getLessons();
    }
//    public int updateVideo(LessonDTO lessonDTO, Lesson lesson, List<String> videos, int index) {
//        if(videos != null && videos.size() > index) {
//            switch (lessonDTO.getActionVideo()) {
//                case "REMOVE" -> {
//                    System.out.println("REMOVE  VIDEO");
//                    lesson.setVideo(null);
//                }
//                case "UPDATE" -> {
//                    System.out.println("UPDATE VIDEO");
//                    lesson.setVideo(videos.get(index));
//                    index++;
//                }
//                case "NONE" -> {
//                    System.out.println("NONE  VIDEO");
//                    lesson.setVideo(null);
//                }
//                case "KEEP" -> {
//                    System.out.println("KEEP  VIDEO");
//                    System.out.println(lessonDTO.getVideo());
//                    lesson.setVideo(lessonDTO.getVideo());
//                }
//                default -> System.out.println("DEFAULT  VIDEO");
//            }
//        }
//        return index;
//    }
public int updateVideo(Lesson lesson, List<String> videos, int index) {
    if (videos != null && videos.size() > index) {
        switch (lesson.getActionVideo()) { // Đảm bảo Lesson có trường `actionVideo`
            case "REMOVE" -> {
                System.out.println("REMOVE VIDEO");
                lesson.setVideo(null);
            }
            case "UPDATE" -> {
                System.out.println("UPDATE VIDEO");
                lesson.setVideo(videos.get(index));
                index++;
            }
            case "NONE" -> {
                System.out.println("NONE VIDEO");
                lesson.setVideo(null);
            }
            case "KEEP" -> {
                System.out.println("KEEP VIDEO");
                lesson.setVideo(lesson.getVideo());
            }
            default -> System.out.println("DEFAULT VIDEO");
        }
    }
    return index;
}

    public int addLessonForSection(List<LessonDTO> lessonDTOs, Section section, List<String> videos, int indexVideo) {
        if (section.getLessons() == null) {
            section.setLessons(new ArrayList<>());
        }
        for (LessonDTO lessonDTO : lessonDTOs) {
            Lesson lesson = Lesson.builder()
                    .section(section)
                    .date(LocalDateTime.now())
                    .title(lessonDTO.getTitle())
                    .description(lessonDTO.getDescription())
                    .linkVideo(lessonDTO.getLinkVideo())
                    .video(lessonDTO.getVideo())
                    .actionVideo(lessonDTO.getActionVideo())
                    .build();
            section.getLessons().add(lesson);

            if (videos != null && videos.size() > indexVideo) {
                indexVideo = updateVideo(lesson, videos, indexVideo);
            }
        }
        return indexVideo;
    }

}

================
File: src/main/java/com/example/demo/service/MessageService.java
================
package com.example.demo.service;

import com.example.demo.dto.UserDTO;
import com.example.demo.entity.data.Message;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.MessageRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class MessageService {

    private final MessageRepository messageRepository;
    private final UserRepository userRepository;

    public MessageService(MessageRepository messageRepository, UserRepository userRepository) {
        this.messageRepository = messageRepository;
        this.userRepository = userRepository;
    }

    public void sendMessage(Integer senderId, Integer receiverId, String content) {
        User sender = userRepository.findById(senderId)
                .orElseThrow(() -> new ResourceNotFoundException("Sender not found"));
        User receiver = userRepository.findById(receiverId)
                .orElseThrow(() -> new ResourceNotFoundException("Receiver not found"));

        String chatRoomId = generateChatRoomId(senderId, receiverId);

        Message message = Message.builder()
                .sender(sender)
                .receiver(receiver)
                .content(content)
                .timestamp(LocalDateTime.now())
                .isRead(false)
                .chatRoomId(chatRoomId)
                .build();

        messageRepository.save(message);
    }

    public List<UserDTO> getStudentsForInstructor(Integer instructorId) {
        // Verify that the instructor exists
        User instructor = userRepository.findById(instructorId)
                .orElseThrow(() -> new ResourceNotFoundException("Instructor not found"));

        // Fetch students via Progress
        List<User> students = messageRepository.findStudentsByInstructorId(instructorId);

        return students.stream()
                .map(this::convertToUserDTO)
                .collect(Collectors.toList());
    }
    private UserDTO convertToUserDTO(User user) {
        return UserDTO.builder()
                .id(user.getId())
                .email(user.getEmail())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .avatar(user.getAvatar())
                .phoneNumber(user.getPhoneNumber())
                .role(user.getRole())
                .build();
    }
    private String generateChatRoomId(Integer userId1, Integer userId2) {
        List<Integer> ids = Arrays.asList(userId1, userId2);
        Collections.sort(ids);
        return ids.get(0) + "_" + ids.get(1);
    }
    public List<Message> getMessagesBetweenUsers(Integer userId1, Integer userId2) {
        return messageRepository.findMessagesBetweenUsers(userId1, userId2);
    }
    public List<Message> getUnreadMessages(Integer receiverId) {
        // Validate receiver existence
        User receiver = userRepository.findById(receiverId)
                .orElseThrow(() -> new ResourceNotFoundException("Receiver not found with ID: " + receiverId));

        // Fetch unread messages
        return messageRepository.findByReceiverAndIsReadFalseOrderByTimestampAsc(receiver);
    }

    public void markMessagesAsRead(Integer receiverId, Integer senderId) {
        // Validate sender and receiver existence
        userRepository.findById(senderId)
                .orElseThrow(() -> new ResourceNotFoundException("Sender not found with ID: " + senderId));
        userRepository.findById(receiverId)
                .orElseThrow(() -> new ResourceNotFoundException("Receiver not found with ID: " + receiverId));

        // Update messages to mark as read
        List<Message> messages = messageRepository.findBySenderAndReceiverOrderByTimestampAsc(
                userRepository.getById(senderId),
                userRepository.getById(receiverId)
        );

        messages.forEach(message -> message.setRead(true));
        messageRepository.saveAll(messages); // Batch update for efficiency
    }
}

================
File: src/main/java/com/example/demo/service/NotificationService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.Notification;
import com.example.demo.repository.data.NotificationRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor
public class NotificationService {
    private  final NotificationRepository notificationRepository;

    public Notification getNotificationById(int id) {
        return notificationRepository.findById(id).orElse(null);
    }

    public Notification readNotification(int id) {
        var notification = notificationRepository.findById(id).orElse(null);
        if (notification == null) {
            return null;
        }
        notification.setRead(true);
        return notificationRepository.save(notification);
    }
    public List<Notification> readAllNotification(int id) {
        var notifications = notificationRepository.findAllByUserIdOrderByDateDesc(id).orElse(null);
        if (notifications == null) {
            return null;
        }
        for (var notification : notifications ) {
            notification.setRead(true);
            notificationRepository.save(notification);
        }
        return notifications;
    }
    public List<Notification> removeAllNotificationsByEmail(int id) {
        var notifications = notificationRepository.findAllByUserIdOrderByDateDesc(id).orElse(null);
        if (notifications == null) {
            return null;
        }
        for (var notification : notifications ) {
            notification.setRead(true);
            notificationRepository.delete(notification);
        }
        return notifications;
    }
    public List<Notification> getAllNotificationsByEmail(int userId) {
        return notificationRepository.findAllByUserIdOrderByDateDesc(userId).orElse(null);
    }
}

================
File: src/main/java/com/example/demo/service/PostService.java
================
package com.example.demo.service;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.PostDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Post;
import com.example.demo.entity.user.User;
import com.example.demo.repository.data.PostRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDateTime;

@Service
public class PostService {
    @Autowired
    private PostRepository postRepository;

    @Autowired
    private CloudService cloudService;

    public ResponseObject getPosts(int page, int size){
        return ResponseObject.builder().status(HttpStatus.OK).content(postRepository.findAll(PageRequest.of(page, size))).build();
    }

    public void savePost(User user, PostDTO postDTO) {
        Post post = Post.builder()
                .date(LocalDateTime.now())
                .title(postDTO.getTitle())
                .content(postDTO.getContent())
                .user(user)
                .build();
        postRepository.save(post);
    }

    public ResponseObject uploadImg(MultipartFile file) {
        String path = null;
        try {
            path = cloudService.uploadImage(file.getBytes());

        } catch (IOException ex) {
            System.out.println("uploadImg: " + ex.getMessage());
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Error while upload image").build();
        }
        return ResponseObject.builder().status(HttpStatus.OK).content(path).mess("upload image successfully").build();
    }

}

================
File: src/main/java/com/example/demo/service/SectionService.java
================
package com.example.demo.service;

import com.example.demo.dto.CourseDTO;
import com.example.demo.dto.LessonDTO;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Lesson;
import com.example.demo.entity.data.Section;
import com.example.demo.repository.data.SectionRepository;
import com.example.demo.dto.SectionDTO;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.AutoConfigureOrder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
@Transactional
@RequiredArgsConstructor
public class SectionService {

    @Autowired
    private SectionRepository sectionRepository;
    @Autowired
    private LessonService lessonService;

    public void removeSection(Section section) {
        sectionRepository.delete(section);
    }

    public void removeAllSection(List<Section> sections) {
        sectionRepository.deleteAll(sections);
    }

    public Section findById(int id) {
        return sectionRepository.findById(id).orElse(null);
    }

    public void deleteSection(int id) {
        var section = sectionRepository.findById(id).orElse(null);
        if (section != null) {
            section.setDeleted(true);
            sectionRepository.save(section);
        }
    }

    public List<Section> getSectionsByCourse(Course course, boolean isDeleted) {
        return sectionRepository.findSectionsByCourse(course.getId(), isDeleted).orElse(null);
    }

    public void updateSection(SectionDTO sectionDTO) {
        var section = sectionRepository.findById(sectionDTO.getId()).orElse(null);

        if (section != null) {
            section.setTitle(sectionDTO.getTitle());
            var lesson = lessonService.updateLessonsOfSection(section, sectionDTO);
            section.setLessons(lesson);
            sectionRepository.save(section);
        }
    }

    public void addListSectionDtoToCourse(Course course, List<SectionDTO> sectionDTOs) {
        if (course.getSections() == null) course.setSections(new ArrayList<>());
        for (var sectionDTO : sectionDTOs) {
            var section = Section.builder()
                    .title(sectionDTO.getTitle())
                    .course(course)
                    .build();

            List<Lesson> lessons = new ArrayList<>();
            for (LessonDTO lessonDTO : sectionDTO.getLessons()) {
                Lesson lesson = Lesson.builder()
                        .description(lessonDTO.getDescription())
                        .linkVideo(lessonDTO.getLinkVideo())
                        .title(lessonDTO.getTitle())
                        .video(lessonDTO.getVideo())
                        .date(LocalDateTime.now())
                        .section(section)
                        .build();
                lessons.add(lesson);
            }
            section.setLessons(lessons);
            course.getSections().add(section);
            sectionRepository.save(section);
        }
    }



    public void updateSections(CourseDTO courseDTO, Course course) {
        if (courseDTO.getSections().isEmpty()) {
            if (course.getSections() == null || course.getSections().isEmpty()) return;
            else {
                course.getSections().forEach(section -> {
                    section.setDeleted(true);
                    sectionRepository.save(section);
                });
                return;
            }
        }

        var updateSections = new ArrayList<Section>();
        for (var sectionDTO : courseDTO.getSections()) {
            Section section;
            if (sectionDTO.getId() == 0) {
                section = Section.builder()
                        .title(sectionDTO.getTitle())
                        .course(course)
                        .build();

                List<Lesson> lessons = new ArrayList<>();
                for (LessonDTO lessonDTO : sectionDTO.getLessons()) {
                    Lesson lesson = Lesson.builder()
                            .description(lessonDTO.getDescription())
                            .linkVideo(lessonDTO.getLinkVideo())
                            .title(lessonDTO.getTitle())
                            .video(lessonDTO.getVideo())
                            .date(LocalDateTime.now())
                            .section(section)
                            .build();
                    lessons.add(lesson);
                }
                section.setLessons(lessons);
                course.getSections().add(section);
                updateSections.add(section);
            } else {
                section = sectionRepository.findById(sectionDTO.getId()).orElse(null);
                if (section != null) {
                    section.setTitle(sectionDTO.getTitle());
                    var lessons = lessonService.updateLessonsOfSection(section, sectionDTO);
                    section.setLessons(lessons);
                    updateSections.add(section);
                }
            }

            assert section != null;
            sectionRepository.save(section);
        }

        course.getSections().forEach(section -> {
            if (!updateSections.contains(section)) {
                section.setDeleted(true);
                sectionRepository.save(section);
            }
        });
    }


}

================
File: src/main/java/com/example/demo/service/StatisticsService.java
================
package com.example.demo.service;

import com.example.demo.dto.StatisticsDTO;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Invoice;
import com.example.demo.entity.user.User;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.repository.data.InvoiceRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;

@Service
public class StatisticsService {
    private final CourseRepository courseRepository;

    private final InvoiceRepository invoiceRepository;

    private final UserRepository userRepository;

    @Autowired
    public StatisticsService(CourseRepository courseRepository, InvoiceRepository invoiceRepository, UserRepository userRepository) {
        this.courseRepository = courseRepository;
        this.invoiceRepository = invoiceRepository;
        this.userRepository = userRepository;
    }

    public StatisticsDTO getMonthlyStatistics(int month, int year, int page, int size) {
        StatisticsDTO statistics = StatisticsDTO.builder()
                .coursesCreated(courseRepository.findCoursesCreatedInMonth(month, year, PageRequest.of(0, Integer.MAX_VALUE)))
                .invoicesCreated(invoiceRepository.findInvoicesCreatedInMonth(month, year, PageRequest.of(0, Integer.MAX_VALUE)))
                .usersRegistered(userRepository.findUsersRegisteredInMonth(month, year, PageRequest.of(0, Integer.MAX_VALUE)))
                .build();
        Long invoiceTotal = invoiceRepository.sumInvoiceTotalInMonth(month, year);
        statistics.setInvoiceTotal(invoiceTotal != null ? invoiceTotal : 0);
        return statistics;
    }
}

================
File: src/main/java/com/example/demo/service/TestService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.*;
import com.example.demo.repository.data.*;
import com.example.demo.dto.*;
import com.example.demo.entity.user.User;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.hibernate.Hibernate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import org.modelmapper.ModelMapper;

@Service
@RequiredArgsConstructor
public class TestService {

    private final TestRepository testRepository;
    private final QuestionRepository questionRepository;
    private final QuestionOptionRepository questionOptionRepository;
    private final UserResponseRepository userResponseRepository;
    private final TestProgressRepository testProgressRepository;
    private final UserRepository userRepository;
    private final PassageRepository passageRepository;
    private final ListeningSectionRepository listeningSectionRepository;

    public Test getTestById(int id) {
        return testRepository.findById(id).orElse(null);
    }

    public List<Test> getAllTests() {
        return testRepository.findAll();
    }
    public List<Passage> getPassagesByTestId(int testId) {
        return passageRepository.findByTest_Id(testId);
    }

    public List<ListeningSection> getListeningSectionsByTestId(int testId) {
        return listeningSectionRepository.findByTest_Id(testId);
    }
    private final ModelMapper modelMapper;

    public TestDTO getTestDTOById(int id) {
        Test test = getTestById(id);
        if (test == null) return null;

        TestDTO testDTO = modelMapper.map(test, TestDTO.class);

        if ("READING".equalsIgnoreCase(test.getType())) {
            List<PassageDTO> passageDTOs = test.getPassages().stream()
                    .map(this::convertToPassageDTO)
                    .collect(Collectors.toList());
            testDTO.setPassages(passageDTOs);
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            List<ListeningSectionDTO> sectionDTOs = test.getListeningSections().stream()
                    .map(this::convertToListeningSectionDTO)
                    .collect(Collectors.toList());
            testDTO.setListeningSections(sectionDTOs);
        }

        return testDTO;
    }
    public List<Question> getQuestionsByTestId(int testId) {
        Test test = testRepository.findById(testId).orElse(null);
        if (test == null) {
            return Collections.emptyList();
        }

        List<Question> questions = new ArrayList<>();

        if ("READING".equalsIgnoreCase(test.getType())) {
            for (Passage passage : test.getPassages()) {
                questions.addAll(passage.getQuestions());
            }
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            for (ListeningSection section : test.getListeningSections()) {
                questions.addAll(section.getQuestions());
            }
        }

        return questions;
    }

    private PassageDTO convertToPassageDTO(Passage passage) {
        PassageDTO passageDTO = modelMapper.map(passage, PassageDTO.class);
        List<QuestionDTO> questionDTOs = passage.getQuestions().stream()
                .map(this::convertToQuestionDTO)
                .collect(Collectors.toList());
        passageDTO.setQuestions(questionDTOs);
        return passageDTO;
    }

    private ListeningSectionDTO convertToListeningSectionDTO(ListeningSection section) {
        ListeningSectionDTO sectionDTO = modelMapper.map(section, ListeningSectionDTO.class);
        List<QuestionDTO> questionDTOs = section.getQuestions().stream()
                .map(this::convertToQuestionDTO)
                .collect(Collectors.toList());
        sectionDTO.setQuestions(questionDTOs);
        return sectionDTO;
    }

    private QuestionDTO convertToQuestionDTO(Question question) {
        QuestionDTO questionDTO = modelMapper.map(question, QuestionDTO.class);
        if (question.getOptions() != null) {
            List<QuestionOptionDTO> questionOptionDTOS = question.getOptions().stream()
                    .map(option -> modelMapper.map(option, QuestionOptionDTO.class))
                    .collect(Collectors.toList());
            questionDTO.setOptions(questionOptionDTOS);
        }
        return questionDTO;
    }
    @Transactional
    public TestProgress startTest(int testId, int userId) {
        Test test = testRepository.findById(testId)
                .orElseThrow(() -> new RuntimeException("Test not found"));
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("User not found"));

        int totalQuestions = 0;

        if ("READING".equalsIgnoreCase(test.getType())) {
            Hibernate.initialize(test.getPassages());
            for (Passage passage : test.getPassages()) {
                Hibernate.initialize(passage.getQuestions());
                totalQuestions += passage.getQuestions().size();
            }
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            Hibernate.initialize(test.getListeningSections());
            for (ListeningSection section : test.getListeningSections()) {
                Hibernate.initialize(section.getQuestions());
                totalQuestions += section.getQuestions().size();
            }
        }

        TestProgress testProgress = TestProgress.builder()
                .test(test)
                .user(user)
                .startTime(LocalDateTime.now())
                .totalQuestions(totalQuestions)
                .isCompleted(false)
                .build();

        return testProgressRepository.save(testProgress);
    }



    private int calculateTotalQuestions(Test test) {
        int totalQuestions = 0;

        if ("READING".equalsIgnoreCase(test.getType())) {
            // Ensure passages are loaded
            List<Passage> passages = test.getPassages();
            if (passages != null) {
                for (Passage passage : passages) {
                    List<Question> questions = passage.getQuestions();
                    if (questions != null) {
                        totalQuestions += questions.size();
                    }
                }
            }
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            // Ensure listening sections are loaded
            List<ListeningSection> sections = test.getListeningSections();
            if (sections != null) {
                for (ListeningSection section : sections) {
                    List<Question> questions = section.getQuestions();
                    if (questions != null) {
                        totalQuestions += questions.size();
                    }
                }
            }
        }

        return totalQuestions;
    }


    @Transactional
    public void submitUserResponses(int testProgressId, List<UserResponseDTO> userResponsesDTO) {
        TestProgress testProgress = testProgressRepository.findById(testProgressId).orElseThrow();

        int correctAnswers = 0;

        for (UserResponseDTO dto : userResponsesDTO) {
            Question question = questionRepository.findById(dto.getQuestionId()).orElseThrow();
            boolean isCorrect = dto.getUserAnswer().trim().equalsIgnoreCase(question.getCorrectAnswer().trim());

            UserResponse userResponse = UserResponse.builder()
                    .testProgress(testProgress)
                    .question(question)
                    .userAnswer(dto.getUserAnswer())
                    .isCorrect(isCorrect)
                    .responseTime(LocalDateTime.now())
                    .build();

            userResponseRepository.save(userResponse);

            if (isCorrect) {
                correctAnswers++;
            }
        }

        // Update test progress
        testProgress.setCorrectAnswers(correctAnswers);
        testProgress.setEndTime(LocalDateTime.now());
        testProgress.setCompleted(true);

        testProgressRepository.save(testProgress);
    }

    @Transactional
    public void completeTest(int testProgressId) {
        TestProgress testProgress = testProgressRepository.findById(testProgressId).orElseThrow();
        testProgress.setEndTime(LocalDateTime.now());
        testProgress.setCompleted(true);

        testProgressRepository.save(testProgress);
    }

    // Additional methods as needed
}

================
File: src/main/java/com/example/demo/service/UploadService.java
================
package com.example.demo.service;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.ResponseObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

@Service
public class UploadService {

    @Autowired
    private CloudService cloudService;

    public ResponseObject uploadImg(byte[] img) {
        var result = cloudService.uploadImage(img);
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }

    public ResponseObject uploadVideo(byte[] video) {
        var result = cloudService.uploadVideo(video);
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }
}

================
File: src/main/java/com/example/demo/service/UserService.java
================
package com.example.demo.service;

import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.UsersAndRoles;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;

@Service
@RequiredArgsConstructor
public class UserService {
    private final UserRepository userRepository;

    public ResponseObject getAllUser() {
        var users = userRepository.findAll();
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get data successfully").status(HttpStatus.OK).content(users).build();
    }

    public ResponseObject getAllRole() {
        return ResponseObject.builder().status(HttpStatus.OK).content(Role.values()).build();
    }
    public ResponseObject getAllUserAndRole(boolean isDeleted){
        var roles = Role.values();
        var users = userRepository.findAllByIsDeleted(isDeleted, PageRequest.of(0, 5));
        UsersAndRoles usersAndRoles = UsersAndRoles.builder().roles(roles).users(users).build();
        return ResponseObject.builder().status(HttpStatus.OK).content(usersAndRoles).build();
    }



    public ResponseObject getUserByRole(String role, int page, int size) {
        if (Objects.equals(role, "All"))
            return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findAll(PageRequest.of(page, size))).build();
        return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findByRole(role, PageRequest.of(page, size))).build();
    }
    public User findByEmail(String email) {
        return userRepository.findByEmail(email)
                .orElseThrow(() -> new ResourceNotFoundException("User not found with email: " + email));
    }
    public ResponseObject getUserByName(String name, boolean isDelete, int page, int size) {
        if (Objects.equals(name, ""))
            return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findAllByIsDeleted(isDelete, PageRequest.of(page, size))).build();
        return ResponseObject.builder().status(HttpStatus.OK)
                .content(userRepository.findByFirstNameContainingOrLastNameContainingAndAndDeleted(name, name,isDelete, PageRequest.of(page, size)))
                .build();
    }

    public ResponseObject getAllByPage(int page, int size) {
        var result = userRepository.findAllByIsDeleted(false, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }
    public Page<User> getAllActiveUsers(Pageable pageable) {
        return userRepository.findByIsDeletedFalse(pageable);
    }

    public ResponseObject getAllDeletedByPage(int page, int size) {
        var result = userRepository.findAllByIsDeleted(true, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }

    public ResponseObject softDelete(int id) {
        var user = userRepository.findById(id).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        if (Objects.equals(user.getRole(), Role.ADMIN) || user.getRole() == Role.MANAGER)
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Cannot delete this user").build();
        user.setDeleted(true);
        userRepository.save(user);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject hardDelete(int id) {
        var user = userRepository.findById(id).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        userRepository.delete(user);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject restoreUserById(int id) {
        var user = userRepository.findById(id).orElse(null);
        if (user == null)
            return ResponseObject.builder().mess("Course does not exist").status(HttpStatus.BAD_REQUEST).build();
        user.setDeleted(false);
        userRepository.save(user);
        return ResponseObject.builder().mess("Restore successfully").status(HttpStatus.OK).build();
    }
}

================
File: src/main/java/com/example/demo/service/VocabularyService.java
================
package com.example.demo.service;



import com.example.demo.entity.data.Vocabulary;
import com.example.demo.repository.data.VocabularyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class VocabularyService {

    @Autowired
    private VocabularyRepository vocabularyRepository;

    public List<Vocabulary> getAllVocabulary(){
        return vocabularyRepository.findAll();
    }

    public Vocabulary addVocabulary(Vocabulary vocabulary){
        return vocabularyRepository.save(vocabulary);
    }

    public Vocabulary updateVocabulary(Integer id, Vocabulary updatedVocabulary){
        return vocabularyRepository.findById(id)
                .map(v -> {
                    v.setWord(updatedVocabulary.getWord());
                    v.setDefinition(updatedVocabulary.getDefinition());
                    v.setExample(updatedVocabulary.getExample());
                    return vocabularyRepository.save(v);
                })
                .orElseThrow(() -> new RuntimeException("Vocabulary not found with id " + id));
    }

    public void deleteVocabulary(Integer id){
        vocabularyRepository.deleteById(id);
    }
}

================
File: src/main/java/com/example/demo/service/WritingService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.*;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.data.*;
import com.example.demo.dto.*;
import com.example.demo.entity.user.User;
import com.example.demo.repository.UserRepository;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class WritingService {

    private final WritingTaskRepository writingTaskRepository;
    private final UserEssayRepository userEssayRepository;
    private final UserRepository userRepository;
    private final ExternalEssayEvaluationService externalEssayEvaluationService; // We'll need to implement this

    public WritingTask getWritingTaskById(int id) {
        return writingTaskRepository.findById(id).orElse(null);
    }

    public List<WritingTask> getAllWritingTasks() {
        return writingTaskRepository.findAll();
    }



    @Transactional
    public UserEssay submitEssay(Integer userId, Integer writingTaskId, String essayContent) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("User not found"));
        WritingTask task = writingTaskRepository.findById(writingTaskId)
                .orElseThrow(() -> new ResourceNotFoundException("Task not found"));

        EssayFeedback feedback = externalEssayEvaluationService.evaluateEssay(task.getPrompt(), essayContent);
        double overallScore = feedback.getOverallScore();

        UserEssay userEssay = UserEssay.builder()
                .user(user)
                .writingTask(task)
                .content(essayContent)
                .submissionTime(LocalDateTime.now())
                .feedbackJson(convertFeedbackToJson(feedback)) // Lưu dưới dạng JSON
                .score(overallScore)
                .build();

        return userEssayRepository.save(userEssay);
    }
    public long getUserEssayCount(int userId) {
        return userEssayRepository.countUserEssaysByUserId(userId);
    }

    public Double getUserAverageEssayScore(int userId) {
        return userEssayRepository.findAverageEssayScoreByUserId(userId);
    }

    public long getTotalEssayCount() {
        return userEssayRepository.countAllEssays();
    }

    public Double getAverageEssayScore() {
        return userEssayRepository.findAverageEssayScore();
    }

    public List<UserEssay> getAllEssays() {
        return userEssayRepository.findAllEssaysOrderedBySubmissionTime();
    }
    public List<UserEssayDTO> getAllEssaysWithUserNames() {
        List<UserEssayDTO> essays = userEssayRepository.findAllEssaysWithUserNames();
        return essays.stream().map(essay -> new UserEssayDTO(
                essay.getId(),
                essay.getContent(),
                essay.getSubmissionTime(),
                essay.getScore(),
                essay.getEmail()
        )).collect(Collectors.toList());
    }

    public List<UserEssay> getUserEssays(int userId) {
        return userEssayRepository.findUserEssaysByUserId(userId);
    }
    private String convertFeedbackToJson(EssayFeedback feedback) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            return mapper.writeValueAsString(feedback);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Error converting feedback to JSON.");
        }
    }
    public WritingTask createWritingTask(WritingTask writingTask) {
        return writingTaskRepository.save(writingTask);
    }

    public WritingTask updateWritingTask(int id, WritingTask updatedTask) {
        WritingTask existingTask = writingTaskRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Task not found"));
        existingTask.setTitle(updatedTask.getTitle());
        existingTask.setPrompt(updatedTask.getPrompt());
        existingTask.setTaskType(updatedTask.getTaskType());
        return writingTaskRepository.save(existingTask);
    }

    public void deleteWritingTask(int id) {
        WritingTask task = writingTaskRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Task not found"));
        writingTaskRepository.delete(task);
    }
    // Additional methods as needed
}

================
File: src/main/resources/application.properties
================
spring.datasource.url = jdbc:mysql://localhost:3306/dreamcatchers
spring.datasource.username=root
spring.datasource.password=Tu@n1111
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
spring.jpa.properties.hibernate.format_sql=true
#logging.level.org.springframework.security=TRACE
jwt-expiration = 3600000

#mail sender
spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=sheamus201515@gmail.com
spring.mail.password=erzayuekjcyzpfdv
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
openai.api.url=https://api.openai.com/v1/chat/completions
openai.api.key=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

##ouath2
#spring.security.oauth2.client.registration.google.client-id= 244170825538-gfjr0s4hfes2euh8qjt5mseq2v0o8js5.apps.googleusercontent.com
#spring.security.oauth2.client.registration.google.client-secret=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
#
#spring.security.oauth2.client.registration.facebook.client-id=726758916291445
#spring.security.oauth2.client.registration.facebook.client-secret=618db4b7e27221a46c7cf48d74db3ec8
#spring.security.oauth2.client.registration.facebook.scope = public_profile, email
#
#
#spring.security.oauth2.client.registration.github.client-id=0e415c66bab86a88d60e
#spring.security.oauth2.client.registration.github.client-secret=1c726ff938a57bb38da145e6c2041daaf528a8ba

#cloudinary
cloudinary.cloud-name=dkyiluhtk
cloudinary.api-key = 689949985374285
cloudinary.api-secret = noGKBhYKVk0gVtdPNGVL02tr5qQ

spring.servlet.multipart.max-file-size=100MB
spring.servlet.multipart.max-request-size=2000MB

================
File: src/test/java/com/example/demo/DemoApplicationTests.java
================
package com.example.demo;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class DemoApplicationTests {

	@Test
	void contextLoads() {
	}

}
