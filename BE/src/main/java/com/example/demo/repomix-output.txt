This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2024-12-07T13:34:17.088Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repomix, visit: https://github.com/yamadashy/repomix

================================================================
Repository Structure
================================================================
auth/AuthenticationRequest.java
auth/AuthService.java
auth/OtpVerifyRequest.java
auth/RegisterRequest.java
auth/ResetPasswordRequest.java
cloudinary/CloudService.java
config/AppConfig.java
config/ConfigVNPAY.java
config/CorsConfig.java
config/CorsFilter.java
config/MethodSecurityConfig.java
config/ModelMapperConfig.java
config/RestAuthenticationEntryPoint.java
config/SecurityConfig.java
config/StompPrincipal.java
config/UserInterceptor.java
config/WebSocketConfig.java
config/WebSocketSecurityConfig.java
controller/PrivateController/CategoryController.java
controller/PrivateController/CourseController.java
controller/PrivateController/DashboardController.java
controller/PrivateController/FlashcardController.java
controller/PrivateController/InstructorController.java
controller/PrivateController/LessonController.java
controller/PrivateController/MeController.java
controller/PrivateController/PrivateTestController.java
controller/PrivateController/PrivateWritingController.java
controller/PrivateController/SpeakingController.java
controller/PrivateController/UploadController.java
controller/PrivateController/UserController.java
controller/PrivateController/VocabularyController.java
controller/PrivateController/VocabularyGenerationController.java
controller/PublicController/ChatController.java
controller/PublicController/CommentController.java
controller/PublicController/DemoController.java
controller/PublicController/PCategoryController.java
controller/PublicController/PCourseController.java
controller/PublicController/PLessonController.java
controller/PublicController/PublicTestController.java
controller/PublicController/PublicWritingController.java
controller/PublicController/PUserController.java
DemoApplication.java
dto/AIChatRequestDTO.java
dto/ChatMessageDTO.java
dto/Choice.java
dto/CommentDTO.java
dto/CourseDTO.java
dto/CourseStatisticDTO.java
dto/CriterionFeedback.java
dto/EnrollDTO.java
dto/EssayFeedback.java
dto/EssaySubmissionRequest.java
dto/GrammarError.java
dto/InstructorDTO.java
dto/LessonDTO.java
dto/LessonProgressDTO.java
dto/ListeningSectionDTO.java
dto/Message.java
dto/OpenAIRequest.java
dto/OpenAIResponse.java
dto/PassageDTO.java
dto/PasswordDTO.java
dto/PostDTO.java
dto/ProgressDTO.java
dto/QuestionDTO.java
dto/QuestionOptionDTO.java
dto/ResponseObject.java
dto/SectionDTO.java
dto/SpeakingFeedbackDTO.java
dto/StatisticsDTO.java
dto/TestDTO.java
dto/UserDTO.java
dto/UserEssayDTO.java
dto/UserResponseDTO.java
dto/UsersAndRoles.java
dto/UserStatisticDTO.java
dto/VocabularyDTO.java
dto/VocabularyError.java
dto/VocabularySetDTO.java
entity/data/Category.java
entity/data/Comment.java
entity/data/Course.java
entity/data/Flashcard.java
entity/data/FlashcardSet.java
entity/data/Lesson.java
entity/data/LessonProgress.java
entity/data/LessonProgressKey.java
entity/data/ListeningSection.java
entity/data/Message.java
entity/data/Passage.java
entity/data/Progress.java
entity/data/Question.java
entity/data/QuestionOption.java
entity/data/Section.java
entity/data/SpeakingFeedback.java
entity/data/SpeakingQuestion.java
entity/data/SpeakingTopic.java
entity/data/Test.java
entity/data/TestProgress.java
entity/data/UserEssay.java
entity/data/UserResponse.java
entity/data/Vocabulary.java
entity/data/VocabularySet.java
entity/data/WritingTask.java
entity/repomix-output.txt
entity/user/OtpStatus.java
entity/user/Permission.java
entity/user/Role.java
entity/user/User.java
exception/CourseNotFoundException.java
exception/GlobalExceptionHandler.java
exception/ResourceNotFoundException.java
exception/UserNotFoundException.java
handler/LogoutHandler.java
handler/Oauth2SuccessHandler.java
jwt/JwtFilter.java
jwt/JwtService.java
jwt/Token.java
mail/MailRequest.java
mail/MailService.java
MUX/MuxService.java
repository/data/CategoryRepository.java
repository/data/CommentRepository.java
repository/data/CourseRepository.java
repository/data/FlashcardRepository.java
repository/data/FlashcardSetRepository.java
repository/data/LessonProgressRepository.java
repository/data/LessonRepository.java
repository/data/ListeningSectionRepository.java
repository/data/MessageRepository.java
repository/data/PassageRepository.java
repository/data/ProgressRepository.java
repository/data/QuestionOptionRepository.java
repository/data/QuestionRepository.java
repository/data/SectionRepository.java
repository/data/SpeakingFeedbackRepository.java
repository/data/SpeakingQuestionRepository.java
repository/data/SpeakingTopicRepository.java
repository/data/TestProgressRepository.java
repository/data/TestRepository.java
repository/data/UserEssayRepository.java
repository/data/UserResponseRepository.java
repository/data/VocabularyRepository.java
repository/data/VocabularySetRepository.java
repository/data/WritingTaskRepository.java
repository/TokenRepository.java
repository/UserRepository.java
service/AIFeedbackService.java
service/AIFeedBackService2.java
service/AudioProcessingService.java
service/AudioStorageService.java
service/CategoryService.java
service/ChatService.java
service/CommentService.java
service/CourseService.java
service/DashboardService.java
service/DTOMapperService.java
service/ExternalEssayEvaluationService.java
service/FlashcardService.java
service/GPTService.java
service/LessonProgressService.java
service/LessonService.java
service/MessageService.java
service/SectionService.java
service/SpeakingService.java
service/SpeechToTextService.java
service/TestService.java
service/UploadService.java
service/UserService.java
service/VocabularyService.java
service/VocabularySetService.java
service/WritingService.java

================================================================
Repository Files
================================================================

================
File: auth/AuthenticationRequest.java
================
package com.example.demo.auth;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class AuthenticationRequest {
    private String email;
    private String password;
}

================
File: auth/AuthService.java
================
package com.example.demo.auth;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.config.ConfigVNPAY;
import com.example.demo.dto.*;
import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.jwt.JwtService;
import com.example.demo.jwt.Token;
import com.example.demo.mail.MailRequest;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.repository.data.ProgressRepository;
import com.example.demo.service.CommentService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.*;

@Service
@RequiredArgsConstructor
@Slf4j
public class AuthService {
    private final UserRepository userRepository;
    private final AuthenticationManager authenticationManager;
    private final CourseRepository courseRepository;
    private final ProgressRepository progressRepository;

    private final JwtService jwtService;
    private final CloudService cloudService;
    private final PasswordEncoder passwordEncoder;

    private  final CommentService commentService;



    public ResponseObject deleteCommentById(String email, int id) {
        var comment = commentService.getById(id);
        if(comment == null) {
            return ResponseObject.builder().status(HttpStatus.OK).mess("Delete successfully").build();
        }
        var user = userRepository.findByEmail(email).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        user.getComments().remove(comment);
        commentService.deleteById(id);
        userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Delete successfully").build();
    }





    public ResponseObject updateLessonsIds(String alias, int courseId, List<Integer> lessonIds) {
        var email = alias + "@gmail.com";
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        var progress = progressRepository.findByCourseIdAndUser(courseId, user).orElse(null);
        if (progress == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User has not registered for the course ").build();
        }
        progress.setLessonIds(lessonIds);
        progressRepository.save(progress);
        return ResponseObject.builder().status(HttpStatus.OK).build();
    }

    public ResponseObject getProgressByCourseId(String alias, int courseId) {
        var email = alias + "@gmail.com";
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        var progress = progressRepository.findByCourseIdAndUser(courseId, user).orElse(null);
        if (progress == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User has not registered for the course ").build();
        }
        var progressDTO = ProgressDTO.builder().course(progress.getCourse()).lessonIds(progress.getLessonIds()).build();

        return ResponseObject.builder().status(HttpStatus.OK).content(progressDTO).build();

    }

    public boolean register(RegisterRequest request) {
        if(isUsedEmail(request.getEmail())) return  false;
        saveUser(request);
        return true;
    }

    public ResponseObject authenticate(AuthenticationRequest auth) {
        try {
            authenticationManager.authenticate(
                    new UsernamePasswordAuthenticationToken(auth.getEmail(), auth.getPassword())
            );
            var user = userRepository.findByEmail(auth.getEmail()).orElse(null);
            if (user == null) {
                return ResponseObject.builder()
                        .status(HttpStatus.BAD_REQUEST)
                        .content("User does not exist.")
                        .build();
            }
            Token token = new Token(jwtService.generateToken(user));
            user.setToken(token);
            var userDTO = getUserDTOFromUser(user);
            userDTO.setToken(token.getToken());
            return ResponseObject.builder()
                    .status(HttpStatus.OK)
                    .content(userDTO)
                    .build();
        } catch (AuthenticationException ex) {
            System.out.println(ex.getMessage() + " Authentication failed!");
            return ResponseObject.builder()
                    .status(HttpStatus.BAD_REQUEST)
                    .mess("Error while authenticating user: " + ex.getMessage())
                    .build();
        }
    }


    public UserDTO getUserDTOFromUser(User user) {
        return UserDTO.builder()
                .id(user.getId()) // Add this line
                .avatar(user.getAvatar())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .phoneNumber(user.getPhoneNumber())
                .role(user.getRole())
                // .progresses(user.getProgresses())
                .build();
    }


    public ResponseObject getAllByPage(int page, int size) {
        var result = userRepository.findAll(PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }

    public ResponseObject getAllUser() {
        var users = userRepository.findAll();
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get data successfully").status(HttpStatus.OK).content(users).build();
    }

    public ResponseObject getAllRole() {
        return ResponseObject.builder().status(HttpStatus.OK).content(Role.values()).build();
    }

    public ResponseObject getUserByRole(String role, int page, int size) {
        if(Objects.equals(role, "All"))
            return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findAll(PageRequest.of(page, size))).build();
        return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findByRole(role, PageRequest.of(page, size))).build();
    }

    public ResponseObject getUserByEmail(String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Username not found").build();
        }
        var userDTO = getUserDTOFromUser(user);
        return ResponseObject.builder().status(HttpStatus.OK).content(userDTO).mess("Successfully").build();
    }

    private void saveUser(RegisterRequest request) {
        User user = User.builder()
                .email(request.getEmail())
                .password(passwordEncoder.encode(request.getPassword()))
                .firstName(request.getFirstName())
                .lastName(request.getLastName())
                .role(Role.USER)
                .build();
        userRepository.save(user);
    }


    public boolean isUsedEmail(String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        return user != null;
    }

    public boolean isValidPhoneNumber(String phoneNumber) {
        var user = userRepository.findByPhoneNumber(phoneNumber).orElse(null);
        if(user == null) return false;
        return true;
    }
    public String getVerifyCode() {
        SecureRandom random = new SecureRandom();
        StringBuilder code = new StringBuilder();
        String characters = "1234567890";
        for(int i = 0; i < 6; i++) {
            code.append(characters.charAt(random.nextInt(characters.length())));
        }
        return code.toString();
    }

    public boolean isValidCode(MailRequest request) {
        User user = findUserByEmail(request.getEmail());
        if(user == null || user.getCode().isEmpty()) return false;
            return user.getCode().get(request.getCode()).isAfter(LocalDateTime.now());
    }

    public ResponseObject resetPassword(ResetPasswordRequest request) {
        var user = findUserByEmail(request.getEmail());
        if(user == null) return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Reset password failed").build();
        ;
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user = userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Reset password successfully").content(user).build();
    }

    public ResponseObject adminUpdatePasswordForUser(PasswordDTO passwordDTO, String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().mess("User not found").status(HttpStatus.BAD_REQUEST).build();
        }
        user.setPassword(passwordEncoder.encode(passwordDTO.getNewPassword()));
        user = userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update password for user successfully").content(user).build();
    }

    public User findUserByEmail(String email) {
        return userRepository.findByEmail(email).orElse(null);
    }

    public boolean saveCode(MailRequest request, String code) {
        User user = userRepository.findByEmail(request.getEmail()).orElse(null);
        if(user == null) return false;
        Map<String, LocalDateTime> token = new HashMap<String, LocalDateTime>();
        token.put(code, LocalDateTime.now().plus(48, ChronoUnit.HOURS));
        user.setCode(token);
        userRepository.save(user);
        return true;
    }
    public boolean saveCode(OtpVerifyRequest request, String code) {
        User user = userRepository.findByPhoneNumber(request.getPhoneNumber()).orElse(null);
        if(user == null) return false;
        Map<String, LocalDateTime> token = new HashMap<String, LocalDateTime>();
        token.put(code, LocalDateTime.now().plus(48, ChronoUnit.HOURS));
        user.setCode(token);
        userRepository.save(user);
        return true;
    }

    public ResponseObject getUserByToken(String token) {
        String userName;
        try {
            userName = jwtService.extractUserName(token);
        }
        catch (Exception e) {
            System.out.println("getUserByToken: " + e.getMessage());
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Username not found").build();
        }
        var user = userRepository.findByEmail(userName).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Username not found").build();
        }
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get user data successfully").build();
    }

    public ResponseObject updateProfile(UserDTO userDTO, MultipartFile avatar) {
        var user = userRepository.findByEmail(userDTO.getEmail()).orElse(null);
        if (user == null) {
            return ResponseObject.builder()
                    .status(HttpStatus.BAD_REQUEST)
                    .mess("User not found")
                    .build();
        }

        // Update user fields
        user.setFirstName(userDTO.getFirstName());
        user.setLastName(userDTO.getLastName());

        if (avatar != null && !avatar.isEmpty()) {
            try {
                // Upload avatar to Cloudinary
                String avatarUrl = cloudService.uploadImage(avatar.getBytes());
                if (avatarUrl != null) {
                    user.setAvatar(avatarUrl);
                } else {
                    return ResponseObject.builder()
                            .status(HttpStatus.INTERNAL_SERVER_ERROR)
                            .mess("Failed to upload avatar")
                            .build();
                }
            } catch (IOException e) {
                System.out.println("Error uploading avatar: " + e.getMessage());
                return ResponseObject.builder()
                        .status(HttpStatus.INTERNAL_SERVER_ERROR)
                        .mess("Error occurred when updating profile")
                        .build();
            }
        }

        userRepository.save(user);
        return ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Update successfully")
                .content(user)
                .build();
    }


    public ResponseObject updatePassword(PasswordDTO passwordDTO) {
        var user = userRepository.findByEmail(passwordDTO.getEmail()).orElse(null);
        if(user == null) {
            return ResponseObject.builder().mess("User not found").status(HttpStatus.BAD_REQUEST).build();
        }
        if(!passwordEncoder.matches( passwordDTO.getOldPassword(), user.getPassword())) {
            return ResponseObject.builder().mess("Old password not correct").status(HttpStatus.BAD_REQUEST).build();
        }
        user.setPassword(passwordEncoder.encode(passwordDTO.getNewPassword()));
        userRepository.save(user);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update password successfully").build();
    }

    public ResponseObject enrollCourse(EnrollDTO enrollDTO) {

        var user = userRepository.findByEmail(enrollDTO.getEmail()).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }

        Optional<Progress> existingProgress = progressRepository.findByCourse_IdAndUser(enrollDTO.getCourseId(), user);
        if (existingProgress.isPresent()) {
            return ResponseObject.builder()
                    .status(HttpStatus.OK)
                    .mess("Continue studying")
                    .content(existingProgress.get())
                    .build();
        }


        var course = courseRepository.findById(enrollDTO.getCourseId()).orElse(null);
        if (course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course not found").build();
        }

        Progress progress = Progress.builder()
                .course(course)
                .user(user)
                .lessonIds(enrollDTO.getLessonIds())
                .build();
        progressRepository.save(progress);

        return ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Enroll course successfully")
                .content(progress)
                .build();
    }


    public ResponseObject getPayment(String method, int courseId, String email) {
        var course = courseRepository.findById(courseId).orElse(null);
        if(course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course not found").build();
        }
        if(!Objects.equals(method,"vnpay")) return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Just VNPAY method").build();
        long amount = course.getPrice() * 100L;

        String vnp_Version = "2.1.0";
        String vnp_Command = "pay";
        String orderType = "other";
        String bankCode = "NCB";

        String vnp_TxnRef = ConfigVNPAY.getRandomNumber(8);
        String vnp_IpAddr = "127.0.0.1";

        String vnp_TmnCode = ConfigVNPAY.vnp_TmnCode;

        Map<String, String> vnp_Params = new HashMap<>();
        vnp_Params.put("vnp_Version", vnp_Version);
        vnp_Params.put("vnp_Command", vnp_Command);
        vnp_Params.put("vnp_TmnCode", vnp_TmnCode);
        vnp_Params.put("vnp_Amount", String.valueOf(amount));
        vnp_Params.put("vnp_CurrCode", "VND");

        vnp_Params.put("vnp_BankCode", bankCode);
        vnp_Params.put("vnp_TxnRef", vnp_TxnRef);
        vnp_Params.put("vnp_OrderInfo", "Pay for the course:" + vnp_TxnRef);
        vnp_Params.put("vnp_OrderType", orderType);

        vnp_Params.put("vnp_Locale", "vn");
        vnp_Params.put("vnp_ReturnUrl", ConfigVNPAY.vnp_ReturnUrl + "/" + email + "/" + courseId);
        vnp_Params.put("vnp_IpAddr", vnp_IpAddr);

        Calendar cld = Calendar.getInstance(TimeZone.getTimeZone("Etc/GMT+7"));
        SimpleDateFormat formatter = new SimpleDateFormat("yyyyMMddHHmmss");
        String vnp_CreateDate = formatter.format(cld.getTime());
        vnp_Params.put("vnp_CreateDate", vnp_CreateDate);

        cld.add(Calendar.MINUTE, 15);
        String vnp_ExpireDate = formatter.format(cld.getTime());
        vnp_Params.put("vnp_ExpireDate", vnp_ExpireDate);

        List fieldNames = new ArrayList(vnp_Params.keySet());
        Collections.sort(fieldNames);
        StringBuilder hashData = new StringBuilder();
        StringBuilder query = new StringBuilder();
        Iterator itr = fieldNames.iterator();
        while (itr.hasNext()) {
            String fieldName = (String) itr.next();
            String fieldValue = (String) vnp_Params.get(fieldName);
            if ((fieldValue != null) && (fieldValue.length() > 0)) {
                //Build hash data
             try {
                 hashData.append(fieldName);
                 hashData.append('=');
                 hashData.append(URLEncoder.encode(fieldValue, StandardCharsets.US_ASCII.toString()));
                 //Build query
                 query.append(URLEncoder.encode(fieldName, StandardCharsets.US_ASCII.toString()));
                 query.append('=');
                 query.append(URLEncoder.encode(fieldValue, StandardCharsets.US_ASCII.toString()));
             }
             catch (Exception ex) {
                 System.out.println("getPayment: " + ex.getMessage());
                 log.info("Error while get payment" + ex.getMessage());
                 return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Error while get payment").build();
             }
                if (itr.hasNext()) {
                    query.append('&');
                    hashData.append('&');
                }
            }
        }
        String queryUrl = query.toString();
        String vnp_SecureHash = ConfigVNPAY.hmacSHA512(ConfigVNPAY.secretKey, hashData.toString());
        queryUrl += "&vnp_SecureHash=" + vnp_SecureHash;
        String paymentUrl = ConfigVNPAY.vnp_PayUrl + "?" + queryUrl;
        return ResponseObject.builder().status(HttpStatus.OK).content(paymentUrl).build();
    }


    public ResponseObject unLockCourse(String email, int courseId) {
        var user = userRepository.findByEmail(email).orElse(null);
        var course = courseRepository.findById(courseId).orElse(null);
        if(user == null || course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User or Course not found").build();
        }
        Progress progress = Progress.builder()
                .user(user)
                .course(course)
                .build();
        user.getProgresses().add(progress);
        progressRepository.save(progress);
        return ResponseObject.builder().status(HttpStatus.OK).content("Enroll course successfully").build();
    }

    public ResponseObject getAllCourseByEmail(String email) {
        var user = userRepository.findByEmail(email).orElse(null);
        if(user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("User not found").build();
        }
        List<ProgressDTO> progresses = progressRepository.findAllDTOByUserEmail(email);

        return ResponseObject.builder().status(HttpStatus.OK).content(progresses).build();
    }
}

================
File: auth/OtpVerifyRequest.java
================
package com.example.demo.auth;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class OtpVerifyRequest {
    private String phoneNumber;
    private String otp;
}

================
File: auth/RegisterRequest.java
================
package com.example.demo.auth;

import com.example.demo.entity.user.Role;
import lombok.*;
import org.springframework.stereotype.Component;

@Component
@NoArgsConstructor
@AllArgsConstructor
@Data
@Builder
public class RegisterRequest {
    private String email;
    private String password;
    private String firstName;
    private String lastName;
    private Role role;
}

================
File: auth/ResetPasswordRequest.java
================
package com.example.demo.auth;

import lombok.Data;
import lombok.NoArgsConstructor;

@NoArgsConstructor
@Data
public class ResetPasswordRequest {
    private String email;
    private String password;
}

================
File: cloudinary/CloudService.java
================
package com.example.demo.cloudinary;

import com.cloudinary.Cloudinary;
import com.cloudinary.EagerTransformation;
import com.cloudinary.utils.ObjectUtils;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.SpeakingFeedback;
import lombok.RequiredArgsConstructor;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class CloudService {
    private final Cloudinary cloud;

    public String uploadImage(byte[] file)  {
        try {
            Map map = cloud.uploader().upload(file, ObjectUtils.asMap("resource_type", "auto", "folder", "dacs"));
            if(map != null) {
                return (map.get("secure_url").toString());
            }
        }
        catch (Exception e) {
            System.out.println("getLinkCloud: " + e.getMessage());
            return null;
        }
        return null;
    }

    public List<String> uploadVideos(List<MultipartFile> filesData){
        List<String> secureUrls = new ArrayList<>();
        for (var fileData : filesData) {
           try {
               Map map = cloud.uploader().upload(fileData.getBytes(),
                       ObjectUtils.asMap("resource_type", "video",
                               "folder", "dacs",
                               "eager", Arrays.asList(
                                       new EagerTransformation().width(300).height(300).crop("pad").audioCodec("none"),
                                       new EagerTransformation().width(160).height(100).crop("crop").gravity("south").audioCodec("none")),
                               "eager_async", true));
//                            "eager_notification_url", "https://mysite.example.com/notify_endpoint"));
               secureUrls.add(map.get("secure_url").toString());
           } catch (Exception e) {
               System.out.println("Upload videos: " + e.getMessage());
           }
        }
        return secureUrls;
    }

    public String uploadVideo(byte[] video) {
        try {
            Map map = cloud.uploader().upload(video,
                    ObjectUtils.asMap("resource_type", "video",
                            "folder", "dacs",
                            "eager", Arrays.asList(
                                    new EagerTransformation().width(300).height(300).crop("pad").audioCodec("none"),
                                    new EagerTransformation().width(160).height(100).crop("crop").gravity("south").audioCodec("none")),
                            "eager_async", true));
//                            "eager_notification_url", "https://mysite.example.com/notify_endpoint"));

        }
        catch (Exception e) {
            System.out.println("Cloud upload video: " + e.getMessage());
        }
        return null;
    }

    @Async("asyncExecutor")
    public void saveImageToCourse(byte[] file, Course course) throws IOException {
        try {
            Map map = cloud.uploader().upload(file, ObjectUtils.asMap("resource_type", "auto", "folder", "dacs"));
            if(map != null) {
                course.setThumbnail(map.get("secure_url").toString());
            }
        }
        catch (Exception e) {
            System.out.println("saveImageToCourse: " + e.getMessage());
        }
    }
    public String uploadAudio(byte[] audioFile) {
        try {
            Map<?, ?> map = cloud.uploader().upload(audioFile, ObjectUtils.asMap(
                    "resource_type", "audio",
                    "folder", "dacs/audio"
            ));

            if (map != null && map.get("secure_url") != null) {
                return map.get("secure_url").toString();
            }
        } catch (Exception e) {
            System.err.println("uploadAudio Exception: " + e.getMessage());
            if (e.getCause() != null) {
                System.err.println("Cause: " + e.getCause().getMessage());
            }
            e.printStackTrace();
        }

        return null;
    }






    /**
     * Uploads multiple audio files to Cloudinary.
     *
     * @param audioFiles List of MultipartFile representing audio files.
     * @return List of secure URLs for the uploaded audio files.
     */
    public List<String> uploadAudios(List<MultipartFile> audioFiles) {
        List<String> secureUrls = new ArrayList<>();
        for (MultipartFile audioFile : audioFiles) {
            try {
                // Kiểm tra loại file audio
                if (!audioFile.getContentType().startsWith("audio/")) {
                    System.err.println("Invalid audio format: " + audioFile.getOriginalFilename());
                    continue;
                }
                Map<?, ?> map = cloud.uploader().upload(audioFile.getBytes(),
                        ObjectUtils.asMap(
                                "resource_type", "audio",
                                "folder", "dacs/audio",
                                "transformation", Arrays.asList(
                                        new EagerTransformation().quality("auto")
                                )
                        ));
                if (map != null && map.get("secure_url") != null) {
                    secureUrls.add(map.get("secure_url").toString());
                }
            } catch (Exception e) {
                System.err.println("Error uploading audio file " + audioFile.getOriginalFilename() + ": " + e.getMessage());
                e.printStackTrace();
            }
        }
        return secureUrls;
    }


    /**
     * Asynchronously uploads an audio file and associates it with an entity.
     * Adjust this method based on your specific requirements.
     *
     * @param audioFile Byte array of the audio file.
     * @param targetEntity The entity to associate the audio with (e.g., SpeakingFeedback).
     */
    @Async("asyncExecutor")
    public void saveAudioToEntity(byte[] audioFile, Object targetEntity) {
        try {
            String audioUrl = uploadAudio(audioFile);
            if (audioUrl != null) {
                // Liên kết với entity cụ thể
                if (targetEntity instanceof SpeakingFeedback) {
                    ((SpeakingFeedback) targetEntity).setAudioUrl(audioUrl);
                    System.out.println("Audio URL successfully saved to entity: " + audioUrl);
                } else {
                    System.err.println("Unknown entity type. Audio URL not saved.");
                }
            } else {
                System.err.println("Failed to upload audio file.");
            }
        } catch (Exception e) {
            System.err.println("Error saving audio to entity: " + e.getMessage());
            e.printStackTrace();
        }
    }

}

================
File: config/AppConfig.java
================
package com.example.demo.config;

import com.cloudinary.Cloudinary;
import com.cloudinary.utils.ObjectUtils;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.util.concurrent.Executor;

@Configuration
@RequiredArgsConstructor
@EnableAsync
public class AppConfig {
    private final UserRepository userRepository;
    @Value("${cloudinary.cloud-name}")
    private String cloudName;
    @Value("${cloudinary.api-key}")
    private String apiKey;
    @Value("${cloudinary.api-secret}")
    private String apiSecret;



    @Bean(name = "asyncExecutor")
    public Executor asyncExecutor() {
            ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setThreadNamePrefix("Async-");
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.initialize();
        return executor;
    }

    @Bean
    public Executor getAsyncTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("Async-");
        executor.initialize();
        return executor;
    }
    @Bean
    public DaoAuthenticationProvider daoAuthenticationProvider() {
        DaoAuthenticationProvider daoAuthenticationProvider = new DaoAuthenticationProvider();
        daoAuthenticationProvider.setUserDetailsService(userDetailsService());
        daoAuthenticationProvider.setPasswordEncoder(passwordEncoder());
        return daoAuthenticationProvider;
    }

    @Bean
    public Cloudinary cloudinary() {
        return new Cloudinary(ObjectUtils.asMap(
                "cloud_name", cloudName,
                "api_key", apiKey,
            "api_secret", apiSecret,
            "secure", true
        ));
    }

    @Bean
    public UserDetailsService userDetailsService() {
        return username -> {
            return userRepository.findByEmail(username).orElseThrow(() -> new UsernameNotFoundException("Username not found"));
        };
    }
    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration configuration) throws Exception {
        return configuration.getAuthenticationManager();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}

================
File: config/ConfigVNPAY.java
================
package com.example.demo.config;

import jakarta.servlet.http.HttpServletRequest;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.io.UnsupportedEncodingException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.*;

public class ConfigVNPAY {
    public static String vnp_PayUrl = "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html";
    public static String vnp_ApiUrl = "https://sandbox.vnpayment.vn/merchant_webapi/api/transaction";
    public static String vnp_ReturnUrl = "http://localhost:8080/api/v1/me/payment/process";
    public static String vnp_TmnCode = "0DTWWU8C";
    public static String secretKey = "P27TDIC7WKMEP85LJN1ZLIMW146I3TEG";


    public static String md5(String message) {
        String digest = null;
        try {
            MessageDigest md = MessageDigest.getInstance("MD5");
            byte[] hash = md.digest(message.getBytes("UTF-8"));
            StringBuilder sb = new StringBuilder(2 * hash.length);
            for (byte b : hash) {
                sb.append(String.format("%02x", b & 0xff));
            }
            digest = sb.toString();
        } catch (UnsupportedEncodingException ex) {
            digest = "";
        } catch (NoSuchAlgorithmException ex) {
            digest = "";
        }
        return digest;
    }

    public static String Sha256(String message) {
        String digest = null;
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            byte[] hash = md.digest(message.getBytes("UTF-8"));
            StringBuilder sb = new StringBuilder(2 * hash.length);
            for (byte b : hash) {
                sb.append(String.format("%02x", b & 0xff));
            }
            digest = sb.toString();
        } catch (UnsupportedEncodingException ex) {
            digest = "";
        } catch (NoSuchAlgorithmException ex) {
            digest = "";
        }
        return digest;
    }

    //Util for VNPAY
    public static String hashAllFields(Map fields) {
        List fieldNames = new ArrayList(fields.keySet());
        Collections.sort(fieldNames);
        StringBuilder sb = new StringBuilder();
        Iterator itr = fieldNames.iterator();
        while (itr.hasNext()) {
            String fieldName = (String) itr.next();
            String fieldValue = (String) fields.get(fieldName);
            if ((fieldValue != null) && (fieldValue.length() > 0)) {
                sb.append(fieldName);
                sb.append("=");
                sb.append(fieldValue);
            }
            if (itr.hasNext()) {
                sb.append("&");
            }
        }
        return hmacSHA512(secretKey,sb.toString());
    }

    public static String hmacSHA512(final String key, final String data) {
        try {

            if (key == null || data == null) {
                throw new NullPointerException();
            }
            final Mac hmac512 = Mac.getInstance("HmacSHA512");
            byte[] hmacKeyBytes = key.getBytes();
            final SecretKeySpec secretKey = new SecretKeySpec(hmacKeyBytes, "HmacSHA512");
            hmac512.init(secretKey);
            byte[] dataBytes = data.getBytes(StandardCharsets.UTF_8);
            byte[] result = hmac512.doFinal(dataBytes);
            StringBuilder sb = new StringBuilder(2 * result.length);
            for (byte b : result) {
                sb.append(String.format("%02x", b & 0xff));
            }
            return sb.toString();

        } catch (Exception ex) {
            return "";
        }
    }

    public static String getIpAddress(HttpServletRequest request) {
        String ipAdress;
        try {
            ipAdress = request.getHeader("X-FORWARDED-FOR");
            if (ipAdress == null) {
                ipAdress = request.getRemoteAddr();
            }
        } catch (Exception e) {
            ipAdress = "Invalid IP:" + e.getMessage();
        }
        return ipAdress;
    }

    public static String getRandomNumber(int len) {
        Random rnd = new Random();
        String chars = "0123456789";
        StringBuilder sb = new StringBuilder(len);
        for (int i = 0; i < len; i++) {
            sb.append(chars.charAt(rnd.nextInt(chars.length())));
        }
        return sb.toString();
    }
}

================
File: config/CorsConfig.java
================
package com.example.demo.config;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("http://localhost:3000")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}

================
File: config/CorsFilter.java
================
//package com.example.demo.config;
//
//import jakarta.servlet.FilterChain;
//import jakarta.servlet.ServletException;
//import jakarta.servlet.http.HttpServletRequest;
//import jakarta.servlet.http.HttpServletResponse;
//import org.springframework.stereotype.Component;
//import org.springframework.web.filter.OncePerRequestFilter;
//
//import java.io.IOException;
//@Component
//public class CorsFilter extends OncePerRequestFilter {
//    @Override
//    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
//        response.setHeader("Access-Control-Allow-Origin", "http://localhost:3000");
//        response.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
//        response.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
//        filterChain.doFilter(request, response);
//    }
//}

================
File: config/MethodSecurityConfig.java
================
package com.example.demo.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.method.configuration.GlobalMethodSecurityConfiguration;

@EnableGlobalMethodSecurity(prePostEnabled = true)
@Configuration
public class MethodSecurityConfig extends GlobalMethodSecurityConfiguration {
}

================
File: config/ModelMapperConfig.java
================
package com.example.demo.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
@Configuration
public class ModelMapperConfig {

    @Bean
    public ModelMapper modelMapper() {
        return new ModelMapper();
    }

}

================
File: config/RestAuthenticationEntryPoint.java
================
package com.example.demo.config;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class RestAuthenticationEntryPoint implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
    }
}

================
File: config/SecurityConfig.java
================
package com.example.demo.config;

import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.user.Role;
import static com.example.demo.entity.user.Permission.*;
import com.example.demo.handler.LogoutHandler;
import com.example.demo.handler.Oauth2SuccessHandler;
import com.example.demo.jwt.JwtFilter;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;


@Configuration
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtFilter jwtFilter;
    private final LogoutHandler logoutHandler;
    private final RestAuthenticationEntryPoint restAuthenticationEntryPoint;

    @Bean
    public AccessDeniedHandler accessDeniedHandler () {
        return (request, response, accessDeniedException) -> {
            response.setStatus(HttpServletResponse.SC_FORBIDDEN);
            ResponseObject res = ResponseObject.builder().status(HttpStatus.FORBIDDEN).mess("You don't have permission!").build();
            ObjectMapper mapper = new ObjectMapper();
            response.getWriter().write(mapper.writeValueAsString(res));
            response.getWriter().flush();
        };
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity
//                .cors(AbstractHttpConfigurer::disable) vô hiệu hóa cấu hình mặc định và cấu hình CORS riêng
                 .csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers(
                                "/api/v1/public/**", "/ws/**").permitAll()
                        .requestMatchers("/api/v1/user/**").hasAnyRole(Role.USER.name(), Role.ADMIN.name(), Role.MANAGER.name())

                        .requestMatchers(HttpMethod.GET, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers(HttpMethod.POST, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers(HttpMethod.PUT, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers(HttpMethod.DELETE, "/api/v1/private/**").hasAnyRole(Role.ADMIN.name(),Role.INSTRUCTOR.name(),Role.USER.name())
                        .requestMatchers("/api/v1/instructor/**").hasRole(Role.INSTRUCTOR.name())
                        .anyRequest()
                        .permitAll()
                )
                .logout(logout -> logout.logoutUrl("/api/v1/me/logout")
                        .addLogoutHandler(logoutHandler)
                        .logoutSuccessHandler(((request, response, authentication) -> {
                            SecurityContextHolder.clearContext();
                            response.setStatus(HttpServletResponse.SC_OK);
                        }))
                )
//                .authenticationProvider(authenticationProvider)
                .exceptionHandling(exception -> exception.authenticationEntryPoint(restAuthenticationEntryPoint))
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)
//                .exceptionHandling(exception -> exception.accessDeniedHandler(accessDeniedHandler()))
                .build();
    }
}

================
File: config/StompPrincipal.java
================
package com.example.demo.config;

import java.security.Principal;

public class StompPrincipal implements Principal {
    private String name;

    public StompPrincipal(String name) {
        this.name = name;
    }

    @Override
    public String getName() {
        return name;
    }
}

================
File: config/UserInterceptor.java
================
package com.example.demo.config;

import org.springframework.messaging.Message;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.simp.stomp.StompHeaderAccessor;
import org.springframework.messaging.support.ChannelInterceptor;
import org.springframework.messaging.simp.stomp.StompCommand; // Import StompCommand

public class UserInterceptor implements ChannelInterceptor {
    @Override
    public Message<?> preSend(Message<?> message, MessageChannel channel) {

        StompHeaderAccessor accessor = StompHeaderAccessor.wrap(message);

        if (StompCommand.CONNECT.equals(accessor.getCommand())) {
            // Get the user ID from the headers
            String userId = accessor.getFirstNativeHeader("userId");
            if (userId != null) {
                // Set the principal with the user ID
                accessor.setUser(new StompPrincipal(userId));
            }
        }

        return message;
    }
}

================
File: config/WebSocketConfig.java
================
package com.example.demo.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.Message;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.simp.config.*;
import org.springframework.messaging.simp.stomp.StompCommand;
import org.springframework.messaging.simp.stomp.StompHeaderAccessor;
import org.springframework.messaging.support.*;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.web.socket.config.annotation.*;

import java.util.Collections;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureClientInboundChannel(ChannelRegistration registration) {
        registration.interceptors(new UserInterceptor());

        registration.interceptors(new ChannelInterceptor() {
            @Override
            public Message<?> preSend(Message<?> message, MessageChannel channel) {

                StompHeaderAccessor accessor =
                        MessageHeaderAccessor.getAccessor(message, StompHeaderAccessor.class);

                if (accessor != null && StompCommand.CONNECT.equals(accessor.getCommand())) {
                    String userId = accessor.getFirstNativeHeader("userId");
                    if (userId != null) {
                        Authentication auth = new UsernamePasswordAuthenticationToken(
                                userId, null, Collections.emptyList());
                        accessor.setUser(auth);
                    }
                }
                return message;
            }
        });
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.setApplicationDestinationPrefixes("/app")
            .enableSimpleBroker("/comment", "/user", "/topic", "/queue");
        config.setUserDestinationPrefix("/user");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")
                .setAllowedOriginPatterns("*")
                .withSockJS();
    }
}

================
File: config/WebSocketSecurityConfig.java
================
package com.example.demo.config;

import org.springframework.security.config.annotation.web.messaging.MessageSecurityMetadataSourceRegistry;
import org.springframework.security.config.annotation.web.socket.AbstractSecurityWebSocketMessageBrokerConfigurer;

public class WebSocketSecurityConfig extends AbstractSecurityWebSocketMessageBrokerConfigurer {
    @Override
    protected boolean sameOriginDisabled() {
        return true; // Adjust based on your CSRF policy
    }

    @Override
    protected void configureInbound(MessageSecurityMetadataSourceRegistry messages) {
        messages
                .simpDestMatchers("/app/**").authenticated()
                .simpSubscribeDestMatchers("/user/**").authenticated()
                .anyMessage().denyAll();
    }
}

================
File: controller/PrivateController/CategoryController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Category;
import com.example.demo.service.CategoryService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/private/category")
@RequiredArgsConstructor
public class CategoryController {
    private final CategoryService categoryService;

    @GetMapping("/getAllDeleted")
    public ResponseEntity<ResponseObject> getAllDeleted(@RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = categoryService.getAllCategoryDeleted(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/{id}")
    public ResponseEntity<ResponseObject> update(@PathVariable int id, @RequestBody Category category) {
        var result = categoryService.updateCategoryById(id, category);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/create")
    public ResponseEntity<ResponseObject> create(@RequestBody String name) {
        var result = categoryService.createCategory(name);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/delete/soft/{id}")
    public ResponseEntity<ResponseObject> softDelete(@PathVariable int id) {
        var result = categoryService.softDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/restore/{id}")
    public ResponseEntity<ResponseObject> restore(@PathVariable int id) {
        var result = categoryService.restoreCategoryById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @DeleteMapping("/delete/hard/{id}")
    public ResponseEntity<ResponseObject> hardDelete(@PathVariable int id) {
        var result = categoryService.hardDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
}

================
File: controller/PrivateController/CourseController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.auth.AuthService;
import com.example.demo.dto.CourseDTO;
import com.example.demo.dto.EnrollDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.exception.CourseNotFoundException;
import com.example.demo.exception.UserNotFoundException;
import com.example.demo.service.CourseService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
@RestController
@RequestMapping("/api/v1/private/course")
@RequiredArgsConstructor
public class CourseController {
    private final CourseService courseService;
    private final AuthService authService;
    @GetMapping("")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> getCourseByCourseTitle(@RequestParam("title") String title,
                                                                 @RequestParam(defaultValue = "0") int page,
                                                                 @RequestParam(defaultValue = "5") int size
            , @RequestParam(defaultValue = "false") boolean isDeleted) {
        var result = courseService.getAllCourseByCourseTitle(title, isDeleted, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/create")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> create(@RequestPart CourseDTO course
          ) {
        System.out.println(course);
        var result = courseService.addCourse(course);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @PostMapping("/enroll")
    public ResponseEntity<ResponseObject> enrollCourse(@RequestBody EnrollDTO enrollDTO) {
        ResponseObject response = authService.enrollCourse(enrollDTO);
        return new ResponseEntity<>(response, response.getStatus());
    }


    @GetMapping("/{courseId}/is-enrolled")
    public ResponseEntity<Boolean> checkEnrollment(
            @PathVariable int courseId,
            @RequestParam int userId) {

        boolean isEnrolled = courseService.isUserEnrolled(courseId, userId);
        return ResponseEntity.ok(isEnrolled);
    }


    @PutMapping("/edit/{id}")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> updateCourse(@PathVariable int id
            , @RequestPart CourseDTO course
          )  {

        var result = courseService.updateCourse(id, course);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/restore/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> restoreCourse(@PathVariable int id) {
        var result = courseService.restoreCourseById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @PutMapping("/delete/soft/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> softDelete(@PathVariable int id) {
        var result = courseService.softDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @DeleteMapping("/delete/hard/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> hardDelete(@PathVariable int id) {
        var result = courseService.hardDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/deleted/category")
    @PreAuthorize("hasAnyRole('INSTRUCTOR', 'ADMIN')")
    public ResponseEntity<ResponseObject> getCourseDeletedByCategoryId(@RequestParam("id") int id, @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourseDeletedByCategoryId(id, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/getAllDeleted")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ResponseObject> getAllDeleted(@RequestParam(defaultValue = "0") int page,
                                                        @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourseDeleted(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/getAll")
    public ResponseEntity<ResponseObject> getAll(@RequestParam(defaultValue = "0") int page,
                                                        @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourse(page, size);
        System.out.println("Result"+result);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

}

================
File: controller/PrivateController/DashboardController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.UserEssayDTO;
import com.example.demo.entity.data.Comment;
import com.example.demo.entity.data.UserEssay;
import com.example.demo.service.CommentService;
import com.example.demo.service.DashboardService;
import com.example.demo.service.WritingService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/private/dashboard")
public class DashboardController {
    private final CommentService commentService;
    private final DashboardService dashboardService;
    private final WritingService writingService;

    public DashboardController(CommentService commentService, DashboardService dashboardService, WritingService writingService) {
        this.commentService = commentService;
        this.dashboardService = dashboardService;
        this.writingService = writingService;
    }

    @GetMapping("/essays/statistics")
    public ResponseEntity<Map<String, Object>> getEssayStatistics() {
        long totalEssayCount = writingService.getTotalEssayCount();
        Double averageScore = writingService.getAverageEssayScore();

        Map<String, Object> response = new HashMap<>();
        response.put("totalEssayCount", totalEssayCount);
        response.put("averageScore", averageScore);

        return ResponseEntity.ok(response);
    }

    @GetMapping("/essays")
    public ResponseEntity<List<UserEssayDTO>> getAllEssays() {
        List<UserEssayDTO> essays = writingService.getAllEssaysWithUserNames();
        return ResponseEntity.ok(essays);
    }

    @GetMapping("/comments")
    public ResponseEntity<?> getRecentComments(@RequestParam(defaultValue = "10") int limit) {
        List<Comment> recentComments = commentService.getRecentComments(limit);
        List<Map<String, Object>> response = recentComments.stream().map(comment -> {
            Map<String, Object> map = new HashMap<>();
            map.put("id", comment.getId());
            map.put("content", comment.getContent());
            map.put("userEmail", comment.getUserEmail());
            map.put("userName", comment.getUserName());
            map.put("avatar", comment.getAvatar());
            map.put("date", comment.getDate());
            map.put("lessonId", comment.getLesson() != null ? comment.getLesson().getId() : null);
            map.put("replyToUser", comment.getReplyToUser());
            map.put("replyToUserName", comment.getReplyToUserName());
            return map;
        }).collect(Collectors.toList());
        return ResponseEntity.ok(response);
    }
    @GetMapping("/stats")
    public ResponseEntity<?> getDashboardStats() {
        Map<String, Integer> stats = dashboardService.getDashboardStats();
        return ResponseEntity.ok(stats);
    }

}

================
File: controller/PrivateController/FlashcardController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.entity.data.FlashcardSet;
import com.example.demo.service.FlashcardService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/private/flashcards")
public class FlashcardController {

    @Autowired
    private FlashcardService flashcardService;

    @GetMapping("/user/{userId}")
    public ResponseEntity<List<FlashcardSet>> getFlashcardSetsByUser(@PathVariable Integer userId){
        return ResponseEntity.ok(flashcardService.getFlashcardSetsByUserId(userId));
    }

    @PostMapping("/create")
    public ResponseEntity<FlashcardSet> createFlashcardSet(@RequestParam Integer userId,
                                                           @RequestParam String title,
                                                           @RequestParam String description,
                                                           @RequestBody List<Integer> vocabularyIds){
        return ResponseEntity.ok(flashcardService.createFlashcardSet(userId, title, description, vocabularyIds));
    }

    // Thêm các endpoint khác như update, delete nếu cần
}

================
File: controller/PrivateController/InstructorController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.UserDTO;
import com.example.demo.entity.user.User;
import com.example.demo.service.ChatService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/private/instructor")
@RequiredArgsConstructor
public class InstructorController {
    private final ChatService chatService;

    @GetMapping("/{userId}")
    public ResponseEntity<List<UserDTO>> getInstructorsForUser(@PathVariable Integer userId) {
        // Directly return the list of UserDTOs from the service
        List<UserDTO> instructors = chatService.getInstructorsForUserCourses(userId);
        return ResponseEntity.ok(instructors);
    }
}

================
File: controller/PrivateController/LessonController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.LessonProgressDTO;
import com.example.demo.entity.data.LessonProgress;
import com.example.demo.service.LessonProgressService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/private/lesson")
@RequiredArgsConstructor
public class LessonController {
    @Autowired
    private LessonProgressService lessonProgressService;

    @PostMapping("/progress")
    public ResponseEntity<?> updateProgress(@RequestBody LessonProgressDTO lessonProgressDTO) {
        lessonProgressService.updateProgress(
                lessonProgressDTO.getUserId(),
                lessonProgressDTO.getLessonId(),
                lessonProgressDTO.getProgressPercentage()
        );
        return ResponseEntity.ok().build();
    }

    @GetMapping("/course/{courseId}/progress/{userId}")
    public ResponseEntity<List<LessonProgressDTO>> getUserProgress(
            @PathVariable int courseId,
            @PathVariable int userId
    ) {
        List<LessonProgress> progressList = lessonProgressService.getUserProgressForCourse(userId, courseId);
        List<LessonProgressDTO> dtoList = progressList.stream().map(lp -> {
            LessonProgressDTO dto = new LessonProgressDTO();
            dto.setUserId(lp.getUser().getId());
            dto.setLessonId(lp.getLesson().getId());
            dto.setProgressPercentage(lp.getProgressPercentage());
            dto.setCompleted(lp.isCompleted());
            dto.setUnlocked(lp.isUnlocked());
            return dto;
        }).collect(Collectors.toList());
        return ResponseEntity.ok(dtoList);
    }
}

================
File: controller/PrivateController/MeController.java
================
package com.example.demo.controller.PrivateController;


import com.example.demo.auth.AuthService;
import com.example.demo.dto.*;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.util.List;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/me")
public class MeController {
    private final AuthService authService;





    @DeleteMapping("/{email}/comment/delete/{id}")
    public ResponseEntity<ResponseObject> DeleteComment(@PathVariable String email, @PathVariable int id) {
        var result = authService.deleteCommentById(email, id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/course/getAll/{email}")
    public ResponseEntity<ResponseObject> getAllCourse(@PathVariable String email) {
        var result = authService.getAllCourseByEmail(email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{email}")
    public ResponseEntity<ResponseObject> getUsername(@PathVariable String email) {
        var result = authService.getUserByEmail(email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/update")
    public ResponseEntity<ResponseObject> updateProfile(
            @RequestPart("user") UserDTO userDTO,
            @RequestPart(value = "avatar", required = false) MultipartFile avatar
    ) {
        ResponseObject response = authService.updateProfile(userDTO, avatar);
        return new ResponseEntity<>(response, response.getStatus());
    }


    @PutMapping("/update/password")
    public ResponseEntity<ResponseObject> updatePassword(@RequestBody PasswordDTO passwordDTO) {
        var result = authService.updatePassword(passwordDTO);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/enroll/course")
    public ResponseEntity<ResponseObject> enrollCourse(@RequestBody EnrollDTO enrollDTO) {
        var result = authService.enrollCourse(enrollDTO);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{alias}/progress/{courseId}")
    public ResponseEntity<ResponseObject> getProgress(@PathVariable String alias, @PathVariable int courseId) {
        // Use the authService to check progress and enrollment status
        ResponseObject result = authService.getProgressByCourseId(alias, courseId);

        // Return the appropriate HTTP status and response body
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/{alias}/progress/{courseId}/updateLessonIds")
    public ResponseEntity<ResponseObject> updateLessonIds(@PathVariable String alias, @PathVariable int courseId
            , @RequestBody List<Integer> lessonIds) {
        var result = authService.updateLessonsIds(alias, courseId, lessonIds);
        return ResponseEntity.status(result.getStatus()).body(result);
    }






}

================
File: controller/PrivateController/PrivateTestController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.UserResponseDTO;
import com.example.demo.entity.data.TestProgress;
import com.example.demo.service.TestService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/private/tests")
@RequiredArgsConstructor
public class PrivateTestController {

    private final TestService testService;

    @PostMapping("/{testId}/start")
    public ResponseEntity<ResponseObject> startTest(@PathVariable int testId, @RequestParam int userId) {
        TestProgress testProgress = testService.startTest(testId, userId);
        return ResponseEntity.status(HttpStatus.CREATED).body(
                ResponseObject.builder()
                        .status(HttpStatus.CREATED)
                        .mess("Test started")
                        .content(testProgress)
                        .build()
        );
    }

    @PostMapping("/{testProgressId}/submit-responses")
    public ResponseEntity<ResponseObject> submitResponses(
            @PathVariable int testProgressId,
            @RequestBody List<UserResponseDTO> userResponses) {

        testService.submitUserResponses(testProgressId, userResponses);

        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Responses submitted")
                        .build()
        );
    }


    @PostMapping("/{testProgressId}/complete")
    public ResponseEntity<ResponseObject> completeTest(@PathVariable int testProgressId) {
        testService.completeTest(testProgressId);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Test completed")
                        .build()
        );
    }
}

================
File: controller/PrivateController/PrivateWritingController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.EssayFeedback;
import com.example.demo.dto.EssaySubmissionRequest;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.UserEssay;
import com.example.demo.entity.data.WritingTask;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.UserEssayRepository;
import com.example.demo.repository.data.WritingTaskRepository;
import com.example.demo.service.ExternalEssayEvaluationService;
import com.example.demo.service.WritingService;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.Authentication;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/v1/private/writing")
@RequiredArgsConstructor
public class PrivateWritingController {

    private final WritingService writingService;
    private final UserEssayRepository userEssayRepository;
    private final UserRepository userRepository;
    private final WritingTaskRepository writingTaskRepository;
    private final ExternalEssayEvaluationService externalEssayEvaluationService;
    @PostMapping("/submit")
    public ResponseEntity<ResponseObject> submitEssay(@Validated @RequestBody EssaySubmissionRequest request) {
        // Gọi service để xử lý việc gửi bài luận
        UserEssay userEssay = writingService.submitEssay(
                request.getUserId(),
                request.getWritingTaskId(),
                request.getEssayContent()
        );

        // Trả về phản hồi với thông tin bài luận đã được lưu
        return ResponseEntity.status(HttpStatus.CREATED).body(
                ResponseObject.builder()
                        .status(HttpStatus.CREATED)
                        .mess("Essay submitted successfully")
                        .content(userEssay)
                        .build()
        );

    }
    private String convertFeedbackToJson(EssayFeedback feedback) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            return mapper.writeValueAsString(feedback);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Error converting feedback to JSON.");
        }
    }

    @GetMapping("/essays/history")
    public ResponseEntity<ResponseObject> getUserEssayHistory(
            @RequestParam Integer userId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        Page<UserEssay> essays = writingService.getUserEssays(userId, PageRequest.of(page, size));
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Essay history retrieved successfully")
                        .content(essays)
                        .build()
        );
    }



    // Endpoint to get a specific essay by ID (optional)
    @GetMapping("/essays/{essayId}")
    public ResponseEntity<ResponseObject> getEssayById(@PathVariable Integer essayId, Authentication authentication) {
        UserEssay essay = writingService.getEssayById(essayId);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Essay retrieved successfully")
                        .content(essay)
                        .build()
        );
    }


    @PostMapping("/tasks")
    public ResponseEntity<ResponseObject> createWritingTask(@RequestBody WritingTask writingTask) {
        WritingTask createdTask = writingService.createWritingTask(writingTask);
        return ResponseEntity.status(HttpStatus.CREATED).body(
                ResponseObject.builder()
                        .status(HttpStatus.CREATED)
                        .mess("Writing task created successfully")
                        .content(createdTask)
                        .build()
        );
    }

    @GetMapping("/tasks")
    public ResponseEntity<List<WritingTask>> getAllWritingTasks() {
        List<WritingTask> tasks = writingService.getAllWritingTasks();
        return ResponseEntity.ok(tasks);
    }

    @GetMapping("/tasks/{id}")
    public ResponseEntity<ResponseObject> getWritingTaskById(@PathVariable int id) {
        WritingTask task = writingService.getWritingTaskById(id);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Writing task retrieved successfully")
                        .content(task)
                        .build()
        );
    }

    @PutMapping("/tasks/{id}")
    public ResponseEntity<ResponseObject> updateWritingTask(@PathVariable int id, @RequestBody WritingTask updatedTask) {
        WritingTask task = writingService.updateWritingTask(id, updatedTask);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Writing task updated successfully")
                        .content(task)
                        .build()
        );
    }

    @DeleteMapping("/tasks/{id}")
    public ResponseEntity<ResponseObject> deleteWritingTask(@PathVariable int id) {
        writingService.deleteWritingTask(id);
        return ResponseEntity.ok(
                ResponseObject.builder()
                        .status(HttpStatus.OK)
                        .mess("Writing task deleted successfully")
                        .build()
        );
    }
}

================
File: controller/PrivateController/SpeakingController.java
================
// src/main/java/com/example/demo/controller/PrivateController/SpeakingController.java

package com.example.demo.controller.PrivateController;

import com.example.demo.dto.AIChatRequestDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.SpeakingFeedback;
import com.example.demo.entity.data.SpeakingQuestion;
import com.example.demo.entity.data.SpeakingTopic;
import com.example.demo.service.SpeakingService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/v1/private/speaking")
@RequiredArgsConstructor
public class SpeakingController {

    private final SpeakingService speakingService;

    // CRUD for Speaking Topics

    @PostMapping("/topics")
    public ResponseEntity<ResponseObject> createSpeakingTopic(@RequestBody SpeakingTopic topic) {
        SpeakingTopic createdTopic = speakingService.createSpeakingTopic(topic);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Topic created successfully.")
                .content(createdTopic)
                .build());
    }

    @PutMapping("/topics/{id}")
    public ResponseEntity<ResponseObject> updateSpeakingTopic(@PathVariable int id, @RequestBody SpeakingTopic topic) {
        SpeakingTopic updatedTopic = speakingService.updateSpeakingTopic(id, topic);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Topic updated successfully.")
                .content(updatedTopic)
                .build());
    }

    @DeleteMapping("/topics/{id}")
    public ResponseEntity<ResponseObject> deleteSpeakingTopic(@PathVariable int id) {
        speakingService.deleteSpeakingTopic(id);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Topic deleted successfully.")
                .content(null)
                .build());
    }

    @GetMapping("/topics")
    public ResponseEntity<ResponseObject> getAllSpeakingTopics() {
        List<SpeakingTopic> topics = speakingService.getAllSpeakingTopics();
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Success")
                .content(topics)
                .build());
    }

    // CRUD for Speaking Questions

    @PostMapping("/topics/{topicId}/questions")
    public ResponseEntity<ResponseObject> createSpeakingQuestion(@PathVariable int topicId, @RequestBody SpeakingQuestion question) {
        SpeakingQuestion createdQuestion = speakingService.createSpeakingQuestion(topicId, question);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Question created successfully.")
                .content(createdQuestion)
                .build());
    }

    @PutMapping("/questions/{id}")
    public ResponseEntity<ResponseObject> updateSpeakingQuestion(@PathVariable int id, @RequestBody SpeakingQuestion question) {
        SpeakingQuestion updatedQuestion = speakingService.updateSpeakingQuestion(id, question);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Question updated successfully.")
                .content(updatedQuestion)
                .build());
    }

    @DeleteMapping("/questions/{id}")
    public ResponseEntity<ResponseObject> deleteSpeakingQuestion(@PathVariable int id) {
        speakingService.deleteSpeakingQuestion(id);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Question deleted successfully.")
                .content(null)
                .build());
    }

    @GetMapping("/topics/{topicId}/questions")
    public ResponseEntity<ResponseObject> getAllQuestionsByTopic(@PathVariable int topicId) {
        List<SpeakingQuestion> questions = speakingService.getAllQuestionsByTopic(topicId);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Success")
                .content(questions)
                .build());
    }

    // Get question by ID
    @GetMapping("/questions/{questionId}")
    public ResponseEntity<ResponseObject> getQuestionById(@PathVariable int questionId) {
        SpeakingQuestion question = speakingService.getQuestionById(questionId);
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Success")
                .content(question)
                .build());
    }

    // Submit Speaking Response

    @PostMapping("/submit")
    public ResponseEntity<?> submitSpeakingResponse(
            @RequestParam int userId,
            @RequestParam int questionId,
            @RequestParam("audioFile") MultipartFile audioFile) {

        // Check file format
        String contentType = audioFile.getContentType();
        if (!"audio/wav".equals(contentType) && !"audio/mp3".equals(contentType)) {
            return ResponseEntity.badRequest().body("Unsupported audio format: " + contentType);
        }

        try {
            SpeakingFeedback feedback = speakingService.submitSpeakingResponse(userId, questionId, audioFile);
            return ResponseEntity.ok(feedback);
        } catch (Exception e) {
            // Log the full stack trace for debugging
            log.error("Error processing speaking response", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body("Failed to process submission: " + e.getMessage());
        }
    }

    // Retrieve User Feedbacks

    @GetMapping("/feedbacks/{userId}")
    public ResponseEntity<List<SpeakingFeedback>> getUserSpeakingFeedbacks(@PathVariable int userId) {
        List<SpeakingFeedback> feedbacks = speakingService.getUserSpeakingFeedbacks(userId);
        return ResponseEntity.ok(feedbacks);
    }

    // AI Chat for Answer Suggestions
    @PostMapping("/generate-answer")
    public ResponseEntity<ResponseObject> generateAnswer(@RequestBody AIChatRequestDTO chatRequest) {
        try {
            // Gọi service để tạo câu trả lời
            String aiAnswer = speakingService.generateAnswer(chatRequest);
            return ResponseEntity.ok(ResponseObject.builder()
                    .status(HttpStatus.OK)
                    .mess("Answer generated successfully.")
                    .content(aiAnswer)
                    .build());
        } catch (Exception e) {
            log.error("Error generating answer", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ResponseObject.builder()
                            .status(HttpStatus.INTERNAL_SERVER_ERROR)
                            .mess("Failed to generate answer.")
                            .content(null)
                            .build());
        }
    }
}

================
File: controller/PrivateController/UploadController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.service.UploadService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

@RestController
@RequestMapping("/api/v1/public/upload")
public class UploadController {

    @Autowired
    private UploadService uploadService;

    @PostMapping("/img")
    public ResponseEntity<ResponseObject> uploadImg(@RequestPart(name = "file") MultipartFile img) throws IOException {
        var result = uploadService.uploadImg(img.getBytes());
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/video")
    public ResponseEntity<ResponseObject> uploadVideo(@RequestPart(name = "file") MultipartFile video) throws IOException {
        var result = uploadService.uploadVideo(video.getBytes());
        return ResponseEntity.status(result.getStatus()).body(result);
    }



}

================
File: controller/PrivateController/UserController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.auth.*;
import com.example.demo.dto.PasswordDTO;
import com.example.demo.dto.PostDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.mail.MailRequest;
import com.example.demo.mail.MailService;
import com.example.demo.repository.UserRepository;
import com.example.demo.service.UserService;
import jakarta.mail.MessagingException;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Optional;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/private/user")
public class UserController {
    private final AuthService authService;
    private final MailService mailService;
    private final UserService userService;
    private final UserRepository userRepository; // Or your service layer if you prefer

//    @PostMapping("/assign-role")
//    public ResponseEntity<?> assignRole(@RequestParam String email, @RequestParam String role) {
//        Role newRole = Role.valueOf(role.toUpperCase());
//        User updatedUser = authService.assignRoleToUser(email, newRole);
//        return ResponseEntity.ok(updatedUser);
//    }


    @PutMapping("/resetPassword/{email}")
    public ResponseEntity<ResponseObject> resetPassword(@RequestBody PasswordDTO passwordDTO, @RequestParam String email) {
        var result = authService.adminUpdatePasswordForUser(passwordDTO, email);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("")
    public ResponseEntity<ResponseObject> greeting() {
        var res = ResponseObject.builder().status(HttpStatus.OK).mess("Welcome to admin dashboard").build();
        return ResponseEntity.status(res.getStatus()).body(res);
    }

    @GetMapping("/getAll")
    public ResponseEntity<Page<User>> getAllActiveUsers(Pageable pageable) {
        Page<User> activeUsers = userService.getAllActiveUsers(pageable);
        return ResponseEntity.ok(activeUsers);
    }

    //    @GetMapping("/active")
//    public ResponseEntity<List<User>> getAllActiveUsers() {
//        List<User> activeUsers = userService.getAllActiveUsers();
//        return ResponseEntity.ok(activeUsers);
//    }
    @GetMapping("/getAllDeleted")
    public ResponseEntity<ResponseObject> getAllDeleted(@RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = userService.getAllDeletedByPage(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/getAllUserAndRole")
    public ResponseEntity<ResponseObject> getAllRole(@RequestParam(defaultValue = "false") boolean isDeleted) {
        var result = userService.getAllUserAndRole(isDeleted);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/filter")
    public ResponseEntity<ResponseObject> getUserByRole(@RequestParam(value = "role") String role,
                                                        @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = userService.getUserByRole(role, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/search")
    public ResponseEntity<ResponseObject> getUserByName(@RequestParam(value = "name") String name, @RequestParam(defaultValue = "false") boolean isDeleted,
                                                        @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = userService.getUserByName(name, isDeleted, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PostMapping("/login")
    public ResponseEntity<ResponseObject> authenticate(@RequestBody AuthenticationRequest request) {
        var res = authService.authenticate(request);
        return ResponseEntity.status(res.getStatus()).body(res);
    }

    @PostMapping("/register")
    public ResponseEntity<String> register(@RequestBody RegisterRequest request) {
        if (!authService.register(request))
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email existed");
        return ResponseEntity.ok("Register success!");
    }

    @PostMapping("/send-verify-email")
    public ResponseEntity<String> sendVerifyEmail(@RequestBody MailRequest email) {
        if (authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email existed");
        }
        String code = authService.getVerifyCode();
        if (mailService.sendCode(email.getEmail(), code)) {
            return ResponseEntity.ok(code);
        }
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Send mail failed!");
    }

    @PostMapping("/send-reset-password-email")
    public ResponseEntity<String> sendResetPasswordEmail(@RequestBody MailRequest email) throws MessagingException {
        if (!authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email does not exist!");
        }
        String code = authService.getVerifyCode();
        if (!mailService.sendMailResetPassword(email.getEmail(), code)) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Send mail failed!");
        }
        authService.saveCode(email, code);
        return ResponseEntity.ok(code);
    }

    @PostMapping("/verify-reset-password-code")
    public ResponseEntity<String> verifyResetPassCode(@RequestBody MailRequest request) {
        if (authService.isValidCode(request)) return ResponseEntity.ok("Valid code");
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Invalid code");
    }

    @PostMapping("/reset-password")
    public ResponseEntity<ResponseObject> resetPassword(@RequestBody ResetPasswordRequest request) {
            var result = authService.resetPassword(request);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/delete/soft/{id}")
    public ResponseEntity<ResponseObject> softDelete(@PathVariable int id) {
        var result = userService.softDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @DeleteMapping("/delete/hard/{id}")
    public ResponseEntity<ResponseObject> hardDelete(@PathVariable int id) {
        var result = userService.hardDelete(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @PutMapping("/restore/{id}")
    public ResponseEntity<ResponseObject> restoreUser(@PathVariable int id) {
        var result = userService.restoreUserById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/findIdByEmail")
    public ResponseEntity<?> getUserIdByEmail(@RequestParam String email) {
        Optional<User> userOptional = userRepository.findByEmail(email);
        if (userOptional.isPresent()) {
            return ResponseEntity.ok(userOptional.get().getId()); // Return just the user ID
        }
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body("User not found");
    }

}

================
File: controller/PrivateController/VocabularyController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.VocabularySetDTO;
import com.example.demo.entity.data.Vocabulary;
import com.example.demo.entity.data.VocabularySet;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.service.UserService;
import com.example.demo.service.VocabularyService;
import com.example.demo.service.VocabularySetService;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/private/vocabulary")
public class VocabularyController {

    @Autowired
    private VocabularyService vocabularyService;
    @Autowired
    private UserService userService;
    @Autowired
    private VocabularySetService vocabularySetService;
    @Autowired
    private ModelMapper modelMapper;
    @GetMapping
    public ResponseEntity<List<Vocabulary>> getAllVocabulary(){
        return ResponseEntity.ok(vocabularyService.getAllVocabulary());
    }

    @PostMapping
    public ResponseEntity<Vocabulary> addVocabulary(@RequestBody Vocabulary vocabulary){
        return ResponseEntity.ok(vocabularyService.addVocabulary(vocabulary));
    }

    @PutMapping("/{id}")
    public ResponseEntity<Vocabulary> updateVocabulary(@PathVariable Integer id, @RequestBody Vocabulary vocabulary){
        return ResponseEntity.ok(vocabularyService.updateVocabulary(id, vocabulary));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteVocabulary(@PathVariable Integer id){
        vocabularyService.deleteVocabulary(id);
        return ResponseEntity.noContent().build();
    }
    @PutMapping("/sets/{setId}")
    public ResponseEntity<VocabularySetDTO> updateVocabularySet(
            @PathVariable Integer setId,
            @RequestBody VocabularySetDTO setDTO,
            Authentication authentication) {

        String userEmail = authentication.getName();
        User user = userService.findByEmail(userEmail);

        VocabularySet set = vocabularySetService.getVocabularySetById(setId)
                .orElseThrow(() -> new ResourceNotFoundException("VocabularySet", "id", setId));

        if (set.getUser().getId() != (user.getId())) {
            throw new AccessDeniedException("You do not have permission to update this VocabularySet");
        }

        // Cập nhật các trường cần thiết
        set.setTitle(setDTO.getTitle());
        set.setTopic(setDTO.getTopic());
        set.setLevel(setDTO.getLevel());
        set.setQuantity(setDTO.getQuantity());

        // Cập nhật từ vựng nếu có
        if (setDTO.getVocabularies() != null) {
            set.getVocabularies().clear();
            setDTO.getVocabularies().forEach(vocabDTO -> {
                Vocabulary vocab = Vocabulary.builder()
                        .word(vocabDTO.getWord())
                        .definition(vocabDTO.getDefinition())
                        .example(vocabDTO.getExample())
                        .build();
                vocab.setVocabularySet(set);
                set.getVocabularies().add(vocab);
            });
        }

        VocabularySet updatedSet = vocabularySetService.createVocabularySet(set, set.getVocabularies());
        VocabularySetDTO updatedSetDTO = modelMapper.map(updatedSet, VocabularySetDTO.class);
        return ResponseEntity.ok(updatedSetDTO);
    }

    @DeleteMapping("/sets/{setId}")
    public ResponseEntity<Void> deleteVocabularySet(@PathVariable Integer setId, Authentication authentication) {
        String userEmail = authentication.getName();
        User user = userService.findByEmail(userEmail);

        VocabularySet set = vocabularySetService.getVocabularySetById(setId)
                .orElseThrow(() -> new ResourceNotFoundException("VocabularySet", "id", setId));

        if (set.getUser().getId()!= (user.getId())) {
            throw new AccessDeniedException("You do not have permission to delete this VocabularySet");
        }

        vocabularySetService.deleteVocabularySet(setId);
        return ResponseEntity.noContent().build();
    }

}

================
File: controller/PrivateController/VocabularyGenerationController.java
================
package com.example.demo.controller.PrivateController;

import com.example.demo.dto.VocabularySetDTO;
import com.example.demo.entity.data.Vocabulary;
import com.example.demo.entity.data.VocabularySet;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.service.GPTService;
import com.example.demo.service.VocabularySetService;
import com.example.demo.service.UserService;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/private/vocabulary-generation")
public class VocabularyGenerationController {

    @Autowired
    private GPTService gptService;

    @Autowired
    private VocabularySetService vocabularySetService;

    @Autowired
    private UserService userService;
    @Autowired
    private ModelMapper modelMapper;
    @PostMapping("/generate")
    public ResponseEntity<VocabularySet> generateVocabularySet(
            @RequestParam String topic,
            @RequestParam int quantity,
            @RequestParam String level,
            Authentication authentication) {

        String userEmail = authentication.getName();
        Integer userId = userService.findByEmail(userEmail).getId();

        // Gọi GPT để tạo từ vựng
        List<Vocabulary> vocabularies = gptService.generateVocabulary(topic, quantity, level);

        // Tạo VocabularySet
        VocabularySet vocabularySet = VocabularySet.builder()
                .title(String.format("Vocabulary Set: %s (%s)", topic, level))
                .topic(topic)
                .level(level)
                .quantity(quantity)
                .user(userService.findByEmail(userEmail))
                .build();

        // Lưu vào cơ sở dữ liệu
        VocabularySet savedSet = vocabularySetService.createVocabularySet(vocabularySet, vocabularies);

        return ResponseEntity.ok(savedSet);
    }

    @GetMapping("/sets")
    public ResponseEntity<List<VocabularySet>> getVocabularySets(Authentication authentication) {
        String userEmail = authentication.getName();
        Integer userId = userService.findByEmail(userEmail).getId();

        List<VocabularySet> sets = vocabularySetService.getVocabularySetsByUser(userId);
        return ResponseEntity.ok(sets);
    }
    @GetMapping("/sets/{setId}")
    public ResponseEntity<VocabularySetDTO> getVocabularySetById(@PathVariable Integer setId, Authentication authentication) {
        String userEmail = authentication.getName();
        User user = userService.findByEmail(userEmail);

        VocabularySet set = vocabularySetService.getVocabularySetById(setId)
                .orElseThrow(() -> new ResourceNotFoundException("VocabularySet", "id", setId));

        if (set.getUser().getId()!=(user.getId())) {
            throw new AccessDeniedException("You do not have permission to access this VocabularySet");
        }

        // Chuyển đổi VocabularySet sang VocabularySetDTO
        VocabularySetDTO setDTO = modelMapper.map(set, VocabularySetDTO.class);
        return ResponseEntity.ok(setDTO);
    }


    // Các endpoint khác như xóa, cập nhật nếu cần
}

================
File: controller/PublicController/ChatController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.ChatMessageDTO;
import com.example.demo.dto.UserDTO;
import com.example.demo.entity.data.Message;
import com.example.demo.service.MessageService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.Payload;
// Remove unused imports
// import org.springframework.messaging.handler.annotation.SendTo;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;
import java.util.stream.Collectors;

@RestController
public class ChatController {

    private final MessageService messageService;
    private final SimpMessagingTemplate messagingTemplate;
    public ChatController(MessageService messageService, SimpMessagingTemplate messagingTemplate) {
        this.messageService = messageService;
        this.messagingTemplate = messagingTemplate;
    }

    @MessageMapping("/chat")
    public void processMessage(@Payload ChatMessageDTO chatMessage, Principal principal) {
        System.out.println("Principal Name (should be senderId): " + principal.getName());

        // Save the message
        messageService.sendMessage(chatMessage.getSenderId(), chatMessage.getReceiverId(), chatMessage.getContent());

        // Send the message to the receiver
        messagingTemplate.convertAndSendToUser(
                chatMessage.getReceiverId().toString(),
                "/queue/messages",
                chatMessage
        );

        // Also send the message back to the sender
        messagingTemplate.convertAndSendToUser(
                principal.getName(), // This should be the sender's userId
                "/queue/messages",
                chatMessage
        );
    }


    @GetMapping("/students/{instructorId}")
    public ResponseEntity<List<UserDTO>> getStudentsForInstructor(@PathVariable Integer instructorId) {
        List<UserDTO> students = messageService.getStudentsForInstructor(instructorId);
        System.out.println(students);
        return ResponseEntity.ok(students);
    }
    @GetMapping("/messages/{userId1}/{userId2}")
    public ResponseEntity<List<ChatMessageDTO>> getMessagesBetweenUsers(
            @PathVariable Integer userId1,
            @PathVariable Integer userId2) {
        List<Message> messages = messageService.getMessagesBetweenUsers(userId1, userId2);
        List<ChatMessageDTO> messageDTOs = messages.stream()
                .map(ChatMessageDTO::new)
                .collect(Collectors.toList());
        return ResponseEntity.ok(messageDTOs);
    }


    @PutMapping("/messages/read")
    public ResponseEntity<Void> markMessagesAsRead(
            @RequestParam Integer receiverId,
            @RequestParam Integer senderId
    ) {
        messageService.markMessagesAsRead(receiverId, senderId);
        return ResponseEntity.noContent().build();
    }
}

================
File: controller/PublicController/CommentController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.CommentDTO;
import com.example.demo.entity.data.Comment;
import com.example.demo.service.CommentService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.handler.annotation.*;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.messaging.simp.annotation.SendToUser;
import org.springframework.stereotype.Controller;

import java.util.Objects;

@Controller
@RequiredArgsConstructor
public class CommentController {
    private final CommentService commentService;

    @Autowired
    private SimpMessagingTemplate simpMessagingTemplate;

    @MessageMapping("/comment/lesson/{lessonId}")
    @SendTo("/comment/lesson/{lessonId}")
    public Comment handleComment(@Payload CommentDTO commentDTO, @DestinationVariable int lessonId) throws Exception {
        System.out.println("Received CommentDTO: " + commentDTO);

        if (commentDTO == null) {
            throw new IllegalArgumentException("CommentDTO cannot be null");
        }



        Comment savedComment = commentService.saveComment(commentDTO);
        System.out.println("Saved Comment: " + savedComment);
        return savedComment;
    }
    @MessageExceptionHandler
    @SendToUser("/queue/errors")
    public String handleException(Throwable exception) {
        return exception.getMessage();
    }

}

================
File: controller/PublicController/DemoController.java
================
package com.example.demo.controller.PublicController;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/public")
public class DemoController {
    @GetMapping
    public String demo() {
        return "hello public";
    }
}

================
File: controller/PublicController/PCategoryController.java
================
package com.example.demo.controller.PublicController;


import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Category;
import com.example.demo.service.CategoryService;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/public/category")
@RequiredArgsConstructor
public class PCategoryController {

    private final CategoryService categoryService;

    @GetMapping("/getAll")
    public ResponseEntity<ResponseObject> getAll(@RequestParam(defaultValue = "0") int page,@RequestParam(defaultValue = "5") int size) {
        var result = categoryService.getAllCategory(page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @GetMapping("")
    public ResponseEntity<ResponseObject> getCategoryByName(@RequestParam String name, @RequestParam(defaultValue = "0") int page,@RequestParam(defaultValue = "5") int size) {
        var result = categoryService.getByTitle(name, page, size);
        return ResponseEntity.ok(result);
    }
    @GetMapping("/{id}")
    public ResponseEntity<Category> getById(@PathVariable int id) {
        var category = categoryService.getById(id);
        if(category == null) {
            return ResponseEntity.badRequest().build();
        }
        return ResponseEntity.ok(category);
    }

}

================
File: controller/PublicController/PCourseController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.InstructorDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.CourseDTO;
import com.example.demo.entity.user.User;
import com.example.demo.service.CourseService;
import com.example.demo.service.DTOMapperService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;


@RestController
@RequestMapping("/api/v1/public/course")
@RequiredArgsConstructor
public class PCourseController {
    private final CourseService courseService;
    private final DTOMapperService dtoMapperService;
    @GetMapping("/getAll")
    public ResponseEntity<ResponseObject> getAllByPageable(@RequestParam(defaultValue = "0") int page,
                                                           @RequestParam(defaultValue = "99") int size) {
        var result = courseService.getAllByPageable(page, size);
        System.out.println("result"+result.getContent());
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getCourseById(@PathVariable int id, @RequestParam boolean isDeleted){
        var result = courseService.getCourseById(id, isDeleted);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/category")
    public ResponseEntity<ResponseObject> getCourseByCategoryId(@RequestParam("id") int id, @RequestParam(defaultValue = "0") int page, @RequestParam(defaultValue = "5") int size) {
        var result = courseService.getAllCourseByCategoryId(id, page, size);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
    @GetMapping("/{courseId}/instructor")
    public ResponseEntity<?> getInstructorByCourseId(@PathVariable int courseId) {
        try {
            User instructor = courseService.getInstructorByCourseId(courseId);
            InstructorDTO instructorDTO = dtoMapperService.mapUserToInstructorDTO(instructor);
            return ResponseEntity.ok(instructorDTO);
        } catch (RuntimeException ex) {
            return ResponseEntity.status(404).body("Course not found or no instructor assigned");
        }
    }
}

================
File: controller/PublicController/PLessonController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.ResponseObject;
import com.example.demo.repository.data.LessonRepository;
import com.example.demo.service.CommentService;
import com.example.demo.service.LessonService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/public/lesson")
@RequiredArgsConstructor
public class PLessonController {
    private final LessonRepository lessonRepository;
    private final LessonService lessonService;
    private final CommentService commentService;

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getById(@PathVariable  int id) {
        var result = lessonService.getById(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

    @GetMapping("/{id}/comments")
    public ResponseEntity<ResponseObject> getComments(@PathVariable  int id) {
        var result = commentService.getCommentByLessonId(id);
        return ResponseEntity.status(result.getStatus()).body(result);
    }
}

================
File: controller/PublicController/PublicTestController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.dto.TestDTO;
import com.example.demo.entity.data.ListeningSection;
import com.example.demo.entity.data.Passage;
import com.example.demo.entity.data.Test;
import com.example.demo.service.TestService;
import com.example.demo.dto.ResponseObject;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/public/tests")
@RequiredArgsConstructor
public class PublicTestController {

    private final TestService testService;

    @GetMapping("")
    public ResponseEntity<ResponseObject> getAllTests() {
        List<Test> tests = testService.getAllTests();
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Tests fetched successfully")
                .content(tests)
                .build());
    }

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getTestById(@PathVariable int id) {
        TestDTO testDTO = testService.getTestDTOById(id);
        if (testDTO == null) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                    ResponseObject.builder()
                            .status(HttpStatus.NOT_FOUND)
                            .mess("Test not found")
                            .build()
            );
        }

        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Test fetched successfully")
                .content(testDTO)
                .build());
    }
}

================
File: controller/PublicController/PublicWritingController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.entity.data.WritingTask;
import com.example.demo.service.WritingService;
import com.example.demo.dto.ResponseObject;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/public/writing")
@RequiredArgsConstructor
public class PublicWritingController {

    private final WritingService writingService;

    @GetMapping("")
    public ResponseEntity<ResponseObject> getAllWritingTasks() {
        List<WritingTask> tasks = writingService.getAllWritingTasks();
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Writing tasks fetched successfully")
                .content(tasks)
                .build());
    }

    @GetMapping("/{id}")
    public ResponseEntity<ResponseObject> getWritingTaskById(@PathVariable int id) {
        WritingTask task = writingService.getWritingTaskById(id);
        if (task == null) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                    ResponseObject.builder()
                            .status(HttpStatus.NOT_FOUND)
                            .mess("Writing task not found")
                            .build()
            );
        }
        return ResponseEntity.ok(ResponseObject.builder()
                .status(HttpStatus.OK)
                .mess("Writing task fetched successfully")
                .content(task)
                .build());
    }
}

================
File: controller/PublicController/PUserController.java
================
package com.example.demo.controller.PublicController;

import com.example.demo.auth.*;
import com.example.demo.dto.ResponseObject;
import com.example.demo.mail.MailRequest;
import com.example.demo.mail.MailService;
import com.example.demo.service.UserService;
import jakarta.mail.MessagingException;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/public/user")
public class PUserController {
    private final AuthService authService;
    private final MailService mailService;

    @PostMapping("/login")
    public ResponseEntity<ResponseObject> authenticate(@RequestBody AuthenticationRequest request) {
        var res = authService.authenticate(request);
        return ResponseEntity.status(res.getStatus()).body(res);
    }

    @PostMapping("/register")
    public ResponseEntity<String> register(@RequestBody RegisterRequest request) {
        if (!authService.register(request))
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email đã tồn tại!");
        return ResponseEntity.ok("Đăng ký thành công!");
    }

    @PostMapping("/send-verify-email")
    public ResponseEntity<String> sendVerifyEmail(@RequestBody MailRequest email) {
        if (authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email đã tồn tại!"); // 400
        }
        String code = authService.getVerifyCode();
        if (mailService.sendCode(email.getEmail(), code)) {
            return ResponseEntity.ok(code);
        }
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Gửi không thành công!");
    }

    @PostMapping("/send-reset-password-email")
    public ResponseEntity<String> sendResetPasswordEmail(@RequestBody MailRequest email) throws MessagingException {
        if (!authService.isUsedEmail(email.getEmail())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Email không tồn tài!");
        }
        String code = authService.getVerifyCode();
        if(!mailService.sendMailResetPassword(email.getEmail(), code)) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Gửi mail thất bại!");
        }
        authService.saveCode(email, code);
        return ResponseEntity.ok(code);
    }

    @PostMapping("/verify-reset-password-code")
    public ResponseEntity<String> verifyResetPassCode(@RequestBody MailRequest request) {
        if (authService.isValidCode(request)) return ResponseEntity.ok("Mã xác thực đúng");
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Mã xác thực sai!");
    }

    @PostMapping("/reset-password")
    public ResponseEntity<ResponseObject> resetPassword(@RequestBody ResetPasswordRequest request) {
            var result = authService.resetPassword(request);
        return ResponseEntity.status(result.getStatus()).body(result);
    }

//    @PostMapping("/send-verify-otp")
//    public ResponseEntity<String> sendOtp(@RequestBody OtpVerifyRequest request) {
//        if(!authService.isValidPhoneNumber(request.getPhoneNumber())) return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Số điện thoại chưa được đăng kí!");
//        if(!authService.sendOtpVerification(request)) return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Gửi OTP thất bại!");
//        return ResponseEntity.ok("Gửi mã xác nhận thành công!");
//    }



}

================
File: DemoApplication.java
================
package com.example.demo;

import com.example.demo.auth.AuthService;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.jwt.JwtService;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.util.List;

@SpringBootApplication
@RequiredArgsConstructor
public class DemoApplication {
    private final UserRepository userRepository;
    private final JwtService jwtService;
    private final PasswordEncoder passwordEncoder;

    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
//    	@Bean
//    CommandLineRunner commandLineRunner (AuthService authService) {
//		return args -> {
//			User user = User.builder()
//					.firstName("nguyen")
//					.lastName("user")
//					.email("user@gmail.com")
//					.password(passwordEncoder.encode("Tuan@1111"))
//					.role(Role.USER)
//					.build();
//			System.out.println(jwtService.generateToken(user));
//			User admin = User.builder()
//					.firstName("nguyen")
//					.lastName("admin")
//					.email("admin@gmail.com")
//					.password(passwordEncoder.encode("Tuan@1111"))
//					.role(Role.ADMIN)
//					.build();
//			System.out.println(jwtService.generateToken(admin));
//
//			User instructor = User.builder()
//					.firstName("nguyen")
//					.lastName("manager")
//					.email("manager@gmail.com")
//					.password(passwordEncoder.encode("Tuan@1111"))
//					.role(Role.INSTRUCTOR)
//					.build();
//			System.out.println(jwtService.generateToken(instructor));
//
//			userRepository.saveAll(List.of(user, admin, instructor));
//		};
//	}

}

================
File: dto/AIChatRequestDTO.java
================
// src/main/java/com/example/demo/dto/AIChatRequestDTO.java

package com.example.demo.dto;

import lombok.Data;

@Data
public class AIChatRequestDTO {
    private int userId;
    private int questionId;
    private String userInput;
}

================
File: dto/ChatMessageDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Message;
import lombok.Data;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDateTime;
@Getter
@Setter
@Data
@NoArgsConstructor

public class ChatMessageDTO {
    private Integer senderId;
    private Integer receiverId;
    private String content;
    private LocalDateTime timestamp; // Add timestamp if needed
    public ChatMessageDTO(Message message) {
        this.senderId = message.getSender().getId();
        this.receiverId = message.getReceiver().getId();
        this.content = message.getContent();
        this.timestamp = message.getTimestamp();
    }
}

================
File: dto/Choice.java
================
package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@JsonIgnoreProperties(ignoreUnknown = true)
public class Choice {
    private int index;
    private Message message;
}

================
File: dto/CommentDTO.java
================
package com.example.demo.dto;

import lombok.Builder;
import lombok.Data;
import org.springframework.context.annotation.Bean;

@Data
@Builder
public class CommentDTO {
    private String email;
    private String userName;
    private String content;
    private String path;
    private int lessonId;
    private boolean sub;
    private String avatar;
    private int parentId;
    private String replyToUser;
    private String replyToUserName;
}

================
File: dto/CourseDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Progress;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

import java.time.LocalDateTime;
import java.util.List;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class CourseDTO {
    private String title;
    private int price;
    private int discount;
    private String description;
    private LocalDateTime date;
    private List<Integer> categories; // IDs of associated categories
    private List<SectionDTO> sections; // Associated sections
    private String thumbnail;
    private String video;
    private String instructor; // Instructor's email
    private boolean isEditedCategories;
    private boolean isEdited;
}

================
File: dto/CourseStatisticDTO.java
================
package com.example.demo.dto;


import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;

@Builder
@AllArgsConstructor
@Data
public class CourseStatisticDTO {
    private int id;
//    private String title;
    private String thumbnail;
//    private int price;
    private String courseTitle;
    private int enrollments;
}

================
File: dto/CriterionFeedback.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
class CriterionFeedback {
    private double score;
    private String comments;
}

================
File: dto/EnrollDTO.java
================
package com.example.demo.dto;

import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
public class EnrollDTO {

    private String email;
    private int courseId;
    private List<Integer> lessonIds;
}

================
File: dto/EssayFeedback.java
================
// src/main/java/com/example/demo/dto/EssayFeedback.java

package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@AllArgsConstructor
@NoArgsConstructor
@JsonIgnoreProperties(ignoreUnknown = true) // Add this annotation
public class EssayFeedback {
    private List<GrammarError> grammarErrors;
    private List<VocabularyError> vocabularyErrors;
    private String overallFeedback;
    private int overallScore;

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class GrammarError {
        private String sentence;
        private String error;
        private String recommendation;
    }

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class VocabularyError {
        private String word;
        private String error;
        private String recommendation;
    }
}

================
File: dto/EssaySubmissionRequest.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class EssaySubmissionRequest {
    private int userId;
    private int writingTaskId;
    private String essayContent;
}

================
File: dto/GrammarError.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
class GrammarError {
    private String sentence;
    private String error;
    private String recommendation;
}

================
File: dto/InstructorDTO.java
================
package com.example.demo.dto;

import lombok.*;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class InstructorDTO {
    private int id;
    private String firstName;
    private String lastName;
    private String email;
    private String avatar;
}

================
File: dto/LessonDTO.java
================
package com.example.demo.dto;

import lombok.Data;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

// NONE, REMOVE, UPDATE, HAS
@Getter
@Data
@NoArgsConstructor
public class LessonDTO {
    private int id;
    private String linkVideo;
    private String title;
    private String description;
    private LocalDateTime date;
    private String video;
    private boolean isEdited;
    private String actionVideo = "NONE";
    public LessonDTO(String value){}
}

================
File: dto/LessonProgressDTO.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class LessonProgressDTO {
    private int userId;
    private int lessonId;
    private double progressPercentage;
    private boolean completed;
    private boolean unlocked;

    // Getters and setters
}

================
File: dto/ListeningSectionDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ListeningSectionDTO {

    private int id;
    private int sectionNumber;
    private String audioUrl;
    private String transcript;
    private List<QuestionDTO> questions;
}

================
File: dto/Message.java
================
package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@JsonIgnoreProperties(ignoreUnknown = true)
public class Message {
    private String role;
    private String content;
}

================
File: dto/OpenAIRequest.java
================
// src/main/java/com/example/demo/dto/OpenAIRequest.java

package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@JsonIgnoreProperties(ignoreUnknown = true)
public class OpenAIRequest {
    private String model;
    private List<Message> messages;

    @Data
    @NoArgsConstructor
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Message {
        private String role;
        private String content;
        private String refusal; // Include this field if you're passing it
        public Message(String role, String content, String refusal) {
            this.role = role;
            this.content = content;
            this.refusal = refusal;
        }

    }
}

================
File: dto/OpenAIResponse.java
================
// src/main/java/com/example/demo/dto/OpenAIResponse.java

package com.example.demo.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Data;

import java.util.List;

@Data
@JsonIgnoreProperties(ignoreUnknown = true)
public class OpenAIResponse {
    private String id;
    private String object;
    private long created;
    private String model;
    private List<Choice> choices;
    private Usage usage;

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Choice {
        private int index;
        private OpenAIRequest.Message message;
        private String finish_reason;
        // Optionally include logprobs if needed
        // private JsonNode logprobs;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Usage {
        private int prompt_tokens;
        private int completion_tokens;
        private int total_tokens;
        // Optionally include prompt_tokens_details if needed
        // private JsonNode prompt_tokens_details;
    }
}

================
File: dto/PassageDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PassageDTO {

    private int id;
    private int passageNumber;
    private String content;
    private List<QuestionDTO> questions;
}

================
File: dto/PasswordDTO.java
================
package com.example.demo.dto;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class PasswordDTO {
    private String email;
    private String oldPassword;
    private String newPassword;
}

================
File: dto/PostDTO.java
================
package com.example.demo.dto;


import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class PostDTO {
    private String content;
    private String title;
    private String email;
}

================
File: dto/ProgressDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Course;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Data
@Builder
public class ProgressDTO {
    private  Course course;
    private List<Integer> lessonIds = new ArrayList<>();
    public ProgressDTO(Course course) {
        this.course = course;
    }

    public ProgressDTO(Course course, List<Integer> lessonIds) {
        this.course = course;
        this.lessonIds = lessonIds;
    }
}

================
File: dto/QuestionDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class QuestionDTO {

    private int id;
    private String content;
    private String questionType;
    private int questionNumber;
    private List<QuestionOptionDTO> options;
}

================
File: dto/QuestionOptionDTO.java
================
package com.example.demo.dto;

import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class QuestionOptionDTO {

    private int id;
    private String content;
}

================
File: dto/ResponseObject.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import org.springframework.http.HttpStatus;

@Data
@Builder
@AllArgsConstructor
public class ResponseObject {
    private HttpStatus status;
    private String mess;
    private Object content;
}

================
File: dto/SectionDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Lesson;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SectionDTO {
    private int id;
    private String title;
    private int isEdited;
    private List<LessonDTO> lessons; // Associated lessons
}

================
File: dto/SpeakingFeedbackDTO.java
================
// src/main/java/com/example/demo/dto/SpeakingFeedbackDTO.java

package com.example.demo.dto;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.Data;

import java.io.IOException;
import java.util.List;

@Data
public class SpeakingFeedbackDTO {
    private List<PronunciationError> pronunciationErrors;
    private List<GrammarError> grammarErrors;
    private List<VocabularyError> vocabularyErrors;
    private String overallFeedback;

    // Method to convert JSON string to DTO
    public static SpeakingFeedbackDTO fromJson(String json) {
        ObjectMapper mapper = new ObjectMapper();
        try {
            return mapper.readValue(json, SpeakingFeedbackDTO.class);
        } catch (IOException e) {
            throw new RuntimeException("Failed to parse SpeakingFeedbackDTO from JSON.", e);
        }
    }

    // Method to convert DTO to JSON string
    public String toJson() {
        ObjectMapper mapper = new ObjectMapper();
        try {
            return mapper.writeValueAsString(this);
        } catch (IOException e) {
            throw new RuntimeException("Failed to convert SpeakingFeedbackDTO to JSON.", e);
        }
    }

    @Data
    public static class PronunciationError {
        private String word;
        private String error;
        private String recommendation;
    }

    @Data
    public static class GrammarError {
        private String sentence;
        private String error;
        private String recommendation;
    }

    @Data
    public static class VocabularyError {
        private String word;
        private String error;
        private String recommendation;
    }
}

================
File: dto/StatisticsDTO.java
================
package com.example.demo.dto;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.domain.Page;
@Data
@Builder
public class StatisticsDTO {
    private Page<CourseStatisticDTO> coursesCreated;
    private Page<UserStatisticDTO> usersRegistered;
}

================
File: dto/TestDTO.java
================
package com.example.demo.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class TestDTO {

    private int id;
    private String title;
    private String type;
    private List<PassageDTO> passages; // For Reading Test
    private List<ListeningSectionDTO> listeningSections; // For Listening TestTest
}

================
File: dto/UserDTO.java
================
package com.example.demo.dto;

import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import jakarta.persistence.Entity;
import lombok.*;

import java.util.List;

@Data
@AllArgsConstructor
@Builder
@NoArgsConstructor
@Getter
@Setter
public class UserDTO {
    private int id;

    private String email;
    private String password;
    private String firstName;
    private String lastName;
    private String avatar;
    private String phoneNumber;
    private String token;
    private List<Progress> progresses;
    private Role role;

    public UserDTO(User user) {
        this.id = user.getId();
        this.email = user.getEmail();
        this.firstName = user.getFirstName();
        this.lastName = user.getLastName();
        this.avatar = user.getAvatar();
        this.phoneNumber = user.getPhoneNumber();
        this.role = user.getRole();
    }

    public void setAvatar(String avatar) {
    }
}

================
File: dto/UserEssayDTO.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class UserEssayDTO {
    private int id;
    private String content;
    private LocalDateTime submissionTime;
    private double score;
    private String email;
}

================
File: dto/UserResponseDTO.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserResponseDTO {
    private int questionId;
    private String userAnswer;
}

================
File: dto/UsersAndRoles.java
================
package com.example.demo.dto;

import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import lombok.Builder;
import lombok.Data;
import org.springframework.data.domain.Page;


@Builder
@Data
public class UsersAndRoles {
    private Page<User> users;
    private Role[] roles;
}

================
File: dto/UserStatisticDTO.java
================
package com.example.demo.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.RequiredArgsConstructor;

@Builder
@AllArgsConstructor
@RequiredArgsConstructor
@Data
public class UserStatisticDTO {
    private int id;
    private final String email;
    private final String firstName;
    private final String lastName;
    private final String avatar;
}

================
File: dto/VocabularyDTO.java
================
package com.example.demo.dto;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class VocabularyDTO {
    private int id;
    private String word;
    private String definition;
    private String example;
    private String topic;
    private String level;
    private LocalDateTime createdAt;
}

================
File: dto/VocabularyError.java
================
package com.example.demo.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
class VocabularyError {
    private String word;
    private String error;
    private String recommendation;
}

================
File: dto/VocabularySetDTO.java
================
package com.example.demo.dto;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

@Data
public class VocabularySetDTO {
    private int id;
    private String title;
    private String topic;
    private String level;
    private int quantity;
    private LocalDateTime createdAt;
    private List<VocabularyDTO> vocabularies;
}

================
File: entity/data/Category.java
================
package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.*;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Builder
@Getter
@Setter
@AllArgsConstructor
@NoArgsConstructor
@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "name")
public class Category {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String name;
    private LocalDateTime date;
    private boolean isDeleted = false;
    @ManyToMany(mappedBy = "categories")
//! không được sử dụng @JsonBackReference() với Collections
    @JsonIgnore
    private List<Course> courses = new ArrayList<>();
}

================
File: entity/data/Comment.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.Date;

@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Comment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private LocalDateTime date;
    @Column(columnDefinition = "TEXT")
    private String content;
    private String userEmail;
    private String userName;
    private String avatar;
    private int parentId;
    private String replyToUser;
    private String replyToUserName;

    @ManyToOne
    @JsonIgnore
    private User user;

    @ManyToOne
    @JsonIgnore
    private Lesson lesson;
}

================
File: entity/data/Course.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.*;
import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.ManyToAny;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "id")
public class Course {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title;

    private String video;

    private int price;

    private int discount;

    private LocalDateTime date;

    @Column(columnDefinition = "TEXT")
    private String description;

    private String thumbnail;

    private String alias;

    private boolean isDeleted = false;

    @ManyToMany
    @JoinTable(
            name = "course_category",
            joinColumns = @JoinColumn(name = "course_id", referencedColumnName = "id"),
            inverseJoinColumns = @JoinColumn(name = "category_id", referencedColumnName = "id")
    )
    @Builder.Default
    private List<Category> categories = new ArrayList<>();

    @OneToMany(mappedBy = "course", cascade = CascadeType.ALL)
    @Builder.Default
    private List<Section> sections = new ArrayList<>();



    // New mapping: reference to the instructor
    @ManyToOne
    @JoinColumn(name = "instructor_id", nullable = false)
    @JsonIgnore // Bỏ qua instructor khi serialize Course

    private User instructor;

    // Additional utility methods if needed
    public void addCategory(Category category) {
        this.categories.add(category);
    }

    public void addSection(Section section) {
        this.sections.add(section);
    }

}

================
File: entity/data/Flashcard.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Entity
@Table(name = "flashcards")
public class Flashcard {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @ManyToOne
    @JoinColumn(name = "set_id")
    private FlashcardSet set;

    @ManyToOne
    @JoinColumn(name = "vocabulary_id")
    private Vocabulary vocabulary;

    // Getters and Setters
}

================
File: entity/data/FlashcardSet.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

import java.time.LocalDateTime;
import java.util.List;

@Getter
@Setter
@Entity
@Table(name = "flashcard_sets")
public class FlashcardSet {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title;
    private String description;

    private LocalDateTime createdAt;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;

    @OneToMany(mappedBy = "set", cascade = CascadeType.ALL)
    private List<Flashcard> flashcards;

    // Getters and Setters
}

================
File: entity/data/Lesson.java
================
package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.JsonBackReference;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
//@Data
@NoArgsConstructor
@Getter
@Setter
@AllArgsConstructor
@Builder
public class Lesson {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String description;
    private String linkVideo;
    private String title;
    private String video;
    private LocalDateTime date;
    private int duration;
    private boolean isDeleted = false;
    private boolean isEdited = false;
    private String actionVideo = "NONE";
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "section_id")
    @JsonBackReference // Ngăn chặn vòng lặp khi serialize
    private Section section;
}

================
File: entity/data/LessonProgress.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@Entity
@NoArgsConstructor
@AllArgsConstructor
public class LessonProgress {
    @EmbeddedId
    private LessonProgressKey id;

    @ManyToOne
    @MapsId("userId")
    @JoinColumn(name = "user_id")
    private User user;

    @ManyToOne
    @MapsId("lessonId")
    @JoinColumn(name = "lesson_id")
    private Lesson lesson;

    private double progressPercentage;

    private boolean isCompleted; // True if progress >= 80%

    private boolean isUnlocked;
}

================
File: entity/data/LessonProgressKey.java
================
package com.example.demo.entity.data;

import jakarta.persistence.Column;
import jakarta.persistence.Embeddable;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.io.Serializable;
@Getter
@Setter
@Embeddable
@NoArgsConstructor
@AllArgsConstructor
public class LessonProgressKey implements Serializable {
    @Column(name = "user_id")
    private int userId;

    @Column(name = "lesson_id")
    private int lessonId;
}

================
File: entity/data/ListeningSection.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class ListeningSection {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private int sectionNumber; // 1, 2, 3, or 4

    private String audioUrl; // URL to the audio file

    @Column(columnDefinition = "TEXT")
    private String transcript; // Optional: transcript of the audio

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_id")
    private Test test;

    @OneToMany(mappedBy = "listeningSection", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Question> questions = new ArrayList<>();
}

================
File: entity/data/Message.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Message {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @ManyToOne
    @JoinColumn(name = "sender_id", nullable = false)
    private User sender;

    @ManyToOne
    @JoinColumn(name = "receiver_id", nullable = false)
    private User receiver;

    @Column(nullable = false)
    private String content;

    @Column(nullable = false)
    private LocalDateTime timestamp;

    @Column(nullable = false)
    private boolean isRead;

    @Column(nullable = false)
    private String chatRoomId;
}

================
File: entity/data/Passage.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Passage {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private int passageNumber; // 1, 2, or 3

    @Column(columnDefinition = "TEXT")
    private String content; // The text content of the passage

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_id")
    private Test test;

    @OneToMany(mappedBy = "passage", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Question> questions = new ArrayList<>();
}

================
File: entity/data/Progress.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import jdk.jshell.spi.ExecutionControl;
import lombok.*;
import org.antlr.v4.runtime.misc.IntegerList;

import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Progress {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private  int id;

    @ElementCollection // 1
    @CollectionTable(name = "lesson_ids", joinColumns = @JoinColumn(name = "id")) // 2
    @Column(name = "list_lessonid") // 3
    private List<Integer> lessonIds;

    @ManyToOne(cascade = CascadeType.PERSIST)
    @JoinColumn(name = "course_id")

    private Course course;

    @ManyToOne(cascade = CascadeType.PERSIST)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;
}

================
File: entity/data/Question.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Question {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @Column(columnDefinition = "TEXT")
    private String content; // The question text

    private String questionType; // e.g., "MULTIPLE_CHOICE", "TRUE_FALSE", "FILL_IN_THE_BLANK"

    private String correctAnswer; // For checking user responses

    private int questionNumber;

    private boolean isDeleted = false;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "passage_id")
    private Passage passage;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "listening_section_id")
    private ListeningSection listeningSection;

    @OneToMany(mappedBy = "question", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<QuestionOption> options = new ArrayList<>(); // For multiple-choice questions
}

================
File: entity/data/QuestionOption.java
================
package com.example.demo.entity.data;


import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "question_option") // Specify a non-reserved table name

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class QuestionOption {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String content; // Option text

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "question_id")
    private Question question;
}

================
File: entity/data/Section.java
================
package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.JsonBackReference;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonManagedReference;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.Where;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Section {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title;
    private boolean isDeleted = false;
    private boolean isEdited = false;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "course_id")
    private Course course;

    @OneToMany(mappedBy = "section", cascade = CascadeType.ALL, orphanRemoval = true)
    @JsonManagedReference // Serialize lessons theo chiều từ Section -> Lesson
    private List<Lesson> lessons = new ArrayList<>();
}

================
File: entity/data/SpeakingFeedback.java
================
// src/main/java/com/example/demo/entity/data/SpeakingFeedback.java

package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class SpeakingFeedback {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @Lob
    @Column(nullable = false, columnDefinition = "LONGTEXT")
    private String transcript;

    @Lob
    @Column(nullable = false, columnDefinition = "LONGTEXT")
    private String feedbackJson; // JSON containing pronunciation, grammar, vocab feedback

    private LocalDateTime submissionTime;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    @JsonIgnore
    private User user;

    @ManyToOne(fetch = FetchType.LAZY)
    @JsonIgnore
    @JoinColumn(name = "question_id", nullable = false)
    private SpeakingQuestion question;

    @Column(nullable = true)
    private String audioUrl;
}

================
File: entity/data/SpeakingQuestion.java
================
// src/main/java/com/example/demo/entity/data/SpeakingQuestion.java

package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class SpeakingQuestion {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @Column(nullable = false)
    private String questionText;

    @ManyToOne(fetch = FetchType.LAZY)
    @JsonIgnore
    @JoinColumn(name = "topic_id", nullable = false)
    private SpeakingTopic topic;
}

================
File: entity/data/SpeakingTopic.java
================
// src/main/java/com/example/demo/entity/data/SpeakingTopic.java

package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class SpeakingTopic {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @Column(nullable = false, unique = true)
    private String name;

    @OneToMany(mappedBy = "topic", cascade = CascadeType.ALL, orphanRemoval = true)
    @JsonIgnore
    private List<SpeakingQuestion> questions;
}

================
File: entity/data/Test.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Test {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String title; // e.g., "IELTS Cambridge Reading Test 1"

    private String type; // "READING" or "LISTENING"

    private LocalDateTime date;

    private boolean isDeleted = false;

    // For Reading Test
    @OneToMany(mappedBy = "test", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Passage> passages = new ArrayList<>();

    // For Listening Test
    @OneToMany(mappedBy = "test", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<ListeningSection> listeningSections = new ArrayList<>();

}

================
File: entity/data/TestProgress.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;
import java.util.List;
import java.util.ArrayList;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class TestProgress {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private LocalDateTime startTime;

    private LocalDateTime endTime;

    private int totalQuestions;

    private int correctAnswers;

    private boolean isCompleted;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_id")
    private Test test;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;

    @OneToMany(mappedBy = "testProgress", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<UserResponse> userResponses = new ArrayList<>();
}

================
File: entity/data/UserEssay.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserEssay {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @Column(columnDefinition = "TEXT")
    private String content; // User's essay content

    private LocalDateTime submissionTime;

    @Column(columnDefinition = "TEXT")
    private String feedbackJson; // JSON feedback from the AI

    private double score; // Optional score assigned

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "writing_task_id")
    @JsonIgnore
    private WritingTask writingTask;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;
}

================
File: entity/data/UserResponse.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserResponse {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String userAnswer;

    private boolean isCorrect;

    private LocalDateTime responseTime;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "question_id")
    private Question question;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_progress_id")
    private TestProgress testProgress;
}

================
File: entity/data/Vocabulary.java
================
package com.example.demo.entity.data;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Getter
@Setter
@Entity
@NoArgsConstructor
@Builder
@AllArgsConstructor

@Table(name = "vocabulary")
public class Vocabulary {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    private String word;
    private String definition;
    private String example;
    private String topic;
    private String level;

    private LocalDateTime createdAt;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "vocabulary_set_id")
    @JsonIgnore
    private VocabularySet vocabularySet;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
    }

    // Getters và Setters
}

================
File: entity/data/VocabularySet.java
================
package com.example.demo.entity.data;

import com.example.demo.entity.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class VocabularySet {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    private String title; // Tiêu đề bộ từ vựng
    private String topic; // Chủ đề
    private String level; // Mức độ (ví dụ: Beginner, Intermediate, Advanced)
    private int quantity; // Số lượng từ

    private LocalDateTime createdAt;

    @ManyToOne
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;

    @OneToMany(mappedBy = "vocabularySet", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Vocabulary> vocabularies = new ArrayList<>();

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
    }
}

================
File: entity/data/WritingTask.java
================
package com.example.demo.entity.data;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class WritingTask {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String taskType; // "TASK1" or "TASK2"

    private String title;

    @Column(columnDefinition = "TEXT")
    private String prompt; // The essay prompt

    private LocalDateTime dateCreated;

    private boolean isDeleted = false;
}

================
File: entity/repomix-output.txt
================
Due to a technological outbreak, there is a probability that crime rates will decrease .It is believed by some that advanced techniques will assist in the prevention of any social issue . I personally agree with this notion and will elucidate my viewpoint in forthcoming paragraphs.

To commence with, there are myriad ways that  can be helpful in detection techniques firstly many big cities have installed safety cameras to reduce traffic issues on roads. These safety cameras should be installed in streets to deteriorate petty crimes like snatching and robbery.

Furthermore, police can use drone cameras in areas where the crime rate is higher. For instance, to monitor rallies and processions police can use drones for live monitoring .

Moreover, face detection and bio-metrics are helping investigators to reach suspects with little effort . Continuous advancement in these technologies will make it  easier to delve into root causes  without any hassle . For example  in Pakistan police were able to catch everyone who was involved in upsetting law and order situation . This was possible only because of face detection techniques .

In addition to that, there are many ways to find out whether the picture or video is real  . And some countries like France are using this to solve mysteries surrounding heinous crimes.

In my opinion, there are many folks who believe that they can escape after committing any petty crimes . No one can point a finger if they do not have solid proof to present in court

To recapitulate, it can be reiterated that new ways will definitely reduce  crimes. if people get to know that they can not deceive these modern techniques then definitely they will think twice or thrice before attempting to commit in crime.

================
File: entity/user/OtpStatus.java
================
package com.example.demo.entity.user;

public enum OtpStatus {
    DELIVERED, FAILED
}

================
File: entity/user/Permission.java
================
package com.example.demo.entity.user;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

public enum Permission {
    INSTRUCTOR_CREATE_COURSE("instructor:create_course"),
    INSTRUCTOR_UPDATE_COURSE("instructor:update_course"),
    INSTRUCTOR_DELETE_COURSE("instructor:delete_course"),
    INSTRUCTOR_READ_COURSE("instructor:read_course"),
    INSTRUCTOR_COMMUNICATE("instructor:communicate"),
    // Existing permissions
    ADMIN_CREATE("admin:create"),
    ADMIN_UPDATE("admin:update"),
    ADMIN_DELETE("admin:delete"),
    ADMIN_READ("admin:read"),
    MANAGER_CREATE("manager:create"),
    MANAGER_UPDATE("manager:update"),
    MANAGER_DELETE("manager:delete"),
    MANAGER_READ("manager:read");

    @Getter
    private final String permission;

    Permission(String permission) {
        this.permission = permission;
    }
}

================
File: entity/user/Role.java
================
package com.example.demo.entity.user;

import lombok.Getter;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import java.util.*;
import java.util.stream.Collectors;
@Getter

public enum Role {

    USER(Collections.emptySet()),
    INSTRUCTOR(
            Set.of(
                    Permission.INSTRUCTOR_CREATE_COURSE,
                    Permission.INSTRUCTOR_UPDATE_COURSE,
                    Permission.INSTRUCTOR_DELETE_COURSE,
                    Permission.INSTRUCTOR_READ_COURSE,
                    Permission.INSTRUCTOR_COMMUNICATE // Allows messaging with users
            )
    ),
    ADMIN(
            Set.of(
                    Permission.ADMIN_CREATE,
                    Permission.ADMIN_UPDATE,
                    Permission.ADMIN_DELETE,
                    Permission.ADMIN_READ,
                    Permission.MANAGER_READ,
                    Permission.MANAGER_CREATE,
                    Permission.MANAGER_UPDATE,
                    Permission.MANAGER_DELETE
            )
    ),
    MANAGER(
            Set.of(
                    Permission.MANAGER_CREATE,
                    Permission.MANAGER_UPDATE,
                    Permission.MANAGER_READ,
                    Permission.MANAGER_DELETE
            )
    );

    @Getter
    private final Set<Permission> permissions;

    Role(Set<Permission> permissions) {
        this.permissions = permissions;
    }


    public List<SimpleGrantedAuthority> getAuthorities() {
        List<SimpleGrantedAuthority> authorities = getPermissions()
                .stream()
                .map(permission -> new SimpleGrantedAuthority(permission.getPermission()))
                .collect(Collectors.toList());
        authorities.add(new SimpleGrantedAuthority("ROLE_" + this.name()));
        return authorities;
    }
}

================
File: entity/user/User.java
================
package com.example.demo.entity.user;

import com.example.demo.entity.data.*;
import com.example.demo.jwt.Token;
import com.fasterxml.jackson.annotation.JsonIdentityInfo;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.ObjectIdGenerators;
import jakarta.persistence.*;
import lombok.*;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.time.LocalDateTime;
import java.util.*;

@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "id")
public class User implements UserDetails {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;
    private String email;
    private String password;
    private String firstName;
    private String lastName;
    private String avatar;
    private String phoneNumber;
    private boolean isDeleted = false;
    private LocalDateTime createdAt = LocalDateTime.now();

    @OneToOne
    @JoinColumn(name = "token_id")
    private Token token;

    @ElementCollection
    @CollectionTable(name = "code_table", joinColumns = @JoinColumn(name = "user_id"))
    @MapKeyColumn(name = "code")
    @Column(name = "expiration")
    private Map<String, LocalDateTime> code = new HashMap<String, LocalDateTime>();

    @Enumerated(EnumType.STRING)
    private Role role;

    @OneToMany(mappedBy = "user",cascade = CascadeType.REMOVE)
    @JsonIgnore
    private List<Comment> comments;


    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL)
    List<Progress> progresses = new ArrayList<>();
    @OneToMany(mappedBy = "instructor", cascade = CascadeType.ALL, orphanRemoval = true)
    @JsonIgnore // Bỏ qua courses khi serialize User

    private List<Course> courses = new ArrayList<>();



    @PrePersist
    protected  void onCreate() {
        createdAt = LocalDateTime.now();
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return role.getAuthorities();
    }

    @Override
    public String getPassword() {
        return password;
    }

    @Override
    public String getUsername() {
        return email;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}

================
File: exception/CourseNotFoundException.java
================
package com.example.demo.exception;

public class CourseNotFoundException extends RuntimeException {
    public CourseNotFoundException(String message) {
        super(message);
    }}

================
File: exception/GlobalExceptionHandler.java
================
package com.example.demo.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;

import java.util.HashMap;
import java.util.Map;

@ControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<?> handleResourceNotFound(ResourceNotFoundException ex) {
        Map<String, String> error = new HashMap<>();
        error.put("message", ex.getMessage());
        return new ResponseEntity<>(error, HttpStatus.NOT_FOUND);
    }

    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<?> handleAccessDenied(AccessDeniedException ex) {
        Map<String, String> error = new HashMap<>();
        error.put("message", ex.getMessage());
        return new ResponseEntity<>(error, HttpStatus.FORBIDDEN);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<?> handleValidationExceptions(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error ->
                errors.put(error.getField(), error.getDefaultMessage()));
        return new ResponseEntity<>(errors, HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleGeneralException(Exception ex) {
        Map<String, String> error = new HashMap<>();
        error.put("message", ex.getMessage());
        return new ResponseEntity<>(error, HttpStatus.INTERNAL_SERVER_ERROR);
    }
}

================
File: exception/ResourceNotFoundException.java
================
package com.example.demo.exception;

public class ResourceNotFoundException extends RuntimeException {
    private String resourceName;
    private String fieldName;
    private Object fieldValue;

    // Constructor hiện tại chỉ nhận một chuỗi thông báo lỗi
    public ResourceNotFoundException(String message) {
        super(message);
    }

    // Constructor mới nhận ba đối số
    public ResourceNotFoundException(String resourceName, String fieldName, Object fieldValue) {
        super(String.format("%s not found with %s : '%s'", resourceName, fieldName, fieldValue));
        this.resourceName = resourceName;
        this.fieldName = fieldName;
        this.fieldValue = fieldValue;
    }

    // Getter methods nếu cần
    public String getResourceName() {
        return resourceName;
    }

    public String getFieldName() {
        return fieldName;
    }

    public Object getFieldValue() {
        return fieldValue;
    }
}

================
File: exception/UserNotFoundException.java
================
package com.example.demo.exception;

public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(String message) {
        super(message);
    }
}

================
File: handler/LogoutHandler.java
================
package com.example.demo.handler;

import com.example.demo.jwt.JwtService;
import com.example.demo.jwt.Token;
import com.example.demo.repository.TokenRepository;
import com.example.demo.repository.UserRepository;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

@Data
@RequiredArgsConstructor
@Component
public class LogoutHandler implements org.springframework.security.web.authentication.logout.LogoutHandler {
    private final TokenRepository tokenRepository;
    private final UserRepository userRepository;
    private final JwtService jwtService;
    @Override
    public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) {
        String jwt= request.getHeader("Authorization");
        if(jwt != null && jwt.startsWith("Bearer ")) {
            jwt = jwt.substring(7);
            Token token = tokenRepository.findByToken(jwt).orElse(null);
            if(token != null) {
                String email = jwtService.extractUserName(token.getToken());
                var user = userRepository.findByEmail(email).orElse(null);
                if(user != null) {
                    user.setToken(null);
                    SecurityContextHolder.clearContext();
                    tokenRepository.delete(token);
                    return;
                }
            }
        }
        SecurityContextHolder.clearContext();
    }
}

================
File: handler/Oauth2SuccessHandler.java
================
package com.example.demo.handler;

import com.example.demo.auth.AuthService;
import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.jwt.JwtService;
import com.example.demo.jwt.Token;
import com.example.demo.repository.UserRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.Data;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Objects;

@Data
@Component
public class Oauth2SuccessHandler implements AuthenticationSuccessHandler {
    private final UserRepository userRepository;
    private final CloudService cloudService;
    private final AuthService authService;
    private final JwtService jwtService;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        OAuth2User oauth2User = (OAuth2User) authentication.getPrincipal();
        String avatar = "";
        if (oauth2User.getAttribute("picture") != null) {
            avatar = Objects.requireNonNull(oauth2User.getAttribute("picture")).toString();
        }
        String email = "";
        if(oauth2User.getAttribute("email") != null) {
            email = oauth2User.getAttribute("email");
        }
        String family_name = "";
        if(oauth2User.getAttribute("name") != null) {
            family_name = oauth2User.getAttribute("name").toString();
        }
        if(oauth2User.getAttribute("login") != null && Objects.equals(email, "")) {
            email = oauth2User.getAttribute("login");
        }
        var user = authService.findUserByEmail(email);
        if(user == null) {
            user = User.builder()
                    .email(Objects.equals(email, "") ? null : email)
                    .lastName(family_name)
                    .role(Role.USER)
                    .avatar(Objects.equals(avatar, "") ? null : avatar)
                    .build();
        }
        String userAvatar = user.getAvatar();
        if(userAvatar == null && !Objects.equals(avatar, "")) {
            user.setAvatar(avatar);
        }

        if(userAvatar != null && Objects.equals(avatar, "")) {
            avatar = user.getAvatar();
        }

        userRepository.save(user);
        Token token = new Token(jwtService.generateToken(user));
        user.setToken(token);

        String redirectUrl = "http://localhost:3000/?token=" + URLEncoder.encode(token.getToken(), StandardCharsets.UTF_8)
                + "&email=" + URLEncoder.encode(email, StandardCharsets.UTF_8)
                + "&lastName=" + URLEncoder.encode(family_name, StandardCharsets.UTF_8)
                + "&avatar=" + URLEncoder.encode(avatar, StandardCharsets.UTF_8);
        response.sendRedirect(redirectUrl);
    }
}

================
File: jwt/JwtFilter.java
================
package com.example.demo.jwt;

import com.example.demo.dto.ResponseObject;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.jsonwebtoken.ExpiredJwtException;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.MalformedJwtException;
import io.jsonwebtoken.security.SignatureException;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.EOFException;
import java.io.IOException;
import java.nio.file.AccessDeniedException;

@Component
@RequiredArgsConstructor
public class JwtFilter extends OncePerRequestFilter {

    private final JwtService jwtService;
    private final UserDetailsService userDetailsService;
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws IOException, ServletException {
        if(request.getServletPath().contains("/api/v1/public")) {
            filterChain.doFilter(request, response);
            return;
        }

       try {
           String authHeader = request.getHeader("Authorization");
           String jwt;
           String email;
           if(authHeader == null || !authHeader.startsWith("Bearer ")) {
               filterChain.doFilter(request, response);
               return;
           }

           jwt = authHeader.substring(7);
           email = jwtService.extractUserName(jwt);
           if(email != null && SecurityContextHolder.getContext().getAuthentication() == null) {
               UserDetails    userDetails = userDetailsService.loadUserByUsername(email);
               if(jwtService.isValidToken(jwt, userDetails)) {
                   UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                   usernamePasswordAuthenticationToken.setDetails(
                           new WebAuthenticationDetailsSource().buildDetails(request)
                   );
                   SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);
               }
           }
           filterChain.doFilter(request, response);
       }
       catch (MalformedJwtException | SignatureException e) {
           logger.error("Token is not valid: " + e.getMessage());
           response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
           ResponseObject res = ResponseObject.builder().status(HttpStatus.UNAUTHORIZED).mess("Token is not valid, Log in again").build();
           ObjectMapper mapper = new ObjectMapper();
           response.getWriter().write(mapper.writeValueAsString(res));
       }
       catch (ExpiredJwtException e) {
           logger.error("Token is expiration: " + e.getMessage());
           response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
           ResponseObject res = ResponseObject.builder().status(HttpStatus.UNAUTHORIZED).mess("Token is expiration, Log in again").build();
           ObjectMapper mapper = new ObjectMapper();
           response.getWriter().write(mapper.writeValueAsString(res));
       }
    }
}

================
File: jwt/JwtService.java
================
package com.example.demo.jwt;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

import javax.crypto.SecretKey;
import java.security.Key;
import java.security.SecureRandom;
import java.util.Base64;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Component
@Data
@NoArgsConstructor
public class JwtService {
    private String SECRET_KEY = getSecretKey();

    @Value("${jwt-expiration}")
    private long expiration;
    private long refreshToken;

    public String buildToken(Map<String, Object> claims, UserDetails userDetails) {
        return Jwts.builder()
                .claims(claims)
                .expiration(new Date(System.currentTimeMillis() + expiration))
                .subject(userDetails.getUsername())
                .signWith(getKey())
                .issuedAt(new Date())
                .compact();
    }

    private <T> T extractClaims(String token, Function<Claims, T> claimsResolver) {
        Claims claims = extractClaimsFromToken(token);
//        if (claims != null) {
            return claimsResolver.apply(claims);
//        }
//        return null;
    }


    public String extractUserName(String token) {
//        return extractClaims(token, new Function<Claims, String> () {
//            @Override
//            public String apply(Claims claims) {
//                return claims.getSubject();
//            }
//        });
//        return extractClaims(token, claims -> claims.getSubject());
        return extractClaims(token, Claims::getSubject);

    }

    public Boolean isTokenExpired(String token) {
        return extractExpiration(token).before(new Date());
    }

    public Date extractExpiration(String token) {
        return extractClaims(token, Claims::getExpiration);
    }

    public Boolean isValidToken(String token, UserDetails userDetails) {
        String username = extractUserName(token);
        return !isTokenExpired(token) && username.equals(userDetails.getUsername());
    }


    private Claims extractClaimsFromToken(String token) {
//       try {
           return Jwts.parser()
                   .verifyWith((SecretKey) getKey())
                   .build().parseSignedClaims(token).getPayload();
//       }
//       catch (Exception e) {
//           System.out.println("extractClaimsFromToken: " + e.getMessage());
//           return null;
//       }
    }


    public String generateToken(UserDetails userDetails )  {
        return buildToken(new HashMap<>(), userDetails);
    }

    public Key getKey() {
        byte[] key = Base64.getDecoder().decode(SECRET_KEY);
        return Keys.hmacShaKeyFor(key);
    }


    private String getSecretKey() {
        SecureRandom random = new SecureRandom(); // hàm random có tính bảo mật cao
        byte[] key = new byte[32];
        random.nextBytes(key); // random ra chuỗi 32byte
        return Base64.getEncoder().encodeToString(key); // encode chuỗi 32 byte sang chuỗi sử dụng base64
    }
}

================
File: jwt/Token.java
================
package com.example.demo.jwt;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import lombok.Data;
import lombok.RequiredArgsConstructor;

import java.time.LocalDateTime;

@Data
@Entity

@RequiredArgsConstructor
public class Token {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private  String token;
    private LocalDateTime createAt;
    private LocalDateTime inspirationAt;
    public Token(String token) {
        this.token = token;
    }
}

================
File: mail/MailRequest.java
================
package com.example.demo.mail;

import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.stereotype.Component;
@Data
@NoArgsConstructor
public class MailRequest {
    private String email;
    private String code;
}

================
File: mail/MailService.java
================
package com.example.demo.mail;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ClassPathResource;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class MailService {
    private final JavaMailSender javaMailSender;

    @Value("${spring.mail.username}")
    private String from;

    public Boolean sendCode(String to, String code)  {
        try {
        MimeMessage mimeMessage = javaMailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true);
        String htmlContent;
            htmlContent = "<!DOCTYPE html>\n" +
                    "<html lang=\"en\">\n" +
                    "<head>\n" +
                    "    <meta charset=\"UTF-8\">\n" +
                    "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n" +
                    "    <style>\n" +
                    "        /* CSS cho email */\n" +
                    "        body {\n" +
                    "            font-family: Arial, sans-serif;\n" +
                    "            background-color: #f4f4f4;\n" +
                    "            margin: 0;\n" +
                    "            padding: 0;\n" +
                    "        }\n" +
                    "        .container {\n" +
                    "            max-width: 600px;\n" +
                    "            margin: 0 auto;\n" +
                    "            background-color: #ffffff;\n" +
                    "            padding: 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            box-shadow: 0 0 10px rgba(0,0,0,0.1);\n" +
                    "        }\n" +
                    "        h1 {\n" +
                    "            color: #333;\n" +
                    "            text-align: center" +
                    "        }\n" +
                    "        p {\n" +
                    "            color: #555;\n" +
                    "        }\n" +
                    "         i {" +
                    "               font-size: 15px;\n" +
                    "         }" +
                    "        .btn {\n" +
                    "            background-color: #007bff;\n" +
                    "            color: #fff;\n" +
                    "            text-decoration: none;\n" +
                    "            padding: 10px 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            display: inline-block;\n" +
                    "        }\n" +
                    "        .btn:hover {\n" +
                    "            background-color: #0056b3;\n" +
                    "        }\n" +
                    "    </style>\n" +
                    "</head>\n" +
                    "<body>\n" +
                    "    <div class=\"container\">\n" +
                    "        <div style=\"display: float\">\n" +
                    "            <img\n" +
                    "                style=\"margin: auto; display: block; height: 60px;\"\n" +
                    "                src='cid:logo'\n" +
                    "                alt=\"Dream Chasers\"\n" +
                    "            />\n" +
                    "        </div>" +
                    "        <h1 >Mã xác nhận đăng kí tài khoản\n</h1>\n" +
                    "        <p>Xin chào,</p>\n" +
                    "        <p>Để xác minh tài khoản của bạn, hãy nhập mã này vào Dream chasers:</p>\n" +
                    " <div style=\"background-color:#ebebeb;color:#333;font-size:40px;letter-spacing:8px;padding:16px;text-align:center\">" + code + "</div>" +
                    "        <p>Mã xác minh sẽ hết hạn sau 48 giờ.</p>\n" +
                    "        <p><strong>Nếu bạn không yêu cầu mã này</strong>, vui lòng bỏ qua tin nhắn này.</p>\n" +
                    "        <p>Trân trọng,</p>\n" +
                    "        <p>Đội ngũ phát triển <strong>Dream Chasers</strong></p>\n" +
                    "<p style=\"Margin:0;Margin-bottom:10px;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:24px;margin:0;margin-bottom:10px;padding:0;text-align:left;color:#757575\">" +
                    "<i>Đây là email được tạo tự động. Vui lòng không trả lời thư này.</i>" +
                    "</p>" +
//                    "        <a style = \" color: #fff;\" href=\"http://localhost:3000/login\" class=\"btn\">Đăng nhập vào Dolar Restaurant</a>\n" +
                    "    </div>\n" +
                    "</body>\n" +
                    "</html>\n";
            helper.setFrom(from, "Dream Chasers");
            helper.setText(htmlContent, true);
            helper.setTo(to);
            helper.addInline("logo", new ClassPathResource("/static/images/logo.png"));
            helper.setSubject("Yêu cầu xác minh email");
            javaMailSender.send(mimeMessage);
            return true;
        }
        catch(Exception e){
            System.out.println(e.getMessage());
            return false;
        }
    }

    public boolean sendMailResetPassword(String email, String code) {
        try {
        MimeMessage mimeMessage = javaMailSender.createMimeMessage();
        MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage, true);
        String htmlContent;
            htmlContent = "<!DOCTYPE html>\n" +
                    "<html lang=\"en\">\n" +
                    "<head>\n" +
                    "    <meta charset=\"UTF-8\">\n" +
                    "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n" +
                    "    <title>Dream Chasers</title>\n" +
                    "    <style>\n" +
                    "        /* CSS cho email */\n" +
                    "        body {\n" +
                    "            font-family: Arial, sans-serif;\n" +
                    "            background-color: #f4f4f4;\n" +
                    "            margin: 0;\n" +
                    "            padding: 0;\n" +
                    "        }\n" +
                    "        .container {\n" +
                    "            max-width: 600px;\n" +
                    "            margin: 0 auto;\n" +
                    "            background-color: #ffffff;\n" +
                    "            padding: 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            box-shadow: 0 0 10px rgba(0,0,0,0.1);\n" +
                    "        }\n" +
                    "        h1 {\n" +
                    "            color: #333;\n" +
                    "           text-align: center\n"+
                    "        }\n" +
                    "        p {\n" +
                    "            color: #555;\n" +
                    "            font-size: 15px;\n" +
                    "        }\n" +
                    "        .btn {\n" +
                    "            background-color: #007bff;\n" +
                    "            color: #fff;\n" +
                    "            text-decoration: none;\n" +
                    "            padding: 10px 20px;\n" +
                    "            border-radius: 5px;\n" +
                    "            display: inline-block;\n" +
                    "        }\n" +
                    "        .btn:hover {\n" +
                    "            background-color: #0056b3;\n" +
                    "        }\n" +
                    "    </style>\n" +
                    "<link rel=\"icon\" type=\"image/png\" href=\"images/logo.png\">"+

                    "</head>\n" +
                    "<body>\n" +
                    "    <div class=\"container\">\n" +
//                    "<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAABuCAYAAAD/PJegAAALRElEQVR4Xu1b7Y0TyxJtiGBJAEwGSwaEQAZ3M4AMIAPIwJsBRABkAD+R+GEkAlgJEN/g5+O9tao9VdVTMx7bM/d1SUeeOV1d3V1nuns+dkvJ28kGZxssN3izwcUG64ZRgFwip8sN/imXuR7NFuUycBPssFiWy9wPNlwFT4sN3HBYQIPeM3KxwarYYA3Hwar0mI2npYk3RazKpTZVW5Qm3pSxKpWZiHUWDlypYVpYlWBPbDcs8wG0umaLYp0apo1FUbZ0HBqmjWX517CecmHD9IEXK9u98MwpbJgHzjZoy+eMsdxg+xKVCxrmAWjXXlLPGNDOkA3zgiEa5gVDNMwLhmiYFwzRMC8YomFeMETDvGCIhnnBEA3zgiEa5gVDNMwLhmiYFwwxe9y/f3/99OnT9Zs3b7bni8Vi/erVq/XDhw+3x+w/cxhidjg5ObkS7eLiYi22Wq225Xfv3r3iYBAWvqenpybWDGGIWQCinZ2drc/Pz6+Jpg0C3rhxwwioDT7L5XJ7AXAbM4EhJguIhmUQy2EkmjY9A//+/cvFxmYqpiEmBYj26NGjrWh9DYLcvHlzu+9BQEHGcIFgdj948GDbB+7XhGCIowMJf/LkySDRtMkMRLzfv3+nxfPs+fPn2yV7gjdBhjgKsGxBNCR9LEMs7IF37tzZCvjnz59eszAyXFgTEtMQB4N35zimaQF//fq18yz0DGJiiT+imIbYG+R2/9mzZ3sTTZsW8MePH1sRZRbuw470eGKI0YEk4u7uEKJpg4ByE/Pt27f1z58/r2bhvkQUQ9vYEjgXe4AhRsfjx495fAcxLeDXr1+3s3Afy2jNZDbiIua8jARDjAZ0GslDIo9hsoTevn17/eXLl/X379+3y+ghZqAY9kidD87RCDDEqMDSeSwTAXERaQGxDx7S5MXA5AWUDuJXEndMkyUUM/Dz58/XBDzUDIS9fv3a5GpEGGIniHg4xpuMYxoERD9wIX369Gl7I3MMAWF4buQ8ce4GwhCDoWcgNu99W9ddrQiIGQgBcSODO1FPwK5Yuxr6ol/J6Qt9RxhiEKRD0ik8E41tWIrwDIk9BcnomuGyB+I5EEuoPEp4eyBiYqbKF463b9+yy86Gx4qRRNMwxGBI55CEXQ0zQgt269YtM/iMgPIY0bWE8hcI2cPxMnssQTEmnoWcwwEwxGBIh5C4viaC4SqVGcbxpQ1pJysgZiAvoWxoUyeUk4tzfJbaVVB5uOf4O8AQgyCJ7TP7IsGyg8sKKHtg1xLK8bk/LDBWBQiKVeLDhw8cMrSR35saIg0eUPahHcLphEWCyUXhJRDICAg/PQOzS+gQ4OLNCIlPU/DX4+Kx9YAhekM6gNlUMy3cDh2+qp8RUC+hmT0wulj4XPMsQEZIWbKjuD1giBR0wziuPbTjbYwsGzpB3HmOycfMDREweozgGch986DHwOPBMYTEReuZfrjnuj1hiBS4wSiZEE/7cz0+Z3CCtH/UphgEhH+fGeiB2+Uy/csAj9iekHrWR/UTMERv1P7qK5uY6NeD1MsICH/vLrQmYNS2tOv1m/34HMDLDd1n6d+OMEQvoGPYlCOLBtPFMXS5HPcVMLOEeiJx+/qceS7nYwAXvPQdX/O1H/smYIgquGO4jY4My0bUoYjnMm9Qcp4REL59Z6AHTzDNcR8jXw3cF+ARRB6hJI7nW4EhquBO1WafvMDVneL63jEjKssICL/sDOQ+Ru1GffP8eezsw+cDYIhO6EZrL4H5zpMR8dnyjIB97kJZjK72ta+uU6sb8RyHyyowRAjuWO2LA141SR3+9ToY8QztkxEQ/kPehTJ0u9xP3fch49BLKPslYIgQ3AA24MiwtrO/F8cbvD736ggyAuoPul0z0GuL+8L9yPLRuNhH80kYIo1Xlb+cjq5or7NRxyNeyvoI2GcGZvrmQYvE51wWIeNDMEQakWFfRHnUmYjXZTJgHrg+zggIP+yBmIFdd6HcVg2RH/O1mF4ZnydgiE6gEQw4shcvXlz56Toch2NGPlFZHwH7zECG13YE9pVz5gXYn+VfCrhOEoYw4IA4xx4Xmff4oONwvKHICIi29J9U1ATU/eXfCNqPx6t9NC//Jsev1/TLBI5RgSEMvIDcuDY8G+IBH9/LuF5feG0LlxHQ2wMhnicgtxO178ETUkP+XKP2F+q4Kcy2p2AIAx0Ux7iCsoYbHfmzCB1rQEevAfWzAnqPEWzcv6GQ+rh4IRj+VwL9yBi2ngHtG+IavIDgur79RQZB5Ss8x/XgtS/ICChXf+ZBnuNn+iDARY1Vp49g2jArB/5TjCE6IQMaKqKY/B0M9oNM52X2wxfLTdffpeg9UO5Coz1Qln3EzqwS+j+tao9TGdtBPMAQvbCriNowEPlPWAxI/ioMbYDve2WzgLUZyIaLA23iQoFQIpj853C0j/U1xLl3757Jq6B2Ef0LQ4QBcCzQPmOKOKaxgLXnwGOYnnk86znHFRgiBW5oiiJ6e2C0hB7aRDzOIyPiFQzhBohmn8bURBQBM18jDmksnpdnzm0FhriGKKB35eB4SiLqJbTrQf5QxjcsXh65rAOGSMFrWI6nIiIERH+mMgOjGxZvkmiOywiGMIGY68JUZuKUBOSZNyIMYcBXA5/rX41jiwgBoy/yhzRPPC9fmTIHhkhBNxKJeOyZKDMw8/+B+zJ9w8J58n61H+c3gCFceIJF4PJjiRjdxHgvs/dh3nMeH+vzmk8FhrgGviL4atEcQ/PHEJEFPOQe6D0qROiTUweGcOEFzjSi6x1aRBFQ9sBDPUb0EU/nyfP3OIIh0vCCe5zmDykiz0At4L6Mb1j0BexNAvbr4hwYoopM0K6OYoB4MYwX1XhxDVEBfOzENzF8oQDwL1q7vDQWAeVV2tCbGPQDwAtu9A/9xKcs9BlfUjAGjEVeevOYOS/RebaMYIgU9BWlua4yPhffrjr4QAohkCQAScOXAiQRn3SQUHwlAJBoJBwCoi5m4MePH9fv3r1bv3//fv3y5cutP4RAXcRAPACx5UsIxOA+cb9qYD8eozd2rpOAIVLgztQ4ry5zHt91zsAzn/h5SdGc+OrYXnyvLoPb8WJ6Zd55rZ0AhkgjasjjuWNy7vlyuZcErqfFw7FXT3x0Ocfh8y6+y6fWZ+E8vgcMsROiDnm8x2XhJUbHk2MRS/tqRDE5LnOMiOcyL6acM5eEIQbB66Qc1zrNcaKyKIZweknkNnU5fvVs9WJpRH41XpdFcWp1e8IQo6DWQW9wXjmfewnwfr36zOPYE9I75nhROxkMqdMBQ4yCro7qpHKCOTl87MXm+lyGX75x4b3Sq+OhVhb5ZesMgCF2giTE63DES5n+ZZ6PPR/2jfoiHAvKfsxH5TUfPo+4HWCIURB1sovn8tq5V6ahb2DkV3ORgBzX84nA/RNEPiPAEKMgGgh33uMisC/Xk/PIT/ja0sl1PI5/deyuOnuAIQ4KTi6XaZ7LI1/x00Lx3SfH4vMsr8s5ruezBxjiIOCBRoPlc/bXPl1xmIsQxWY/r07kF/EjwBCjoTYoSWiUdE44+3TFZB/9HMh12NcrZ3C9Lr89whB7BYvSlQCvTNeLEMX16kbn3FftMyEY4ujgZNXOvWTLuex7kY/HaV9uR4PjHBHlwiFnj4kleV+AduWNU9AwD0C7cu4UNMwDyw3KmVPQMA/8s0E5Kf/RffD/ANBua+dOYcO0sSzKFo5Dw7SxKGTPinVqmCaglTGsp6tinRumhVVRex/bojQRp4xVcZZOttPSRJwiVuVSm5QtShNxSliVxMxjwzrbbmyOD2gQ7nkZW5T2nHho4MXKsgyYdTXDVXBWLsV8W9rbmzGBXCKny3KZ4/SM+x+ZTP2qney0rQAAAABJRU5ErkJggg==\" />"+
                    "        <div style=\"display: flex\">\n" +
                    "            <img\n" +
                    "                style=\"margin: auto; display: block; height: 60px;\"\n" +
                    "                src='cid:logo'\n" +
                    "                alt=\"Dream Chasers\"\n" +
                    "            />\n" +
                    "        </div>" +
                    "        <h1>Mã khôi phục mật khẩu\n</h1>\n" +
                    "        <p>Xin chào,</p>\n" +
                    "        <p>Bạn nhân được email này vì chúng tôi đã nhận được yêu cầu đặt lại mật khẩu cho tài khoản của bạn.</p>\n" +
                    " <div style=\"background-color:#ebebeb;color:#333;font-size:40px;letter-spacing:8px;padding:16px;text-align:center\">" + code + "</div>" +
                    "        <p>Mã xác minh sẽ hết hạn sau 48 giờ.</p>\n" +
                    "        <p><strong>Nếu bạn không yêu cầu mã này</strong>, vui lòng bỏ qua tin nhắn này.</p>\n" +
                    "        <p>Trân trọng,</p>\n" +
                    "        <p>Đội ngũ phát triển <strong>Dream Chasers</strong></p>\n" +
                    "<p style=\"Margin:0;Margin-bottom:10px;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:24px;margin:0;margin-bottom:10px;padding:0;text-align:left;color:#757575\">" +
                    "<i>Đây là email được tạo tự động. Vui lòng không trả lời thư này.</i>" +
                    "</p>" +
//                    "        <a style = \" color: #fff;\" href=\"http://localhost:3000/login\" class=\"btn\">Đăng nhập vào Dolar Restaurant</a>\n" +
                    "    </div>\n" +
                    "</body>\n" +
                    "</html>\n";;
                    mimeMessageHelper.setFrom(from, "Dream Chasers");
                    mimeMessageHelper.setSubject("Yêu cầu khôi phục mật khẩu Dream Chasers");
                    mimeMessageHelper.setTo(email);
                    mimeMessageHelper.setText(htmlContent, true);
                    mimeMessageHelper.addInline("logo", new ClassPathResource("/static/images/logo.png"));
                    javaMailSender.send(mimeMessage);
        }
        catch (Exception ex) {
            System.out.println(ex.getMessage());
            return false;
        }
        return true;
    }

}

================
File: MUX/MuxService.java
================
//package com.example.demo.MUX;
////import com.mux.ApiClient;
////import com.mux.ApiException;
////import com.mux.Configuration;
////import com.mux.auth.*;
////import com.mux.models.*;
////import com.mux.sdk.AssetsApi;
//import  com.
//public class MuxService {
//}

================
File: repository/data/CategoryRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Category;
import com.example.demo.entity.data.Course;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import javax.swing.text.html.Option;
import java.util.List;
import java.util.Optional;
@Repository
public interface CategoryRepository extends JpaRepository<Category, Integer> {
    @Query(value = "select * from category", nativeQuery = true)
    Optional<List<Category>> getAllCategories();

    Page<Category> findAllByIsDeleted(boolean isDeleted, Pageable pageable);

    Optional<Category> findByName(String name);

    Page<Category> findByNameContaining(String name, Pageable pageable);
    Optional<List<Category>> findByCourses(Course course);
}

================
File: repository/data/CommentRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.CommentDTO;
import com.example.demo.entity.data.Comment;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;


@Repository
public interface CommentRepository extends JpaRepository<Comment, Integer> {

    @Query(value = "SELECT * FROM comment WHERE lesson_id = :lessonId ORDER BY date DESC", nativeQuery = true)
    Page<Comment> findAllByLessonId(int lessonId, Pageable pageable);
    @Query("SELECT c FROM Comment c ORDER BY c.date DESC")
    List<Comment> findRecentComments(Pageable pageable);
    List<Comment> findAllByParentId(int parentId);
}

================
File: repository/data/CourseRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.CourseDTO;
import com.example.demo.dto.CourseStatisticDTO;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Section;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface CourseRepository extends JpaRepository<Course, Integer> {
    @Query("SELECT COUNT(c) FROM Course c WHERE c.isDeleted = false")
    int countActiveCourses(); // Trả về kiểu int


    Optional<Course> findByTitle(String title);

    @Query(value = "SELECT * FROM section s " +
            "left join course c on s.course_id = c.id " +
            "where s.is_deleted = :isDeleted and c.id = :id " , nativeQuery = true)
    Optional<List<Section>> findSectionsById(int id, boolean isDeleted);

    Page<Course> findAllByIsDeleted(boolean isDeleted, Pageable pageable);

    @Query(value = "select * from course left join course_category on course.id = course_category.course_id where category_id = :id and title like %:title%", nativeQuery = true)
    Optional<List<Course>> findByCategoryIdAndTitle(int id, String title);

    @Query(value = "select * from course left join course_category on course.id = course_category.course_id where category_id = :id and course.is_deleted = 0", nativeQuery = true)
    Page<Course> findByCategoryId(int id, Pageable pageable);

    @Query(value = "select * from course left join course_category on course.id = course_category.course_id where category_id = :id and course.is_deleted = 1", nativeQuery = true)
    Page<Course> findByCategoryIdAndIsDeleted(int id, Pageable pageable);

    Page<Course> findByTitleContainingAndIsDeleted(String title, boolean isDeleted, Pageable pageable);


    Page<Course> findAll(Pageable pageable);

    @Query("SELECT COUNT(c) FROM Course c WHERE MONTH(c.date) = :month AND YEAR(c.date) = :year")
int countCoursesCreatedInMonth(@Param("month") int month, @Param("year") int year);

    @Query("SELECT NEW com.example.demo.dto.CourseStatisticDTO(c.id, c.title, c.thumbnail, c.price) FROM Course c WHERE MONTH(c.date) = :month AND YEAR(c.date) = :year")
    Page<CourseStatisticDTO> findCoursesCreatedInMonth(@Param("month") int month, @Param("year") int year, Pageable pageable);
}

================
File: repository/data/FlashcardRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Flashcard;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface FlashcardRepository extends JpaRepository<Flashcard, Integer> {
}

================
File: repository/data/FlashcardSetRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.FlashcardSet;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface FlashcardSetRepository extends JpaRepository<FlashcardSet, Integer> {
    List<FlashcardSet> findByUserId(Integer userId);
}

================
File: repository/data/LessonProgressRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.LessonProgress;
import com.example.demo.entity.data.LessonProgressKey;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
@Repository
public interface LessonProgressRepository extends JpaRepository<LessonProgress, LessonProgressKey> {
    List<LessonProgress> findByUserId(int userId);
    @Query("SELECT lp FROM LessonProgress lp JOIN FETCH lp.lesson l JOIN FETCH l.section s JOIN FETCH s.course c WHERE lp.user.id = :userId")
    List<LessonProgress> findByUserIdWithCourse(@Param("userId") int userId);
}

================
File: repository/data/LessonRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Lesson;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.Set;

@Repository
public interface LessonRepository extends JpaRepository<Lesson, Integer> {
//    @Query(value = "select l.* from lesson l where l.is_deleted = :isDeleted and l.section_id = :sectionId", nativeQuery = true)
//    Optional<List<Lesson>> findLessonsBySection(int sectionId, boolean isDeleted);
    @Query(value = "select * from lesson l where l.section_id in :list ", nativeQuery = true)
    List<Lesson> findLessonsBySections(List<Integer> list);
}

================
File: repository/data/ListeningSectionRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.ListeningSection;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ListeningSectionRepository extends JpaRepository<ListeningSection, Integer> {
    // Additional query methods if needed
    List<ListeningSection> findByTest_Id(int testId);


}

================
File: repository/data/MessageRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Message;
import com.example.demo.entity.user.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface MessageRepository extends JpaRepository<Message, Long> {
    List<Message> findBySenderAndReceiverOrderByTimestampAsc(User sender, User receiver);

    List<Message> findByReceiverAndIsReadFalseOrderByTimestampAsc(User receiver);
    List<Message> findByChatRoomId(String chatRoomId);
    @Query("SELECT m FROM Message m WHERE (m.sender.id = :userId1 AND m.receiver.id = :userId2) OR (m.sender.id = :userId2 AND m.receiver.id = :userId1) ORDER BY m.timestamp ASC")
    List<Message> findMessagesBetweenUsers(@Param("userId1") Integer userId1, @Param("userId2") Integer userId2);
    @Query("SELECT DISTINCT m.chatRoomId FROM Message m WHERE m.sender = :email OR m.receiver = :email")
    List<String> findChatRoomsByUser(@Param("email") String email);
    boolean existsByChatRoomId(String chatRoomId);
    @Query("SELECT DISTINCT m.sender FROM Message m WHERE m.receiver.id = :instructorId")
    List<User> findDistinctStudentsByInstructorId(@Param("instructorId") Integer instructorId);
    @Query("SELECT DISTINCT p.user FROM Progress p WHERE p.course.instructor.id = :instructorId")
    List<User> findStudentsByInstructorId(@Param("instructorId") Integer instructorId);

}

================
File: repository/data/PassageRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Passage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface PassageRepository extends JpaRepository<Passage, Integer> {
    // Additional query methods if needed
    List<Passage> findByTest_Id(int testId);

}

================
File: repository/data/ProgressRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.ProgressDTO;
import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;
import java.util.Optional;

public interface ProgressRepository extends JpaRepository<Progress, Integer> {
    Optional<Progress> findByCourseIdAndUser(int courseId, User user);
    List<Progress> findByUser(User user);
    boolean existsByCourse_IdAndUser_Id(int courseId, int userId);
    Optional<Progress> findByCourse_IdAndUser(int courseId, User user);
    List<ProgressDTO> findAllByUserEmail(String email);
    @Query("SELECT new com.example.demo.dto.ProgressDTO(p.course) FROM Progress p WHERE p.user.email = :email")
    List<ProgressDTO> findAllDTOByUserEmail(@Param("email") String email);
}

================
File: repository/data/QuestionOptionRepository.java
================
package com.example.demo.repository.data;
import com.example.demo.entity.data.QuestionOption;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
@Repository
public interface QuestionOptionRepository extends JpaRepository<QuestionOption,Integer> {

}

================
File: repository/data/QuestionRepository.java
================
package com.example.demo.repository.data;
import com.example.demo.entity.data.Question;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface QuestionRepository extends JpaRepository<Question,Integer> {
    List<Question> findByPassage_Test_Id(int testId);
    List<Question> findByListeningSection_Test_Id(int testId);


}

================
File: repository/data/SectionRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Section;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface SectionRepository extends JpaRepository<Section, Integer> {
    @Query(value = "select s.* from section s where s.course_id = :courseId and s.is_deleted = :isDeleted", nativeQuery = true)
    Optional<List<Section>> findSectionsByCourse(int courseId, boolean isDeleted);
}

================
File: repository/data/SpeakingFeedbackRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.SpeakingFeedback;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface SpeakingFeedbackRepository extends JpaRepository<SpeakingFeedback, Integer> {
    List<SpeakingFeedback> findByUserId(int userId);
    List<SpeakingFeedback> findByQuestionId(int questionId);
}

================
File: repository/data/SpeakingQuestionRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.SpeakingQuestion;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface SpeakingQuestionRepository extends JpaRepository<SpeakingQuestion, Integer> {
    List<SpeakingQuestion> findByTopicId(int topicId);
}

================
File: repository/data/SpeakingTopicRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.SpeakingTopic;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface SpeakingTopicRepository extends JpaRepository<SpeakingTopic, Integer> {
    boolean existsByName(String name);
}

================
File: repository/data/TestProgressRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.TestProgress;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface TestProgressRepository  extends JpaRepository<TestProgress, Integer> {
}

================
File: repository/data/TestRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Test;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface TestRepository extends JpaRepository<Test, Integer> {
    // Additional query methods if needed
    @EntityGraph(attributePaths = {"passages.questions"})
    Optional<Test> findById(int id);
    @EntityGraph(attributePaths = {"passages.questions"})
    @Query("SELECT t FROM Test t WHERE t.id = :id")
    Optional<Test> findByIdWithPassagesAndQuestions(@Param("id") int id);

    @EntityGraph(attributePaths = {"listeningSections.questions"})
    @Query("SELECT t FROM Test t WHERE t.id = :id")
    Optional<Test> findByIdWithSectionsAndQuestions(@Param("id") int id);


}

================
File: repository/data/UserEssayRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.dto.UserEssayDTO;
import com.example.demo.entity.data.UserEssay;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface UserEssayRepository extends JpaRepository<UserEssay,Integer> {
    @Query("SELECT COUNT(e) FROM UserEssay e WHERE e.user.id = :userId")
    long countUserEssaysByUserId(@Param("userId") int userId);

    @Query("SELECT AVG(e.score) FROM UserEssay e WHERE e.user.id = :userId")
    Double findAverageEssayScoreByUserId(@Param("userId") int userId);

    @Query("SELECT e FROM UserEssay e WHERE e.user.id = :userId ORDER BY e.submissionTime DESC")
    List<UserEssay> findUserEssaysByUserId(@Param("userId") int userId);
    @Query("SELECT COUNT(e) FROM UserEssay e")
    long countAllEssays();
    Page<UserEssay> findAllByUserId(Integer userId, Pageable pageable);
    List<UserEssay> findAllByUserId(Integer userId);

    @Query("SELECT AVG(e.score) FROM UserEssay e")
    Double findAverageEssayScore();

    @Query("SELECT e FROM UserEssay e ORDER BY e.submissionTime DESC")
    List<UserEssay> findAllEssaysOrderedBySubmissionTime();
    @Query("SELECT new com.example.demo.dto.UserEssayDTO(e.id, e.content, e.submissionTime, e.score, u.email) " +
            "FROM UserEssay e JOIN e.user u ORDER BY e.submissionTime DESC")
    List<UserEssayDTO> findAllEssaysWithUserNames();

}

================
File: repository/data/UserResponseRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.UserResponse;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserResponseRepository extends JpaRepository<UserResponse, Integer> {

}

================
File: repository/data/VocabularyRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.Vocabulary;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface VocabularyRepository extends JpaRepository<Vocabulary, Integer> {
    Vocabulary findByWord(String word);
    List<Vocabulary> findByVocabularySetId(Integer setId);}

================
File: repository/data/VocabularySetRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.VocabularySet;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface VocabularySetRepository extends JpaRepository<VocabularySet, Integer> {
    List<VocabularySet> findByUserId(Integer userId);

}

================
File: repository/data/WritingTaskRepository.java
================
package com.example.demo.repository.data;

import com.example.demo.entity.data.WritingTask;
import org.springframework.data.jpa.repository.JpaRepository;

public interface WritingTaskRepository extends JpaRepository<WritingTask,Integer> {
}

================
File: repository/TokenRepository.java
================
package com.example.demo.repository;

import com.example.demo.jwt.Token;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface TokenRepository extends JpaRepository<Token, Integer> {
    public Optional<Token> findByToken(String token);
}

================
File: repository/UserRepository.java
================
package com.example.demo.repository;

import com.example.demo.dto.UserStatisticDTO;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User, Integer> {
    Optional<User> findByEmail(String email);
    @Query("SELECT COUNT(u) FROM User u WHERE u.role = :role")
    int countByRole(@Param("role") Role role);

    Page<User> findByIsDeletedFalse(Pageable pageable);

    Optional<User> findByPhoneNumber(String phoneNumber);

    @Query(value = "select * from user where role = :role", nativeQuery = true)
    Page<User> findByRole(String role, Pageable pageable);

    @Query(value = "select u from User u where (u.firstName like %?1% or u.lastName like %?2%) and u.isDeleted = ?3")
    Page<User> findByFirstNameContainingOrLastNameContainingAndAndDeleted(String firstName, String lastName, boolean isDelete, Pageable pageable);

    Page<User> findAllByIsDeleted(boolean isDeleted, Pageable pageable);

    @Query("SELECT COUNT(u) FROM User u WHERE MONTH(u.createdAt) = :month AND YEAR(u.createdAt) = :year")
    int countUsersRegisteredInMonth(@Param("month") int month, @Param("year") int year);

    @Query("SELECT NEW com.example.demo.dto.UserStatisticDTO(u.id, u.email, u.firstName, u.lastName, u.avatar) FROM User u WHERE MONTH(u.createdAt) = :month AND YEAR(u.createdAt) = :year")
    Page<UserStatisticDTO> findUsersRegisteredInMonth(@Param("month") int month, @Param("year") int year, Pageable pageable);

}

================
File: service/AIFeedbackService.java
================
// src/main/java/com/example/demo/service/AIFeedbackService.java

package com.example.demo.service;

import com.example.demo.dto.SpeakingFeedbackDTO;
import com.example.demo.dto.OpenAIRequest;
import com.example.demo.dto.OpenAIResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class AIFeedbackService {

    @Value("${openai.api.key}")
    private String openAiApiKey;

    private final RestTemplate restTemplate = new RestTemplate();


    public SpeakingFeedbackDTO generateFeedback(String transcript, String question, String topic) {
        String url = "https://api.openai.com/v1/chat/completions";

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(openAiApiKey);

        String prompt = String.format(
                "You are an IELTS examiner. Evaluate the following spoken response for IELTS Speaking Part 1. Provide feedback on pronunciation, grammar, and vocabulary errors. " +
                        "Respond **only** with the JSON format as specified, and **do not include any additional text or formatting**. " +
                        "**Do not include any Markdown formatting or code blocks.**\n\n" +
                        "JSON structure:\n" +
                        "{\n" +
                        "  \"pronunciationErrors\": [\n" +
                        "    {\n" +
                        "      \"word\": \"incorrectWord\",\n" +
                        "      \"error\": \"Pronunciation error description.\",\n" +
                        "      \"recommendation\": \"Correct pronunciation or tip.\"\n" +
                        "    }\n" +
                        "  ],\n" +
                        "  \"grammarErrors\": [\n" +
                        "    {\n" +
                        "      \"sentence\": \"Incorrect sentence here.\",\n" +
                        "      \"error\": \"Grammar error description.\",\n" +
                        "      \"recommendation\": \"Corrected sentence or grammar tip.\"\n" +
                        "    }\n" +
                        "  ],\n" +
                        "  \"vocabularyErrors\": [\n" +
                        "    {\n" +
                        "      \"word\": \"incorrectWord\",\n" +
                        "      \"error\": \"Vocabulary usage error.\",\n" +
                        "      \"recommendation\": \"Suggested word or usage tip.\"\n" +
                        "    }\n" +
                        "  ],\n" +
                        "  \"overallFeedback\": \"General feedback and score.\"\n" +
                        "}\n\n" +
                        "**Question:** %s\n\n" +
                        "**Topic:** %s\n\n" +
                        "**Transcript:**\n%s",
                question, topic, transcript
        );


        // Prepare request payload
        Map<String, Object> payload = new HashMap<>();
        payload.put("model", "gpt-4o-mini");
        List<Map<String, String>> messages = new ArrayList<>();
        Map<String, String> systemMessage = new HashMap<>();
        systemMessage.put("role", "system");
        systemMessage.put("content", "You are a helpful assistant.");
        Map<String, String> userMessage = new HashMap<>();
        userMessage.put("role", "user");
        userMessage.put("content", prompt);
        messages.add(systemMessage);
        messages.add(userMessage);
        payload.put("messages", messages);

        HttpEntity<Map<String, Object>> requestEntity = new HttpEntity<>(payload, headers);

        ResponseEntity<String> response = restTemplate.postForEntity(url, requestEntity, String.class);

        if (response.getStatusCode() == HttpStatus.OK) {
            // Parse the AI's JSON response
            ObjectMapper mapper = new ObjectMapper();
            try {
                String aiResponse = mapper.readTree(response.getBody())
                        .path("choices")
                        .get(0)
                        .path("message")
                        .path("content")
                        .asText();
                aiResponse = cleanAIResponse(aiResponse);

                // Convert the response to SpeakingFeedbackDTO
                return SpeakingFeedbackDTO.fromJson(aiResponse);
            } catch (IOException e) {
                throw new RuntimeException("Failed to parse AI feedback response.", e);
            }
        } else {
            throw new RuntimeException("Failed to get feedback from AI. Status: " + response.getStatusCode());
        }
    }

    private String cleanAIResponse(String aiResponse) {
        // Loại bỏ các ký tự không mong muốn
        aiResponse = aiResponse.trim();

        // Kiểm tra và loại bỏ phần mở đầu của code block
        if (aiResponse.startsWith("```json")) {
            aiResponse = aiResponse.substring(aiResponse.indexOf("```json") + 7).trim();
            // Loại bỏ phần kết thúc của code block
            if (aiResponse.endsWith("```")) {
                aiResponse = aiResponse.substring(0, aiResponse.lastIndexOf("```")).trim();
            }
        } else if (aiResponse.startsWith("```")) {
            aiResponse = aiResponse.substring(aiResponse.indexOf("```") + 3).trim();
            // Loại bỏ phần kết thúc của code block
            if (aiResponse.endsWith("```")) {
                aiResponse = aiResponse.substring(0, aiResponse.lastIndexOf("```")).trim();
            }
        }

        // Kiểm tra và loại bỏ bất kỳ ký tự không phải JSON nào ở đầu và cuối
        int startIndex = aiResponse.indexOf("{");
        int endIndex = aiResponse.lastIndexOf("}");
        if (startIndex != -1 && endIndex != -1) {
            aiResponse = aiResponse.substring(startIndex, endIndex + 1);
        }

        return aiResponse;
    }

    public String getAnswerSuggestions(String prompt) {
        String url = "https://api.openai.com/v1/chat/completions";

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(openAiApiKey);

        // Prepare request payload
        Map<String, Object> payload = new HashMap<>();
        payload.put("model", "gpt-4o-mini");
        List<Map<String, String>> messages = new ArrayList<>();
        Map<String, String> systemMessage = new HashMap<>();
        systemMessage.put("role", "system");
        systemMessage.put("content", "You are a helpful assistant.");
        Map<String, String> userMessage = new HashMap<>();
        userMessage.put("role", "user");
        userMessage.put("content", prompt);
        messages.add(systemMessage);
        messages.add(userMessage);
        payload.put("messages", messages);

        HttpEntity<Map<String, Object>> requestEntity = new HttpEntity<>(payload, headers);

        ResponseEntity<String> response = restTemplate.postForEntity(url, requestEntity, String.class);

        if (response.getStatusCode() == HttpStatus.OK) {
            // Parse the AI's JSON response
            ObjectMapper mapper = new ObjectMapper();
            try {
                String aiResponse = mapper.readTree(response.getBody())
                        .path("choices")
                        .get(0)
                        .path("message")
                        .path("content")
                        .asText();

                return aiResponse;
            } catch (IOException e) {
                throw new RuntimeException("Failed to parse AI answer suggestions response.", e);
            }
        } else {
            throw new RuntimeException("Failed to get answer suggestions from AI. Status: " + response.getStatusCode());
        }
    }
}

================
File: service/AIFeedBackService2.java
================
// src/main/java/com/example/demo/service/AIFeedbackService.java

package com.example.demo.service;

import com.example.demo.dto.AIChatRequestDTO;
import com.example.demo.dto.OpenAIRequest;
import com.example.demo.dto.OpenAIResponse;
import com.example.demo.entity.data.SpeakingQuestion;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.data.SpeakingQuestionRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.Arrays;

@Service
@RequiredArgsConstructor
public class AIFeedBackService2 {

    @Value("${openai.api.key}")
    private String openAiApiKey;

    @Value("${openai.model.chat}")
    private String chatModel; // e.g., "gpt-4o-mini"

    @Value("${openai.api.url}")
    private String apiUrl;

    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper objectMapper = new ObjectMapper();
    private final SpeakingQuestionRepository speakingQuestionRepository;

    // Sinh câu trả lời dựa trên ý tưởng của người dùng
    public String generateAnswer(AIChatRequestDTO chatRequest) {
        SpeakingQuestion question = speakingQuestionRepository.findById(chatRequest.getQuestionId())
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingQuestion", "id", chatRequest.getQuestionId()));

        String prompt = String.format(
                "Bạn là một chuyên gia dạy IELTS. Dựa trên ý tưởng của người dùng, hãy viết một câu trả lời hoàn chỉnh cho câu hỏi dưới đây trong khoảng 2 đến 3 câu vì đây là IELTS Speaking Part 1. Chỉ trả về một câu trả lời duy nhất và bằng tiếng anh.\n\n" +
                        "**Câu Hỏi:** %s\n\n" +
                        "**Ý Tưởng Người Dùng:** %s\n\n" +
                        "Câu trả lời của bạn:",
                question.getQuestionText(),
                chatRequest.getUserInput()
        );

        // Tạo yêu cầu đến OpenAI API
        OpenAIRequest requestPayload = new OpenAIRequest();
        requestPayload.setModel(chatModel);
        requestPayload.setMessages(Arrays.asList(
                new OpenAIRequest.Message("user", prompt,null)
        ));

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(openAiApiKey);

        HttpEntity<OpenAIRequest> requestEntity = new HttpEntity<>(requestPayload, headers);

        try {
            ResponseEntity<String> response = restTemplate.exchange(
                    apiUrl,
                    HttpMethod.POST,
                    requestEntity,
                    String.class
            );

            if (response.getStatusCode() == HttpStatus.OK) {
                String responseBody = response.getBody();

                // Lấy nội dung trả về từ AI
                JsonNode rootNode = objectMapper.readTree(responseBody);
                String aiContent = rootNode.path("choices").get(0).path("message").path("content").asText();

                return aiContent.trim();
            } else {
                throw new RuntimeException("Failed to get response from AI. Status code: " + response.getStatusCode());
            }
        } catch (Exception e) {
            throw new RuntimeException("Error processing AI response: " + e.getMessage(), e);
        }
    }
}

================
File: service/AudioProcessingService.java
================
package com.example.demo.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.http.*;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;

@Service
@RequiredArgsConstructor
public class AudioProcessingService {

    @Value("${openai.api.key}")
    private String openAiApiKey;

    private final RestTemplate restTemplate = new RestTemplate();

    public String transcribeAudio(MultipartFile audioFile) throws IOException {
        String url = "https://api.openai.com/v1/audio/transcriptions";

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        headers.setBearerAuth(openAiApiKey);

        // Prepare multipart request
        MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
        body.add("file", new ByteArrayResource(audioFile.getBytes()) {
            @Override
            public String getFilename() {
                return audioFile.getOriginalFilename();
            }
        });
        body.add("model", "whisper-1"); // Use the appropriate model

        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        ResponseEntity<String> response = restTemplate.postForEntity(url, requestEntity, String.class);

        if (response.getStatusCode() == HttpStatus.OK) {
            // Parse the transcription result
            // Assuming the response has a 'text' field
            // Use a JSON parser like Jackson to extract the 'text'
            ObjectMapper mapper = new ObjectMapper();
            try {
                JsonNode root = mapper.readTree(response.getBody());
                return root.path("text").asText();
            } catch (IOException e) {
                throw new RuntimeException("Failed to parse transcription response.");
            }
        } else {
            throw new RuntimeException("Failed to transcribe audio. Status: " + response.getStatusCode());
        }
    }
}

================
File: service/AudioStorageService.java
================
package com.example.demo.service;

import com.google.auth.oauth2.ServiceAccountCredentials;
import com.google.cloud.storage.BlobId;
import com.google.cloud.storage.BlobInfo;
import com.google.cloud.storage.Storage;
import com.google.cloud.storage.StorageOptions;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.io.FileInputStream;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.UUID;
@Slf4j
@Service
public class AudioStorageService {

    private final Storage storage;
    private final String bucketName = "eliteproject";

    // AudioStorageService.java
    public AudioStorageService() {
        try {
            // Đường dẫn đến tệp JSON của tài khoản dịch vụ
            String jsonPath = "D:/DACN/Cloud/google-speech-key.json"; // Thay đổi đường dẫn này

            // Tạo đối tượng Storage với thông tin xác thực từ tệp JSON
            storage = StorageOptions.newBuilder()
                    .setCredentials(ServiceAccountCredentials.fromStream(new FileInputStream(jsonPath)))
                    .setProjectId("modern-photon-442512-j8") // Thay đổi ID dự án của bạn
                    .build()
                    .getService();
        } catch (IOException e) {
            log.error("Không thể tải tệp JSON của tài khoản dịch vụ", e);
            throw new RuntimeException("Failed to initialize Google Cloud Storage client", e);
        }
    }
    public String uploadAudio(byte[] audioData, String originalFileName, String contentType) {
        try {
            String uniqueFileName = UUID.randomUUID().toString() + "_" + originalFileName;
            BlobId blobId = BlobId.of(bucketName, "audio/" + uniqueFileName);
            BlobInfo blobInfo = BlobInfo.newBuilder(blobId).setContentType(contentType).build();
            storage.create(blobInfo, audioData);
            return String.format("https://storage.googleapis.com/%s/audio/%s", bucketName, uniqueFileName);
        } catch (Exception e) {
            throw new RuntimeException("Failed to upload audio to Google Cloud Storage", e);
        }
    }


}

================
File: service/CategoryService.java
================
package com.example.demo.service;

import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Category;
import com.example.demo.entity.data.Course;
import com.example.demo.repository.data.CategoryRepository;
import com.example.demo.repository.data.CourseRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional
public class CategoryService {
    private final CategoryRepository categoryRepository;
    private final CourseRepository courseRepository;

    public ResponseObject getAllCategory(int page, int size) {
        var categories = categoryRepository.findAllByIsDeleted(false, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(categories).build();
    }
    public List<Category> getCategoriesByIds(List<Integer> ids) {
        // Validate and fetch categories
        return categoryRepository.findAllById(ids);
    }
    public ResponseObject getAllCategoryDeleted(int page, int size) {
        var categories = categoryRepository.findAllByIsDeleted(true, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(categories).build();
    }

    public Category getById(int id) {
        var cate = categoryRepository.findById(id).orElse(null);
        if(cate == null) {
            return null;
        }
        return cate;
    }

    public void updateCategoriesForCourse(Course course, List<Integer> categoryIds) {
        var categories = getCategoriesByIds(categoryIds);
        course.setCategories(categories);
    }
    public void addCategoriesForCourse(Course course, List<Integer> categoryIds) {
        var categories = getCategoriesByIds(categoryIds);
        course.getCategories().addAll(categories);
    }

    public ResponseObject getByTitle(String title, int page, int size) {
        var result = categoryRepository.findByNameContaining(title, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get data successfully").content(result).build();
    }

    public ResponseObject updateCategoryById(int id, Category category) {
        var tempCategory = categoryRepository.findById(id).orElse(null);
        var existName = categoryRepository.findByName(category.getName()).orElse(null);
        if (tempCategory == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Category does not exist!").build();
        }
        if(existName != null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("The category name existed!").build();
        }
        categoryRepository.save(category);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update successfully").build();
    }

    public ResponseObject createCategory(String name)
    {
        var result = categoryRepository.findByName(name).orElse(null);
        if(result == null) {
            result = Category.builder().name(name).build();
            categoryRepository.save(result);
            return ResponseObject.builder().status(HttpStatus.OK).mess("Create category successfully").build();
        }
        return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Category existed").build();
    }

    public ResponseObject softDelete(int id) {
        var category = categoryRepository.findById(id).orElse(null);
        if (category == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Category does not exist!").build();
        }
        category.setDeleted(true);
        for (Course course : category.getCourses()) {
            course.getCategories().remove(category);
            courseRepository.save(course);
        }
        category.setCourses(null);
        categoryRepository.save(category);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject hardDelete(int id) {
        var category = categoryRepository.findById(id).orElse(null);
        if (category == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        categoryRepository.delete(category);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject restoreCategoryById(int id) {
        var category = categoryRepository.findById(id).orElse(null);
        if(category == null) return ResponseObject.builder().mess("Category does not exist").status(HttpStatus.BAD_REQUEST).build();
        category.setDeleted(false);
        return ResponseObject.builder().mess("Restore successfully").status(HttpStatus.OK).build();
    }
}

================
File: service/ChatService.java
================
package com.example.demo.service;

import com.example.demo.dto.UserDTO;
import com.example.demo.entity.data.Message;
import com.example.demo.entity.data.Progress;
import com.example.demo.entity.user.User;
import com.example.demo.entity.data.Course;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.repository.data.MessageRepository;
import com.example.demo.repository.data.ProgressRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ChatService {

    private final MessageRepository messageRepository;
    private final CourseRepository courseRepository;
    private final UserRepository userRepository;
    private final ProgressRepository progressRepository;
    /**
     * Retrieve a list of instructors for courses the user has joined.
     *
     * @param userEmail the email of the user
     * @return a list of distinct instructors
     */


    public List<UserDTO> getInstructorsForUserCourses(Integer userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("User not found"));

        // Fetch all progress records for the user
        List<Progress> progresses = progressRepository.findByUser(user);

        // Extract courses from progress records
        List<Course> courses = progresses.stream()
                .map(Progress::getCourse)
                .collect(Collectors.toList());

        // Extract instructors from courses
        List<User> instructors = courses.stream()
                .map(Course::getInstructor)
                .distinct()
                .collect(Collectors.toList());

        // Convert instructors to UserDTO
        List<UserDTO> instructorDTOs = instructors.stream()
                .map(this::getUserDTOFromUser)
                .collect(Collectors.toList());

        return instructorDTOs;
    }
    public UserDTO getUserDTOFromUser(User user) {
        return UserDTO.builder()
                .id(user.getId())
                .avatar(user.getAvatar())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .phoneNumber(user.getPhoneNumber())
                .role(user.getRole())
                .build();
    }
    public String createOrGetChatRoom(String userEmail, String instructorEmail) {
        // Retrieve User entities based on email
        User sender = userRepository.findByEmail(userEmail)
                .orElseThrow(() -> new ResourceNotFoundException("User not found with email: " + userEmail));
        User receiver = userRepository.findByEmail(instructorEmail)
                .orElseThrow(() -> new ResourceNotFoundException("User not found with email: " + instructorEmail));

        // Generate a unique chat room ID
        String chatRoomId = generateChatRoomId(userEmail, instructorEmail);

        // Check if the chat room already exists
        boolean chatExists = messageRepository.existsByChatRoomId(chatRoomId);
        if (!chatExists) {
            // Create an initial message to initialize the chat room
            Message initialMessage = Message.builder()
                    .sender(sender) // Use User entity
                    .receiver(receiver) // Use User entity
                    .content("Chat started.")
                    .timestamp(LocalDateTime.now())
                    .chatRoomId(chatRoomId)
                    .build();
            messageRepository.save(initialMessage);
        }

        return chatRoomId;
    }

    /**
     * Generate a consistent chat room ID based on user and instructor emails.
     *
     * @param userEmail       the email of the user
     * @param instructorEmail the email of the instructor
     * @return a unique chat room ID
     */
    private String generateChatRoomId(String userEmail, String instructorEmail) {
        return userEmail.compareTo(instructorEmail) < 0
                ? userEmail + "_" + instructorEmail
                : instructorEmail + "_" + userEmail;
    }

    /**
     * Initialize a chat room with a placeholder message.
     *
     * @param chatRoomId      the ID of the chat room
     * @param userEmail       the email of the user
     * @param instructorEmail the email of the instructor
     */
    private void initializeChatRoom(String chatRoomId, String userEmail, String instructorEmail) {
        Message initialMessage = Message.builder()
                .sender(userRepository.findByEmail(userEmail)
                        .orElseThrow(() -> new IllegalArgumentException("User not found: " + userEmail)))
                .receiver(userRepository.findByEmail(instructorEmail)
                        .orElseThrow(() -> new IllegalArgumentException("Instructor not found: " + instructorEmail)))
                .content("Chat started.")
                .timestamp(LocalDateTime.now())
                .chatRoomId(chatRoomId)
                .isRead(false)
                .build();

        messageRepository.save(initialMessage);
    }

    /**
     * Validate the email addresses of the user and instructor.
     *
     * @param userEmail       the email of the user
     * @param instructorEmail the email of the instructor
     */
    private void validateEmails(String userEmail, String instructorEmail) {
        if (userEmail == null || userEmail.trim().isEmpty()) {
            throw new IllegalArgumentException("User email cannot be null or empty.");
        }
        if (instructorEmail == null || instructorEmail.trim().isEmpty()) {
            throw new IllegalArgumentException("Instructor email cannot be null or empty.");
        }
    }
}

================
File: service/CommentService.java
================
package com.example.demo.service;

import com.example.demo.dto.CommentDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.entity.data.Comment;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CommentRepository;
import com.example.demo.repository.data.LessonRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional
public class CommentService {
    private final UserRepository userRepository;
    private  final CommentRepository commentRepository;
    private  final LessonRepository lessonRepository;

    public Comment getById(int id) {
        return commentRepository.findById(id).orElse(null);
    }
    public List<Comment> getRecentComments(int limit) {
        Pageable pageable = PageRequest.of(0, limit);
        return commentRepository.findRecentComments(pageable);
    }
    public void deleteById(int id) {
        var comment = commentRepository.findById(id).orElse(null);
        if (comment == null) {
            return ;
        }
        List<Comment> subComments = commentRepository.findAllByParentId(id);

        if(!subComments.isEmpty()) {
            for (Comment subComment : subComments) {
                subComment.getUser().getComments().remove(subComment);
                commentRepository.delete(subComment);
            }
        }
        commentRepository.delete(comment);
    }


    public Comment saveComment(CommentDTO commentDTO) {
        var user = userRepository.findByEmail(commentDTO.getEmail()).orElse(null);
        var lesson = lessonRepository.findById(commentDTO.getLessonId()).orElse(null);
        if (user == null || lesson == null) {
            System.out.println("user || lesson not found");
            return null;
        }
        Comment comment = Comment.builder()
                .userEmail(commentDTO.getEmail())
                .userName(commentDTO.getUserName())
                .avatar(commentDTO.getAvatar())
                .user(user)
                .content(commentDTO.getContent())
                .lesson(lesson)
                .parentId(commentDTO.getParentId())
                .date(LocalDateTime.now())
                .replyToUser(commentDTO.getReplyToUser())
                .replyToUserName(commentDTO.getReplyToUserName())
                .build();
        return commentRepository.save(comment);
    }

    public ResponseObject getCommentByLessonId(int lessonId) {
        var comments = commentRepository.findAllByLessonId(lessonId, PageRequest.of(0, Integer.MAX_VALUE));
        return ResponseObject.builder().status(HttpStatus.OK).content(comments).build();
    }
}

================
File: service/CourseService.java
================
package com.example.demo.service;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.CourseStatisticDTO;
import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.SectionDTO;
import com.example.demo.entity.data.*;
import com.example.demo.entity.user.User;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import com.example.demo.dto.CourseDTO;
import com.example.demo.repository.data.LessonProgressRepository;
import com.example.demo.repository.data.ProgressRepository;
import com.example.demo.repository.data.SectionRepository;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.atomic.AtomicReference;
import java.util.stream.Collectors;

@Data
@RequiredArgsConstructor
@Service
@Transactional
public class CourseService {
    private final CourseRepository courseRepository;
    private final UserRepository userRepository;
    private final LessonProgressRepository lessonProgressRepository;
    private final CloudService cloudService;
    private final CategoryService categoryService;
    private final LessonService lessonService;
    private final SectionService sectionService;
    private final ProgressRepository progressRepository;
    private final UserService userService; // Fetch instructors and students
    public ResponseObject getCourseById(int id, boolean isDeleted) {
        Course course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().mess("Course is not exist!").status(HttpStatus.BAD_REQUEST).build();
        }
        var sections = sectionService.getSectionsByCourse(course, isDeleted);
        course.setSections(sections);
        return ResponseObject.builder().content(course).status(HttpStatus.OK).build();
    }
    public User getInstructorByCourseId(int courseId) {
        Course course = courseRepository.findById(courseId)
                .orElseThrow(() -> new RuntimeException("Course not found"));
        return course.getInstructor();
    }
    public ResponseObject getAllCourse(int page, int size) {
        var courses = courseRepository.findAllByIsDeleted(false, PageRequest.of(page, size));
        System.out.println("Gello"+courses);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(courses).build();
    }

    public ResponseObject getAllCourseDeleted(int page, int size) {
        var courses = courseRepository.findAllByIsDeleted(true, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get successfully").content(courses).build();
    }
    public boolean isUserEnrolled(int courseId, int userId) {
        return progressRepository.existsByCourse_IdAndUser_Id(courseId, userId);
    }
    private void unlockFirstLessonForUser(int courseId, int userId) {
        Course course = courseRepository.findById(courseId).orElseThrow();
        User user = userRepository.findById(userId).orElseThrow();

        List<Section> sections = course.getSections();
        sections.sort(Comparator.comparingInt(Section::getId));
        if (!sections.isEmpty()) {
            Section firstSection = sections.get(0);
            List<Lesson> lessons = firstSection.getLessons();
            lessons.sort(Comparator.comparingInt(Lesson::getId));
            if (!lessons.isEmpty()) {
                Lesson firstLesson = lessons.get(0);
                LessonProgressKey key = new LessonProgressKey(userId, firstLesson.getId());
                LessonProgress lessonProgress = new LessonProgress();
                lessonProgress.setId(key);
                lessonProgress.setUser(user);
                lessonProgress.setLesson(firstLesson);
                lessonProgress.setUnlocked(true);
                lessonProgressRepository.save(lessonProgress);
            }

        }
    }

    public ResponseObject updateCourse(int id, CourseDTO courseDTO) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().mess("Course does not exist!").status(HttpStatus.BAD_REQUEST).build();
        }

        course.setThumbnail(courseDTO.getThumbnail());
        course.setVideo(courseDTO.getVideo());
        course.setDescription(courseDTO.getDescription());
        course.setDiscount(courseDTO.getDiscount());
        course.setTitle(courseDTO.getTitle());

        sectionService.updateSections(courseDTO, course);

        if (courseDTO.isEditedCategories()) {
            categoryService.updateCategoriesForCourse(course, courseDTO.getCategories());
        }

        courseRepository.save(course);
        return ResponseObject.builder().status(HttpStatus.OK).mess("Update successfully").build();
    }

    public ResponseObject addCourse(CourseDTO request) {
        if (courseRepository.findByTitle(request.getTitle()).isPresent()) {
            return ResponseObject.builder().mess("Course already exists").status(HttpStatus.BAD_REQUEST).build();
        }

        // Fetch instructor
        var instructor = userService.findByEmail(request.getInstructor());
        if (instructor == null) {
            return ResponseObject.builder().mess("Instructor not found").status(HttpStatus.BAD_REQUEST).build();
        }
        Course course = Course.builder()
                .title(request.getTitle())
                .price(request.getPrice())
                .discount(request.getDiscount())
                .description(request.getDescription())
                .date(LocalDateTime.now())
                .thumbnail(request.getThumbnail())
                .video(request.getVideo())
                .instructor(instructor)
                .categories(categoryService.getCategoriesByIds(request.getCategories()))
                .build();

        for (SectionDTO sectionDTO : request.getSections()) {
            Section section = Section.builder()
                    .title(sectionDTO.getTitle())
                    .course(course)
                    .build();

            if (sectionDTO.getLessons() != null) {
                lessonService.addLessonForSection(sectionDTO.getLessons(), section, null, 0);
            }

            course.getSections().add(section);
        }

        // Lưu Course
        courseRepository.save(course);

        return ResponseObject.builder().mess("Course created successfully").status(HttpStatus.OK).build();
    }

    public ResponseObject softDelete(int id) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).content(courseRepository.findAllByIsDeleted(false, PageRequest.of(0, 5))).mess("Course is not exist!").build();
        }
        course.setDeleted(true);
        courseRepository.save(course);
        return ResponseObject.builder().mess("Delete course successfully!").content(courseRepository.findAllByIsDeleted(false, PageRequest.of(0, 5))).status(HttpStatus.OK).build();
    }

    public ResponseObject hardDelete(int id) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        courseRepository.delete(course);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject getAllCourseByCategoryIdAndTitle(int id, String title) {
        List<Course> result = courseRepository.findAll();
        if (!Objects.equals(title, ""))
            result = result.stream().filter(c -> c.getTitle().contains(title)).toList();
        if (id != -1) {
            result = result.stream().filter(c -> c.getCategories().stream().anyMatch(ca -> ca.getId() == id)).toList();
        }
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject getAllCourseByCategoryId(int id, int page, int size) {
        if (id == -1) {
            return ResponseObject.builder().status(HttpStatus.OK).content(courseRepository.findAll(PageRequest.of(page, size))).mess("Get data successfully").build();
        }
        var result = courseRepository.findByCategoryId(id, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject getAllCourseDeletedByCategoryId(int id, int page, int size) {
        if (id == -1) {
            return ResponseObject.builder().status(HttpStatus.OK).content(courseRepository.findAllByIsDeleted(true, PageRequest.of(page, size))).mess("Get data successfully").build();
        }
        var result = courseRepository.findByCategoryIdAndIsDeleted(id, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject getAllCourseByCourseTitle(String title, boolean isDeleted, int page, int size) {
        var result = courseRepository.findByTitleContainingAndIsDeleted(title, isDeleted, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).mess("Get data successfully").build();
    }

    public ResponseObject restoreCourseById(int id) {
        var course = courseRepository.findById(id).orElse(null);
        if (course == null)
            return ResponseObject.builder().mess("Course does not exist").status(HttpStatus.BAD_REQUEST).build();
        course.setDeleted(false);
        courseRepository.save(course);
        return ResponseObject.builder().content(courseRepository.findAllByIsDeleted(true, PageRequest.of(0, 5))).mess("Restore successfully").status(HttpStatus.OK).build();
    }

    @Transactional
    public boolean enrollUser(int courseId, int userId) {
        // Check if the user is already enrolled in the course
        if (progressRepository.existsByCourse_IdAndUser_Id(courseId, userId)) {
            return false; // User is already enrolled
        }

        // Find course and user
        Course course = courseRepository.findById(courseId)
                .orElseThrow(() -> new RuntimeException("Course not found"));
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("User not found"));

        // Create a new Progress entry to represent the enrollment
        Progress progress = Progress.builder()
                .course(course)
                .user(user)
                .lessonIds(new ArrayList<>()) // Initialize if needed
                .build();

        // Save the Progress entity
        progressRepository.save(progress);

        return true; // User enrolled successfully
    }




    public ResponseObject getAllByPageable(int page, int size) {
        Pageable pageable = PageRequest.of(page, size);
        var courses = courseRepository.findAllByIsDeleted(false, pageable);
        System.out.println("Fetched Courses: " + courses.getContent());
        return ResponseObject.builder().status(HttpStatus.OK).content(courses).build();
    }
    public ResponseObject getAllcoursesNotdeleted(int page, int size) {
        Pageable pageable = PageRequest.of(page, size);
        var courses = courseRepository.findAllByIsDeleted(false, pageable);
        System.out.println("Fetched Courses: " + courses.getContent());
        return ResponseObject.builder().status(HttpStatus.OK).content(courses).build();
    }

}

================
File: service/DashboardService.java
================
package com.example.demo.service;

import com.example.demo.entity.user.Role;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.CourseRepository;
import org.springframework.stereotype.Service;

import java.util.Map;

@Service
public class DashboardService {

    private final CourseRepository courseRepository;
    private final UserRepository userRepository;

    public DashboardService(CourseRepository courseRepository, UserRepository userRepository) {
        this.courseRepository = courseRepository;
        this.userRepository = userRepository;
    }

    public Map<String, Integer> getDashboardStats() {
        int totalCourses = courseRepository.countActiveCourses(); // Trả về int
        int totalStudents = userRepository.countByRole(Role.USER);
        int totalInstructors = userRepository.countByRole(Role.INSTRUCTOR);

        return Map.of(
                "totalCourses", totalCourses,
                "totalStudents", totalStudents,
                "totalInstructors", totalInstructors
        );
    }
}

================
File: service/DTOMapperService.java
================
package com.example.demo.service;

import com.example.demo.dto.*;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Category;
import com.example.demo.entity.data.Section;
import com.example.demo.entity.data.Lesson;
import com.example.demo.entity.user.User;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class DTOMapperService {


    public InstructorDTO mapUserToInstructorDTO(User user) {
        return InstructorDTO.builder()
                .id(user.getId())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .avatar(user.getAvatar())
                .build();
    }


}

================
File: service/ExternalEssayEvaluationService.java
================
// src/main/java/com/example/demo/service/ExternalEssayEvaluationService.java

package com.example.demo.service;

import com.example.demo.dto.EssayFeedback;
import com.example.demo.dto.OpenAIRequest;
import com.example.demo.dto.OpenAIResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;

import java.util.Arrays;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
@RequiredArgsConstructor
public class ExternalEssayEvaluationService {

    @Value("${openai.api.key}")
    private String apiKey;

    @Value("${openai.api.url}")
    private String apiUrl;

    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper objectMapper = new ObjectMapper();

    private static final long COOLDOWN_PERIOD = 3000; // 3 seconds
    private long lastRequestTime = 0;

    public EssayFeedback evaluateEssay(String prompt, String essayContent) {
        // Kiểm tra cooldown nếu cần thiết
        long currentTime = System.currentTimeMillis();
        if (currentTime - lastRequestTime < COOLDOWN_PERIOD) {
            try {
                Thread.sleep(COOLDOWN_PERIOD - (currentTime - lastRequestTime));
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        lastRequestTime = System.currentTimeMillis();

        // Tạo đối tượng OpenAIRequest
        OpenAIRequest requestPayload = new OpenAIRequest();
        requestPayload.setModel("gpt-4o-mini");
        requestPayload.setMessages(Arrays.asList(
                new OpenAIRequest.Message("system", "You are an IELTS examiner.", null),
                new OpenAIRequest.Message("user", buildUserMessage(prompt, essayContent), null) // Pass null here
        ));

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(apiKey);

        HttpEntity<OpenAIRequest> entity = new HttpEntity<>(requestPayload, headers);

        try {
            ResponseEntity<String> response = restTemplate.postForEntity(apiUrl, entity, String.class);

            if (response.getStatusCode() == HttpStatus.OK) {
                // Ghi log phản hồi từ AI để kiểm tra
                System.out.println("AI Response Body: " + response.getBody());

                OpenAIResponse openAIResponse = objectMapper.readValue(response.getBody(), OpenAIResponse.class);
                if (openAIResponse.getChoices() != null && !openAIResponse.getChoices().isEmpty()) {
                    String content = openAIResponse.getChoices().get(0).getMessage().getContent();
                    // Ghi log nội dung phần content
                    System.out.println("AI Content for Deserialization: " + content);

                    // Strip code fences if present
                    content = stripCodeFences(content);

                    // Deserialize chỉ phần content vào EssayFeedback
                    return objectMapper.readValue(content, EssayFeedback.class);
                } else {
                    throw new RuntimeException("No choices found in AI response.");
                }
            } else {
                throw new RuntimeException("Failed to get response from AI. Status code: " + response.getStatusCode());
            }
        } catch (HttpClientErrorException.BadRequest e) {
            // Ghi log lỗi chi tiết từ OpenAI
            System.err.println("Bad Request Error: " + e.getResponseBodyAsString());
            throw new RuntimeException("Bad Request: " + e.getResponseBodyAsString(), e);
        } catch (Exception e) {
            throw new RuntimeException("Error processing AI response: " + e.getMessage(), e);
        }
    }

    private String buildUserMessage(String prompt, String essayContent) {
        return "Please evaluate the following essay focusing on grammatical and vocabulary errors and show how to elevate it to higher by recommend a band 7 to 8 sentence. Provide the feedback strictly in JSON format with the following structure:\n" +
                "{\n" +
                "  \"grammarErrors\": [\n" +
                "    {\n" +
                "      \"sentence\": \"Incorrect sentence here.\",\n" +
                "      \"error\": \"Subject-verb agreement.\",\n" +
                "      \"recommendation\": \"Corrected sentence here.\"\n" +
                "    }\n" +
                "  ],\n" +
                "  \"vocabularyErrors\": [\n" +
                "    {\n" +
                "      \"word\": \"incorrectWord\",\n" +
                "      \"error\": \"Wrong usage.\",\n" +
                "      \"recommendation\": \"Suggested word here.\"\n" +
                "    }\n" +
                "  ],\n" +
                "  \"overallFeedback\": \"Detailed overall feedback here.\",\n" +
                "  \"overallScore\": 6\n" +
                "}\n\n" +
                "**Prompt:**\n" + prompt + "\n\n" +
                "**Essay:**\n" + essayContent + "\n\n" +
                "Please respond ONLY with the JSON object as specified above. Do not include any Markdown formatting, code fences, or additional text.";
    }

    /**
     * Strips Markdown code fences (```json and ```) from the AI response content.
     *
     * @param content The raw content from the AI response.
     * @return The cleaned JSON string.
     */
    private String stripCodeFences(String content) {
        if (content.startsWith("```")) {
            // Remove the first line (e.g., ```json)
            int firstNewline = content.indexOf("\n");
            if (firstNewline != -1) {
                content = content.substring(firstNewline + 1);
            }

            // Remove the last three backticks
            if (content.endsWith("```")) {
                content = content.substring(0, content.length() - 3);
            }
        }
        return content.trim();
    }

    public double calculateScore(String feedback) {
        // Sử dụng regex để tìm điểm số từ 0 đến 9, có thể có dấu chấm thập phân
        Pattern pattern = Pattern.compile("(\\b[0-9](?:\\.[0-9])?\\b)");
        Matcher matcher = pattern.matcher(feedback);
        double score = 0.0;
        while (matcher.find()) {
            double potentialScore = Double.parseDouble(matcher.group());
            if (potentialScore >= 0.0 && potentialScore <= 9.0) {
                score = potentialScore;
                break;
            }
        }
        return score;
    }
}

================
File: service/FlashcardService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.Flashcard;
import com.example.demo.entity.data.FlashcardSet;
import com.example.demo.entity.data.Vocabulary;
import com.example.demo.repository.data.FlashcardRepository;
import com.example.demo.repository.data.FlashcardSetRepository;
import com.example.demo.repository.data.VocabularyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class FlashcardService {

    @Autowired
    private FlashcardSetRepository flashcardSetRepository;

    @Autowired
    private VocabularyRepository vocabularyRepository;

    @Autowired
    private FlashcardRepository flashcardRepository;

    public List<FlashcardSet> getFlashcardSetsByUserId(Integer userId){
        return flashcardSetRepository.findByUserId(userId);
    }

    public FlashcardSet createFlashcardSet(Integer userId, String title, String description, List<Integer> vocabularyIds){
        FlashcardSet set = new FlashcardSet();
        set.setTitle(title);
        set.setDescription(description);
        // Assume you have a method to get user by id
        // set.setUser(userService.getUserById(userId));

        FlashcardSet savedSet = flashcardSetRepository.save(set);

        for(Integer vocabId : vocabularyIds){
            Vocabulary vocab = vocabularyRepository.findById(vocabId)
                    .orElseThrow(() -> new RuntimeException("Vocabulary not found with id " + vocabId));
            Flashcard flashcard = new Flashcard();
            flashcard.setSet(savedSet);
            flashcard.setVocabulary(vocab);
            flashcardRepository.save(flashcard);
        }

        return savedSet;
    }

    // Thêm các phương thức khác như update, delete nếu cần
}

================
File: service/GPTService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.Vocabulary;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.*;
import org.json.JSONObject;
import org.json.JSONArray;

import java.util.ArrayList;
import java.util.List;

@Service
public class GPTService {

    @Value("${openai.api.key}")
    private String openAIApiKey;

    private final String OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";

    public List<Vocabulary> generateVocabulary(String topic, int quantity, String level) {
        RestTemplate restTemplate = new RestTemplate();
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(openAIApiKey);

        JSONObject requestBody = new JSONObject();
        requestBody.put("model", "gpt-4"); // hoặc mô hình bạn muốn sử dụng
        JSONArray messages = new JSONArray();
        JSONObject systemMessage = new JSONObject();
        systemMessage.put("role", "system");
        systemMessage.put("content", "Bạn là một trợ lý giúp tạo danh sách từ vựng.");
        JSONObject userMessage = new JSONObject();
        userMessage.put("role", "user");
        userMessage.put("content", String.format(
                "Hãy tạo một danh sách gồm %d từ vựng về chủ đề '%s' ở mức độ '%s'. Đối với mỗi từ, hãy cung cấp định nghĩa và một ví dụ sử dụng.",
                quantity, topic, level));
        messages.put(systemMessage);
        messages.put(userMessage);
        requestBody.put("messages", messages);

        HttpEntity<String> entity = new HttpEntity<>(requestBody.toString(), headers);

        try {
            ResponseEntity<String> response = restTemplate.postForEntity(OPENAI_API_URL, entity, String.class);
            if (response.getStatusCode() == HttpStatus.OK) {
                JSONObject responseBody = new JSONObject(response.getBody());
                JSONArray choices = responseBody.getJSONArray("choices");
                String content = choices.getJSONObject(0).getJSONObject("message").getString("content");

                // Phân tích nội dung trả về để trích xuất từ vựng
                return parseVocabularyFromGPTResponse(content);
            } else {
                throw new RuntimeException("GPT API request failed with status: " + response.getStatusCode());
            }
        } catch (Exception e) {
            throw new RuntimeException("Error while calling GPT API: " + e.getMessage());
        }
    }

    private List<Vocabulary> parseVocabularyFromGPTResponse(String response) {
        List<Vocabulary> vocabularies = new ArrayList<>();
      
        String[] lines = response.split("\n");
        for (String line : lines) {
            line = line.trim();
            if (line.matches("^\\d+\\.\\s+.*")) { // Kiểm tra dòng bắt đầu bằng số.
                // Tách số thứ tự
                int dotIndex = line.indexOf('.');
                String content = line.substring(dotIndex + 1).trim();
                // Tách từ, định nghĩa và ví dụ
                String[] parts = content.split(":");
                if (parts.length >= 2) {
                    String word = parts[0].trim();
                    String[] defAndEx = parts[1].split("\\. ");
                    String definition = defAndEx[0].trim();
                    String example = defAndEx.length > 1 ? defAndEx[1].trim() : "";
                    Vocabulary vocab = Vocabulary.builder()
                            .word(word)
                            .definition(definition)
                            .example(example)
                            .build();
                    vocabularies.add(vocab);
                }
            }
        }
        return vocabularies;
    }
}

================
File: service/LessonProgressService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.*;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.LessonProgressRepository;
import com.example.demo.repository.data.LessonRepository;
import com.example.demo.repository.data.SectionRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Comparator;
import java.util.List;
import java.util.stream.Collectors;

@Service

public class LessonProgressService {
    @Autowired
    private LessonProgressRepository lessonProgressRepository;

    @Autowired
    private LessonRepository lessonRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private SectionRepository sectionRepository;

    public void updateProgress(int userId, int lessonId, double progress) {
        LessonProgressKey key = new LessonProgressKey(userId, lessonId);
        LessonProgress lessonProgress = lessonProgressRepository.findById(key).orElseGet(() -> {
            LessonProgress lp = new LessonProgress();
            lp.setId(key);
            lp.setUser(userRepository.findById(userId).orElseThrow());
            lp.setLesson(lessonRepository.findById(lessonId).orElseThrow());
            lp.setUnlocked(true);
            return lp;
        });

        lessonProgress.setProgressPercentage(progress);
        if (progress >= 80 && !lessonProgress.isCompleted()) {
            lessonProgress.setCompleted(true);
            unlockNextLesson(userId, lessonId);
        }

        lessonProgressRepository.save(lessonProgress);
    }

    private void unlockNextLesson(int userId, int currentLessonId) {
        // Find the next lesson in the course
        Lesson currentLesson = lessonRepository.findById(currentLessonId).orElseThrow();
        Section currentSection = currentLesson.getSection();
        Course course = currentSection.getCourse();

        List<Section> sections = course.getSections();
        // Sort sections and lessons if not already sorted
        sections.sort(Comparator.comparingInt(Section::getId));

        boolean nextLessonFound = false;

        for (int i = 0; i < sections.size(); i++) {
            Section section = sections.get(i);
            List<Lesson> lessons = section.getLessons();
            lessons.sort(Comparator.comparingInt(Lesson::getId));

            for (int j = 0; j < lessons.size(); j++) {
                Lesson lesson = lessons.get(j);
                if (nextLessonFound) {
                    // Unlock this lesson for the user
                    LessonProgressKey key = new LessonProgressKey(userId, lesson.getId());
                    LessonProgress lessonProgress = new LessonProgress();
                    lessonProgress.setId(key);
                    lessonProgress.setUser(userRepository.findById(userId).orElseThrow());
                    lessonProgress.setLesson(lesson);
                    lessonProgress.setUnlocked(true);
                    lessonProgressRepository.save(lessonProgress);
                    return; // Only unlock the immediate next lesson
                }
                if (lesson.getId() == currentLessonId) {
                    nextLessonFound = true;
                }
            }
        }
    }

    public List<LessonProgress> getUserProgressForCourse(int userId, int courseId) {
        // Fetch all LessonProgress for the user with related entities
        List<LessonProgress> allProgress = lessonProgressRepository.findByUserIdWithCourse(userId);

        // Filter by courseId (no lazy loading issues)
        return allProgress.stream()
                .filter(lp -> lp.getLesson().getSection().getCourse().getId() == courseId)
                .collect(Collectors.toList());
    }
}

================
File: service/LessonService.java
================
package com.example.demo.service;

import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.SectionDTO;
import com.example.demo.dto.LessonDTO;
import com.example.demo.entity.data.Lesson;
import com.example.demo.entity.data.Section;
import com.example.demo.repository.data.LessonRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;

@Service
@RequiredArgsConstructor
@Transactional
public class LessonService {
    private final LessonRepository lessonRepository;

    public ResponseObject getById(int id) {
        var lesson = lessonRepository.findById(id).orElse(null);
        if(lesson == null) {
            return ResponseObject.builder().content("Lesson is not exist!").status(HttpStatus.BAD_REQUEST).build();
        }
        return  ResponseObject.builder().status(HttpStatus.OK).content(lesson).build();
    }

    public List<Lesson> getLessonsBySections(List<Integer> list) {
        return lessonRepository.findLessonsBySections(list);
    }

    public List<Lesson> updateLessonsOfSection(Section oldSection, SectionDTO newSection) {
        if (newSection.getLessons().isEmpty()) {
            // Handle deletion...
            return null;
        }

        var lessonsUpdate = new ArrayList<Lesson>();

        for (var newLesson : newSection.getLessons()) {
            var currentLesson = oldSection.getLessons().stream()
                    .filter(l -> newLesson.getId() == l.getId())
                    .findFirst()
                    .orElse(null);

            if (currentLesson != null) {
                // Update existing lesson
                currentLesson.setDescription(newLesson.getDescription());
                currentLesson.setTitle(newLesson.getTitle());
                currentLesson.setVideo(newLesson.getVideo());
                currentLesson.setLinkVideo(newLesson.getLinkVideo());
                // Ensure section is set
                currentLesson.setSection(oldSection);
                lessonsUpdate.add(currentLesson);
            } else {
                // Create new lesson
                currentLesson = Lesson.builder()
                        .description(newLesson.getDescription())
                        .video(newLesson.getVideo())
                        .title(newLesson.getTitle())
                        .linkVideo(newLesson.getLinkVideo())
                        .section(oldSection) // Set the section
                        .build();
                oldSection.getLessons().add(currentLesson);
                lessonsUpdate.add(currentLesson);
            }
        }

        // Handle deletion of removed lessons...
        return oldSection.getLessons();
    }
//    public int updateVideo(LessonDTO lessonDTO, Lesson lesson, List<String> videos, int index) {
//        if(videos != null && videos.size() > index) {
//            switch (lessonDTO.getActionVideo()) {
//                case "REMOVE" -> {
//                    System.out.println("REMOVE  VIDEO");
//                    lesson.setVideo(null);
//                }
//                case "UPDATE" -> {
//                    System.out.println("UPDATE VIDEO");
//                    lesson.setVideo(videos.get(index));
//                    index++;
//                }
//                case "NONE" -> {
//                    System.out.println("NONE  VIDEO");
//                    lesson.setVideo(null);
//                }
//                case "KEEP" -> {
//                    System.out.println("KEEP  VIDEO");
//                    System.out.println(lessonDTO.getVideo());
//                    lesson.setVideo(lessonDTO.getVideo());
//                }
//                default -> System.out.println("DEFAULT  VIDEO");
//            }
//        }
//        return index;
//    }
public int updateVideo(Lesson lesson, List<String> videos, int index) {
    if (videos != null && videos.size() > index) {
        switch (lesson.getActionVideo()) { // Đảm bảo Lesson có trường `actionVideo`
            case "REMOVE" -> {
                System.out.println("REMOVE VIDEO");
                lesson.setVideo(null);
            }
            case "UPDATE" -> {
                System.out.println("UPDATE VIDEO");
                lesson.setVideo(videos.get(index));
                index++;
            }
            case "NONE" -> {
                System.out.println("NONE VIDEO");
                lesson.setVideo(null);
            }
            case "KEEP" -> {
                System.out.println("KEEP VIDEO");
                lesson.setVideo(lesson.getVideo());
            }
            default -> System.out.println("DEFAULT VIDEO");
        }
    }
    return index;
}

    public int addLessonForSection(List<LessonDTO> lessonDTOs, Section section, List<String> videos, int indexVideo) {
        if (section.getLessons() == null) {
            section.setLessons(new ArrayList<>());
        }
        for (LessonDTO lessonDTO : lessonDTOs) {
            Lesson lesson = Lesson.builder()
                    .section(section)
                    .date(LocalDateTime.now())
                    .title(lessonDTO.getTitle())
                    .description(lessonDTO.getDescription())
                    .linkVideo(lessonDTO.getLinkVideo())
                    .video(lessonDTO.getVideo())
                    .actionVideo(lessonDTO.getActionVideo())
                    .build();
            section.getLessons().add(lesson);

            if (videos != null && videos.size() > indexVideo) {
                indexVideo = updateVideo(lesson, videos, indexVideo);
            }
        }
        return indexVideo;
    }

}

================
File: service/MessageService.java
================
package com.example.demo.service;

import com.example.demo.dto.UserDTO;
import com.example.demo.entity.data.Message;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import com.example.demo.repository.data.MessageRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class MessageService {

    private final MessageRepository messageRepository;
    private final UserRepository userRepository;

    public MessageService(MessageRepository messageRepository, UserRepository userRepository) {
        this.messageRepository = messageRepository;
        this.userRepository = userRepository;
    }

    public void sendMessage(Integer senderId, Integer receiverId, String content) {
        User sender = userRepository.findById(senderId)
                .orElseThrow(() -> new ResourceNotFoundException("Sender not found"));
        User receiver = userRepository.findById(receiverId)
                .orElseThrow(() -> new ResourceNotFoundException("Receiver not found"));

        String chatRoomId = generateChatRoomId(senderId, receiverId);

        Message message = Message.builder()
                .sender(sender)
                .receiver(receiver)
                .content(content)
                .timestamp(LocalDateTime.now())
                .isRead(false)
                .chatRoomId(chatRoomId)
                .build();

        messageRepository.save(message);
    }

    public List<UserDTO> getStudentsForInstructor(Integer instructorId) {
        // Verify that the instructor exists
        User instructor = userRepository.findById(instructorId)
                .orElseThrow(() -> new ResourceNotFoundException("Instructor not found"));

        // Fetch students via Progress
        List<User> students = messageRepository.findStudentsByInstructorId(instructorId);

        return students.stream()
                .map(this::convertToUserDTO)
                .collect(Collectors.toList());
    }
    private UserDTO convertToUserDTO(User user) {
        return UserDTO.builder()
                .id(user.getId())
                .email(user.getEmail())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .avatar(user.getAvatar())
                .phoneNumber(user.getPhoneNumber())
                .role(user.getRole())
                .build();
    }
    private String generateChatRoomId(Integer userId1, Integer userId2) {
        List<Integer> ids = Arrays.asList(userId1, userId2);
        Collections.sort(ids);
        return ids.get(0) + "_" + ids.get(1);
    }
    public List<Message> getMessagesBetweenUsers(Integer userId1, Integer userId2) {
        return messageRepository.findMessagesBetweenUsers(userId1, userId2);
    }
    public List<Message> getUnreadMessages(Integer receiverId) {
        // Validate receiver existence
        User receiver = userRepository.findById(receiverId)
                .orElseThrow(() -> new ResourceNotFoundException("Receiver not found with ID: " + receiverId));

        // Fetch unread messages
        return messageRepository.findByReceiverAndIsReadFalseOrderByTimestampAsc(receiver);
    }

    public void markMessagesAsRead(Integer receiverId, Integer senderId) {
        // Validate sender and receiver existence
        userRepository.findById(senderId)
                .orElseThrow(() -> new ResourceNotFoundException("Sender not found with ID: " + senderId));
        userRepository.findById(receiverId)
                .orElseThrow(() -> new ResourceNotFoundException("Receiver not found with ID: " + receiverId));

        // Update messages to mark as read
        List<Message> messages = messageRepository.findBySenderAndReceiverOrderByTimestampAsc(
                userRepository.getById(senderId),
                userRepository.getById(receiverId)
        );

        messages.forEach(message -> message.setRead(true));
        messageRepository.saveAll(messages); // Batch update for efficiency
    }
}

================
File: service/SectionService.java
================
package com.example.demo.service;

import com.example.demo.dto.CourseDTO;
import com.example.demo.dto.LessonDTO;
import com.example.demo.entity.data.Course;
import com.example.demo.entity.data.Lesson;
import com.example.demo.entity.data.Section;
import com.example.demo.repository.data.SectionRepository;
import com.example.demo.dto.SectionDTO;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.AutoConfigureOrder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
@Transactional
@RequiredArgsConstructor
public class SectionService {

    @Autowired
    private SectionRepository sectionRepository;
    @Autowired
    private LessonService lessonService;

    public void removeSection(Section section) {
        sectionRepository.delete(section);
    }

    public void removeAllSection(List<Section> sections) {
        sectionRepository.deleteAll(sections);
    }

    public Section findById(int id) {
        return sectionRepository.findById(id).orElse(null);
    }

    public void deleteSection(int id) {
        var section = sectionRepository.findById(id).orElse(null);
        if (section != null) {
            section.setDeleted(true);
            sectionRepository.save(section);
        }
    }

    public List<Section> getSectionsByCourse(Course course, boolean isDeleted) {
        return sectionRepository.findSectionsByCourse(course.getId(), isDeleted).orElse(null);
    }

    public void updateSection(SectionDTO sectionDTO) {
        var section = sectionRepository.findById(sectionDTO.getId()).orElse(null);

        if (section != null) {
            section.setTitle(sectionDTO.getTitle());
            var lesson = lessonService.updateLessonsOfSection(section, sectionDTO);
            section.setLessons(lesson);
            sectionRepository.save(section);
        }
    }

    public void addListSectionDtoToCourse(Course course, List<SectionDTO> sectionDTOs) {
        if (course.getSections() == null) course.setSections(new ArrayList<>());
        for (var sectionDTO : sectionDTOs) {
            var section = Section.builder()
                    .title(sectionDTO.getTitle())
                    .course(course)
                    .build();

            List<Lesson> lessons = new ArrayList<>();
            for (LessonDTO lessonDTO : sectionDTO.getLessons()) {
                Lesson lesson = Lesson.builder()
                        .description(lessonDTO.getDescription())
                        .linkVideo(lessonDTO.getLinkVideo())
                        .title(lessonDTO.getTitle())
                        .video(lessonDTO.getVideo())
                        .date(LocalDateTime.now())
                        .section(section)
                        .build();
                lessons.add(lesson);
            }
            section.setLessons(lessons);
            course.getSections().add(section);
            sectionRepository.save(section);
        }
    }



    public void updateSections(CourseDTO courseDTO, Course course) {
        if (courseDTO.getSections().isEmpty()) {
            if (course.getSections() == null || course.getSections().isEmpty()) return;
            else {
                course.getSections().forEach(section -> {
                    section.setDeleted(true);
                    sectionRepository.save(section);
                });
                return;
            }
        }

        var updateSections = new ArrayList<Section>();
        for (var sectionDTO : courseDTO.getSections()) {
            Section section;
            if (sectionDTO.getId() == 0) {
                section = Section.builder()
                        .title(sectionDTO.getTitle())
                        .course(course)
                        .build();

                List<Lesson> lessons = new ArrayList<>();
                for (LessonDTO lessonDTO : sectionDTO.getLessons()) {
                    Lesson lesson = Lesson.builder()
                            .description(lessonDTO.getDescription())
                            .linkVideo(lessonDTO.getLinkVideo())
                            .title(lessonDTO.getTitle())
                            .video(lessonDTO.getVideo())
                            .date(LocalDateTime.now())
                            .section(section)
                            .build();
                    lessons.add(lesson);
                }
                section.setLessons(lessons);
                course.getSections().add(section);
                updateSections.add(section);
            } else {
                section = sectionRepository.findById(sectionDTO.getId()).orElse(null);
                if (section != null) {
                    section.setTitle(sectionDTO.getTitle());
                    var lessons = lessonService.updateLessonsOfSection(section, sectionDTO);
                    section.setLessons(lessons);
                    updateSections.add(section);
                }
            }

            assert section != null;
            sectionRepository.save(section);
        }

        course.getSections().forEach(section -> {
            if (!updateSections.contains(section)) {
                section.setDeleted(true);
                sectionRepository.save(section);
            }
        });
    }


}

================
File: service/SpeakingService.java
================
// src/main/java/com/example/demo/service/SpeakingService.java

package com.example.demo.service;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.AIChatRequestDTO;
import com.example.demo.dto.SpeakingFeedbackDTO;
import com.example.demo.entity.data.SpeakingFeedback;
import com.example.demo.entity.data.SpeakingQuestion;
import com.example.demo.entity.data.SpeakingTopic;
import com.example.demo.entity.user.User;
import com.example.demo.repository.data.SpeakingFeedbackRepository;
import com.example.demo.repository.data.SpeakingQuestionRepository;
import com.example.demo.repository.data.SpeakingTopicRepository;
import com.example.demo.repository.UserRepository;
import com.example.demo.exception.ResourceNotFoundException;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
public class SpeakingService {

    private final SpeakingTopicRepository speakingTopicRepository;
    private final SpeakingQuestionRepository speakingQuestionRepository;
    private final SpeakingFeedbackRepository speakingFeedbackRepository;
    private final UserRepository userRepository;
    private final SpeechToTextService speechToTextService;
    private final AIFeedbackService aiFeedbackService;
    private final CloudService cloudService;
    private final AudioStorageService audioStorageService;
    private final AIFeedBackService2 aiFeedBackService2;
    // CRUD for Speaking Topics
    public SpeakingTopic createSpeakingTopic(SpeakingTopic topic) {
        if (speakingTopicRepository.existsByName(topic.getName())) {
            throw new IllegalArgumentException("Topic with this name already exists.");
        }
        return speakingTopicRepository.save(topic);
    }
    public SpeakingQuestion getQuestionById(int questionId) {
        return speakingQuestionRepository.findById(questionId)
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingQuestion", "id", questionId));
    }

    public SpeakingTopic updateSpeakingTopic(int id, SpeakingTopic updatedTopic) {
        SpeakingTopic topic = speakingTopicRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingTopic", "id", id));
        topic.setName(updatedTopic.getName());
        return speakingTopicRepository.save(topic);
    }

    public void deleteSpeakingTopic(int id) {
        SpeakingTopic topic = speakingTopicRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingTopic", "id", id));
        speakingTopicRepository.delete(topic);
    }

    public List<SpeakingTopic> getAllSpeakingTopics() {
        return speakingTopicRepository.findAll();
    }

    // CRUD for Speaking Questions
    public SpeakingQuestion createSpeakingQuestion(int topicId, SpeakingQuestion question) {
        SpeakingTopic topic = speakingTopicRepository.findById(topicId)
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingTopic", "id", topicId));
        question.setTopic(topic);
        return speakingQuestionRepository.save(question);
    }

    public SpeakingQuestion updateSpeakingQuestion(int id, SpeakingQuestion updatedQuestion) {
        SpeakingQuestion question = speakingQuestionRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingQuestion", "id", id));
        question.setQuestionText(updatedQuestion.getQuestionText());
        return speakingQuestionRepository.save(question);
    }

    public void deleteSpeakingQuestion(int id) {
        SpeakingQuestion question = speakingQuestionRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingQuestion", "id", id));
        speakingQuestionRepository.delete(question);
    }

    public List<SpeakingQuestion> getAllQuestionsByTopic(int topicId) {
        return speakingQuestionRepository.findByTopicId(topicId);
    }

    // Submit Speaking Response
    public SpeakingFeedback submitSpeakingResponse(int userId, int questionId, MultipartFile audioFile) throws IOException {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("User", "id", userId));
        SpeakingQuestion question = speakingQuestionRepository.findById(questionId)
                .orElseThrow(() -> new ResourceNotFoundException("SpeakingQuestion", "id", questionId));

        // Bước 1: Tải lên âm thanh tới Google Cloud Storage
        String audioUrl = audioStorageService.uploadAudio(
                audioFile.getBytes(),
                audioFile.getOriginalFilename(),
                audioFile.getContentType()
        );
        if (audioUrl == null) {
            throw new RuntimeException("Không thể tải lên âm thanh.");
        }

        // Bước 2: Chuyển đổi âm thanh thành văn bản
        String transcript;
        try {
            transcript = speechToTextService.transcribeAudio(audioFile.getBytes());
        } catch (Exception e) {
            throw new RuntimeException("Failed to transcribe audio.", e);
        }

        // Bước 3: Tạo phản hồi sử dụng AI
        SpeakingFeedbackDTO feedbackDTO = aiFeedbackService.generateFeedback(
                transcript,
                question.getQuestionText(),
                question.getTopic().getName()
        );
        if (feedbackDTO == null) {
            throw new RuntimeException("Không thể tạo phản hồi.");
        }

        // Bước 4: Lưu phản hồi
        SpeakingFeedback feedback = SpeakingFeedback.builder()
                .user(user)
                .question(question)
                .transcript(transcript)
                .feedbackJson(feedbackDTO.toJson())
                .submissionTime(LocalDateTime.now())
                .audioUrl(audioUrl)
                .build();

        return speakingFeedbackRepository.save(feedback);
    }

    // Retrieve Feedbacks
    public List<SpeakingFeedback> getUserSpeakingFeedbacks(int userId) {
        return speakingFeedbackRepository.findByUserId(userId);
    }
    public String generateAnswer(AIChatRequestDTO chatRequest) {
        return aiFeedBackService2.generateAnswer(chatRequest);
    }
}

================
File: service/SpeechToTextService.java
================
package com.example.demo.service;

import com.google.api.gax.core.FixedCredentialsProvider;
import com.google.auth.oauth2.ServiceAccountCredentials;
import com.google.cloud.speech.v1.*;
import com.google.protobuf.ByteString;
import lombok.extern.slf4j.Slf4j;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.io.InputStream;

@Slf4j
@Service
public class SpeechToTextService {

    private final SpeechClient speechClient;

    public SpeechToTextService() {
        try {
            // Tải tệp JSON từ thư mục resources
            ClassPathResource resource = new ClassPathResource("google-speech-key.json"); // Đảm bảo tệp này nằm trong src/main/resources

            // Tạo thông tin xác thực từ tệp JSON
            InputStream credentialsStream = resource.getInputStream();
            ServiceAccountCredentials credentials = ServiceAccountCredentials.fromStream(credentialsStream);

            // Tạo SpeechClient với thông tin xác thực
            SpeechSettings speechSettings = SpeechSettings.newBuilder()
                    .setCredentialsProvider(FixedCredentialsProvider.create(credentials))
                    .build();

            speechClient = SpeechClient.create(speechSettings);

            log.info("SpeechClient initialized with provided credentials.");
        } catch (IOException e) {
            log.error("Không thể khởi tạo SpeechClient với thông tin xác thực", e);
            throw new RuntimeException("Failed to initialize SpeechClient", e);
        }
    }

    public String transcribeAudio(byte[] audioBytes) {
        try {
            // Configure recognition settings
            RecognitionConfig config = RecognitionConfig.newBuilder()
                    .setEncoding(RecognitionConfig.AudioEncoding.WEBM_OPUS) // Set to WEBM_OPUS
                    .setLanguageCode("en-US") // Adjust as needed
                    .build(); // Do not set sampleRateHertz

            // Create the audio content
            RecognitionAudio audio = RecognitionAudio.newBuilder()
                    .setContent(ByteString.copyFrom(audioBytes))
                    .build();

            // Perform the transcription
            RecognizeResponse response = speechClient.recognize(config, audio);

            // Process the results
            StringBuilder transcription = new StringBuilder();
            for (SpeechRecognitionResult result : response.getResultsList()) {
                transcription.append(result.getAlternativesList().get(0).getTranscript());
            }

            log.info("Transcription successful: {}", transcription.toString());

            return transcription.toString();
        } catch (Exception e) {
            log.error("Failed to transcribe audio.", e);
            throw new RuntimeException("Failed to transcribe audio.", e);
        }
    }

    // Ensure SpeechClient is closed when the application stops
    public void shutdown() {
        if (speechClient != null) {
            speechClient.close();
        }
    }
}

================
File: service/TestService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.*;
import com.example.demo.repository.data.*;
import com.example.demo.dto.*;
import com.example.demo.entity.user.User;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.hibernate.Hibernate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import org.modelmapper.ModelMapper;

@Service
@RequiredArgsConstructor
public class TestService {

    private final TestRepository testRepository;
    private final QuestionRepository questionRepository;
    private final QuestionOptionRepository questionOptionRepository;
    private final UserResponseRepository userResponseRepository;
    private final TestProgressRepository testProgressRepository;
    private final UserRepository userRepository;
    private final PassageRepository passageRepository;
    private final ListeningSectionRepository listeningSectionRepository;

    public Test getTestById(int id) {
        return testRepository.findById(id).orElse(null);
    }

    public List<Test> getAllTests() {
        return testRepository.findAll();
    }
    public List<Passage> getPassagesByTestId(int testId) {
        return passageRepository.findByTest_Id(testId);
    }

    public List<ListeningSection> getListeningSectionsByTestId(int testId) {
        return listeningSectionRepository.findByTest_Id(testId);
    }
    private final ModelMapper modelMapper;

    public TestDTO getTestDTOById(int id) {
        Test test = getTestById(id);
        if (test == null) return null;

        TestDTO testDTO = modelMapper.map(test, TestDTO.class);

        if ("READING".equalsIgnoreCase(test.getType())) {
            List<PassageDTO> passageDTOs = test.getPassages().stream()
                    .map(this::convertToPassageDTO)
                    .collect(Collectors.toList());
            testDTO.setPassages(passageDTOs);
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            List<ListeningSectionDTO> sectionDTOs = test.getListeningSections().stream()
                    .map(this::convertToListeningSectionDTO)
                    .collect(Collectors.toList());
            testDTO.setListeningSections(sectionDTOs);
        }

        return testDTO;
    }
    public List<Question> getQuestionsByTestId(int testId) {
        Test test = testRepository.findById(testId).orElse(null);
        if (test == null) {
            return Collections.emptyList();
        }

        List<Question> questions = new ArrayList<>();

        if ("READING".equalsIgnoreCase(test.getType())) {
            for (Passage passage : test.getPassages()) {
                questions.addAll(passage.getQuestions());
            }
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            for (ListeningSection section : test.getListeningSections()) {
                questions.addAll(section.getQuestions());
            }
        }

        return questions;
    }

    private PassageDTO convertToPassageDTO(Passage passage) {
        PassageDTO passageDTO = modelMapper.map(passage, PassageDTO.class);
        List<QuestionDTO> questionDTOs = passage.getQuestions().stream()
                .map(this::convertToQuestionDTO)
                .collect(Collectors.toList());
        passageDTO.setQuestions(questionDTOs);
        return passageDTO;
    }

    private ListeningSectionDTO convertToListeningSectionDTO(ListeningSection section) {
        ListeningSectionDTO sectionDTO = modelMapper.map(section, ListeningSectionDTO.class);
        List<QuestionDTO> questionDTOs = section.getQuestions().stream()
                .map(this::convertToQuestionDTO)
                .collect(Collectors.toList());
        sectionDTO.setQuestions(questionDTOs);
        return sectionDTO;
    }

    private QuestionDTO convertToQuestionDTO(Question question) {
        QuestionDTO questionDTO = modelMapper.map(question, QuestionDTO.class);
        if (question.getOptions() != null) {
            List<QuestionOptionDTO> questionOptionDTOS = question.getOptions().stream()
                    .map(option -> modelMapper.map(option, QuestionOptionDTO.class))
                    .collect(Collectors.toList());
            questionDTO.setOptions(questionOptionDTOS);
        }
        return questionDTO;
    }
    @Transactional
    public TestProgress startTest(int testId, int userId) {
        Test test = testRepository.findById(testId)
                .orElseThrow(() -> new RuntimeException("Test not found"));
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("User not found"));

        int totalQuestions = 0;

        if ("READING".equalsIgnoreCase(test.getType())) {
            Hibernate.initialize(test.getPassages());
            for (Passage passage : test.getPassages()) {
                Hibernate.initialize(passage.getQuestions());
                totalQuestions += passage.getQuestions().size();
            }
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            Hibernate.initialize(test.getListeningSections());
            for (ListeningSection section : test.getListeningSections()) {
                Hibernate.initialize(section.getQuestions());
                totalQuestions += section.getQuestions().size();
            }
        }

        TestProgress testProgress = TestProgress.builder()
                .test(test)
                .user(user)
                .startTime(LocalDateTime.now())
                .totalQuestions(totalQuestions)
                .isCompleted(false)
                .build();

        return testProgressRepository.save(testProgress);
    }



    private int calculateTotalQuestions(Test test) {
        int totalQuestions = 0;

        if ("READING".equalsIgnoreCase(test.getType())) {
            // Ensure passages are loaded
            List<Passage> passages = test.getPassages();
            if (passages != null) {
                for (Passage passage : passages) {
                    List<Question> questions = passage.getQuestions();
                    if (questions != null) {
                        totalQuestions += questions.size();
                    }
                }
            }
        } else if ("LISTENING".equalsIgnoreCase(test.getType())) {
            // Ensure listening sections are loaded
            List<ListeningSection> sections = test.getListeningSections();
            if (sections != null) {
                for (ListeningSection section : sections) {
                    List<Question> questions = section.getQuestions();
                    if (questions != null) {
                        totalQuestions += questions.size();
                    }
                }
            }
        }

        return totalQuestions;
    }


    @Transactional
    public void submitUserResponses(int testProgressId, List<UserResponseDTO> userResponsesDTO) {
        TestProgress testProgress = testProgressRepository.findById(testProgressId).orElseThrow();

        int correctAnswers = 0;

        for (UserResponseDTO dto : userResponsesDTO) {
            Question question = questionRepository.findById(dto.getQuestionId()).orElseThrow();
            boolean isCorrect = dto.getUserAnswer().trim().equalsIgnoreCase(question.getCorrectAnswer().trim());

            UserResponse userResponse = UserResponse.builder()
                    .testProgress(testProgress)
                    .question(question)
                    .userAnswer(dto.getUserAnswer())
                    .isCorrect(isCorrect)
                    .responseTime(LocalDateTime.now())
                    .build();

            userResponseRepository.save(userResponse);

            if (isCorrect) {
                correctAnswers++;
            }
        }

        // Update test progress
        testProgress.setCorrectAnswers(correctAnswers);
        testProgress.setEndTime(LocalDateTime.now());
        testProgress.setCompleted(true);

        testProgressRepository.save(testProgress);
    }

    @Transactional
    public void completeTest(int testProgressId) {
        TestProgress testProgress = testProgressRepository.findById(testProgressId).orElseThrow();
        testProgress.setEndTime(LocalDateTime.now());
        testProgress.setCompleted(true);

        testProgressRepository.save(testProgress);
    }

    // Additional methods as needed
}

================
File: service/UploadService.java
================
package com.example.demo.service;

import com.example.demo.cloudinary.CloudService;
import com.example.demo.dto.ResponseObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

@Service
public class UploadService {

    @Autowired
    private CloudService cloudService;

    public ResponseObject uploadImg(byte[] img) {
        var result = cloudService.uploadImage(img);
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }

    public ResponseObject uploadVideo(byte[] video) {
        var result = cloudService.uploadVideo(video);
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }
}

================
File: service/UserService.java
================
package com.example.demo.service;

import com.example.demo.dto.ResponseObject;
import com.example.demo.dto.UsersAndRoles;
import com.example.demo.entity.user.Role;
import com.example.demo.entity.user.User;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;

@Service
@RequiredArgsConstructor
public class UserService {
    private final UserRepository userRepository;

    public ResponseObject getAllUser() {
        var users = userRepository.findAll();
        return ResponseObject.builder().status(HttpStatus.OK).mess("Get data successfully").status(HttpStatus.OK).content(users).build();
    }

    public ResponseObject getAllRole() {
        return ResponseObject.builder().status(HttpStatus.OK).content(Role.values()).build();
    }
    public ResponseObject getAllUserAndRole(boolean isDeleted){
        var roles = Role.values();
        var users = userRepository.findAllByIsDeleted(isDeleted, PageRequest.of(0, 5));
        UsersAndRoles usersAndRoles = UsersAndRoles.builder().roles(roles).users(users).build();
        return ResponseObject.builder().status(HttpStatus.OK).content(usersAndRoles).build();
    }



    public ResponseObject getUserByRole(String role, int page, int size) {
        if (Objects.equals(role, "All"))
            return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findAll(PageRequest.of(page, size))).build();
        return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findByRole(role, PageRequest.of(page, size))).build();
    }
    public User findByEmail(String email) {
        return userRepository.findByEmail(email)
                .orElseThrow(() -> new ResourceNotFoundException("User not found with email: " + email));
    }
    public ResponseObject getUserByName(String name, boolean isDelete, int page, int size) {
        if (Objects.equals(name, ""))
            return ResponseObject.builder().status(HttpStatus.OK).content(userRepository.findAllByIsDeleted(isDelete, PageRequest.of(page, size))).build();
        return ResponseObject.builder().status(HttpStatus.OK)
                .content(userRepository.findByFirstNameContainingOrLastNameContainingAndAndDeleted(name, name,isDelete, PageRequest.of(page, size)))
                .build();
    }

    public ResponseObject getAllByPage(int page, int size) {
        var result = userRepository.findAllByIsDeleted(false, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }
    public Page<User> getAllActiveUsers(Pageable pageable) {
        return userRepository.findByIsDeletedFalse(pageable);
    }

    public ResponseObject getAllDeletedByPage(int page, int size) {
        var result = userRepository.findAllByIsDeleted(true, PageRequest.of(page, size));
        return ResponseObject.builder().status(HttpStatus.OK).content(result).build();
    }

    public ResponseObject softDelete(int id) {
        var user = userRepository.findById(id).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        if (Objects.equals(user.getRole(), Role.ADMIN) || user.getRole() == Role.MANAGER)
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Cannot delete this user").build();
        user.setDeleted(true);
        userRepository.save(user);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject hardDelete(int id) {
        var user = userRepository.findById(id).orElse(null);
        if (user == null) {
            return ResponseObject.builder().status(HttpStatus.BAD_REQUEST).mess("Course is not exist!").build();
        }
        userRepository.delete(user);
        return ResponseObject.builder().mess("Delete course successfully!").status(HttpStatus.OK).build();
    }

    public ResponseObject restoreUserById(int id) {
        var user = userRepository.findById(id).orElse(null);
        if (user == null)
            return ResponseObject.builder().mess("Course does not exist").status(HttpStatus.BAD_REQUEST).build();
        user.setDeleted(false);
        userRepository.save(user);
        return ResponseObject.builder().mess("Restore successfully").status(HttpStatus.OK).build();
    }
}

================
File: service/VocabularyService.java
================
package com.example.demo.service;



import com.example.demo.entity.data.Vocabulary;
import com.example.demo.repository.data.VocabularyRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class VocabularyService {

    @Autowired
    private VocabularyRepository vocabularyRepository;

    public List<Vocabulary> getAllVocabulary(){
        return vocabularyRepository.findAll();
    }

    public Vocabulary addVocabulary(Vocabulary vocabulary){
        return vocabularyRepository.save(vocabulary);
    }

    public Vocabulary updateVocabulary(Integer id, Vocabulary updatedVocabulary){
        return vocabularyRepository.findById(id)
                .map(v -> {
                    v.setWord(updatedVocabulary.getWord());
                    v.setDefinition(updatedVocabulary.getDefinition());
                    v.setExample(updatedVocabulary.getExample());
                    return vocabularyRepository.save(v);
                })
                .orElseThrow(() -> new RuntimeException("Vocabulary not found with id " + id));
    }

    public void deleteVocabulary(Integer id){
        vocabularyRepository.deleteById(id);
    }
}

================
File: service/VocabularySetService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.Vocabulary;
import com.example.demo.entity.data.VocabularySet;
import com.example.demo.repository.data.VocabularyRepository;
import com.example.demo.repository.data.VocabularySetRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

@Service
public class VocabularySetService {

    @Autowired
    private VocabularySetRepository vocabularySetRepository;

    @Autowired
    private VocabularyRepository vocabularyRepository;

    @Transactional
    public VocabularySet createVocabularySet(VocabularySet vocabularySet, List<Vocabulary> vocabularies) {
        vocabularySet.setVocabularies(vocabularies);
        vocabularies.forEach(vocab -> vocab.setVocabularySet(vocabularySet));
        return vocabularySetRepository.save(vocabularySet);
    }

    public List<VocabularySet> getVocabularySetsByUser(Integer userId) {
        return vocabularySetRepository.findByUserId(userId);
    }

    public Optional<VocabularySet> getVocabularySetById(Integer setId) {
        return vocabularySetRepository.findById(setId);
    }

    public void deleteVocabularySet(Integer setId) {
        vocabularySetRepository.deleteById(setId);
    }

    // Các phương thức khác nếu cần
}

================
File: service/WritingService.java
================
package com.example.demo.service;

import com.example.demo.entity.data.*;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.data.*;
import com.example.demo.dto.*;
import com.example.demo.entity.user.User;
import com.example.demo.repository.UserRepository;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class WritingService {

    private final WritingTaskRepository writingTaskRepository;
    private final UserEssayRepository userEssayRepository;
    private final UserRepository userRepository;
    private final ExternalEssayEvaluationService externalEssayEvaluationService; // We'll need to implement this

    public WritingTask getWritingTaskById(int id) {
        return writingTaskRepository.findById(id).orElse(null);
    }

    public List<WritingTask> getAllWritingTasks() {
        return writingTaskRepository.findAll();
    }


    @Transactional
    public UserEssay submitEssay(Integer userId, Integer writingTaskId, String essayContent) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("User not found"));
        WritingTask task = writingTaskRepository.findById(writingTaskId)
                .orElseThrow(() -> new ResourceNotFoundException("Task not found"));

        EssayFeedback feedback = externalEssayEvaluationService.evaluateEssay(task.getPrompt(), essayContent);
        double overallScore = feedback.getOverallScore();

        UserEssay userEssay = UserEssay.builder()
                .user(user)
                .writingTask(task)
                .content(essayContent)
                .submissionTime(LocalDateTime.now())
                .feedbackJson(convertFeedbackToJson(feedback)) // Lưu dưới dạng JSON
                .score(overallScore)
                .build();

        return userEssayRepository.save(userEssay);
    }

    public long getUserEssayCount(int userId) {
        return userEssayRepository.countUserEssaysByUserId(userId);
    }

    public Double getUserAverageEssayScore(int userId) {
        return userEssayRepository.findAverageEssayScoreByUserId(userId);
    }

    public long getTotalEssayCount() {
        return userEssayRepository.countAllEssays();
    }

    public Double getAverageEssayScore() {
        return userEssayRepository.findAverageEssayScore();
    }

    public List<UserEssay> getAllEssays() {
        return userEssayRepository.findAllEssaysOrderedBySubmissionTime();
    }

    public List<UserEssayDTO> getAllEssaysWithUserNames() {
        List<UserEssayDTO> essays = userEssayRepository.findAllEssaysWithUserNames();
        return essays.stream().map(essay -> new UserEssayDTO(
                essay.getId(),
                essay.getContent(),
                essay.getSubmissionTime(),
                essay.getScore(),
                essay.getEmail()
        )).collect(Collectors.toList());
    }

    public List<UserEssay> getUserEssays(int userId) {
        return userEssayRepository.findUserEssaysByUserId(userId);
    }

    private String convertFeedbackToJson(EssayFeedback feedback) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            return mapper.writeValueAsString(feedback);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Error converting feedback to JSON.");
        }
    }

    public WritingTask createWritingTask(WritingTask writingTask) {
        return writingTaskRepository.save(writingTask);
    }

    public WritingTask updateWritingTask(int id, WritingTask updatedTask) {
        WritingTask existingTask = writingTaskRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Task not found"));
        existingTask.setTitle(updatedTask.getTitle());
        existingTask.setPrompt(updatedTask.getPrompt());
        existingTask.setTaskType(updatedTask.getTaskType());
        return writingTaskRepository.save(existingTask);
    }

    public void deleteWritingTask(int id) {
        WritingTask task = writingTaskRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Task not found"));
        writingTaskRepository.delete(task);
    }

    public Page<UserEssay> getUserEssays(Integer userId, Pageable pageable) {
        return userEssayRepository.findAllByUserId(userId, pageable);
        // Additional methods as needed
    }
    public UserEssay getEssayById(Integer essayId) {
        return userEssayRepository.findById(essayId)
                .orElseThrow(() -> new ResourceNotFoundException("UserEssay", "id", essayId));
    }
    public List<UserEssay> getUserEssays(Integer userId) {
        return userEssayRepository.findAllByUserId(userId);
    }

}
